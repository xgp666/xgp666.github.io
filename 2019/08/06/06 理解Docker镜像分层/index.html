<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>理解Docker镜像分层 | Xgp &amp; Blog</title><meta name="description" content="目录 关于base镜像 关于存储结构（About storage drivers） 先来创建一个自己的镜像 docker镜像的分层结构 容器的大小 修改时复制策略 copy-on-write (CoW) Copying makes containers efficient 关于base镜像 base 镜像有两层含义： 不依赖其他镜像，从 scratch 构建。 其他镜像可以之为基础进行扩展。 所以"><meta name="keywords" content="bash"><meta name="author" content="Wu Shao Dong"><meta name="copyright" content="Wu Shao Dong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://gitee.com/xgpqq/tuchuang/raw/master/img/Yun.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="rPK0WSwqdm"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="理解Docker镜像分层"><meta name="twitter:description" content="目录 关于base镜像 关于存储结构（About storage drivers） 先来创建一个自己的镜像 docker镜像的分层结构 容器的大小 修改时复制策略 copy-on-write (CoW) Copying makes containers efficient 关于base镜像 base 镜像有两层含义： 不依赖其他镜像，从 scratch 构建。 其他镜像可以之为基础进行扩展。 所以"><meta name="twitter:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq118p.jpg"><meta property="og:type" content="article"><meta property="og:title" content="理解Docker镜像分层"><meta property="og:url" content="wsdlxgp.top/2019/08/06/06%20%E7%90%86%E8%A7%A3Docker%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82/"><meta property="og:site_name" content="Xgp &amp; Blog"><meta property="og:description" content="目录 关于base镜像 关于存储结构（About storage drivers） 先来创建一个自己的镜像 docker镜像的分层结构 容器的大小 修改时复制策略 copy-on-write (CoW) Copying makes containers efficient 关于base镜像 base 镜像有两层含义： 不依赖其他镜像，从 scratch 构建。 其他镜像可以之为基础进行扩展。 所以"><meta property="og:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq118p.jpg"><meta property="article:published_time" content="2019-08-05T16:00:00.000Z"><meta property="article:modified_time" content="2020-07-09T06:59:06.286Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="wsdlxgp.top/2019/08/06/06%20%E7%90%86%E8%A7%A3Docker%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82/"><link rel="prev" title="Dockerfile常用指令" href="/wsdlxgp.top/2019/08/07/07%20Dockerfile%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/"><link rel="next" title="Dockers镜像分层" href="/wsdlxgp.top/2019/08/05/05%20Dockers%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82/"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cad0cd04042fcca2c687648c42a45fc9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: Wu Shao Dong","link":"链接: ","source":"来源: Xgp & Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/self/hybrid.css"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Xgp & Blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/666.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">132</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">76</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#目录"><span class="toc-number">1.</span> <span class="toc-text">目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">关于base镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#base-镜像有两层含义："><span class="toc-number">1.</span> <span class="toc-text">base 镜像有两层含义：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#base-镜像提供的是最小安装的-Linux-发行版。"><span class="toc-number">2.</span> <span class="toc-text">base 镜像提供的是最小安装的 Linux 发行版。</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#拉取"><span class="toc-number">2.1.</span> <span class="toc-text">拉取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看"><span class="toc-number">2.2.</span> <span class="toc-text">查看</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#需要注意的是："><span class="toc-number">2.3.</span> <span class="toc-text">需要注意的是：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">关于存储结构（About storage drivers）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#先来创建一个自己的镜像"><span class="toc-number"></span> <span class="toc-text">先来创建一个自己的镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在当前目录下新建一个文件Dockerfile-填充上述内容。然后执行"><span class="toc-number"></span> <span class="toc-text">在当前目录下新建一个文件Dockerfile, 填充上述内容。然后执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker镜像的分层结构"><span class="toc-number"></span> <span class="toc-text">docker镜像的分层结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改时复制策略-copy-on-write-CoW"><span class="toc-number"></span> <span class="toc-text">修改时复制策略 copy-on-write (CoW)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#当容器需要读取文件的时候"><span class="toc-number">1.</span> <span class="toc-text">当容器需要读取文件的时候</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当容器需要添加文件的时候"><span class="toc-number">2.</span> <span class="toc-text">当容器需要添加文件的时候</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当容器需要修改文件的时候"><span class="toc-number">3.</span> <span class="toc-text">当容器需要修改文件的时候</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#当容器需要删除文件的时候"><span class="toc-number">4.</span> <span class="toc-text">当容器需要删除文件的时候</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#构建"><span class="toc-number">4.1.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建-2"><span class="toc-number">4.2.</span> <span class="toc-text">构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#比较二者大小"><span class="toc-number">4.3.</span> <span class="toc-text">比较二者大小</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq118p.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Xgp &amp; Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">理解Docker镜像分层</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-08-06 00:00:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-08-06</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-09 14:59:06"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-09</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/docker/">docker</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon far fa-file-word" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.5k</span><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-clock" aria-hidden="true"></i><span>阅读时长: 15 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h3 id="目录"><strong>目录</strong></h3>
<p><strong>关于base镜像</strong><br>
<strong>关于存储结构（About storage drivers）</strong><br>
<strong>先来创建一个自己的镜像</strong><br>
<strong>docker镜像的分层结构</strong><br>
<strong>容器的大小</strong><br>
<strong>修改时复制策略 copy-on-write (CoW)</strong><br>
<strong>Copying makes containers efficient</strong></p>
<h1>关于base镜像</h1>
<h3 id="base-镜像有两层含义："><strong>base 镜像有两层含义</strong>：</h3>
<p><strong>不依赖其他镜像，从 scratch 构建。</strong><br>
<strong>其他镜像可以之为基础进行扩展。</strong><br>
<strong>所以，能称作 base 镜像的通常都是各种 Linux 发行版的 Docker 镜像，比如 Ubuntu, Debian, CentOS 等。</strong></p>
<h3 id="base-镜像提供的是最小安装的-Linux-发行版。"><strong>base 镜像提供的是最小安装的 Linux 发行版。</strong></h3>
<p><strong>我们大部分镜像都将是基于base镜像构建的。所以，通常使用的是官方发布的base镜像。可以在docker hub里找到。比如centos： <a href="https://hub.docker.com/_/centos" target="_blank" rel="noopener">https://hub.docker.com/_/centos</a></strong></p>
<p><strong>点击版本可以看到github里的Dockerfile</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">FROM scratch<br>ADD centos<span class="hljs-literal">-7</span><span class="hljs-literal">-docker</span>.tar.xz /<br><br>LABEL org.label<span class="hljs-literal">-schema</span>.schema<span class="hljs-literal">-version</span>=<span class="hljs-string">"1.0"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.name=<span class="hljs-string">"CentOS Base Image"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.vendor=<span class="hljs-string">"CentOS"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.license=<span class="hljs-string">"GPLv2"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.build<span class="hljs-literal">-date</span>=<span class="hljs-string">"20181205"</span><br><br>CMD [<span class="hljs-string"><code class="language-hljs powershell">FROM scratch<br>ADD centos<span class="hljs-literal">-7</span><span class="hljs-literal">-docker</span>.tar.xz /<br><br>LABEL org.label<span class="hljs-literal">-schema</span>.schema<span class="hljs-literal">-version</span>=<span class="hljs-string">"1.0"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.name=<span class="hljs-string">"CentOS Base Image"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.vendor=<span class="hljs-string">"CentOS"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.license=<span class="hljs-string">"GPLv2"</span> \<br>    org.label<span class="hljs-literal">-schema</span>.build<span class="hljs-literal">-date</span>=<span class="hljs-string">"20181205"</span><br><br>CMD [<span class="hljs-string">"/bin/bash"</span>]<br></code></pre></td></tr></table></figure>
<p><strong>ADD命令将本地的centos7的tar包添加到镜像，并解压到根目录/下。生成/dev,/proc/,/bin等。</strong></p>
<p><strong>我们可以自己构建docker base镜像，也可以直接使用已有的base镜像。比如centos。我们可以直接从docker hub上拉取。</strong></p>
<h4 id="拉取"><strong>拉取</strong></h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><code class="language-hljs powershell">docker pull centos<br></code></pre></td></tr></table></figure>
<h4 id="查看"><strong>查看</strong></h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"># docker images centos </span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>centos              latest              <span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        <span class="hljs-number"><code class="language-hljs powershell"><span class="hljs-comment"># docker images centos </span><br>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE<br>centos              latest              <span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        <span class="hljs-number">202</span>MB<br></code></pre></td></tr></table></figure>
<p><strong>可以看到最新的centos镜像只有200mb，是不是觉得太小了？这是因为docker镜像在运行的时候直接使用docker宿主机器的kernel。</strong></p>
<p><strong>Linux操作系统由内核空间和用户空间组成。</strong></p>
<p><strong>内核空间是kernel，用户空间是rootfs, 不同Linux发行版的区别主要是rootfs.比如 Ubuntu 14.04 使用 upstart 管理服务，apt 管理软件包；而 CentOS 7 使用 systemd 和 yum。这些都是用户空间上的区别，Linux kernel 差别不大。</strong></p>
<p><strong>所以 Docker 可以同时支持多种 Linux 镜像，模拟出多种操作系统环境。</strong></p>
<h4 id="需要注意的是："><strong>需要注意的是：</strong></h4>
<p><strong>base镜像只是用户空间和发行版一致。kernel使用的是docker宿主机器的kernel。例如 CentOS 7 使用 3.x.x 的 kernel，如果 Docker Host 是 Ubuntu 16.04（比如我们的实验环境），那么在 CentOS 容器中使用的实际是是 Host 4.x.x 的 kernel。</strong></p>
<p><strong>① Host kernel 为 4.4.0-31</strong><br>
<strong>② 启动并进入 CentOS 容器</strong><br>
<strong>③ 验证容器是 CentOS 7</strong><br>
<strong>④ 容器的 kernel 版本与 Host 一致</strong></p>
<h1><strong>关于存储结构（About storage drivers）</strong></h1>
<p><strong>上文里展示了如何下载一个base镜像。我们通常是基于这份base镜像来构建我们自己的镜像。比如，在centos里添加一个nginx负载均衡。首先，得需要了解镜像的结构是什么。</strong></p>
<p><strong>官方文档： <a href="https://docs.docker.com/storage/storagedriver/" target="_blank" rel="noopener">https://docs.docker.com/storage/storagedriver/</a></strong></p>
<h2 id="先来创建一个自己的镜像"><strong>先来创建一个自己的镜像</strong></h2>
<p><strong>首先，base镜像是基于docker宿主机器kernel之上的Linux发行版。</strong></p>
<p><strong>现在，我们给这台机器安装一个vim，一个httpd. 基于Dockerfile来创建一个新的镜像。</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">我们的Dockerfile<br><br>FROM centos:<span class="hljs-number">7</span><br>RUN yum install <span class="hljs-literal">-y</span> vim<br>RUN yum install <span class="hljs-literal">-y</span> httpd<br>CMD [<span class="hljs-string"><code class="language-hljs powershell">我们的Dockerfile<br><br>FROM centos:<span class="hljs-number">7</span><br>RUN yum install <span class="hljs-literal">-y</span> vim<br>RUN yum install <span class="hljs-literal">-y</span> httpd<br>CMD [<span class="hljs-string">"/bin/bash"</span>]<br>含义：<br><br>基于centos7的base镜像构建<br>安装vim<br>安装httpd<br>执行bash<br></code></pre></td></tr></table></figure>
<h2 id="在当前目录下新建一个文件Dockerfile-填充上述内容。然后执行"><strong>在当前目录下新建一个文件Dockerfile, 填充上述内容。然后执行</strong></h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"># docker build -t ryan/httpd:v1.0 .</span><br>Sending build context to Docker daemon  <span class="hljs-number">6.144</span>kB<br>Step <span class="hljs-number">1</span>/<span class="hljs-number">4</span> : FROM centos:<span class="hljs-number">7</span><br> ---&gt; <span class="hljs-number">1</span>e1148e4cc2c<br>Step <span class="hljs-number">2</span>/<span class="hljs-number">4</span> : RUN yum install <span class="hljs-literal">-y</span> vim<br> ---&gt; <span class="hljs-keyword">Using</span> cache<br> ---&gt; <span class="hljs-number">74</span>bdbea98f73<br>Step <span class="hljs-number">3</span>/<span class="hljs-number">4</span> : RUN yum install <span class="hljs-literal">-y</span> httpd<br> ---&gt; <span class="hljs-keyword">Using</span> cache<br> ---&gt; <span class="hljs-number">17</span>d8c4095dc4<br>Step <span class="hljs-number">4</span>/<span class="hljs-number">4</span> : CMD /bin/bash<br> ---&gt; <span class="hljs-keyword"><code class="language-hljs powershell"><span class="hljs-comment"># docker build -t ryan/httpd:v1.0 .</span><br>Sending build context to Docker daemon  <span class="hljs-number">6.144</span>kB<br>Step <span class="hljs-number">1</span>/<span class="hljs-number">4</span> : FROM centos:<span class="hljs-number">7</span><br> ---&gt; <span class="hljs-number">1</span>e1148e4cc2c<br>Step <span class="hljs-number">2</span>/<span class="hljs-number">4</span> : RUN yum install <span class="hljs-literal">-y</span> vim<br> ---&gt; <span class="hljs-keyword">Using</span> cache<br> ---&gt; <span class="hljs-number">74</span>bdbea98f73<br>Step <span class="hljs-number">3</span>/<span class="hljs-number">4</span> : RUN yum install <span class="hljs-literal">-y</span> httpd<br> ---&gt; <span class="hljs-keyword">Using</span> cache<br> ---&gt; <span class="hljs-number">17</span>d8c4095dc4<br>Step <span class="hljs-number">4</span>/<span class="hljs-number">4</span> : CMD /bin/bash<br> ---&gt; <span class="hljs-keyword">Using</span> cache<br> ---> f2b58b1192de<br>Successfully built f2b58b1192de<br>Successfully tagged ryan/httpd:latest<br></code></pre></td></tr></table></figure>
<p><strong>-t 指定我们创建的镜像名称，镜像名称可以用组织/id:version的方式标记</strong><br>
<strong>最后一个参数是Dockerfile所在的路径., 表示当前目录</strong><br>
<strong>然后我们添加一个tag latest</strong></p>
<p><strong><code>docker tag ryan/httpd:v1.0 ryan/httpd:latest</code></strong><br>
<strong>即给镜像ryan/httpd:v1.0标记为ryan/httpd:latest</strong><br>
<strong>构建完成之后，查看</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"># docker images  | grep -E '(ryan|centos)'</span><br>ryan/httpd                                                               latest                     f2b58b1192de        About an hour ago   <span class="hljs-number">444</span>MB<br>ryan/httpd                                                               v1.<span class="hljs-number">0</span>                       f2b58b1192de        About an hour ago   <span class="hljs-number">444</span>MB<br>centos                                                                   <span class="hljs-number">7</span>                          <span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        <span class="hljs-number">202</span>MB<br>centos                                                                   latest                     <span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        <span class="hljs-number"><code class="language-hljs powershell"><span class="hljs-comment"># docker images  | grep -E '(ryan|centos)'</span><br>ryan/httpd                                                               latest                     f2b58b1192de        About an hour ago   <span class="hljs-number">444</span>MB<br>ryan/httpd                                                               v1.<span class="hljs-number">0</span>                       f2b58b1192de        About an hour ago   <span class="hljs-number">444</span>MB<br>centos                                                                   <span class="hljs-number">7</span>                          <span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        <span class="hljs-number">202</span>MB<br>centos                                                                   latest                     <span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        <span class="hljs-number">202</span>MB<br></code></pre></td></tr></table></figure>
<p><strong>可以运行我们创建的镜像：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"># docker run -d  --privileged=true -it ryan/httpd:v1.0 /usr/sbin/init</span><br><span class="hljs-number">48</span>a4a128cd7b6924149cd97670919d4e2af6cb96c73c901af60d05fe4478225a<br><span class="hljs-comment"># docker ps | grep ryan</span><br><span class="hljs-number">48</span>a4a128cd7b        ryan/httpd:v1.<span class="hljs-number">0</span>                                                          <span class="hljs-string">"/usr/sbin/init"</span>         <span class="hljs-number">8</span> seconds ago       Up <span class="hljs-number"><code class="language-hljs powershell"><span class="hljs-comment"># docker run -d  --privileged=true -it ryan/httpd:v1.0 /usr/sbin/init</span><br><span class="hljs-number">48</span>a4a128cd7b6924149cd97670919d4e2af6cb96c73c901af60d05fe4478225a<br><span class="hljs-comment"># docker ps | grep ryan</span><br><span class="hljs-number">48</span>a4a128cd7b        ryan/httpd:v1.<span class="hljs-number">0</span>                                                          <span class="hljs-string">"/usr/sbin/init"</span>         <span class="hljs-number">8</span> seconds ago       Up <span class="hljs-number">8</span> seconds<br></code></pre></td></tr></table></figure>
<p><strong>现在我们的基于原生base centos7的httpd服务器已经启动了。可以通过docker exec -it zealous_kirch /bin/bash来进入容器内部，查看启动httpd。</strong></p>
<h2 id="docker镜像的分层结构"><strong>docker镜像的分层结构</strong></h2>
<p><strong>我们可以查看镜像的历史，用上一步的镜像id f2b58b1192de</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"># docker history f2b58b1192de</span><br>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>f2b58b1192de        About an hour ago   /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop)  CMD ["/bin/bash"]            0B                  </span><br><span class="hljs-number">17</span>d8c4095dc4        About an hour ago   /bin/sh <span class="hljs-literal">-c</span> yum install <span class="hljs-literal">-y</span> httpd                 <span class="hljs-number">110</span>MB               <br><span class="hljs-number">74</span>bdbea98f73        About an hour ago   /bin/sh <span class="hljs-literal">-c</span> yum install <span class="hljs-literal">-y</span> vim                   <span class="hljs-number">133</span>MB               <br><span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop)  CMD ["/bin/bash"]            0B                  </span><br>&lt;missing&gt;           <span class="hljs-number">2</span> months ago        /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop)  LABEL org.label-schema....   0B                  </span><br>&lt;missing&gt;           <span class="hljs-number">2</span> months ago        /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># docker history f2b58b1192de</span><br>IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT<br>f2b58b1192de        About an hour ago   /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop)  CMD ["/bin/bash"]            0B                  </span><br><span class="hljs-number">17</span>d8c4095dc4        About an hour ago   /bin/sh <span class="hljs-literal">-c</span> yum install <span class="hljs-literal">-y</span> httpd                 <span class="hljs-number">110</span>MB               <br><span class="hljs-number">74</span>bdbea98f73        About an hour ago   /bin/sh <span class="hljs-literal">-c</span> yum install <span class="hljs-literal">-y</span> vim                   <span class="hljs-number">133</span>MB               <br><span class="hljs-number">1</span>e1148e4cc2c        <span class="hljs-number">2</span> months ago        /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop)  CMD ["/bin/bash"]            0B                  </span><br>&lt;missing&gt;           <span class="hljs-number">2</span> months ago        /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop)  LABEL org.label-schema....   0B                  </span><br>&lt;missing&gt;           <span class="hljs-number">2</span> months ago        /bin/sh <span class="hljs-literal">-c</span> <span class="hljs-comment">#(nop) ADD file:6f877549795f479...   202MB</span><br></code></pre></td></tr></table></figure>
<p><strong>启动镜像的时候，一个新的可写层会加载到镜像的顶部。这一层通常称为“容器层”， 之下是“镜像层”。</strong></p>
<p><strong>容器层可以读写，容器所有发生文件变更写都发生在这一层。镜像层read-only,只允许读取。</strong><br>
<strong><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200607165003007.png" alt="image-20200607165003007"></strong></p>
<p><strong>(上图来自官方文档，和本次实验内容略有不同，但原理一样)</strong></p>
<p><strong>第一列是imageid, 最上面的id就是我们新创建ryan/httpd:latest. 下面几行都是我们dockerfile里定义的步骤堆栈。由此可以看出，每个步骤都将创建一个imgid, 一直追溯到1e1148e4cc2c正好是我们的base镜像的id。关于<missing>的部分，则不在本机上。</strong></p>
<p><strong>最后一列是每一层的大小。最后一层只是启动bash，所以没有文件变更，大小是0. 我们创建的镜像是在base镜像之上的，并不是完全复制一份base，然后修改，而是共享base的内容。这时候，如果我们新建一个新的镜像，同样也是共享base镜像。</strong></p>
<p><strong>那修改了base镜像，会不会导致我们创建的镜像也被修改呢？ 不会！因为不允许修改历史镜像，只允许修改容器，而容器只可以在最上面的容器层进行写和变更。</strong></p>
<p><strong>容器的大小</strong><br>
<strong>创建镜像的时候，分层可以让docker只保存我们添加和修改的部分内容。其他内容基于base镜像，不需要存储，读取base镜像即可。如此，当我们创建多个镜像的时候，所有的镜像共享base部分。节省了磁盘空间。</strong></p>
<p><strong>对于启动的容器，查看所需要的磁盘空间可以通过docker ps -s</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><br><span class="hljs-comment"># docker run -d -it centos</span><br><span class="hljs-number">4</span>b0df4bc3e705c540144d545441930689124ade087961d01f56c2ac55bfd986d<br><span class="hljs-comment"># docker ps -s | grep -E '(ryan|centos)'</span><br><span class="hljs-number">4</span>b0df4bc3e70        centos                                                                   <span class="hljs-string">"/bin/bash"</span>              <span class="hljs-number">23</span> seconds ago      Up <span class="hljs-number">23</span> seconds                           vigorous_elion                                                                                                                           <span class="hljs-number">0</span>B (virtual <span class="hljs-number">202</span>MB)<br>b36421d05005        ryan/httpd:v1.<span class="hljs-number">0</span>                                                          <span class="hljs-string">"/usr/sbin/init"</span>         <span class="hljs-number">32</span> minutes ago      Up <span class="hljs-number">32</span> minutes                           gracious_swirles                                                                                                                         <span class="hljs-number">61.6</span>kB (virtual <span class="hljs-number"><code class="language-hljs powershell"><br><span class="hljs-comment"># docker run -d -it centos</span><br><span class="hljs-number">4</span>b0df4bc3e705c540144d545441930689124ade087961d01f56c2ac55bfd986d<br><span class="hljs-comment"># docker ps -s | grep -E '(ryan|centos)'</span><br><span class="hljs-number">4</span>b0df4bc3e70        centos                                                                   <span class="hljs-string">"/bin/bash"</span>              <span class="hljs-number">23</span> seconds ago      Up <span class="hljs-number">23</span> seconds                           vigorous_elion                                                                                                                           <span class="hljs-number">0</span>B (virtual <span class="hljs-number">202</span>MB)<br>b36421d05005        ryan/httpd:v1.<span class="hljs-number">0</span>                                                          <span class="hljs-string">"/usr/sbin/init"</span>         <span class="hljs-number">32</span> minutes ago      Up <span class="hljs-number">32</span> minutes                           gracious_swirles                                                                                                                         <span class="hljs-number">61.6</span>kB (virtual <span class="hljs-number">444</span>MB)<br></code></pre></td></tr></table></figure>
<p><strong>首先启动一个base镜像用来对比</strong><br>
<strong>可以看到第一行就是base镜像centos，第2列的size是0和202MB, 0表示容器层可写层的大小，virtual则是容器层+镜像层的大小。这里对比可以看到一共202M,正好是最初centos镜像的大小。</strong><br>
<strong>第二行是我们自己创建的镜像。virtual达到了444MB。对比前面的history部分，可以发现这个数字是每一层大小之和。同时，由于共享base，其中的202M是和第一行的镜像共享的。</strong></p>
<h2 id="修改时复制策略-copy-on-write-CoW"><strong>修改时复制策略 copy-on-write (CoW)</strong></h2>
<p><strong>docker通过一个叫做copy-on-write (CoW) 的策略来保证base镜像的安全性，以及更高的性能和空间利用率。</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><br><span class="hljs-built_in">Copy-on</span><span class="hljs-literal">-write</span> is a strategy of sharing and copying files <span class="hljs-keyword">for</span> maximum efficiency. <span class="hljs-keyword">If</span> a file or directory exists <span class="hljs-keyword">in</span> a lower layer within the image, and another layer (including the writable layer) needs read access to it, it just uses the existing file. The first time another layer needs to modify the file (when building the image or running the container), the file is copied into that layer and modified. This minimizes I/O and the size of each of the subsequent layers. These advantages are explained <span class="hljs-keyword">in</span> more depth below.<br><br>Copying makes containers efficient<br>When you start a container, a thin writable container layer is added on top of the other layers. Any changes the container makes to the filesystem are stored here. Any files the container does not change <span class="hljs-keyword">do</span> not get copied to this writable layer. This means that the writable layer is as small as possible.<br><br>When an existing file <span class="hljs-keyword">in</span> a container is modified, the storage driver performs a <span class="hljs-built_in">copy-on</span><span class="hljs-literal">-write</span> operation. The specifics steps involved depend on the specific storage driver. <span class="hljs-keyword">For</span> the aufs, overlay, and overlay2 drivers, the <span class="hljs-built_in">copy-on</span><span class="hljs-literal">-write</span> operation follows this rough sequence:<br><br>Search through the image layers <span class="hljs-keyword">for</span> the file to update. The <span class="hljs-keyword">process</span> starts at the newest layer and works down to the base layer one layer at a time. When results are found, they are added to a cache to speed future operations.<br><br>Perform a copy_up operation on the first copy of the file that is found, to copy the file to the container’s writable layer.<br><br>Any modifications are made to this copy of the file, and the container cannot see the <span class="hljs-built_in">read-only</span> copy of the file that exists <span class="hljs-keyword">in</span> the lower layer.<br><br>Btrfs, ZFS, and other drivers handle the <span class="hljs-built_in">copy-on</span><span class="hljs-literal">-write</span> differently. You can read more about the methods of these drivers later <span class="hljs-keyword">in</span> their detailed descriptions.<br><br>Containers that write a lot of <span class="hljs-keyword">data</span> consume more space than containers that <span class="hljs-keyword">do</span> not. This is because most write operations consume new space <span class="hljs-keyword"><code class="language-hljs powershell"><br><span class="hljs-built_in">Copy-on</span><span class="hljs-literal">-write</span> is a strategy of sharing and copying files <span class="hljs-keyword">for</span> maximum efficiency. <span class="hljs-keyword">If</span> a file or directory exists <span class="hljs-keyword">in</span> a lower layer within the image, and another layer (including the writable layer) needs read access to it, it just uses the existing file. The first time another layer needs to modify the file (when building the image or running the container), the file is copied into that layer and modified. This minimizes I/O and the size of each of the subsequent layers. These advantages are explained <span class="hljs-keyword">in</span> more depth below.<br><br>Copying makes containers efficient<br>When you start a container, a thin writable container layer is added on top of the other layers. Any changes the container makes to the filesystem are stored here. Any files the container does not change <span class="hljs-keyword">do</span> not get copied to this writable layer. This means that the writable layer is as small as possible.<br><br>When an existing file <span class="hljs-keyword">in</span> a container is modified, the storage driver performs a <span class="hljs-built_in">copy-on</span><span class="hljs-literal">-write</span> operation. The specifics steps involved depend on the specific storage driver. <span class="hljs-keyword">For</span> the aufs, overlay, and overlay2 drivers, the <span class="hljs-built_in">copy-on</span><span class="hljs-literal">-write</span> operation follows this rough sequence:<br><br>Search through the image layers <span class="hljs-keyword">for</span> the file to update. The <span class="hljs-keyword">process</span> starts at the newest layer and works down to the base layer one layer at a time. When results are found, they are added to a cache to speed future operations.<br><br>Perform a copy_up operation on the first copy of the file that is found, to copy the file to the container’s writable layer.<br><br>Any modifications are made to this copy of the file, and the container cannot see the <span class="hljs-built_in">read-only</span> copy of the file that exists <span class="hljs-keyword">in</span> the lower layer.<br><br>Btrfs, ZFS, and other drivers handle the <span class="hljs-built_in">copy-on</span><span class="hljs-literal">-write</span> differently. You can read more about the methods of these drivers later <span class="hljs-keyword">in</span> their detailed descriptions.<br><br>Containers that write a lot of <span class="hljs-keyword">data</span> consume more space than containers that <span class="hljs-keyword">do</span> not. This is because most write operations consume new space <span class="hljs-keyword">in</span> the container’s thin writable top layer.<br></code></pre></td></tr></table></figure>
<p><strong>简单的说，启动容器的时候，最上层容器层是可写层，之下的都是镜像层，只读层。</strong></p>
<h3 id="当容器需要读取文件的时候"><strong>当容器需要读取文件的时候</strong></h3>
<p><strong>从最上层镜像开始查找，往下找，找到文件后读取并放入内存，若已经在内存中了，直接使用。(即，同一台机器上运行的docker容器共享运行时相同的文件)。</strong></p>
<h3 id="当容器需要添加文件的时候"><strong>当容器需要添加文件的时候</strong></h3>
<p><strong>直接在最上面的容器层可写层添加文件，不会影响镜像层。</strong></p>
<h3 id="当容器需要修改文件的时候"><strong>当容器需要修改文件的时候</strong></h3>
<p><strong>从上往下层寻找文件，找到后，复制到容器可写层，然后，对容器来说，可以看到的是容器层的这个文件，看不到镜像层里的文件。容器在容器层修改这个文件。</strong></p>
<h3 id="当容器需要删除文件的时候"><strong>当容器需要删除文件的时候</strong></h3>
<p><strong>从上往下层寻找文件，找到后在容器中记录删除。即，并不会真正的删除文件，而是软删除。这将导致镜像体积只会增加，不会减少。</strong></p>
<p><strong>综上，Docker镜像通过分层实现了资源共享，通过copy-on-write实现了文件隔离。</strong></p>
<p><strong>对于文件只增加不减少问题，我们应当在同一层做增删操作，从而减少镜像体积。比如，如下测试。</strong></p>
<hr>
<p><strong>Dockerfile.A: 分层删除文件</strong>**</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">FROM centos:<span class="hljs-number">7</span><br>RUN yum install <span class="hljs-literal">-y</span> vim<br>RUN yum install <span class="hljs-literal">-y</span> httpd<br>WORKDIR /home<br>RUN dd <span class="hljs-keyword">if</span>=/dev/zero of=<span class="hljs-number">50</span>M.file bs=<span class="hljs-number">1</span>M count=<span class="hljs-number">50</span><br><span class="hljs-comment">#创建大小为50M的测试文件</span><br>RUN rm <span class="hljs-literal">-rf</span> <span class="hljs-number">50</span>M.file<br>CMD [<span class="hljs-string"><code class="language-hljs powershell">FROM centos:<span class="hljs-number">7</span><br>RUN yum install <span class="hljs-literal">-y</span> vim<br>RUN yum install <span class="hljs-literal">-y</span> httpd<br>WORKDIR /home<br>RUN dd <span class="hljs-keyword">if</span>=/dev/zero of=<span class="hljs-number">50</span>M.file bs=<span class="hljs-number">1</span>M count=<span class="hljs-number">50</span><br><span class="hljs-comment">#创建大小为50M的测试文件</span><br>RUN rm <span class="hljs-literal">-rf</span> <span class="hljs-number">50</span>M.file<br>CMD [<span class="hljs-string">"/bin/bash"</span>]<br></code></pre></td></tr></table></figure>
<h4 id="构建"><strong>构建</strong></h4>
<p><strong><code>docker build -t test:a -f Dockerfile.A .</code></strong><br>
<strong>Dockerfile.B: 同层删除</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">FROM centos:<span class="hljs-number">7</span><br>RUN yum install <span class="hljs-literal">-y</span> vim<br>RUN yum install <span class="hljs-literal">-y</span> httpd<br>WORKDIR /home<br>RUN dd <span class="hljs-keyword">if</span>=/dev/zero of=<span class="hljs-number">50</span>M.file bs=<span class="hljs-number">1</span>M count=<span class="hljs-number">50</span> &amp;&amp; rm <span class="hljs-literal">-rf</span> <span class="hljs-number"><code class="language-hljs powershell">FROM centos:<span class="hljs-number">7</span><br>RUN yum install <span class="hljs-literal">-y</span> vim<br>RUN yum install <span class="hljs-literal">-y</span> httpd<br>WORKDIR /home<br>RUN dd <span class="hljs-keyword">if</span>=/dev/zero of=<span class="hljs-number">50</span>M.file bs=<span class="hljs-number">1</span>M count=<span class="hljs-number">50</span> &amp;&amp; rm <span class="hljs-literal">-rf</span> <span class="hljs-number">50</span>M.file<br></code></pre></td></tr></table></figure>
<h4 id="构建-2"><strong>构建</strong></h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">docker build <span class="hljs-literal">-t</span> test:b <span class="hljs-operator"><code class="language-hljs powershell">docker build <span class="hljs-literal">-t</span> test:b <span class="hljs-operator">-f</span> Dockerfile.B .<br></code></pre></td></tr></table></figure>
<h4 id="比较二者大小"><strong>比较二者大小</strong></h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">sh</span>-<span class="hljs-type">k8s</span>-<span class="hljs-number">001</span> <span class="hljs-type">tmp</span>]<span class="hljs-comment"># docker images | grep test</span><br>test                                                                     a                          ae673aa7db48        <span class="hljs-number">9</span> minutes ago       <span class="hljs-number">497</span>MB<br>test                                                                     b                          <span class="hljs-number">21</span>b2bc49f0bd        <span class="hljs-number">12</span> minutes ago      <span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">sh</span>-<span class="hljs-type">k8s</span>-<span class="hljs-number">001</span> <span class="hljs-type">tmp</span>]<span class="hljs-comment"># docker images | grep test</span><br>test                                                                     a                          ae673aa7db48        <span class="hljs-number">9</span> minutes ago       <span class="hljs-number">497</span>MB<br>test                                                                     b                          <span class="hljs-number">21</span>b2bc49f0bd        <span class="hljs-number">12</span> minutes ago      <span class="hljs-number">444</span>MB<br></code></pre></td></tr></table></figure>
<p><strong>显然，分层删除操作并没有真正删除掉文件。</strong></p>
<p><strong>来源</strong><br>
**链接：**<a href="https://www.cnblogs.com/woshimrf/p/docker-container-lawyer.html" target="_blank" rel="noopener">https://www.cnblogs.com/woshimrf/p/docker-container-lawyer.html</a><br>
<a href="https://www.cnblogs.com/CloudMan6/p/6799197.html" target="_blank" rel="noopener">https://www.cnblogs.com/CloudMan6/p/6799197.html</a><br>
<a href="https://www.cnblogs.com/CloudMan6/p/6806193.html" target="_blank" rel="noopener">https://www.cnblogs.com/CloudMan6/p/6806193.html</a><br>
<a href="https://docs.docker.com/storage/storagedriver/" target="_blank" rel="noopener">https://docs.docker.com/storage/storagedriver/</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wu Shao Dong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="/wsdlxgp.top/2019/08/06/06%20%E7%90%86%E8%A7%A3Docker%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82/">wsdlxgp.top/2019/08/06/06%20%E7%90%86%E8%A7%A3Docker%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="wsdlxgp.top" target="_blank">Xgp & Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/bash/">bash</a></div><div class="post_share"><div class="social-share" data-image="http://xgp-cunchu.test.upcdn.net/k8s/325738.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/3.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/1.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/2.jpg" alt="QQ支付"/><div class="post-qr-code__desc">QQ支付</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/08/07/07%20Dockerfile%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/"><img class="prev_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq117p.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Dockerfile常用指令</div></div></a></div><div class="next-post pull_right"><a href="/2019/08/05/05%20Dockers%E9%95%9C%E5%83%8F%E5%88%86%E5%B1%82/"><img class="next_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq124p.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dockers镜像分层</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM0NS8yNTgzNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq118p.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Wu Shao Dong</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="ypy"><a href="https://console.upyun.com/services/file/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/1591433700(1).png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>