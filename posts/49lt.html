<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Xtrabackup备份还原 | Xgp &amp; Blog</title><meta name="description" content="一、Xtrabackup介绍 MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工"><meta name="keywords" content="MySQL优化"><meta name="author" content="Wu Shao Dong"><meta name="copyright" content="Wu Shao Dong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://gitee.com/xgpqq/tuchuang/raw/master/img/Yun.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="rPK0WSwqdm"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Xtrabackup备份还原"><meta name="twitter:description" content="一、Xtrabackup介绍 MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工"><meta name="twitter:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq2p.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Xtrabackup备份还原"><meta property="og:url" content="https://wsdlxgp.top/posts/49lt.html"><meta property="og:site_name" content="Xgp &amp; Blog"><meta property="og:description" content="一、Xtrabackup介绍 MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工"><meta property="og:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq2p.jpg"><meta property="article:published_time" content="2020-06-24T16:02:00.000Z"><meta property="article:modified_time" content="2020-07-01T03:24:01.795Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://wsdlxgp.top/posts/49lt.html"><link rel="prev" title="nnobackupex全库备份+innobackupex增量备份" href="https://wsdlxgp.top/posts/49er.html"><link rel="next" title="mysqldump备份还原" href="https://wsdlxgp.top/posts/49et.html"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cad0cd04042fcca2c687648c42a45fc9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: Wu Shao Dong","link":"链接: ","source":"来源: Xgp & Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/self/Kimbiedark.css"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Xgp & Blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/666.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">132</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">76</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">1.</span> <span class="toc-text">一、Xtrabackup介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、Xtrabackup优点"><span class="toc-number">1.1.</span> <span class="toc-text">1、Xtrabackup优点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Xtrabackup备份原理"><span class="toc-number">1.2.</span> <span class="toc-text">2、Xtrabackup备份原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、xtrabackup的安装部署以及备份恢复实现"><span class="toc-number">1.3.</span> <span class="toc-text">3、xtrabackup的安装部署以及备份恢复实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）下载xtrabackup"><span class="toc-number">1.3.1.</span> <span class="toc-text">（1）下载xtrabackup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）解压"><span class="toc-number">1.3.2.</span> <span class="toc-text">（2）解压</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）进入解压目录"><span class="toc-number">1.3.3.</span> <span class="toc-text">（3）进入解压目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（4）复制bin下的所有程序到-usr-bin"><span class="toc-number">1.3.4.</span> <span class="toc-text">（4）复制bin下的所有程序到&#x2F;usr&#x2F;bin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Xtrabackup中主要包含两个工具："><span class="toc-number">1.3.5.</span> <span class="toc-text">Xtrabackup中主要包含两个工具：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装相关插件"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">安装相关插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#常用选项"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">常用选项:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户："><span class="toc-number">1.3.5.3.</span> <span class="toc-text">如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（5）下载percona-toolkit并安装"><span class="toc-number">1.3.6.</span> <span class="toc-text">（5）下载percona-toolkit并安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">2.</span> <span class="toc-text">二、xtrabackup全量备份与恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#命令语法格式"><span class="toc-number">2.0.0.0.1.</span> <span class="toc-text">命令语法格式</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1、准备-prepare-一个完全备份"><span class="toc-number">2.1.</span> <span class="toc-text">1、准备(prepare)一个完全备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、从一个完全备份中恢复数据"><span class="toc-number">2.2.</span> <span class="toc-text">2、从一个完全备份中恢复数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、实战练习"><span class="toc-number">2.3.</span> <span class="toc-text">3、实战练习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）全量备份"><span class="toc-number">2.3.1.</span> <span class="toc-text">（1）全量备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）恢复"><span class="toc-number">2.3.2.</span> <span class="toc-text">（2）恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#总结全库备份与恢复三步曲："><span class="toc-number">2.3.2.1.</span> <span class="toc-text">总结全库备份与恢复三步曲：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">3.</span> <span class="toc-text">三、xtrabackup增量备份与恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、增量备份演示"><span class="toc-number">3.1.</span> <span class="toc-text">1、增量备份演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、使用innobackupex进行增量备份"><span class="toc-number">3.2.</span> <span class="toc-text">2、使用innobackupex进行增量备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、增量备份后数据恢复演示"><span class="toc-number">3.3.</span> <span class="toc-text">3、增量备份后数据恢复演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）模拟mysql故障，删除数据目录所有数据"><span class="toc-number">3.3.1.</span> <span class="toc-text">（1）模拟mysql故障，删除数据目录所有数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）合并全备数据目录，确保数据的一致性"><span class="toc-number">3.3.2.</span> <span class="toc-text">（2）合并全备数据目录，确保数据的一致性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）将增量备份数据合并到全备数据目录当中"><span class="toc-number">3.3.3.</span> <span class="toc-text">（3）将增量备份数据合并到全备数据目录当中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（4）恢复数据"><span class="toc-number">3.3.4.</span> <span class="toc-text">（4）恢复数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结："><span class="toc-number">3.3.5.</span> <span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方案一：xtrabackup完全备份-binlog增量备份"><span class="toc-number">3.4.</span> <span class="toc-text">方案一：xtrabackup完全备份+binlog增量备份</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1、备份-创建备份目录"><span class="toc-number">3.5.</span> <span class="toc-text">1、备份 创建备份目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）完全备份"><span class="toc-number">3.5.1.</span> <span class="toc-text">（1）完全备份</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#各文件说明："><span class="toc-number">3.5.1.1.</span> <span class="toc-text">各文件说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模拟数据库修改："><span class="toc-number">3.5.1.2.</span> <span class="toc-text">模拟数据库修改：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）增量备份二进制文件："><span class="toc-number">3.5.2.</span> <span class="toc-text">（2）增量备份二进制文件：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、还原数据库：-模拟数据库损坏：-我这里直接使用删除数据目录文件来模拟损坏"><span class="toc-number">3.6.</span> <span class="toc-text">2、还原数据库： 模拟数据库损坏： 我这里直接使用删除数据目录文件来模拟损坏</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#还原完全备份："><span class="toc-number">3.6.1.</span> <span class="toc-text">还原完全备份：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）准备-prepare-一个完全备份"><span class="toc-number">3.6.2.</span> <span class="toc-text">（1）准备(prepare)一个完全备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）还原数据库语法："><span class="toc-number">3.6.3.</span> <span class="toc-text">（2）还原数据库语法：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改还原后的数据目录权限"><span class="toc-number">3.6.3.1.</span> <span class="toc-text">修改还原后的数据目录权限:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）还原增量备份：-为了防止还原时产生大量的二进制日志，在还原时可临时关闭二进制日志后再还原："><span class="toc-number">3.6.4.</span> <span class="toc-text">（3）还原增量备份： 为了防止还原时产生大量的二进制日志，在还原时可临时关闭二进制日志后再还原：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">4.</span> <span class="toc-text">方案二、xtrabackup完全备份+xtrabacup增量备份</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、-xtrabacup进行备份-执行完全备份：-备份命令："><span class="toc-number">4.1.</span> <span class="toc-text">1、 xtrabacup进行备份 执行完全备份： 备份命令：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#部分显示信息如下所示："><span class="toc-number">4.1.0.1.</span> <span class="toc-text">部分显示信息如下所示：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、-xtrabacup进行增量恢复-为了验证比对，先删除两个增量备份前表里面的数据"><span class="toc-number">4.2.</span> <span class="toc-text">2、 xtrabacup进行增量恢复 为了验证比对，先删除两个增量备份前表里面的数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#完整备份恢复："><span class="toc-number">4.2.0.1.</span> <span class="toc-text">**完整备份恢复： **</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#恢复到第一次增量的时刻"><span class="toc-number">4.2.0.2.</span> <span class="toc-text">**恢复到第一次增量的时刻 **</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#恢复到第二次增量备份前面：-恢复命令"><span class="toc-number">4.2.0.3.</span> <span class="toc-text">恢复到第二次增量备份前面： 恢复命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#恢复整个库-恢复命令："><span class="toc-number">4.2.0.4.</span> <span class="toc-text">恢复整个库 恢复命令：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#然后停止mysql数据库："><span class="toc-number">4.2.0.5.</span> <span class="toc-text">然后停止mysql数据库：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#开始rsync数据文件："><span class="toc-number">4.2.0.6.</span> <span class="toc-text">开始rsync数据文件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动mysql服务："><span class="toc-number">4.2.0.7.</span> <span class="toc-text">启动mysql服务：</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq2p.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Xgp &amp; Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Xtrabackup备份还原</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-06-25 00:02:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-06-25</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-01 11:24:01"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-01</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/mysql/">mysql</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon far fa-file-word" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">11.4k</span><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-clock" aria-hidden="true"></i><span>阅读时长: 49 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1>一、Xtrabackup介绍</h1>
<p><strong>MySQL冷备、mysqldump、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而Percona-Xtrabackup就是为了实现增量备份而出现的一款主流备份工具，xtrabakackup有2个工具，分别是xtrabakup、innobakupe。</strong></p>
<p><strong>Percona-xtrabackup是 Percona公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。</strong></p>
<h2 id="1、Xtrabackup优点">1、Xtrabackup优点</h2>
<p><strong>（1）备份速度快，物理备份可靠</strong></p>
<p><strong>（2）备份过程不会打断正在执行的事务（无需锁表）</strong></p>
<p><strong>（3）能够基于压缩等功能节约磁盘空间和流量</strong></p>
<p><strong>（4）自动备份校验</strong></p>
<p><strong>（5）还原速度快</strong></p>
<p><strong>（6）可以流传将备份传输到另外一台机器上</strong></p>
<p><strong>（7）在不增加服务器负载的情况备份数据</strong></p>
<h2 id="2、Xtrabackup备份原理">2、Xtrabackup备份原理</h2>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200627212311123.png" alt="image-20200627212311123"></p>
<p><strong>（1）innobackupex启动后，会先fork一个进程，用于启动xtrabackup，然后等待xtrabackup备份ibd数据文件；</strong></p>
<p><strong>（2）xtrabackup在备份innoDB数据是，有2种线程：redo拷贝线程和ibd数据拷贝线程。xtrabackup进程开始执行后，会启动一个redo拷贝的线程，用于从最新的checkpoint点开始顺序拷贝redo.log；再启动ibd数据拷贝线程，进行拷贝ibd数据。这里是先启动redo拷贝线程的。在此阶段，innobackupex进行处于等待状态（等待文件被创建）</strong></p>
<p><strong>（4）xtrabackup拷贝完成ibd数据文件后，会通知innobackupex（通过创建文件），同时xtrabackup进入等待状态（redo线程依旧在拷贝redo.log）</strong></p>
<p><strong>（5）innobackupex收到xtrabackup通知后哦，执行FLUSH TABLES WITH READ LOCK（FTWRL），取得一致性位点，然后开始备份非InnoDB文件（如frm、MYD、MYI、CSV、opt、par等格式的文件），在拷贝非InnoDB文件的过程当中，数据库处于全局只读状态。</strong></p>
<p><strong>（6）当innobackup拷贝完所有的非InnoDB文件后，会通知xtrabackup，通知完成后，进入等待状态；</strong></p>
<p><strong>（7）xtrabackup收到innobackupex备份完成的通知后，会停止redo拷贝线程，然后通知innobackupex，redo.log文件拷贝完成；</strong></p>
<p><strong>（8）innobackupex收到redo.log备份完成后，就进行解锁操作，执行：UNLOCK TABLES；</strong></p>
<p><strong>（9）最后innbackupex和xtrabackup进程各自释放资源，写备份元数据信息等，innobackupex等xtrabackup子进程结束后退出。</strong></p>
<h2 id="3、xtrabackup的安装部署以及备份恢复实现">3、xtrabackup的安装部署以及备份恢复实现</h2>
<h3 id="（1）下载xtrabackup">（1）下载xtrabackup</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">wget https://www.percona.com/downloads/XtraBackup/Percona<span class="hljs-literal">-XtraBackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span>/binary/tarball/percona<span class="hljs-literal">-xtrabackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span><span class="hljs-literal">-Linux</span><span class="hljs-literal"><code class="language-hljs powershell">wget https://www.percona.com/downloads/XtraBackup/Percona<span class="hljs-literal">-XtraBackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span>/binary/tarball/percona<span class="hljs-literal">-xtrabackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span><span class="hljs-literal">-Linux</span><span class="hljs-literal">-x86_64</span>.tar.gz<br></code></pre></td></tr></table></figure>
<h3 id="（2）解压">（2）解压</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">tar zxf percona<span class="hljs-literal">-xtrabackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span><span class="hljs-literal">-Linux</span><span class="hljs-literal"><code class="language-hljs powershell">tar zxf percona<span class="hljs-literal">-xtrabackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span><span class="hljs-literal">-Linux</span><span class="hljs-literal">-x86_64</span>.tar.gz<br></code></pre></td></tr></table></figure>
<h3 id="（3）进入解压目录">（3）进入解压目录</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">cd percona<span class="hljs-literal">-xtrabackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span><span class="hljs-literal">-Linux</span><span class="hljs-literal"><code class="language-hljs powershell">cd percona<span class="hljs-literal">-xtrabackup</span><span class="hljs-literal">-2</span>.<span class="hljs-number">4.4</span><span class="hljs-literal">-Linux</span><span class="hljs-literal">-x86_64</span>/<br></code></pre></td></tr></table></figure>
<h3 id="（4）复制bin下的所有程序到-usr-bin">（4）复制bin下的所有程序到/usr/bin</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">percona</span>-<span class="hljs-type">xtrabackup</span>-<span class="hljs-number">2.4</span><span class="hljs-type">.4</span>-<span class="hljs-type">Linux</span>-<span class="hljs-type">x86_64</span>]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">percona</span>-<span class="hljs-type">xtrabackup</span>-<span class="hljs-number">2.4</span><span class="hljs-type">.4</span>-<span class="hljs-type">Linux</span>-<span class="hljs-type">x86_64</span>]<span class="hljs-comment"># cp bin/* /usr/bin/</span><br></code></pre></td></tr></table></figure>
<h3 id="Xtrabackup中主要包含两个工具：">Xtrabackup中主要包含两个工具：</h3>
<ul>
<li><strong><code>xtrabackup</code>：是用于热备份innodb, xtradb表中数据的工具，支持在线热备份，可以在不加锁的情况下备份Innodb数据表，不过此工具不能操作Myisam引擎表；</strong></li>
<li><strong><code>innobackupex</code>：是将xtrabackup进行封装的perl脚本，能同时处理Innodb和Myisam，但在处理Myisam时需要加一个读锁。 由于操作Myisam时需要加读锁，这会堵塞线上服务的写操作，而Innodb没有这样的限制，所以数据库中Innodb表类型所占的比例越大，则越有利。</strong></li>
</ul>
<h4 id="安装相关插件">安装相关插件</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment">#yum install perl-DBI perl-DBD-MySQL perl-Time-HiRes perl-IO-Socket-SSL perl-TermReadKey.x86_64 perl-Digest-MD5 –y</span><br></code></pre></td></tr></table></figure>
<h4 id="常用选项">常用选项:</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">-<span class="hljs-literal">-host</span>     指定主机<br>-<span class="hljs-literal">-user</span>     指定用户名<br>-<span class="hljs-literal">-password</span>    指定密码<br>-<span class="hljs-literal">-port</span>     指定端口<br>-<span class="hljs-literal">-databases</span>     指定数据库<br><br>-<span class="hljs-literal">-incremental</span>    创建增量备份<br>-<span class="hljs-literal">-incremental</span><span class="hljs-literal">-basedir</span>   指定包含完全备份的目录<br>-<span class="hljs-literal">-incremental</span><span class="hljs-literal">-dir</span>      指定包含增量备份的目录  <br><br>-<span class="hljs-literal">-apply</span><span class="hljs-literal">-log</span>        对备份进行预处理操作             <br>  一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使得数据文件处于一致性状态。<br>-<span class="hljs-literal">-redo</span><span class="hljs-literal">-only</span>      不回滚未提交事务<br>-<span class="hljs-literal">-copy</span><span class="hljs-literal"><code class="language-hljs powershell">-<span class="hljs-literal">-host</span>     指定主机<br>-<span class="hljs-literal">-user</span>     指定用户名<br>-<span class="hljs-literal">-password</span>    指定密码<br>-<span class="hljs-literal">-port</span>     指定端口<br>-<span class="hljs-literal">-databases</span>     指定数据库<br><br>-<span class="hljs-literal">-incremental</span>    创建增量备份<br>-<span class="hljs-literal">-incremental</span><span class="hljs-literal">-basedir</span>   指定包含完全备份的目录<br>-<span class="hljs-literal">-incremental</span><span class="hljs-literal">-dir</span>      指定包含增量备份的目录  <br><br>-<span class="hljs-literal">-apply</span><span class="hljs-literal">-log</span>        对备份进行预处理操作             <br>  一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使得数据文件处于一致性状态。<br>-<span class="hljs-literal">-redo</span><span class="hljs-literal">-only</span>      不回滚未提交事务<br>-<span class="hljs-literal">-copy</span><span class="hljs-literal">-back</span>     恢复备份目录<br></code></pre></td></tr></table></figure>
<p><strong>使用innobackupex备份时，其会调用xtrabackup备份所有的InnoDB表，复制所有关于表结构定义的相关文件(.frm)、以及MyISAM、MERGE、CSV和ARCHIVE表的相关文件，同时还会备份触发器和数据库配置信息相关的文件，这些文件会被保存到一个以时间命名的目录当中。在备份的同时，innobackupex还会在备份目录中创建如下文件：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">(<span class="hljs-number">1</span>)xtrabackup_checkpoints -- 备份类型(如完全或增量)、备份状态(如是否已经为prepared状态)和LSN(日志序列号)范围信息：<br><br>每个InnoDB页(通常为<span class="hljs-number">16</span>k大小)<br>都会包含一个日志序列号，即LSN，LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的。<br><br>(<span class="hljs-number">2</span>)xtrabackup_binlog_info  --  mysql服务器当前正在使用的二进制日志文件及备份这一刻位置二进制日志时间的位置。<br><br>(<span class="hljs-number">3</span>)xtrabackup_binlog_pos_innodb  --  二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当前position。<br><br>(<span class="hljs-number">4</span>)xtrabackup_binary  --  备份中用到的xtrabackup的可执行文件；<br><br>(<span class="hljs-number">5</span>)<span class="hljs-built_in">backup-my</span>.cnf  --  备份命令用到的配置选项信息：<br><br>在使用innobackupex进行备份时，还可以使用-<span class="hljs-literal">-no</span><span class="hljs-literal">-timestamp</span>选项来阻止命令自动创建一个以时间命名的目录：如此一来，innobackupex命令将会创建一个<span class="hljs-built_in"><code class="language-hljs powershell">(<span class="hljs-number">1</span>)xtrabackup_checkpoints -- 备份类型(如完全或增量)、备份状态(如是否已经为prepared状态)和LSN(日志序列号)范围信息：<br><br>每个InnoDB页(通常为<span class="hljs-number">16</span>k大小)<br>都会包含一个日志序列号，即LSN，LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的。<br><br>(<span class="hljs-number">2</span>)xtrabackup_binlog_info  --  mysql服务器当前正在使用的二进制日志文件及备份这一刻位置二进制日志时间的位置。<br><br>(<span class="hljs-number">3</span>)xtrabackup_binlog_pos_innodb  --  二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当前position。<br><br>(<span class="hljs-number">4</span>)xtrabackup_binary  --  备份中用到的xtrabackup的可执行文件；<br><br>(<span class="hljs-number">5</span>)<span class="hljs-built_in">backup-my</span>.cnf  --  备份命令用到的配置选项信息：<br><br>在使用innobackupex进行备份时，还可以使用-<span class="hljs-literal">-no</span><span class="hljs-literal">-timestamp</span>选项来阻止命令自动创建一个以时间命名的目录：如此一来，innobackupex命令将会创建一个<span class="hljs-built_in">BACKUP-DIR</span>目录来存储备份数据。<br></code></pre></td></tr></table></figure>
<h4 id="如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：">如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">mysql&gt; CREATE USER <span class="hljs-string">'bkpuser'</span><span class="hljs-string">@'localhost' IDENTIFIED BY '123456';　　</span><br><span class="hljs-string">#创建用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM 'bkpuser';　　</span><br><span class="hljs-string">#回收此用户所有权限</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; GRANT RELOAD,LOCK TABLES,RELICATION CLIENT ON *.* TO 'bkpuser'@'localhost';　　</span><br><span class="hljs-string">#授权刷新、锁定表、用户查看服务器状态</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; FLUSH PRIVILEGES;　　</span><br><span class="hljs-string"><code class="language-hljs powershell">mysql&gt; CREATE USER <span class="hljs-string">'bkpuser'</span><span class="hljs-string">@'localhost' IDENTIFIED BY '123456';　　</span><br><span class="hljs-string">#创建用户</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; REVOKE ALL PRIVILEGES,GRANT OPTION FROM 'bkpuser';　　</span><br><span class="hljs-string">#回收此用户所有权限</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; GRANT RELOAD,LOCK TABLES,RELICATION CLIENT ON *.* TO 'bkpuser'@'localhost';　　</span><br><span class="hljs-string">#授权刷新、锁定表、用户查看服务器状态</span><br><span class="hljs-string"></span><br><span class="hljs-string">mysql&gt; FLUSH PRIVILEGES;　　</span><br><span class="hljs-string">#刷新授权表</span><br></code></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs text"><code class="language-hljs text">注意：备份时需启动MySQL,恢复时需关闭MySQL,清空mysql数据目录且不能重新初始化,恢复数据后应该立即进行一次完全备份<br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="（5）下载percona-toolkit并安装">（5）下载percona-toolkit并安装</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment">#wget https://www.percona.com/downloads/percona-toolkit/2.2.19/RPM/perconatoolkit-2.2.19-1.noarch.rpm</span><br><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment">#wget https://www.percona.com/downloads/percona-toolkit/2.2.19/RPM/perconatoolkit-2.2.19-1.noarch.rpm</span><br><span class="hljs-comment"># rpm -vih percona-toolkit-2.2.19-1.noarch.rpm</span><br></code></pre></td></tr></table></figure>
<p><strong>下面就可以启动备份了</strong></p>
<h1>二、xtrabackup全量备份与恢复</h1>
<h5 id="命令语法格式">命令语法格式</h5>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">备份：<br>innobackupex -<span class="hljs-literal">-user</span>=DBUSER -<span class="hljs-literal">-password</span>=DBUSERPASS -<span class="hljs-literal">-defaults</span><span class="hljs-operator">-file</span>=/etc/my.cnf /path/to/<span class="hljs-built_in">BACKUP-DIR</span>/<br><br>恢复：<br>innobackupex -<span class="hljs-literal">-apply</span><span class="hljs-literal">-log</span> /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-04</span><span class="hljs-literal">-55</span>/<br>innobackupex -<span class="hljs-literal">-copy</span><span class="hljs-literal">-back</span> -<span class="hljs-literal">-defaults</span><span class="hljs-operator">-file</span>=/etc/my.cnf  /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-04</span><span class="hljs-literal"><code class="language-hljs powershell">备份：<br>innobackupex -<span class="hljs-literal">-user</span>=DBUSER -<span class="hljs-literal">-password</span>=DBUSERPASS -<span class="hljs-literal">-defaults</span><span class="hljs-operator">-file</span>=/etc/my.cnf /path/to/<span class="hljs-built_in">BACKUP-DIR</span>/<br><br>恢复：<br>innobackupex -<span class="hljs-literal">-apply</span><span class="hljs-literal">-log</span> /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-04</span><span class="hljs-literal">-55</span>/<br>innobackupex -<span class="hljs-literal">-copy</span><span class="hljs-literal">-back</span> -<span class="hljs-literal">-defaults</span><span class="hljs-operator">-file</span>=/etc/my.cnf  /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-04</span><span class="hljs-literal">-55</span>/<br></code></pre></td></tr></table></figure>
<h2 id="1、准备-prepare-一个完全备份">1、准备(prepare)一个完全备份</h2>
<p><strong>一般情况下，在备份完成后，数据尚且不能用于恢复操作，因为备份的数据中可能会包含尚未提交的事务或者已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处于不一致状态。&quot;准备&quot;的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使用得数据文件处于一致性状态。</strong></p>
<p><strong>innobackupex命令的–apply-log选项可用于实现上述功能，如下面的命令：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"># innobackupex --apply-log /path/to/BACKUP-DIR</span><br>如果执行正确，其最后输出的几行信息通常如下：<br><br><span class="hljs-number">120407</span> <span class="hljs-number">09</span>:<span class="hljs-number">01</span>:<span class="hljs-number"><code class="language-hljs powershell"><span class="hljs-comment"># innobackupex --apply-log /path/to/BACKUP-DIR</span><br>如果执行正确，其最后输出的几行信息通常如下：<br><br><span class="hljs-number">120407</span> <span class="hljs-number">09</span>:<span class="hljs-number">01</span>:<span class="hljs-number">04</span> innobackupex: completed OK!<br></code></pre></td></tr></table></figure>
<p><strong>在实现&quot;准备&quot;的过程中，innobackupex通常还可以使用–user-memory选项来指定其可以使用的内存的大小，默认为100M.如果有足够的内存空间可用，可以多划分一些内存给prepare的过程，以提高其完成备份的速度。</strong></p>
<h2 id="2、从一个完全备份中恢复数据">2、从一个完全备份中恢复数据</h2>
<p><em><strong>注意：恢复不用启动MySQL</strong></em></p>
<p><strong>innobackupex命令的–copy-back选项用于恢复操作，其通过复制所有数据相关的文件至mysql服务器DATADIR目录中来执行恢复过程。innobackupex通过backup-my.cnf来获取DATADIR目录的相关信息。</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># innobackupex --copy-back /path/to/BACKUP-DIR</span><br></code></pre></td></tr></table></figure>
<p><strong>当数据恢复至DATADIR目录以后，还需要确保所有的数据文件的属主和属组均为正确的用户，如mysql，否则，在启动mysqld之前还需要事先修改数据文件的属主和属组。如：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># chown -R mysql.mysql /mydata/data/</span><br></code></pre></td></tr></table></figure>
<h2 id="3、实战练习">3、实战练习</h2>
<h3 id="（1）全量备份">（1）全量备份</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># innobackupex --user=root --password=123 --host=127.0.0.1 /backups/　　</span><br><span class="hljs-comment">#在master上进行全库备份#语法解释说明：</span><br><span class="hljs-comment">#--user=root 指定备份用户</span><br><span class="hljs-comment">#--password=123456  指定备份用户密码</span><br><span class="hljs-comment">#--host　　指定主机</span><br><span class="hljs-comment">#/backups　　指定备份目录</span><br><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># ll</span><br>total <span class="hljs-number">0</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">7</span> root root <span class="hljs-number">232</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> <span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># ll 2018-07-30_11-01-37/　　</span><br><span class="hljs-comment">#查看备份数据</span><br>total <span class="hljs-number">77856</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">418</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> <span class="hljs-built_in">backup-my</span>.cnf　　<br><span class="hljs-comment">#备份用到的配置选项信息文件</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">79691776</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> ibdata1　　<br><span class="hljs-comment">#数据文件</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> kim<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> repppp<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> wordpress<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root       <span class="hljs-number">21</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_binlog_info　　<br><span class="hljs-comment">#mysql服务器当前正在使用的二进制日志文件和此时二进制日志时间的位置信息文件</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">113</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_checkpoints　　<br><span class="hljs-comment">#备份的类型、状态和LSN状态信息文件</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">482</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_info<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root     <span class="hljs-number">2560</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_logfile　　　　<br><span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># innobackupex --user=root --password=123 --host=127.0.0.1 /backups/　　</span><br><span class="hljs-comment">#在master上进行全库备份#语法解释说明：</span><br><span class="hljs-comment">#--user=root 指定备份用户</span><br><span class="hljs-comment">#--password=123456  指定备份用户密码</span><br><span class="hljs-comment">#--host　　指定主机</span><br><span class="hljs-comment">#/backups　　指定备份目录</span><br><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># ll</span><br>total <span class="hljs-number">0</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">7</span> root root <span class="hljs-number">232</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> <span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># ll 2018-07-30_11-01-37/　　</span><br><span class="hljs-comment">#查看备份数据</span><br>total <span class="hljs-number">77856</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">418</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> <span class="hljs-built_in">backup-my</span>.cnf　　<br><span class="hljs-comment">#备份用到的配置选项信息文件</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">79691776</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> ibdata1　　<br><span class="hljs-comment">#数据文件</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> kim<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> repppp<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> wordpress<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root       <span class="hljs-number">21</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_binlog_info　　<br><span class="hljs-comment">#mysql服务器当前正在使用的二进制日志文件和此时二进制日志时间的位置信息文件</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">113</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_checkpoints　　<br><span class="hljs-comment">#备份的类型、状态和LSN状态信息文件</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">482</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_info<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root     <span class="hljs-number">2560</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> xtrabackup_logfile　　　　<br><span class="hljs-comment">#备份的日志文件</span><br></code></pre></td></tr></table></figure>
<h3 id="（2）恢复">（2）恢复</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld stop　　#停止slave上的mysql</span><br>Shutting down MySQL.. SUCCESS! <br><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> <span class="hljs-type">tools</span>]<span class="hljs-comment"># yum install -y percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm 　　#安装xtrabackup</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># scp -r 2018-07-30_11-01-37/ root@192.168.56.12:/backups/　　 #从master上拷贝备份数据</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> <span class="hljs-type">tools</span>]<span class="hljs-comment"># innobackupex --apply-log /backups/2018-07-30_11-01-37/　　　　　 #合并数据，使数据文件处于一致性的状态</span><br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">18</span>:<span class="hljs-number">23</span> innobackupex: Starting the apply<span class="hljs-literal">-log</span> operation<br><br>IMPORTANT: Please check that the apply<span class="hljs-literal">-log</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful apply<span class="hljs-literal">-log</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br><br>innobackupex version <span class="hljs-number">2.4</span>.<span class="hljs-number">9</span> based on MySQL server <span class="hljs-number">5.7</span>.<span class="hljs-number">13</span> Linux (x86_64) (revision id: a467167cdd4)<br>xtrabackup: cd to /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span>/<br>xtrabackup: This target seems to be not prepared yet.<br>InnoDB: Number of pools: <span class="hljs-number">1</span><br>xtrabackup: xtrabackup_logfile detected: size=<span class="hljs-number">8388608</span>, start_lsn=(<span class="hljs-number">3127097</span>)<br>......<br>InnoDB: FTS optimize thread exiting.<br>InnoDB: Starting shutdown...<br>InnoDB: Shutdown completed; log sequence number <span class="hljs-number">3129915</span><br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">18</span>:<span class="hljs-number">30</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># rm -rf /usr/local/mysql/data/　　#在slave上删除原有的数据</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># vim /etc/my.cnf　　#配置my.cnf的数据目录路径，否则会报错，要和master一致</span><br>datadir=/usr/local/mysql/<span class="hljs-keyword">data</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># innobackupex --copy-back /backups/2018-07-30_11-01-37/　　#在slave上数据恢复</span><br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span>:<span class="hljs-number">03</span> innobackupex: Starting the <span class="hljs-built_in">copy-back</span> operation<br><br>IMPORTANT: Please check that the <span class="hljs-built_in">copy-back</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful <span class="hljs-built_in">copy-back</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br>......<br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span>:<span class="hljs-number">08</span> completed OK!　　<span class="hljs-comment">#看到completed OK就是恢复正常了</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># ll /usr/local/mysql/data/　　#slave上查看数据目录，可以看到数据已经恢复，但是属主会有问题，需要进行修改，所以一般使用mysql的运行用户进行恢复，否则需要进行修改属主和属组信息</span><br>total <span class="hljs-number">188432</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">79691776</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ibdata1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ib_logfile0<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ib_logfile1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">12582912</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ibtmp1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> kim<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> repppp<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> wordpress<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">482</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> xtrabackup_info<br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># chown -R mysql.mysql /usr/local/mysql/data/　　#修改属主属组</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld start　　#启动mysql</span><br>Starting MySQL. SUCCESS! <br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld stop　　#停止slave上的mysql</span><br>Shutting down MySQL.. SUCCESS! <br><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> <span class="hljs-type">tools</span>]<span class="hljs-comment"># yum install -y percona-xtrabackup-24-2.4.9-1.el7.x86_64.rpm 　　#安装xtrabackup</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># scp -r 2018-07-30_11-01-37/ root@192.168.56.12:/backups/　　 #从master上拷贝备份数据</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> <span class="hljs-type">tools</span>]<span class="hljs-comment"># innobackupex --apply-log /backups/2018-07-30_11-01-37/　　　　　 #合并数据，使数据文件处于一致性的状态</span><br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">18</span>:<span class="hljs-number">23</span> innobackupex: Starting the apply<span class="hljs-literal">-log</span> operation<br><br>IMPORTANT: Please check that the apply<span class="hljs-literal">-log</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful apply<span class="hljs-literal">-log</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br><br>innobackupex version <span class="hljs-number">2.4</span>.<span class="hljs-number">9</span> based on MySQL server <span class="hljs-number">5.7</span>.<span class="hljs-number">13</span> Linux (x86_64) (revision id: a467167cdd4)<br>xtrabackup: cd to /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span>/<br>xtrabackup: This target seems to be not prepared yet.<br>InnoDB: Number of pools: <span class="hljs-number">1</span><br>xtrabackup: xtrabackup_logfile detected: size=<span class="hljs-number">8388608</span>, start_lsn=(<span class="hljs-number">3127097</span>)<br>......<br>InnoDB: FTS optimize thread exiting.<br>InnoDB: Starting shutdown...<br>InnoDB: Shutdown completed; log sequence number <span class="hljs-number">3129915</span><br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">18</span>:<span class="hljs-number">30</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># rm -rf /usr/local/mysql/data/　　#在slave上删除原有的数据</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># vim /etc/my.cnf　　#配置my.cnf的数据目录路径，否则会报错，要和master一致</span><br>datadir=/usr/local/mysql/<span class="hljs-keyword">data</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># innobackupex --copy-back /backups/2018-07-30_11-01-37/　　#在slave上数据恢复</span><br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span>:<span class="hljs-number">03</span> innobackupex: Starting the <span class="hljs-built_in">copy-back</span> operation<br><br>IMPORTANT: Please check that the <span class="hljs-built_in">copy-back</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful <span class="hljs-built_in">copy-back</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br>......<br><span class="hljs-number">180729</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span>:<span class="hljs-number">08</span> completed OK!　　<span class="hljs-comment">#看到completed OK就是恢复正常了</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># ll /usr/local/mysql/data/　　#slave上查看数据目录，可以看到数据已经恢复，但是属主会有问题，需要进行修改，所以一般使用mysql的运行用户进行恢复，否则需要进行修改属主和属组信息</span><br>total <span class="hljs-number">188432</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">79691776</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ibdata1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ib_logfile0<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ib_logfile1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">12582912</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> ibtmp1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> kim<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> repppp<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> wordpress<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">482</span> Jul <span class="hljs-number">29</span> <span class="hljs-number">23</span>:<span class="hljs-number">32</span> xtrabackup_info<br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># chown -R mysql.mysql /usr/local/mysql/data/　　#修改属主属组</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld start　　#启动mysql</span><br>Starting MySQL. SUCCESS! <br>[<span class="hljs-type">root</span>@<span class="hljs-type">slave</span> ~]<span class="hljs-comment"># mysql -uroot -p -e "show databases;"　　#查看数据，是否恢复</span><br>Enter password: <br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| kim                |<br>| mysql              |<br>| performance_schema |<br>| repppp             |<br>| wordpress          |<br>+--------------------+<br></code></pre></td></tr></table></figure>
<h4 id="总结全库备份与恢复三步曲：">总结全库备份与恢复三步曲：</h4>
<ul>
<li><strong>innobackupex全量备份，并指定备份目录路径；</strong></li>
<li><strong>在恢复前，需要使用–apply-log参数先进行合并数据文件，确保数据的一致性要求；</strong></li>
<li><strong>恢复时，直接使用–copy-back参数进行恢复，需要注意的是，在my.cnf中要指定数据文件目录的路径。</strong></li>
</ul>
<h1>三、xtrabackup增量备份与恢复</h1>
<p><strong>使用innobackupex进行增量备份，每个InnoDB的页面都会包含一个LSN信息，每当相关的数据发生改变，相关的页面的LSN就会自动增长。这正是InnoDB表可以进行增量备份的基础，即innobackupex通过备份上次完全备份之后发生改变的页面来实现。在进行增量备份时，首先要进行一次全量备份，第一次增量备份是基于全备的，之后的增量备份都是基于上一次的增量备份的，以此类推。</strong></p>
<p><strong>要实现第一次增量备份，可以使用下面的命令进行：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs text"><code class="language-hljs text">基于全量备份的增量备份与恢复<br>做一次增量备份（基于当前最新的全量备份）<br>innobackupex --user&#x3D;root --password&#x3D;root --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --incremental &#x2F;backups&#x2F; --incremental-basedir&#x3D;&#x2F;backups&#x2F;2018-07-30_11-01-37<br>1. 准备基于全量<br>innobackupex --user&#x3D;root --password&#x3D;root --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --apply-log --redo-only &#x2F;backups&#x2F;2018-07-30_11-01-37<br>2. 准备基于增量<br>innobackupex --user&#x3D;root --password&#x3D;root --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --apply-log --redo-only &#x2F;backups&#x2F;2018-07-30_11-01-37 --incremental-dir&#x3D;&#x2F;backups&#x2F;2018-07-30_13-51-47&#x2F;3. 恢复<br>innobackupex --copy-back --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf &#x2F;opt&#x2F;2017-01-05_11-04-55&#x2F;<br>解释：<br>1. 2018-07-30_11-01-37指的是完全备份所在的目录。2. 2018-07-30_13-51-47指定是第一次基于2018-07-30_11-01-37增量备份的目录，其他类似以此类推，即如果有多次增量备份。每一次都要执行如上操作。<br></code></pre></td></tr></table></figure>
<p><strong>需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。</strong></p>
<p><strong>&quot;准备&quot;(prepare)增量备份与整理完全备份有着一些不同，尤其要注意的是：</strong></p>
<ul>
<li><strong>需要在每个备份 (包括完全和各个增量备份)上，将已经提交的事务进行&quot;重放&quot;。&quot;重放&quot;之后，所有的备份数据将合并到完全备份上。</strong></li>
<li><strong>基于所有的备份将未提交的事务进行&quot;回滚&quot;</strong></li>
</ul>
<h2 id="1、增量备份演示"><strong>1、增量备份演示</strong></h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># innobackupex --user=root --password=123456 --host=127.0.0.1 /backups/   #全备数据[root@master ~]# mysql -uroot -p　　#在master上创建student库并创建testtb表插入若干数据Enter password: </span><br>mysql&gt; create database student;<br>Query OK, <span class="hljs-number">1</span> row affected (<span class="hljs-number">0.03</span> sec)<br><br>mysql&gt; use student;<br>Database changed<br>mysql&gt; create table testtb(id int);<br>Query OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0.07</span> sec)<br><br>mysql&gt; insert into testtb values(<span class="hljs-number">1</span>),(<span class="hljs-number">10</span>),(<span class="hljs-number">99</span>);<br>Query OK, <span class="hljs-number">3</span> rows affected (<span class="hljs-number">0.04</span> sec)<br>Records: <span class="hljs-number">3</span>  Duplicates: <span class="hljs-number">0</span>  Warnings: <span class="hljs-number">0</span><br><br>mysql&gt; select * from testtb;<br>+------+<br>| id   |<br>+------+<br>|    <span class="hljs-number">1</span> |<br>|   <span class="hljs-number">10</span> |<br>|   <span class="hljs-number">99</span> |<br>+------+<br><span class="hljs-number">3</span> rows <span class="hljs-keyword">in</span> set (<span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># innobackupex --user=root --password=123456 --host=127.0.0.1 /backups/   #全备数据[root@master ~]# mysql -uroot -p　　#在master上创建student库并创建testtb表插入若干数据Enter password: </span><br>mysql&gt; create database student;<br>Query OK, <span class="hljs-number">1</span> row affected (<span class="hljs-number">0.03</span> sec)<br><br>mysql&gt; use student;<br>Database changed<br>mysql&gt; create table testtb(id int);<br>Query OK, <span class="hljs-number">0</span> rows affected (<span class="hljs-number">0.07</span> sec)<br><br>mysql&gt; insert into testtb values(<span class="hljs-number">1</span>),(<span class="hljs-number">10</span>),(<span class="hljs-number">99</span>);<br>Query OK, <span class="hljs-number">3</span> rows affected (<span class="hljs-number">0.04</span> sec)<br>Records: <span class="hljs-number">3</span>  Duplicates: <span class="hljs-number">0</span>  Warnings: <span class="hljs-number">0</span><br><br>mysql&gt; select * from testtb;<br>+------+<br>| id   |<br>+------+<br>|    <span class="hljs-number">1</span> |<br>|   <span class="hljs-number">10</span> |<br>|   <span class="hljs-number">99</span> |<br>+------+<br><span class="hljs-number">3</span> rows <span class="hljs-keyword">in</span> set (<span class="hljs-number">0.00</span> sec)<br><br>mysql> quit;<br>Bye<br></code></pre></td></tr></table></figure>
<h2 id="2、使用innobackupex进行增量备份">2、使用innobackupex进行增量备份</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># innobackupex --user=root --password=123456 --host=127.0.0.1 --incremental /backups/ --incremental-basedir=/backups/2018-07-30_11-01-37/</span><br>......<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> Executing UNLOCK TABLES<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> All tables unlocked<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> Backup created <span class="hljs-keyword">in</span> directory <span class="hljs-string">'/backups/2018-07-30_13-51-47/'</span><br>MySQL binlog position: filename <span class="hljs-string">'mysql-bin.000005'</span>, position <span class="hljs-string">'664'</span><br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>] Writing /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_13</span><span class="hljs-literal">-51</span><span class="hljs-literal">-47</span>/<span class="hljs-built_in">backup-my</span>.cnf<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>]        ...done<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>] Writing /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_13</span><span class="hljs-literal">-51</span><span class="hljs-literal">-47</span>/xtrabackup_info<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>]        ...done<br>xtrabackup: Transaction log of lsn (<span class="hljs-number">3158741</span>) to (<span class="hljs-number">3158741</span>) was copied.<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># ll　　#查看备份数据</span><br>total <span class="hljs-number">0</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">7</span> root root <span class="hljs-number">232</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> <span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span>　　<span class="hljs-comment">#全量备份数据目录</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">8</span> root root <span class="hljs-number">273</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span> <span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_13</span><span class="hljs-literal">-51</span><span class="hljs-literal">-47</span>　　<span class="hljs-comment">#增量备份数据目录</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-number">2018</span>-<span class="hljs-number">07</span>-<span class="hljs-number">30</span><span class="hljs-type">_11</span>-<span class="hljs-number">01</span>-<span class="hljs-number">37</span>]<span class="hljs-comment"># cat xtrabackup_checkpoints #查看全量备份的xtrabackup_checkpoints</span><br>backup_type = full<span class="hljs-literal">-backuped</span>　　<span class="hljs-comment">#备份类型为全量备份</span><br>from_lsn = <span class="hljs-number">0</span>　　<span class="hljs-comment">#lsn从0开始</span><br>to_lsn = <span class="hljs-number">3127097</span>　　<span class="hljs-comment">#lsn到3127097结束</span><br>last_lsn = <span class="hljs-number">3127097</span><br>compact = <span class="hljs-number">0</span><br>recover_binlog_info = <span class="hljs-number">0</span><br><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-number">2018</span>-<span class="hljs-number">07</span>-<span class="hljs-number">30</span><span class="hljs-type">_13</span>-<span class="hljs-number">51</span>-<span class="hljs-number">47</span>]<span class="hljs-comment"># cat xtrabackup_checkpoints 　　#查看增量备份的xtrabackup_checkpoints</span><br>backup_type = incremental　　<span class="hljs-comment">#备份类型为增量备份</span><br>from_lsn = <span class="hljs-number">3127097</span>　　<span class="hljs-comment">#lsn从3127097开始</span><br>to_lsn = <span class="hljs-number">3158741</span>　　  <span class="hljs-comment">#lsn到啊3158741结束</span><br>last_lsn = <span class="hljs-number">3158741</span>　　<br>compact = <span class="hljs-number">0</span><br>recover_binlog_info = <span class="hljs-number"><code class="language-hljs powershell"><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># innobackupex --user=root --password=123456 --host=127.0.0.1 --incremental /backups/ --incremental-basedir=/backups/2018-07-30_11-01-37/</span><br>......<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> Executing UNLOCK TABLES<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> All tables unlocked<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> Backup created <span class="hljs-keyword">in</span> directory <span class="hljs-string">'/backups/2018-07-30_13-51-47/'</span><br>MySQL binlog position: filename <span class="hljs-string">'mysql-bin.000005'</span>, position <span class="hljs-string">'664'</span><br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>] Writing /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_13</span><span class="hljs-literal">-51</span><span class="hljs-literal">-47</span>/<span class="hljs-built_in">backup-my</span>.cnf<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>]        ...done<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>] Writing /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_13</span><span class="hljs-literal">-51</span><span class="hljs-literal">-47</span>/xtrabackup_info<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> [<span class="hljs-number">00</span>]        ...done<br>xtrabackup: Transaction log of lsn (<span class="hljs-number">3158741</span>) to (<span class="hljs-number">3158741</span>) was copied.<br><span class="hljs-number">180730</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span>:<span class="hljs-number">50</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-type">backups</span>]<span class="hljs-comment"># ll　　#查看备份数据</span><br>total <span class="hljs-number">0</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">7</span> root root <span class="hljs-number">232</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">11</span>:<span class="hljs-number">01</span> <span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span>　　<span class="hljs-comment">#全量备份数据目录</span><br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">8</span> root root <span class="hljs-number">273</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">13</span>:<span class="hljs-number">51</span> <span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_13</span><span class="hljs-literal">-51</span><span class="hljs-literal">-47</span>　　<span class="hljs-comment">#增量备份数据目录</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-number">2018</span>-<span class="hljs-number">07</span>-<span class="hljs-number">30</span><span class="hljs-type">_11</span>-<span class="hljs-number">01</span>-<span class="hljs-number">37</span>]<span class="hljs-comment"># cat xtrabackup_checkpoints #查看全量备份的xtrabackup_checkpoints</span><br>backup_type = full<span class="hljs-literal">-backuped</span>　　<span class="hljs-comment">#备份类型为全量备份</span><br>from_lsn = <span class="hljs-number">0</span>　　<span class="hljs-comment">#lsn从0开始</span><br>to_lsn = <span class="hljs-number">3127097</span>　　<span class="hljs-comment">#lsn到3127097结束</span><br>last_lsn = <span class="hljs-number">3127097</span><br>compact = <span class="hljs-number">0</span><br>recover_binlog_info = <span class="hljs-number">0</span><br><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> <span class="hljs-number">2018</span>-<span class="hljs-number">07</span>-<span class="hljs-number">30</span><span class="hljs-type">_13</span>-<span class="hljs-number">51</span>-<span class="hljs-number">47</span>]<span class="hljs-comment"># cat xtrabackup_checkpoints 　　#查看增量备份的xtrabackup_checkpoints</span><br>backup_type = incremental　　<span class="hljs-comment">#备份类型为增量备份</span><br>from_lsn = <span class="hljs-number">3127097</span>　　<span class="hljs-comment">#lsn从3127097开始</span><br>to_lsn = <span class="hljs-number">3158741</span>　　  <span class="hljs-comment">#lsn到啊3158741结束</span><br>last_lsn = <span class="hljs-number">3158741</span>　　<br>compact = <span class="hljs-number">0</span><br>recover_binlog_info = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<h2 id="3、增量备份后数据恢复演示"><strong>3、增量备份后数据恢复演示</strong></h2>
<h3 id="（1）模拟mysql故障，删除数据目录所有数据">（1）模拟mysql故障，删除数据目录所有数据</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld stop　　#模拟mysql故障，停止mysql</span><br>Shutting down MySQL.. SUCCESS! <br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld stop　　#模拟mysql故障，停止mysql</span><br>Shutting down MySQL.. SUCCESS! <br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># rm -rf /usr/local/mysql/data/*　　#删除数据目录中的所有数据</span><br></code></pre></td></tr></table></figure>
<h3 id="（2）合并全备数据目录，确保数据的一致性">（2）合并全备数据目录，确保数据的一致性</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># innobackupex --apply-log --redo-only /backups/2018-07-30_11-01-37/</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">05</span>:<span class="hljs-number">27</span> innobackupex: Starting the apply<span class="hljs-literal">-log</span> operation<br><br>IMPORTANT: Please check that the apply<span class="hljs-literal">-log</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful apply<span class="hljs-literal">-log</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br><br>innobackupex version <span class="hljs-number">2.4</span>.<span class="hljs-number">9</span> based on MySQL server <span class="hljs-number">5.7</span>.<span class="hljs-number">13</span> Linux (x86_64) (revision id: a467167cdd4)<br>xtrabackup: cd to /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span>/<br>......<br>......<br>xtrabackup: starting shutdown with innodb_fast_shutdown = <span class="hljs-number">1</span><br>InnoDB: Starting shutdown...<br>InnoDB: Shutdown completed; log sequence number <span class="hljs-number">3127106</span><br>InnoDB: Number of pools: <span class="hljs-number">1</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">05</span>:<span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># innobackupex --apply-log --redo-only /backups/2018-07-30_11-01-37/</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">05</span>:<span class="hljs-number">27</span> innobackupex: Starting the apply<span class="hljs-literal">-log</span> operation<br><br>IMPORTANT: Please check that the apply<span class="hljs-literal">-log</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful apply<span class="hljs-literal">-log</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br><br>innobackupex version <span class="hljs-number">2.4</span>.<span class="hljs-number">9</span> based on MySQL server <span class="hljs-number">5.7</span>.<span class="hljs-number">13</span> Linux (x86_64) (revision id: a467167cdd4)<br>xtrabackup: cd to /backups/<span class="hljs-number">2018</span><span class="hljs-literal">-07</span><span class="hljs-literal">-30_11</span><span class="hljs-literal">-01</span><span class="hljs-literal">-37</span>/<br>......<br>......<br>xtrabackup: starting shutdown with innodb_fast_shutdown = <span class="hljs-number">1</span><br>InnoDB: Starting shutdown...<br>InnoDB: Shutdown completed; log sequence number <span class="hljs-number">3127106</span><br>InnoDB: Number of pools: <span class="hljs-number">1</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">05</span>:<span class="hljs-number">29</span> completed OK!<br></code></pre></td></tr></table></figure>
<h3 id="（3）将增量备份数据合并到全备数据目录当中">（3）将增量备份数据合并到全备数据目录当中</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># innobackupex --apply-log --redo-only /backups/2018-07-30_11-01-37/ --incremental-dir=/backups/2018-07-30_13-51-47/</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">42</span> innobackupex: Starting the apply<span class="hljs-literal">-log</span> operation<br><br>IMPORTANT: Please check that the apply<span class="hljs-literal">-log</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful apply<span class="hljs-literal">-log</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br>......<br>......<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">44</span> [<span class="hljs-number">00</span>]        ...done<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">44</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># cat /backups/2018-07-30_11-01-37/xtrabackup_checkpoints </span><br>backup_type = log<span class="hljs-literal">-applied</span>　　<span class="hljs-comment">#查看到数据备份类型是增加</span><br>from_lsn = <span class="hljs-number">0</span>　　<span class="hljs-comment">#lsn从0开始</span><br>to_lsn = <span class="hljs-number">3158741</span>　　<span class="hljs-comment">#lsn结束号为最新的lsn</span><br>last_lsn = <span class="hljs-number">3158741</span><br>compact = <span class="hljs-number">0</span><br>recover_binlog_info = <span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># innobackupex --apply-log --redo-only /backups/2018-07-30_11-01-37/ --incremental-dir=/backups/2018-07-30_13-51-47/</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">42</span> innobackupex: Starting the apply<span class="hljs-literal">-log</span> operation<br><br>IMPORTANT: Please check that the apply<span class="hljs-literal">-log</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful apply<span class="hljs-literal">-log</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br>......<br>......<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">44</span> [<span class="hljs-number">00</span>]        ...done<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">44</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># cat /backups/2018-07-30_11-01-37/xtrabackup_checkpoints </span><br>backup_type = log<span class="hljs-literal">-applied</span>　　<span class="hljs-comment">#查看到数据备份类型是增加</span><br>from_lsn = <span class="hljs-number">0</span>　　<span class="hljs-comment">#lsn从0开始</span><br>to_lsn = <span class="hljs-number">3158741</span>　　<span class="hljs-comment">#lsn结束号为最新的lsn</span><br>last_lsn = <span class="hljs-number">3158741</span><br>compact = <span class="hljs-number">0</span><br>recover_binlog_info = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<h3 id="（4）恢复数据">（4）恢复数据</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># innobackupex --copy-back /backups/2018-07-30_11-01-37/</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">07</span>:<span class="hljs-number">51</span> innobackupex: Starting the <span class="hljs-built_in">copy-back</span> operation<br><br>IMPORTANT: Please check that the <span class="hljs-built_in">copy-back</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful <span class="hljs-built_in">copy-back</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br>.......<br>.......<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span>:<span class="hljs-number">17</span> [<span class="hljs-number">01</span>]        ...done<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span>:<span class="hljs-number">17</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># ll /usr/local/mysql/data/</span><br>total <span class="hljs-number">77844</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">79691776</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> ibdata1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> kim<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> repppp<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">56</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> student<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> wordpress<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root       <span class="hljs-number">21</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> xtrabackup_binlog_pos_innodb<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">554</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> xtrabackup_info<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># chown -R mysql.mysql /usr/local/mysql/data　　#更改数据的属主属组</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld start　　#启动mysql</span><br>Starting MySQL.Logging to <span class="hljs-string">'/usr/local/mysql/data/master.err'</span>.<br>.. SUCCESS! <br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># innobackupex --copy-back /backups/2018-07-30_11-01-37/</span><br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">07</span>:<span class="hljs-number">51</span> innobackupex: Starting the <span class="hljs-built_in">copy-back</span> operation<br><br>IMPORTANT: Please check that the <span class="hljs-built_in">copy-back</span> run completes successfully.<br>           At the <span class="hljs-keyword">end</span> of a successful <span class="hljs-built_in">copy-back</span> run innobackupex<br>           prints <span class="hljs-string">"completed OK!"</span>.<br>.......<br>.......<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span>:<span class="hljs-number">17</span> [<span class="hljs-number">01</span>]        ...done<br><span class="hljs-number">180730</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span>:<span class="hljs-number">17</span> completed OK!<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># ll /usr/local/mysql/data/</span><br>total <span class="hljs-number">77844</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">79691776</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> ibdata1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> kim<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> repppp<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">56</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> student<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> wordpress<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root       <span class="hljs-number">21</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> xtrabackup_binlog_pos_innodb<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">554</span> Jul <span class="hljs-number">30</span> <span class="hljs-number">14</span>:<span class="hljs-number">08</span> xtrabackup_info<br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># chown -R mysql.mysql /usr/local/mysql/data　　#更改数据的属主属组</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># /etc/init.d/mysqld start　　#启动mysql</span><br>Starting MySQL.Logging to <span class="hljs-string">'/usr/local/mysql/data/master.err'</span>.<br>.. SUCCESS! <br>[<span class="hljs-type">root</span>@<span class="hljs-type">master</span> ~]<span class="hljs-comment"># mysql -uroot -p -e "show databases;"　　#查看数据是否恢复</span><br>Enter password: <br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| kim                |<br>| mysql              |<br>| performance_schema |<br>| repppp             |<br>| student            |<br>| wordpress          |<br>+--------------------+<br></code></pre></td></tr></table></figure>
<h3 id="总结：">总结：</h3>
<ul>
<li><strong>增量备份需要使用参数–incremental指定需要备份到哪个目录，使用incremental-dir指定全备目录；</strong></li>
<li><strong>进行数据备份时，需要使用参数–apply-log redo-only先合并全备数据目录数据，确保全备数据目录数据的一致性；</strong></li>
<li><strong>再将增量备份数据使用参数–incremental-dir合并到全备数据当中；</strong></li>
<li><strong>最后通过最后的全备数据进行恢复数据，注意，如果有多个增量备份，需要逐一合并到全备数据当中，再进行恢复。</strong></li>
</ul>
<h2 id="方案一：xtrabackup完全备份-binlog增量备份">方案一：xtrabackup完全备份+binlog增量备份</h2>
<h2 id="1、备份-创建备份目录">1、备份 创建备份目录</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">mkdir <span class="hljs-literal"><code class="language-hljs powershell">mkdir <span class="hljs-literal">-p</span> /opt/mysqlbackup/&#123;full,inc&#125;<br></code></pre></td></tr></table></figure>
<p>**full：全备存放的目录；inc：增量备份存放的目录 **</p>
<h3 id="（1）完全备份">（1）完全备份</h3>
<p><a href="https://wsdlxgp.top/posts/af18.html"><em><strong>需要开启和设置二进制日志</strong></em></a></p>
<p><strong>基本语法：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">innobackupex -<span class="hljs-literal">-user</span>=DBUSER -<span class="hljs-literal">-password</span>=DBUSERPASS /path/to/<span class="hljs-built_in"><code class="language-hljs powershell">innobackupex -<span class="hljs-literal">-user</span>=DBUSER -<span class="hljs-literal">-password</span>=DBUSERPASS /path/to/<span class="hljs-built_in">BACKUP-DIR</span>/<br></code></pre></td></tr></table></figure>
<p><strong>执行下面的命令进行完全备份：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># innobackupex --user=root --password=123 /opt/mysqlbackup/full</span><br></code></pre></td></tr></table></figure>
<p><strong>注： --defaults-file=/etc/my.cnf 指定mysql的配置文件my.cfg，如果指定则必须是第一个参数。</strong></p>
<p><strong>/path/to/BACKUP-DIR/指定备份所存放的目标目录，备份过程会创建一个以当时备份时间命名的目录存放备份文件。 出现如下提示。表示成功</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> Backup created <span class="hljs-keyword">in</span> directory <span class="hljs-string">'/opt/mysqlbackup/full/2020-01-13_09-</span><br><span class="hljs-string">49-22'</span><br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] Writing <span class="hljs-built_in">backup-my</span>.cnf<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] ...done<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] Writing xtrabackup_info<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] ...done<br>xtrabackup: Transaction log of lsn (<span class="hljs-number">67343410</span>) to (<span class="hljs-number">67343419</span>) was copied.<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number"><code class="language-hljs powershell"><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> Backup created <span class="hljs-keyword">in</span> directory <span class="hljs-string">'/opt/mysqlbackup/full/2020-01-13_09-</span><br><span class="hljs-string">49-22'</span><br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] Writing <span class="hljs-built_in">backup-my</span>.cnf<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] ...done<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] Writing xtrabackup_info<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> [<span class="hljs-number">00</span>] ...done<br>xtrabackup: Transaction log of lsn (<span class="hljs-number">67343410</span>) to (<span class="hljs-number">67343419</span>) was copied.<br><span class="hljs-number">200113</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span>:<span class="hljs-number">37</span> completed OK!<br></code></pre></td></tr></table></figure>
<p><strong>备份后的文件： 在备份的同时，备份数据会在备份目录下创建一个以当前日期时间为名字的目录存放备份文件：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># cd /opt/mysqlbackup/full/</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">full</span>]<span class="hljs-comment">#</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">full</span>]<span class="hljs-comment"># ll</span><br>total <span class="hljs-number">4</span><br>drwxr<span class="hljs-literal">-x</span>---. <span class="hljs-number">12</span> root root <span class="hljs-number">4096</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> <span class="hljs-number">2020</span><span class="hljs-literal">-01</span><span class="hljs-literal">-13_09</span><span class="hljs-literal">-49</span><span class="hljs-literal">-22</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">full</span>]<span class="hljs-comment"># ll 2020-01-13_09-49-22/</span><br>total <span class="hljs-number">77892</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">425</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> <span class="hljs-built_in">backup-my</span>.cnf<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">115</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> xtrabackup_checkpoints<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">431</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> xtrabackup_info<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">2560</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># cd /opt/mysqlbackup/full/</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">full</span>]<span class="hljs-comment">#</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">full</span>]<span class="hljs-comment"># ll</span><br>total <span class="hljs-number">4</span><br>drwxr<span class="hljs-literal">-x</span>---. <span class="hljs-number">12</span> root root <span class="hljs-number">4096</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> <span class="hljs-number">2020</span><span class="hljs-literal">-01</span><span class="hljs-literal">-13_09</span><span class="hljs-literal">-49</span><span class="hljs-literal">-22</span><br>[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> <span class="hljs-type">full</span>]<span class="hljs-comment"># ll 2020-01-13_09-49-22/</span><br>total <span class="hljs-number">77892</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">425</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> <span class="hljs-built_in">backup-my</span>.cnf<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">115</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> xtrabackup_checkpoints<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">431</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> xtrabackup_info<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>-----. <span class="hljs-number">1</span> root root <span class="hljs-number">2560</span> Jan <span class="hljs-number">13</span> <span class="hljs-number">09</span>:<span class="hljs-number">49</span> xtrabackup_logfile<br></code></pre></td></tr></table></figure>
<h4 id="各文件说明：">各文件说明：</h4>
<ul>
<li><strong>xtrabackup_checkpoints ——备份类型（如完全或增量）、备份状态（如是否已经为prepared状态）和LSN(日志序列号)范围信息； 每个InnoDB页(通常为16k大小)都会包含一个日志序列号，即LSN。LSN是整个数据库系统的系统版本号，每个页面相关的LSN能够表明此页面最近是如何发生改变的。</strong></li>
<li><strong>xtrabackup_binlog_info —— mysql服务器当前正在使用的二进制日志文件及至备份这一刻为止二进制日志事件的位置。</strong></li>
<li><strong>xtrabackup_binlog_pos_innodb ——二进制日志文件及用于InnoDB或XtraDB表的二进制日志文件的当前position。</strong></li>
<li><strong>xtrabackup_binary ——备份中用到的xtrabackup的可执行文件；</strong></li>
<li><strong>backup-my.cnf ——备份命令用到的配置选项信息；</strong></li>
<li>
<ul>
<li><strong>在使用innobackupex进行备份时，还可以使用–no-timestamp选项来阻止命令自动创建一个以时间命名的目录；如此一来，innobackupex命令将会创建一个BACKUP-DIR目录来存储备份数据</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>注意：相关选项说明： 其中，</strong></p>
<p><strong>–user指定连接数据库的用户名，</strong></p>
<p><strong>–password指定连接数据库的密码，</strong></p>
<p><strong>–defaults-file指定数据库的配置文件，innobackupex要从其中获取datadir等信息；</strong></p>
<p><strong>–database指定要备份的数据库，这里指定的数据库只对MyISAM表有效，对于InnoDB 数据来说都是全备（所有数据库中的InnoDB数据都进行了备份，不是只备份指定的数据库，恢复时也一样）；</strong></p>
<p><strong>/opt/mysqlbackup/full是备份文件的存放位置。</strong></p>
</blockquote>
<p><strong>注意：备份数据库的用户需要具有相应权限，如果要使用一个最小权限的用户进行备份，则可基于如下命令创建此类用户：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> CREATE USER 'bkpuser'@'localhost' IDENTIFIED BY '123456';　　#创建用户<br>mysql> REVOKE ALL PRIVILEGES ON *.*  FROM 'bkpuser'@'localhost';　　#回收此用户所有权限<br>mysql> GRANT RELOAD,LOCK TABLES,RELICATION CLIENT ON *.* TO 'bkpuser'@'localhost';　　#授权刷新、锁定表、用户查看服务器状态<br>mysql> FLUSH PRIVILEGES;　　#刷新授权表<br></code></pre></td></tr></table></figure>
<p><strong>至此全备完全成功，然后向mysql某个库插入几条数据，然后进行增量备份 对完全备份的后数据库更改进行二进制日志增量备份：</strong></p>
<h4 id="模拟数据库修改：">模拟数据库修改：</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> create database tb1;<br>Query OK, 1 row affected (0.00 sec)<br><br>mysql> use tb1;<br>Database changed<br><br>mysql> create table tom1(qq int(10));<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql> create table tom2(qq int(10));<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql> insert into tb1.tom1 values (3);<br>Query OK, 1 row affected (0.00 sec)<br><br>mysql> insert into tb1.tom2 values (4);<br>Query OK, 1 row affected (0.00 sec)<br></code></pre></td></tr></table></figure>
<h3 id="（2）增量备份二进制文件：">（2）增量备份二进制文件：</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># mysqlbinlog --start-position=2378 /usr/local/mysql/data/mysql_bin_log.000001 > /opt/mysqlbackup/inc/`date +%F`.sql</span><br></code></pre></td></tr></table></figure>
<h2 id="2、还原数据库：-模拟数据库损坏：-我这里直接使用删除数据目录文件来模拟损坏">2、还原数据库： 模拟数据库损坏： 我这里直接使用删除数据目录文件来模拟损坏</h2>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># rm -fr /usr/local/mysql/data/*</span><br></code></pre></td></tr></table></figure>
<h3 id="还原完全备份：">还原完全备份：</h3>
<h3 id="（1）准备-prepare-一个完全备份">（1）准备(prepare)一个完全备份</h3>
<p><strong>一般情况下，在备份完成后，数据尚且不能用于恢复操作，</strong><br>
<strong>因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此，此时数据文件仍处理不一致状态。“准备”的主要作用正是通过回滚未提交的事务及同步已经提交的事务至数据文件也使得数据文件处于一致性状态。 在准备（prepare）过程结束后，InnoDB表数据已经前滚到整个备份结束的点，而不是回滚到xtrabackup刚开始时的点。 innobakupex命令的–apply-log选项可用于实现上述功能。</strong></p>
<p><strong>如下面的命令： --apply-log指明是将日志应用到数据文件上，完成之后将备份文件中的数据恢复到数据库中：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># innobackupex --apply-log /opt/mysqlbackup/full/2020-06-28_17-55-31/</span><br></code></pre></td></tr></table></figure>
<p><strong>注：/opt/mysqlbackup/full/2020-06-28_17-55-31/备份文件所在目录名称 如果执行正确，其最后输出的几行信息通常如下：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">InnoDB: FTS optimize thread exiting.<br>InnoDB: Starting shutdown...<br>InnoDB: Shutdown completed; log sequence number <span class="hljs-number">2598952</span><br><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">01</span>:<span class="hljs-number"><code class="language-hljs powershell">InnoDB: FTS optimize thread exiting.<br>InnoDB: Starting shutdown...<br>InnoDB: Shutdown completed; log sequence number <span class="hljs-number">2598952</span><br><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">01</span>:<span class="hljs-number">23</span> completed OK!<br></code></pre></td></tr></table></figure>
<p><strong>在实现“准备”的过程中，innobackupex通常还可以使用–use-memory选项来指定其可以使用的内存的大小，默认通常为100M。如果有足够的内存可用，可以多划分一些内存给prepare的过程，以提高其完成速度。</strong></p>
<p><strong>innobackupex命令的–copy-back选项用于执行恢复操作，其通过复制所有数据相关的文件至mysql服务器DATADIR目录中来执行恢复过程。innobackupex通过backup-my.cnf来获取DATADIR目录的相关信息。</strong></p>
<h3 id="（2）还原数据库语法：">（2）还原数据库语法：</h3>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># innobackupex --copy-back /opt/mysqlbackup/full/2020-06-28_17-55-31/</span><br></code></pre></td></tr></table></figure>
<p><strong>这里的–copy-back指明是进行数据恢复。数据恢复完成之后，需要修改相关文件的权限mysql数据库才能正常启动。 如果执行正确，其输出信息的最后几行通常如下：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span>:<span class="hljs-number">29</span> [<span class="hljs-number">01</span>] Copying ./ibtmp1 to /usr/local/mysql/<span class="hljs-keyword">data</span>/ibtmp1<br><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span>:<span class="hljs-number">29</span> [<span class="hljs-number">01</span>]        ...done<br><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span>:<span class="hljs-number"><code class="language-hljs powershell"><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span>:<span class="hljs-number">29</span> [<span class="hljs-number">01</span>] Copying ./ibtmp1 to /usr/local/mysql/<span class="hljs-keyword">data</span>/ibtmp1<br><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span>:<span class="hljs-number">29</span> [<span class="hljs-number">01</span>]        ...done<br><span class="hljs-number">200628</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span>:<span class="hljs-number">29</span> completed OK!<br></code></pre></td></tr></table></figure>
<p><strong>请确保如上信息的最行一行出现“completed OK!”。</strong></p>
<h4 id="修改还原后的数据目录权限">修改还原后的数据目录权限:</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># ll /usr/local/mysql/data/</span><br>总用量 <span class="hljs-number">122916</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">258</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ib_buffer_pool<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">12582912</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ibdata1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ib_logfile0<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ib_logfile1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">12582912</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ibtmp1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">8192</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">8192</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> sys<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">84</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> tb1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> test2<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root      <span class="hljs-number">248</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> testdb<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> testqq<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> xgp<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">481</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># ll /usr/local/mysql/data/</span><br>总用量 <span class="hljs-number">122916</span><br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">258</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ib_buffer_pool<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">12582912</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ibdata1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ib_logfile0<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">50331648</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ib_logfile1<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root <span class="hljs-number">12582912</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> ibtmp1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">4096</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> mysql<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">8192</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> performance_schema<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root     <span class="hljs-number">8192</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> sys<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">84</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> tb1<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> test2<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root      <span class="hljs-number">248</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> testdb<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> testqq<br>drwxr<span class="hljs-literal">-x</span>--- <span class="hljs-number">2</span> root root       <span class="hljs-number">20</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> xgp<br><span class="hljs-literal">-rw</span><span class="hljs-literal">-r</span>----- <span class="hljs-number">1</span> root root      <span class="hljs-number">481</span> Jun <span class="hljs-number">28</span> <span class="hljs-number">18</span>:<span class="hljs-number">04</span> xtrabackup_info<br></code></pre></td></tr></table></figure>
<p><strong>当数据恢复至DATADIR目录以后，还需要确保所有数据文件的属主和属组均为正确的用户，如mysql，否则，在启动mysqld之前还需要事先修改数据文件的属主和属组。如：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># chown -R mysql:mysql /usr/local/mysql/data/</span><br></code></pre></td></tr></table></figure>
<p><strong>必须重启MySQL：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">mysql</span> ~]<span class="hljs-comment"># systemctl restart mysqld</span><br></code></pre></td></tr></table></figure>
<p><strong>验证还原后的数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> use tb1<br>Database changed<br><br>mysql> show tables;<br>+---------------+<br>| Tables_in_tb1 |<br>+---------------+<br>| tom1          |<br>| tom2          |<br>+---------------+<br>2 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure>
<h3 id="（3）还原增量备份：-为了防止还原时产生大量的二进制日志，在还原时可临时关闭二进制日志后再还原：">（3）还原增量备份： 为了防止还原时产生大量的二进制日志，在还原时可临时关闭二进制日志后再还原：</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> set sql_log_bin&#x3D;0;<br>mysql> source &#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;2020-06-28.sql<br></code></pre></td></tr></table></figure>
<p><strong>或者在命令行：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql –uroot –p < &#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;2016-09-12.sql<br>mysqlbinlog &#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;2016-09-12.sql | mysql –uroot -p<br></code></pre></td></tr></table></figure>
<p><strong>重新启动二进制日志并验证还原数据：</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs routeros">mysql&gt; <span class="hljs-builtin-name">set</span> <span class="hljs-attribute"><code class="language-hljs routeros">mysql&gt; <span class="hljs-builtin-name">set</span> <span class="hljs-attribute">sql_log_bin</span>=1;<br></code></pre></td></tr></table></figure>
<p><strong>验证数据是否恢复回来</strong></p>
<h1>方案二、xtrabackup完全备份+xtrabacup增量备份</h1>
<p><strong>前面我们进行增量备份时，使用的还是老方法：备份二进制日志。其实xtrabackup还支持进行增量备份。 先介绍下xtrabackup的备份原理 在InnoDB内部会维护一个redo日志文件，我们也可以叫做事务日志文件（transaction log，事务日志）。事务日志会存储每一个InnoDB表数据的记录修改。当InnoDB启动时，InnoDB会检查数据文件和事务日志，并执行两个步骤：它应用已经提交的事务日志到数据文件，并将修改过但没有提交的数据进行回滚操作。 xtrabackup在启动时会记住log sequence number（LSN），并且复制所有的数据文件。复制过程需要一些时间，所以这期间如果数据文件有改动，那么将会使数据库处于一个不同的时间点。这时，xtrabackup会运行一个后台进程，用于监视事务日志，并从事务日志复制最新的修改。xtrabackup必须持续的做这个操作，是因为事务日志是会轮转重复的写入，并且事务日志可以被重用。所以xtrabackup自启动开始，就不停的将事务日志中每个数据文件的修改都记录下来。这就是xtrabackup的备份过程</strong></p>
<p><strong>所以每个InnoDB的页面都会包含一个LSN信息，每当相关的数据发生改变，相关的页面的LSN就会自动增长。这正是InnoDB表可以进行增量备份的基础。 xtraBackup基于InnoDB的crash-recovery功能。它会复制innodb的data file，由于不锁表，复制出来的数据是不一致的，在恢复的时候使用crash-recovery，使得数据恢复一致。当InnoDB启动的时候，它会先去检查data file和transaction log，并且会做二步操作： <a href="http://1.It" target="_blank" rel="noopener">1.It</a> applies committed transaction logentries to the data files <a href="http://2.it" target="_blank" rel="noopener">2.it</a> performs an undo operation on anytransactions that modified data but did not commit. 所以在prepare过程中，XtraBackup使用复制到的transactions log对备份出来的innodb data file进行crash recovery。 测试环境准备 创建一个测试数据库，并创建一张表输入几行数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> create database test;<br>mysql> use test;<br>mysql> create table xx(id int,name varchar(20));<br>mysql> insert into xx values(1,'tom1');<br>mysql> insert into xx values(2,'tom2');<br></code></pre></td></tr></table></figure>
<h2 id="1、-xtrabacup进行备份-执行完全备份：-备份命令：">1、 xtrabacup进行备份 执行完全备份： 备份命令：</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql"># xtrabackup --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --user&#x3D;root --password&#x3D;"123456" --port&#x3D;3306 --backup --target-dir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;full&#x2F;full_incre_$(date+%Y%m%d_%H%M%S)<br></code></pre></td></tr></table></figure>
<h4 id="部分显示信息如下所示：">部分显示信息如下所示：</h4>
<ul>
<li>
<p><strong>–defaults-file指定数据库的配置文件，如果使用该参数必须做为第一个参数；</strong></p>
</li>
<li>
<p><strong>–user指定连接数据库的用户名；</strong></p>
</li>
<li>
<p><strong>–password指定连接数据库的密码；</strong></p>
</li>
<li>
<p><strong>–port指定连接数据库的端口号；</strong></p>
</li>
<li>
<p><strong>–backup 实施备份到target-dir;</strong></p>
</li>
<li>
<p><strong>–target-dir=name 备份文件的存放目录路径。innobackupex要从其中获取datadir等信息；</strong></p>
</li>
<li>
<p><strong>–database指定要备份的数据库，这里指定的数据库只对MyISAM表和InnoDB表的表结构有效，对于InnoDB 数据来说都是全备（所有数据库中的InnoDB数据都进行了备份，不是只备份指定的数据库，恢复时也一样）；</strong></p>
</li>
<li>
<p><strong>/opt/mysqlbackup/full/是备份文件的存放位置。 查看完全备份文件</strong></p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># ls /opt/mysqlbackup/full/ -l</span><br>drwxr<span class="hljs-literal">-x</span>---. <span class="hljs-number">8</span> root root <span class="hljs-number">4096</span> Sep <span class="hljs-number">12</span> <span class="hljs-number">22</span>:<span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># ls /opt/mysqlbackup/full/ -l</span><br>drwxr<span class="hljs-literal">-x</span>---. <span class="hljs-number">8</span> root root <span class="hljs-number">4096</span> Sep <span class="hljs-number">12</span> <span class="hljs-number">22</span>:<span class="hljs-number">11</span> full_incre_20160912_221111<br></code></pre></td></tr></table></figure>
<p><strong>xtrabackup进行增量备份 先录入些数据，实现第一次增量数据：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> use test;<br>mysql> insert into xx values(3,'tom3');<br>再进行增量备份1<br>备份命令：<br># xtrabackup --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --user&#x3D;root --password&#x3D;"123456" --port&#x3D;3306 --backup --target-dir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;incre_$(date +%Y%m%d_%H%M%S) --incremental-basedir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;full&#x2F;full_incre_20160912_221111&#x2F;<br></code></pre></td></tr></table></figure>
<p><strong>其中，–incremental-basedir指定上次完整备份或者增量备份文件的位置(即如果是第一次增量备份则指向完全备份所在目录，在执行过增量备份之后再一次进行增量备份时，其–incremental-basedir应该指向上一次的增量备份所在的目录)。 查看增量备份文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">[root@localhost ~]# ls -l &#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;<br>drwxr-x---. 8 root root 4096 Sep 12 22:15 incre_20160912_221510<br>注：<br>这里的增量备份其实只针对的是InnoDB，对于MyISAM来说，还是完整备份。<br>向表中再插入几行数据，继续第二次增量备份<br>mysql> use test;<br>mysql> insert into xx values(4,'tom4');<br>mysql> commit;<br>进行第二次增量备份<br>备份命令：<br># xtrabackup --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --user&#x3D;root --password&#x3D;"123456" --<br>port&#x3D;3306 --backup --target-dir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;incre_$(date +%Y%m%d_%H%M%S)<br>--incremental-basedir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;incre_20160912_221510&#x2F;<br></code></pre></td></tr></table></figure>
<p><strong>注：第二次增量备份–incremental-basedir指向上一次增量备份文件的位置。 查看增量备份文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">[root@localhost ~]# ls -l &#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;<br>drwxr-x---. 8 root root 4096 Sep 12 22:15 incre_20160912_221510<br>drwxr-x---. 8 root root 4096 Sep 12 22:19 incre_20160912_221916<br></code></pre></td></tr></table></figure>
<h2 id="2、-xtrabacup进行增量恢复-为了验证比对，先删除两个增量备份前表里面的数据">2、 xtrabacup进行增量恢复 为了验证比对，先删除两个增量备份前表里面的数据</h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">mysql> use test;<br>mysql> delete from xx where id&#x3D;3;<br></code></pre></td></tr></table></figure>
<h4 id="完整备份恢复：">**完整备份恢复： **</h4>
<p><strong>在进行恢复前，如果完整备份在远程主机上，首先将完整备份复制到本地主机上，如果是tar包，则需要先解包，解包命令为：tar –izxf xxx.tar，这里必须使用-i参数（忽略存档中的 0 字节块（通常意味着文件结束））。 开始全备份恢复 命令如下：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># xtrabackup --defaults-file=/etc/my.cnf --prepare --user=root --password="123456" --apply-log-only --target-dir=/opt/mysqlbackup/full/full_incre_20160912_221111/</span><br></code></pre></td></tr></table></figure>
<h4 id="恢复到第一次增量的时刻">**恢复到第一次增量的时刻 **</h4>
<p>**增量备份恢复的步骤和完整备份恢复的步骤基本一致，只是应用日志的过程稍有不同。增量备份恢复时，是先将所有的增量备份挨个应用到完整备份的数据文件中，然后再将完整备份中的数据恢复到数据库中。 恢复命令：  **</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># xtrabackup --defaults-file=/etc/my.cnf --prepare --user=root --password="123456" --apply-log-only --target-dir=/opt/mysqlbackup/full/full_incre_20160912_221111/ --incremental-dir=/opt/mysqlbackup/inc/incre_20160912_221510/</span><br></code></pre></td></tr></table></figure>
<h4 id="恢复到第二次增量备份前面：-恢复命令"><strong>恢复到第二次增量备份前面： 恢复命令</strong></h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql"># xtrabackup --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf --prepare --user&#x3D;root --password&#x3D;"123456" --apply-log-only --target-dir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;full&#x2F;full_incre_20160912_221111&#x2F; --incremental-dir&#x3D;&#x2F;opt&#x2F;mysqlbackup&#x2F;inc&#x2F;incre_20160912_221916&#x2F;<br></code></pre></td></tr></table></figure>
<h4 id="恢复整个库-恢复命令：">恢复整个库 恢复命令：</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># xtrabackup --defaults-file=/etc/my.cnf --prepare --user=root --password="123456" --target-dir=/opt/mysqlbackup/full/full_incre_20160912_221111/</span><br></code></pre></td></tr></table></figure>
<h4 id="然后停止mysql数据库：">然后停止mysql数据库：</h4>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># systemctl stop mysqld</span><br></code></pre></td></tr></table></figure>
<h4 id="开始rsync数据文件：">开始rsync数据文件：</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql"># cd &#x2F;opt&#x2F;mysqlbackup&#x2F;full&#x2F;full_incre_20160912_221111&#x2F;<br>#rsync -rvt --exclude 'xtrabackup_checkpoints' --exclude 'xtrabackup_logfile' .&#x2F; &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data&#x2F;<br></code></pre></td></tr></table></figure>
<p><strong>当数据恢复至DATADIR目录以后，还需要确保所有数据文件的属主和属组均为正确的用户，如mysql，否则，在启动mysqld之前还需要事先修改数据文件的属主和属组。 授予mysql访问权限：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs powershell"><span class="hljs-comment"><code class="language-hljs powershell"><span class="hljs-comment"># chown -R mysql:mysql /usr/local/mysql/data/</span><br></code></pre></td></tr></table></figure>
<h4 id="启动mysql服务：">启动mysql服务：</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql"># systemctl start mysqld<br></code></pre></td></tr></table></figure>
<p><strong>验证 登录mysql，看到以前在备份之后删除的数据已经通过2次增量备份恢复过来了，如下所示：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># mysql -uroot -p123456 -e "select * from test.xx"</span><br>+------+------+<br>| id | name |<br>+------+------+<br>| <span class="hljs-number">1</span> | tom1 |<br>| <span class="hljs-number">2</span> | tom2 |<br>| <span class="hljs-number">3</span> | tom3 |<br>| <span class="hljs-number"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">localhost</span> ~]<span class="hljs-comment"># mysql -uroot -p123456 -e "select * from test.xx"</span><br>+------+------+<br>| id | name |<br>+------+------+<br>| <span class="hljs-number">1</span> | tom1 |<br>| <span class="hljs-number">2</span> | tom2 |<br>| <span class="hljs-number">3</span> | tom3 |<br>| <span class="hljs-number">4</span> | tom4 |<br>+------+------+<br></code></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">#备份：<br>innobackupex --user&#x3D;DBUSER --password&#x3D;DBUSERPASS --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf &#x2F;path&#x2F;to&#x2F;BACKUP-DIR&#x2F;<br><br>#恢复：<br>innobackupex --apply-log &#x2F;backups&#x2F;2018-07-30_11-04-55&#x2F;<br>innobackupex --copy-back --defaults-file&#x3D;&#x2F;etc&#x2F;my.cnf  &#x2F;backups&#x2F;2018-07-30_11-04-55&#x2F;<br></code></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql"># 预处理全量备份<br>innobackupex --apply-log --redo-only &#x2F;backups&#x2F;2020-06-28_17-24-29&#x2F;<br># 把增量备份合并到全量备份<br>innobackupex --apply-log --redo-only &#x2F;backups&#x2F;2020-06-28_17-24-29&#x2F; --incremental-dir&#x3D;&#x2F;backups&#x2F;2020-06-28_17-29-29&#x2F;<br># 用全量备份恢复<br>innobackupex --user&#x3D;root --password&#x3D;1234 --copyback &#x2F;backups&#x2F;2020-06-28_17-24-29&#x2F;<br></code></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wu Shao Dong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wsdlxgp.top/posts/49lt.html">https://wsdlxgp.top/posts/49lt.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wsdlxgp.top" target="_blank">Xgp & Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL%E4%BC%98%E5%8C%96/">MySQL优化</a></div><div class="post_share"><div class="social-share" data-image="http://xgp-cunchu.test.upcdn.net/k8s/325738.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/3.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/1.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/2.jpg" alt="QQ支付"/><div class="post-qr-code__desc">QQ支付</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/49er.html"><img class="prev_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq1p.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">nnobackupex全库备份+innobackupex增量备份</div></div></a></div><div class="next-post pull_right"><a href="/posts/49et.html"><img class="next_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq3p.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">mysqldump备份还原</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/49c4.html" title="MySQL配置参数优化"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq8p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">MySQL配置参数优化</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49c6.html" title="MySQL软件优化"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq6p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">MySQL软件优化</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49ca.html" title="MySQL之my.cnf配置文件优化"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq7p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">MySQL之my.cnf配置文件优化</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49an.html" title="MySQL配置参数优化"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq5p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">MySQL配置参数优化</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49wn.html" title="MySQL配置参数优化"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq4p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">MySQL配置参数优化</div></div></a></div><div class="relatedPosts_item"><a href="/posts/49et.html" title="mysqldump备份还原"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq3p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">mysqldump备份还原</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM0NS8yNTgzNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq2p.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Wu Shao Dong</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="ypy"><a href="https://console.upyun.com/services/file/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/1591433700(1).png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>