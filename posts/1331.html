<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>python中Ansible模块的Playbook理解 | Xgp &amp; Blog</title><meta name="description" content="Playbook 在上一节中，我们详细介绍了Ansible提供的一些常用模块。可以看到，Ansible中的每个模块专注于某一方面的功能。虽然每个模块实现的功能都比较简单，但是，将各个模块组合起来就可以实现比较复杂的功能。在Ansible中，将各个模块组合起来的文件是一个YAML格式的配置文件。这个配置文件，在Ansible中称为Playbook。 在这一节中，我们将循序渐进地介绍Ansible中的"><meta name="keywords" content="nfs,deployment,pv,pvc,dashboard,helm,StorageClass"><meta name="author" content="Wu Shao Dong"><meta name="copyright" content="Wu Shao Dong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://gitee.com/xgpqq/tuchuang/raw/master/img/Yun.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="rPK0WSwqdm"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="python中Ansible模块的Playbook理解"><meta name="twitter:description" content="Playbook 在上一节中，我们详细介绍了Ansible提供的一些常用模块。可以看到，Ansible中的每个模块专注于某一方面的功能。虽然每个模块实现的功能都比较简单，但是，将各个模块组合起来就可以实现比较复杂的功能。在Ansible中，将各个模块组合起来的文件是一个YAML格式的配置文件。这个配置文件，在Ansible中称为Playbook。 在这一节中，我们将循序渐进地介绍Ansible中的"><meta name="twitter:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq128p.jpg"><meta property="og:type" content="article"><meta property="og:title" content="python中Ansible模块的Playbook理解"><meta property="og:url" content="https://wsdlxgp.top/posts/1331.html"><meta property="og:site_name" content="Xgp &amp; Blog"><meta property="og:description" content="Playbook 在上一节中，我们详细介绍了Ansible提供的一些常用模块。可以看到，Ansible中的每个模块专注于某一方面的功能。虽然每个模块实现的功能都比较简单，但是，将各个模块组合起来就可以实现比较复杂的功能。在Ansible中，将各个模块组合起来的文件是一个YAML格式的配置文件。这个配置文件，在Ansible中称为Playbook。 在这一节中，我们将循序渐进地介绍Ansible中的"><meta property="og:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq128p.jpg"><meta property="article:published_time" content="2019-10-15T16:01:00.000Z"><meta property="article:modified_time" content="2020-06-30T06:54:35.676Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://wsdlxgp.top/posts/1331.html"><link rel="prev" title="Python的SaltStack" href="https://wsdlxgp.top/posts/1332.html"><link rel="next" title="python自动化管理Ansible" href="https://wsdlxgp.top/posts/5017.html"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cad0cd04042fcca2c687648c42a45fc9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: Wu Shao Dong","link":"链接: ","source":"来源: Xgp & Blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/self/Kimbiedark.css"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Xgp & Blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/666.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">132</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">76</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">1.</span> <span class="toc-text">Playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、Playbook的定义"><span class="toc-number">1.1.</span> <span class="toc-text">1、Playbook的定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、ansible拆分playbook-yml"><span class="toc-number">1.2.</span> <span class="toc-text">2、ansible拆分playbook.yml</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看一下所需文件是否正确"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">查看一下所需文件是否正确</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#拆分playbook-yml"><span class="toc-number">1.2.1.</span> <span class="toc-text">拆分playbook.yml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、使用Ansible-playbook执行Playbook"><span class="toc-number">1.3.</span> <span class="toc-text">3、使用Ansible-playbook执行Playbook</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">2.</span> <span class="toc-text">二、Playbook的详细语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）权限"><span class="toc-number">2.0.1.</span> <span class="toc-text">（1）权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例"><span class="toc-number">2.0.2.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#执行一下"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">执行一下</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）通知"><span class="toc-number">2.0.3.</span> <span class="toc-text">（2）通知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）变量"><span class="toc-number">2.0.4.</span> <span class="toc-text">（3）变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（4）Facts变量"><span class="toc-number">2.0.5.</span> <span class="toc-text">（4）Facts变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（5）循环"><span class="toc-number">2.0.6.</span> <span class="toc-text">（5）循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（6）条件"><span class="toc-number">2.0.7.</span> <span class="toc-text">（6）条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（7）任务执行策略"><span class="toc-number">2.0.8.</span> <span class="toc-text">（7）任务执行策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、案例：使用Playbook部署nginx"><span class="toc-number">2.1.</span> <span class="toc-text">4、案例：使用Playbook部署nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#第二台服务器启动一下nginx"><span class="toc-number">2.1.1.</span> <span class="toc-text">第二台服务器启动一下nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#浏览器访问一下"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">浏览器访问一下</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq128p.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Xgp &amp; Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">python中Ansible模块的Playbook理解</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-10-16 00:01:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-10-16</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-30 14:54:35"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-30</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/python/">python</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon far fa-file-word" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">8k</span><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-clock" aria-hidden="true"></i><span>阅读时长: 33 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1>Playbook</h1>
<p><strong>在上一节中，我们详细介绍了Ansible提供的一些常用模块。可以看到，Ansible中的每个模块专注于某一方面的功能。虽然每个模块实现的功能都比较简单，但是，将各个模块组合起来就可以实现比较复杂的功能。在Ansible中，将各个模块组合起来的文件是一个YAML格式的配置文件。这个配置文件，在Ansible中称为Playbook。</strong></p>
<p><strong>在这一节中，我们将循序渐进地介绍Ansible中的Playbook，我们将首先介绍Playbook的定义，然后介绍如何使用Playbook完成远程服务器部署，之后详细介绍Playbook的基本语法，使用Playbook的基本讲法就能够完成大部分的部署任务。</strong></p>
<p><strong>在这一节中，找们将介绍如何使用Playbook的基本语法完成nginx与MongoDB的部署，最后，我们介绍了部分Playbook的高级语法。</strong></p>
<h2 id="1、Playbook的定义"><strong>1、Playbook的定义</strong></h2>
<p><strong>Playbook不同于其他使用单个模块操作远程服务器，Playbook的功能更加强大。如果只使用Playbook的基本功能，那么，Playbook是一个非常简单的配、管理和部署系统。此外，Playbook也可以实现各种高级功能，如指定任务的执行顺序，委派其他主机来执行某一个任务，与监控服务器和负载均衡组件进行交互等。</strong></p>
<p><strong>有一个非常恰当的比喻,，Ansible中的模块类似于Linux下的命令，Ansible中的Playbook类似于Linux下的Shell脚本文件。Shell脚本文件将各个Linux命令组合起来，以此实现复杂的功能，Playbook将各个模块组合起来也可以实现复杂的部署功能。在shell脚本中，除了调用Linux命令以外，还有一些基本的语法，如变量定义、if语句、for循环等。在Playbook中，一方面通过YAML格式进行定义提高Playbook的可读性、可维护性，降低工程师的学习负担；另一方面，Ansible提供了若干可以应用在Playbook中的选项，以便工程师实现更加高级的功能。</strong></p>
<p><strong>一个Playbook可以包含一到多个Play，每一个Play是一个完整的部署任务。在Play中，我们需要指定对哪些远程服务器执行操作，以及对这些远程服务器执行哪些操作。</strong></p>
<p><strong>下面是一个名为first_playbook.yml的Playbook。在这个Playbook中，我们定义了两个Play，前者用来在数据库服务器上部署MongoDB，后者用来在web服务器上部署“应用”。这里只是为了对Playbook进行演示，并没有真的部署应用。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-string">[root@python</span> <span class="hljs-string">~]#</span> <span class="hljs-string">vim</span> <span class="hljs-string">first_playbook.yml</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">mongodb</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=mongodb-server</span> <span class="hljs-string">state=present</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/data.txt</span> <span class="hljs-string">dest=/tmp/data.txt</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">change</span> <span class="hljs-string">mode</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">dest=/tmp/data.txt</span> <span class="hljs-string">mode=655</span> <span class="hljs-string">owner=root</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-string">[root@python</span> <span class="hljs-string">~]#</span> <span class="hljs-string">vim</span> <span class="hljs-string">first_playbook.yml</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">mongodb</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=mongodb-server</span> <span class="hljs-string">state=present</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">copy:</span> <span class="hljs-string">src=/tmp/data.txt</span> <span class="hljs-string">dest=/tmp/data.txt</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">change</span> <span class="hljs-string">mode</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">dest=/tmp/data.txt</span> <span class="hljs-string">mode=655</span> <span class="hljs-string">owner=root</span> <span class="hljs-string">group=root</span><br></code></pre></td></tr></table></figure>
<p><strong>这个Playbook中包含了两个Play。一个Playbook可以包含一到多个Play，所以即使Playbook中值包含一个Play，也需要使用列表的形式进行定义。在YAML语法中，“- hosts”前面的“-”表示定义列表。</strong></p>
<p><strong>在Ansible中，一个Play必须包含以下两项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs tex"><code class="language-hljs tex">1. hosts：需要对哪些远程服务器执行操作<br>2. tasks：需要在这些服务器上执行的任务列表<br></code></pre></td></tr></table></figure>
<p><strong>例如，对web服务器进行部署时，我们仅仅使用了hosts和tasks两个选项。前者表示对哪些服务器执行操作，后者表示对服务器执行哪些操作。在部署数据库服务器时需要安装软件，因此使用了become与become_method两个选项，用来表示使用管理员的身份去安装MongoDB数据库。</strong></p>
<p><strong>一个Play可以包含一到多个task，因此task也必须以YAML的列表形式进行定义。可以看到，在这个例子中，对数据库服务器进行操作时仅包含了一个task，对web服务器进行部署时包含了两个task。</strong></p>
<p><strong>在Ansible中，task有两种定义形式：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs tex"><code class="language-hljs tex">1. action：module options<br>2. module：options<br></code></pre></td></tr></table></figure>
<p><strong>前一种形式是Ansible的旧版本语法，第2种形式是新版本的语法，直接使用模块的名称作为键，使用模块的参数作为值。如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">update_cache=yes</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">update_cache=yes</span> <span class="hljs-string">state=present</span><br></code></pre></td></tr></table></figure>
<p><strong>在安装Apache的例子中，“name=httpd update_cache=yes state=present”是一个完整的字符串，而不是一个字典。只是字符串的值是一个“key=value”形式的参数。</strong></p>
<p><strong>在参数较多时，为了增加Playbook的可读性，我们也可以像下面这样定义一个task：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">&gt;</span><br>    <span class="hljs-string">name=httpd</span><br>    <span class="hljs-string">update_cache=yes</span><br>    <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">&gt;</span><br>    <span class="hljs-string">name=httpd</span><br>    <span class="hljs-string">update_cache=yes</span><br>    <span class="hljs-string">state=present</span><br></code></pre></td></tr></table></figure>
<p><strong>在Ansible中，当参数较长时，除了使用“&gt;”进行折叠换行以外，也可以使用缩进字块的形式：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <br>    <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span><br>    <span class="hljs-attr">update_cache:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <br>    <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span><br>    <span class="hljs-attr">update_cache:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br></code></pre></td></tr></table></figure>
<p><strong>虽然从字面来看，这两种指定参数的方式相差不大。但是，从YAML的语法来说，这是完全不同的两个方法。前者是一个比较长的字符串，后者是一个字典。</strong></p>
<p><strong>task的定义中，name是可选的。所以，像下面这样定义task也是完全合法的：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">update_cache=yes</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">update_cache=yes</span> <span class="hljs-string">state=present</span><br></code></pre></td></tr></table></figure>
<p><strong>name的作用在于，执行Playbook时作为注释进行显示，以便使用者知道当前执行到哪一步。因此，在定义task时，一般都会定义name字段。</strong></p>
<p><strong>在实际工作中，虽然一个Playbook可以包含多个Play，但是为了Playbook的可读性和可维护性，我们一般只会在Playbook中编写一个Play。例如，对于这里的例子，我们可以将first_playbook.yml这个Playbook拆分成两个Playbook，分别名为db.yml与web.yml。其中，db.yml文件包含了与数据库服务器相关的部署任务，web.yml文件包含了与web服务器相关的部署任务。</strong></p>
<p><strong>当我们需要部署数据库服务器和web服务器时，可以先执行db.yml文件，再执行web.yml文件。除此之外，Ansible还提供了一种便捷方式来处理这种情况。例如，我们可以编写一个名为all.yml的Playbook，它的内容如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">db.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">db.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">web.yml</span><br></code></pre></td></tr></table></figure>
<p><strong>include选项是Ansible提供的，用于在一个Playbook中导入其他Playbook。在Ansible中，只需要使用include选项导入其他Playbook文件，执行这个Playbook时，被导入的Playbook便会依次执行。</strong></p>
<p><strong>上面详细介绍了Ansible的Playbook定义，这个Playbook定义虽然比较简单，但是，是一个比较完整的Playbook例子。在实际工作中使用的Playbook也不会比这个Playbook复杂很多。</strong></p>
<p><strong>我们接下来将介绍如何使用ansible-playbook命令执行Playbook，然后再介绍Playbook的其他语法。</strong></p>
<h2 id="2、ansible拆分playbook-yml">2、ansible拆分playbook.yml</h2>
<h4 id="查看一下所需文件是否正确">查看一下所需文件是否正确</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@python ~]# cat hosts <br>127.0.0.1<br>[webservers]<br>192.168.1.60<br>[dbservers]<br>192.168.1.80<br>[common:children]<br>dbservers<br>webservers<br>[root@python ~]# cat /etc/ansible/ansible.cfg <br>[defaults]<br>remote_user = root<br>remote_port = 22<br>inventory = /root/hosts<br></code></pre></td></tr></table></figure>
<h3 id="拆分playbook-yml">拆分playbook.yml</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@python ~]# cat db.yml <br>---<br>- hosts: dbservers<br>  become: yes<br>  become_method: sudo<br>  tasks:<br>  - name: install mongodb<br>    yum: name=mongodb-server state=present  #mongodb-server 可欢成其他服务如（git）<br>[root@python ~]# cat web.yml <br>---<br>- hosts: webservers<br>  tasks:<br>  - name: copy file<br>    copy: src=/tmp/data.txt dest=/opt/data.txt <br>  - name: change mode<br>    file: dest=/opt/data.txt mode=655 owner=root group=root<br>[root@python ~]# cat all.yml <br>---<br>- include: db.yml<br>- include: web.yml<br>[root@python ~]# touch /tmp/data.txt<br>[root@python ~]# touch /opt/data.txt<br></code></pre></td></tr></table></figure>
<h2 id="3、使用Ansible-playbook执行Playbook">3、使用Ansible-playbook执行Playbook</h2>
<p><strong>上一小节中，我们简单地介绍了Playbook的定义。那么，当我们有了一个Playbook文件以后，如何执行这个文件完成应用部署呢？我们知道，Ansible安装完成以后存在多个可执行的命令行工具，其中，ansible-playbook便是用于执行Playbook的命令行工具。</strong></p>
<p><strong>ansible-playbook的执行方式如下:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs python"><code class="language-hljs python">ansible-playbook first_playbook.yml<br></code></pre></td></tr></table></figure>
<p><strong>ansible-playbook命令也有若干命令行选项，其中,有部分选项与ansible命令相同。Ansible中也存在一些ansible-playbook特有的命令行选项。</strong></p>
<p><strong>ansible-playbook命令与ansible命令相同的命令行选项:</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs tex"><code class="language-hljs tex">-T --timeout：建立SSH连接的超时时间<br>--key-file --private-key：建立SSH连接的私钥文件<br>-i --inventory-file：指定Inventory文件，默认是/etc/ansible/hosts<br>-f --forks：并发执行的进程数，默认为5<br>--list-hosts：playbooks匹配的服务器列表。<br></code></pre></td></tr></table></figure>
<p><strong>ansible-playbook也有一个名为–list-hosts的选项，该选项的作用是列出匹配的服务器列表。例如，在我们这个 Playbook的例子中，hosts文件的内容如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">127.0.0.1<br>[webservers]<br>192.168.1.60<br>[dbservers]<br>192.168.1.80<br>[common:children]<br>dbservers<br>webservers<br></code></pre></td></tr></table></figure>
<p><strong>我们知道，Ansible中的Play定义了需要对哪些服务器执行哪些操作，也就是说，每一个Play都可以指定匹配的远程服务器。在我们这个Playbook的例子中，对数据库服务器安装MongoDB，对web服务器部署“应用“。因此，ansible-playbook命令与ansible命令的–list-hosts选项输出的结果将会大不相同。ansible-playbook命令的–list-hosts选项输出的结果如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@python ~]# ansible-playbook all.yml --list-hosts<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520151225728.png" alt="image-20200520151225728"></p>
<p><strong>ansible-playbook命令有一些特有的选项，如下所示：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs tex"><code class="language-hljs tex">--list-tasks：列出任务列表<br>--step：每执行一个任务后停止，等待用户确认<br>--syntax-check：检查Playbook语法<br>-C --check：检查当前这个Playbook是否会修改远程服务器，相当于预测Playbook的执行结果。<br></code></pre></td></tr></table></figure>
<p><strong>这里的几个选项，除了–step以外，其他几个选项都不会执行Playbook中的任务。这些选项存在主要是为了便于调试Playbook。例如，–list-tasks选项，该选项用来显示当前Playbook中的任务列表。当Playbook比较大时，可以通过这个方式快速查看任务列表。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@python ~]#  ansible-playbook  all.yml --list-tasks<br>playbook: all.yml<br><br>  play #1 (dbservers): dbservers	TAGS: []<br>    tasks:<br>      install mongodb	TAGS: []<br><br>  play #2 (webservers): webservers	TAGS: []<br>    tasks:<br>      copy file	TAGS: []<br>      change mode	TAGS: []<br></code></pre></td></tr></table></figure>
<p><strong>当我们查看任务列表时，任务的名称就是task的name字段。因此，name的定义需要具有较好的描述性，让使用者通过名字就能知道该任务需要做什么事情。</strong></p>
<p><strong>–step选项类似于编程语言中的单步调试。当我们使–step选项执行Playbook时，ansible-playbook在每一个任务之前都会停住，等侍用户输入yes,、no或continue。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@python ~]# ansible-playbook all.yml --step<br>[DEPRECATION WARNING]: 'include' for playbook includes. You should use <br>'import_playbook' instead. This feature will be removed in version 2.12. <br>Deprecation warnings can be disabled by setting deprecation_warnings=False in <br>ansible.cfg.<br><br>PLAY [dbservers] ***************************************************************<br>Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: y<br><br>Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: *********************<br><br>TASK [Gathering Facts] *********************************************************<br>ok: [192.168.1.80]<br>Perform task: TASK: install mongodb (N)o/(y)es/(c)ontinue: y<br><br>Perform task: TASK: install mongodb (N)o/(y)es/(c)ontinue: *********************<br><br>TASK [install mongodb] *********************************************************<br>changed: [192.168.1.80]<br><br>PLAY [webservers] **************************************************************<br>Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: y<br><br>Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: *********************<br><br>TASK [Gathering Facts] *********************************************************<br>ok: [192.168.1.60]<br>Perform task: TASK: copy file (N)o/(y)es/(c)ontinue: y<br><br>Perform task: TASK: copy file (N)o/(y)es/(c)ontinue: ***************************<br><br>TASK [copy file] ***************************************************************<br>changed: [192.168.1.60]<br>Perform task: TASK: change mode (N)o/(y)es/(c)ontinue: y<br><br>Perform task: TASK: change mode (N)o/(y)es/(c)ontinue: *************************<br><br>TASK [change mode] *************************************************************<br>changed: [192.168.1.60]<br><br>PLAY RECAP *********************************************************************<br>192.168.1.60               : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   <br>192.168.1.80               : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0<br></code></pre></td></tr></table></figure>
<p><strong>输入yes以后，任务将会继续执行，并在下一个任务时停止，等待用户继续输入。当我们输入continue时，Ansible会执行完当前这个Play，当执行到下一个Play时再停止，并等待用户输入。</strong></p>
<h1>二、Playbook的详细语法</h1>
<p><strong>到目前为止，我们已经学习了如何编写Playbook以及如何运行Playbook。但是，我们仅仅介绍了最简单的Playbook。在这一节中，我们将会介绍Playbook是如何通过不同的选项提供丰富多样的功能。灵活使用这些选项，能够编写出形式各异的Playbook，以此应对自动部署中的各种情况。</strong></p>
<p><strong>在定义Play时，只有hosts与tasks是必选选项，其他选项都是根据需要添加的。在这一小节中。我们将介绍Playbook提供的不同功能，以Playbook的功能为线索，介绍Play与task中可以使用的选项。</strong></p>
<h3 id="（1）权限"><strong>（1）权限</strong></h3>
<p><strong>在Ansible中，默认使用当前用户连接远程服务器执行操作。我们也可以在anaible.cfg文件中配置连接远程服务器的默认用户。此外，如果是不同的用户使用不同类型的远程服务器，那么也可以在Playbook的Play定义中指定连接远程服务器的用户。例如，我们可以指定执行Play的用户：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br></code></pre></td></tr></table></figure>
<p><strong>用户可以细分每一个task，如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">werbservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">connection</span><br>      <span class="hljs-attr">ping:</span><br>        <span class="hljs-attr">remote_user:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">werbservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">connection</span><br>      <span class="hljs-attr">ping:</span><br>        <span class="hljs-attr">remote_user:</span> <span class="hljs-string">yourname</span><br></code></pre></td></tr></table></figure>
<p><strong>很多时候，我们需要的不是以某个特定用户连接远程服务器，而是在需要更高级别的权限时，使用管理员身份去执行操作。在ansible中，可以通过become与become_ method选项实现：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">werbservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">werbservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br></code></pre></td></tr></table></figure>
<p><strong>与remote_user选项类似，我们也可以为单个任务使用管理员权限，如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">werbservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">yourname</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">installed</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span><br>      <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>      <span class="hljs-attr">become_method:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">werbservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">yourname</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">installed</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span><br>      <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>      <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span><br></code></pre></td></tr></table></figure>
<h3 id="实例">实例</h3>
<p><strong>先修改远程服务器中test的权限为（0:0）</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@192 ~]# vim /etc/passwd<br>test:x:0:0::/home/test:/bin/bash<br>[root@python ~]# chown test:root /etc/ansible/*<br>[root@python ~]# su test<br>[test@python root]$ cd <br>[test@python ~]$ vim hosts<br>[db]<br>192.168.1.60<br><br>[test@python ~]$ vim db.yml<br><br>---<br>- hosts: db<br>  remote_user: root             #远程服务器登陆的用户<br>  tasks:<br>    - name: installed nginx<br>      become: yes<br>      become_method: sudo<br>      ping:<br>        remote_user: root         #远程服务器登陆的用户<br>[test@python ~]$ vim /etc/ansible/ansible.cfg <br><br>[defaults]<br>inventory = /home/test/hosts<br></code></pre></td></tr></table></figure>
<h4 id="执行一下">执行一下</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[test@python ~]$ sudo ansible-playbook db.yml --step<br><br>We trust you have received the usual lecture from the local System<br>Administrator. It usually boils down to these three things:<br><br>    #1) Respect the privacy of others.<br>    #2) Think before you type.<br>    #3) With great power comes great responsibility.<br><br>[sudo] password for test: <br><br>PLAY [db] **********************************************************************<br>Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: y<br><br>Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: *********************<br><br>TASK [Gathering Facts] *********************************************************<br>Enter passphrase for key '/root/.ssh/id_rsa': <br>ok: [192.168.1.60]<br>Perform task: TASK: installed nginx (N)o/(y)es/(c)ontinue: <br><br>Perform task: TASK: installed nginx (N)o/(y)es/(c)ontinue: *********************<br><br>PLAY RECAP *********************************************************************<br>192.168.1.60               : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0<br></code></pre></td></tr></table></figure>
<h3 id="（2）通知">（2）通知</h3>
<p><strong>在Ansible中，模块是幂等的。例如，我们要在远程服务器上创建一个用户，如果该用户已经存在，那么Ansible不会将该用户删除以后重新创建，而是直接返回成功，并通过changed字段表示是否对远程服务器进行了修改。</strong></p>
<p><strong>考虑这样一种需求：我们要通过Ansible修改Apache的配置文件，并重启Apache服务，使得新的配置文件生效。由于Ansible的模块是幂等的，当我们修改Apache的配置文件时，如果配置文件的内容已经与我们想要修改成的内容一样（例如，不小心将Ansible执行了两次的情况），那么，Ansible就什么也不做。既然Apache的配置文件并没有真的被修改，那么我们也不应该去重启Apache的服务器。在Ansible中，通过notify与handler机制来实现这里的功能。</strong></p>
<p><strong>在下面的例子中，我们首先尝试安装Apache，然后修改Apache的配置文件。如果配置文件被修改，则通过notify选项通知handler进行后续处理。</strong></p>
<p><strong>handler是Ansible提供的条件机制，与tasks比较类似，都是去执行某些操作。但是，handler只有在被notify触发以后才会执行，如果没有被触发则不会执行。在Playbook中，如果task后面存在notify选项，那么，当Ansible识别到task改变了系统的状态，就会通过notify去触发handler。</strong></p>
<p><strong>Ansibie是通过什么条件判断notify触发的是哪一个handler呢？很简单，在Ansible中，task使用handler的名字作为参数，以此来触发特定的handler。例如，在我们这里的例子中，notify触发的是“restart apache&quot;这个handler, handlers中也存在一个名为&quot; restart apache“的handler。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">apache</span> <span class="hljs-string">is</span> <span class="hljs-string">at</span> <span class="hljs-string">the</span> <span class="hljs-string">latest</span> <span class="hljs-string">version</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=latest</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">write</span> <span class="hljs-string">the</span> <span class="hljs-string">apache</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">template:</span> <span class="hljs-string">src=/srv/httpd.j2</span> <span class="hljs-string">dest=/etc/httpd.conf</span><br>    <span class="hljs-attr">notify:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">restart</span> <span class="hljs-string">apache</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">apache</span> <span class="hljs-string">is</span> <span class="hljs-string">running</span><br>    <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span><br>    <br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">apache</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">apache</span> <span class="hljs-string">is</span> <span class="hljs-string">at</span> <span class="hljs-string">the</span> <span class="hljs-string">latest</span> <span class="hljs-string">version</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=latest</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">write</span> <span class="hljs-string">the</span> <span class="hljs-string">apache</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">template:</span> <span class="hljs-string">src=/srv/httpd.j2</span> <span class="hljs-string">dest=/etc/httpd.conf</span><br>    <span class="hljs-attr">notify:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">restart</span> <span class="hljs-string">apache</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">apache</span> <span class="hljs-string">is</span> <span class="hljs-string">running</span><br>    <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span><br>    <br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">apache</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=restarted</span><br></code></pre></td></tr></table></figure>
<p><strong>需要注意的是，handler只会在所有task执行完后执行。并且，即便一个handler被触发多次，它也只会执行一次。handler并不是在被触发时立即执行，而是按照Play中定义的顺序执行。一般情况下，handler都位于Play的最后，即在所有任务执行完成以后再执行。</strong></p>
<p><strong>Ansible官方文档提到handler的唯一用途，就是重启服务与服务器，正如找们这个例子所演示的。</strong></p>
<p><strong>在这个例子中，我们还用到T了template模块。template模块用以渲染Jinja模板。</strong></p>
<h3 id="（3）变量">（3）变量</h3>
<p><strong>在Inventory管理章节，我们已经介绍了如何定义变量。在Ansible中，还有其他几种定义变量的方式。对于简单的Playbook，最直接的方式是将变量定义在Playbook的vars选项中。如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">mysql_port:</span> <span class="hljs-number"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">mysql_port:</span> <span class="hljs-number">3307</span><br></code></pre></td></tr></table></figure>
<p><strong>在Playbook中定义变量，可以在模板渲染时使用。例如：Ansible官方给出的例子中，MySQL配置文件的部分模板如下：</strong></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">datadir</span>=/var/lib/mysql<br><span class="hljs-attr">socket</span>=/var/lib/mysql/mysql.sock<br><span class="hljs-attr">user</span>=mysql<br><span class="hljs-attr"><code class="language-hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">datadir</span>=/var/lib/mysql<br><span class="hljs-attr">socket</span>=/var/lib/mysql/mysql.sock<br><span class="hljs-attr">user</span>=mysql<br><span class="hljs-attr">port</span>=&#123;&#123; mysql_port &#125;&#125;<br></code></pre></td></tr></table></figure>
<p><strong>当变量较少的时候，定义在vars选项中完全没有问题。当变量较多时，可以将变量保存在一个独立的文件中，并通过vars_files选项引用该文件。如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">favcolor:</span> <span class="hljs-string">blue</span><br>  <span class="hljs-attr">vars_files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/vars/external_vars.yml</span><br>    <br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">this</span> <span class="hljs-string">is</span> <span class="hljs-string">just</span> <span class="hljs-string">a</span> <span class="hljs-string">placeholer</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/echo</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">favcolor:</span> <span class="hljs-string">blue</span><br>  <span class="hljs-attr">vars_files:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/vars/external_vars.yml</span><br>    <br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">this</span> <span class="hljs-string">is</span> <span class="hljs-string">just</span> <span class="hljs-string">a</span> <span class="hljs-string">placeholer</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/echo</span> <span class="hljs-string">foo</span><br></code></pre></td></tr></table></figure>
<p><strong>保存变量的文件是一个简单的YAML格式的字典，如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># in th above example, this would be vars/external_vars.yml</span><br><span class="hljs-attr">somevar:</span> <span class="hljs-string">somevalue</span><br><span class="hljs-attr">password:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># in th above example, this would be vars/external_vars.yml</span><br><span class="hljs-attr">somevar:</span> <span class="hljs-string">somevalue</span><br><span class="hljs-attr">password:</span> <span class="hljs-string">magic</span><br></code></pre></td></tr></table></figure>
<p><strong>在shell脚本中，我们可以通过获取上一条命令的返回码判断命令是否执行成功。在Ansible中，我们也可以获取任务的执行结果，将任务的执行结果保存在一个变最中，并在之后引用这个变量。这样的变量在Ansible中使用register选项获取，也称为注册变量。</strong></p>
<p><strong>例如，在下面这个例子中，我们首先执行/usr/bin/foo命令，并通过register选项获取命令的执行结果，将结果保存在foo_result中。在之后的task中，使用这个变量名引用/usr/bin/foo命令的执行结果。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web_servers</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/bin/foo</span><br>    <span class="hljs-attr">register:</span> <span class="hljs-string">foo_result</span><br>    <span class="hljs-attr">ignore_errors:</span> <span class="hljs-literal">True</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/bin/bar</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">foo_result</span> <span class="hljs-string">==</span> <span class="hljs-number"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web_servers</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/bin/foo</span><br>    <span class="hljs-attr">register:</span> <span class="hljs-string">foo_result</span><br>    <span class="hljs-attr">ignore_errors:</span> <span class="hljs-literal">True</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/bin/bar</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">foo_result</span> <span class="hljs-string">==</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>
<p><strong>这个例子还涉及了两个新的选项，分别是ignore_errors与when。前者表示忽略当前task中的错误，后者是一个条件语句，只有条件为真时才会执行这个task。</strong></p>
<h3 id="（4）Facts变量"><strong>（4）Facts变量</strong></h3>
<p><strong>在Ansible中，还有一些特殊的变量，这些变量不需要我们进行任何设置就可以直接使用，这样的变量称为Facts变量。Facts变量是Ansible执行远程部署之前从远程服务器中获取的系统信息，包括服务器的名称、IP地址、操作系统、分区信息、硬件信息等。Facts变量可以配合Playbook实现更加个性化的功能需求。例如，将MongoDB数据库的数据保存在/var/mongo-&lt;hostname&gt;/目录下。</strong></p>
<p><strong>我们可以通过setup模块查看Facts变量的列表，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs python"><code class="language-hljs python">ansible all -m setup<br></code></pre></td></tr></table></figure>
<p><strong>有了Facts变量以后，如何在Ansible中使用它们呢？答案是直接使用。我们可以在Playbook中直接通过变量的名字引用变量，也可以在Jinja2模板中通过变量的名字引用变量。下面是一个名为test_facts.yml的Playbook。在这个Playbook中，我们输出了操作系统的类型，并且只有在操作系统为“RedHat&quot;类操作系统时才会执行安装操作。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">myecho</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span> <span class="hljs-string">var=myecho.stdout_lines</span><br>    <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">git</span> <span class="hljs-string">on</span> <span class="hljs-string">Red</span> <span class="hljs-string">Hat</span> <span class="hljs-string">Linux</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=git</span> <span class="hljs-string">state=installed</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">==</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">myecho</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span> <span class="hljs-string">var=myecho.stdout_lines</span><br>    <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">git</span> <span class="hljs-string">on</span> <span class="hljs-string">Red</span> <span class="hljs-string">Hat</span> <span class="hljs-string">Linux</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=git</span> <span class="hljs-string">state=installed</span><br>      <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">==</span> <span class="hljs-string">"RedHat"</span><br></code></pre></td></tr></table></figure>
<p><strong>setup模块为了输出结果的可读性，对模块的输出进行了归类和整理。因此，当我们要访问复杂变量的子属性时，需要使用嵌套结构。例如，我们可以通过下面两种方式访问Ansible中的ipv4地址：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-string">ansible_ens33['ipv4']['address']</span><br><span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-string">ansible_ens33['ipv4']['address']</span><br><span class="hljs-string">ansible_ens33.ipv4.address</span><br></code></pre></td></tr></table></figure>
<p><strong>访问复杂的变量的Playbook：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">ansible_ens33['ipv4']['address']</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">myecho</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span> <span class="hljs-string">var=myecho.stdout_lines</span><br>    <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">ansible_ens33.ipv4.address</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">myecho</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">ansible_ens33['ipv4']['address']</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">myecho</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span> <span class="hljs-string">var=myecho.stdout_lines</span><br>    <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">ansible_ens33.ipv4.address</span> <span class="hljs-string">&#125;&#125;</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">myecho</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">debug:</span> <span class="hljs-string">var=myecho.stdout_lines</span><br></code></pre></td></tr></table></figure>
<p><strong>在实际工作中，我们一般会在Jinja2模板中引用Facts变量。使用方式与这里的例子一样，为了节省篇幅就不再赘述了。</strong></p>
<p><strong>在Playbook中，可以通过gather_ facts选项控制是否收集远程服务器的信息。该选项默认取值为yes，如果确定不需要用到远程服务器的信息，可以将该选项设置为no，以此提高Ansible部署的效率。如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">gather_factes:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbservers</span><br>  <span class="hljs-attr">gather_factes:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br></code></pre></td></tr></table></figure>
<h3 id="（5）循环"><strong>（5）循环</strong></h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Mysql</span> <span class="hljs-string">package</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=installed</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-server</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">MySQL-python</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">libselinux-python</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Mysql</span> <span class="hljs-string">package</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=installed</span><br>  <span class="hljs-attr">with_items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-server</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">MySQL-python</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">libselinux-python</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">libsemanage-python</span><br></code></pre></td></tr></table></figure>
<h3 id="（6）条件"><strong>（6）条件</strong></h3>
<p><strong>有时候，一个任务是否执行取决于一个变量的取值，或者上一个任务的执行结果，这个时候找们就需要条件语句。再或者说，在循环的时候想要跳过一些特定的元素，在服务器部署时只对某些特定的操作系统进行操作。所有这些行为都可以使用条件语句解决。Ansible的Playbook不是一门编程语言，因此没有相应的条件语句，不过Ansible提供了一个类似的选项。</strong></p>
<p><strong>在Playbook中可以通过when选项执行条件语句，when就类似于编程语言中的if语句。</strong></p>
<p><strong>下面是一个简单的when选项使用示例：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-comment"># 查看Linux系统版本：cat /etc/redhat-release</span><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"系统关机"</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">==</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-comment"># 查看Linux系统版本：cat /etc/redhat-release</span><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"系统关机"</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_os_family</span> <span class="hljs-string">==</span> <span class="hljs-string">"RedHat"</span><br></code></pre></td></tr></table></figure>
<p><strong>when选项也支持多个条件语句，下面是一个YAML格式的多条件：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"shutdown CentOS 7 systems"</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">"CentOS"</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"shutdown CentOS 7 systems"</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">"CentOS"</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">"7"</span><br></code></pre></td></tr></table></figure>
<p><strong>对于更复杂的条件可以使用and、or与括号进行定义：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"shutdown CentOS 7 and Debian 6 systems"</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">(ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">"CentOS"</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">"7"</span><span class="hljs-string">)</span> <span class="hljs-string">or</span> <span class="hljs-string">(ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">"Debian"</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">"6"</span><span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"shutdown CentOS 7 and Debian 6 systems"</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/sbin/shutdown</span> <span class="hljs-string">-t</span> <span class="hljs-string">now</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">(ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">"CentOS"</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">"7"</span><span class="hljs-string">)</span> <span class="hljs-string">or</span> <span class="hljs-string">(ansible_distribution</span> <span class="hljs-string">==</span> <span class="hljs-string">"Debian"</span> <span class="hljs-string">and</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">"6"</span><span class="hljs-string">)</span><br></code></pre></td></tr></table></figure>
<p><strong>在when选项中可以读取变量的取值，例如：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-attr">vars:</span><br>  <span class="hljs-attr">epic:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"This certainly is epic!"</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-attr">vars:</span><br>  <span class="hljs-attr">epic:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"This certainly is epic!"</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">epic</span><br></code></pre></td></tr></table></figure>
<p><strong>when选项可以与循环一起使用，以实现过滤的功能：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span><br>    <span class="hljs-attr">with_items:</span> <span class="hljs-string">[0,</span> <span class="hljs-number">2</span><span class="hljs-string">,</span> <span class="hljs-number">4</span><span class="hljs-string">,</span> <span class="hljs-number">6</span><span class="hljs-string">,</span> <span class="hljs-number">8</span><span class="hljs-string">,</span> <span class="hljs-number">10</span><span class="hljs-string">]</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">item</span> <span class="hljs-string">&gt;</span> <span class="hljs-number"><code class="language-hljs yaml"><span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span><br>    <span class="hljs-attr">with_items:</span> <span class="hljs-string">[0,</span> <span class="hljs-number">2</span><span class="hljs-string">,</span> <span class="hljs-number">4</span><span class="hljs-string">,</span> <span class="hljs-number">6</span><span class="hljs-string">,</span> <span class="hljs-number">8</span><span class="hljs-string">,</span> <span class="hljs-number">10</span><span class="hljs-string">]</span><br>    <span class="hljs-attr">when:</span> <span class="hljs-string">item</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>
<h3 id="（7）任务执行策略"><strong>（7）任务执行策略</strong></h3>
<p><strong>在Ansible中，Playbook的执行是以task为单位进行的。Ansible默认使用5个进程对远程服务器执行任务。在默认情况的任务执行策略( linear)中，Ansible首先执行task1，并且等到所有服务器执行完task1以后再开始执行task2，以此类推。从Ansible 2.0开始，Ansible支持名为free的任务执行策略，允许执行较快的远程服务器提前完成Play的部署，不用等待其他远程服务器一起执行task。如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">strategy:</span> <span class="hljs-string">free</span><br>  <span class="hljs-attr">tasks:</span><br>   <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">strategy:</span> <span class="hljs-string">free</span><br>  <span class="hljs-attr">tasks:</span><br>   <span class="hljs-string">……</span><br></code></pre></td></tr></table></figure>
<p><strong>在这一节中，我们比较详细地介绍了Ansible中的Playbook选项。在Ansible中，Play与task都有很多选项，每个选项可以实现不同的功能。Ansibie官方并没有通过功能的形式介绍不同的选项给出一个完整的选项列表。我们也可以参考https://github.com/lorin/ansible-quickref快速了解Play与task中的选项，以及各个选项的含义。</strong></p>
<h2 id="4、案例：使用Playbook部署nginx"><strong>4、案例：使用Playbook部署nginx</strong></h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo<br>//下载源<br></code></pre></td></tr></table></figure>
<p><strong>在这个例子中，我们使用Ansible配置一台服务器运行nginx进程。部署nginx的Playbook如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre class=" language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">worker_prosess:</span> <span class="hljs-number">4</span><br>    <span class="hljs-attr">worker_connections:</span> <span class="hljs-number">768</span><br>    <span class="hljs-attr">max_open_files:</span> <span class="hljs-number">65506</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">update_cache=yes</span> <span class="hljs-string">state=present</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">nginx</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=/root/test_ansible/nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">index.html</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/test_ansible/index.html.j2</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/usr/share/nginx/www/index.html</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string"><code class="language-hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">worker_prosess:</span> <span class="hljs-number">4</span><br>    <span class="hljs-attr">worker_connections:</span> <span class="hljs-number">768</span><br>    <span class="hljs-attr">max_open_files:</span> <span class="hljs-number">65506</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">update_cache=yes</span> <span class="hljs-string">state=present</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">nginx</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">template:</span> <span class="hljs-string">src=/root/test_ansible/nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">index.html</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/test_ansible/index.html.j2</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/usr/share/nginx/www/index.html</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-number">0644</span><br>      <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">handlers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=restarted</span><br></code></pre></td></tr></table></figure>
<p><strong>在这个Playbook中，我们首先通过hosts选项指定了要对哪些远程服务器执行操作。随后，我们通过become与become_method选项声明了部署时使用sudo权限。接下来，我们在vars字段中定义了三个变量，这三个变量将用在nginx的配置文件中。我们在tasks选项下定义了部署nginx服务的任务列表，包括软件安装、模板渲染、定制s首页和重启nginx进程。</strong></p>
<p><strong>为了避免配置文件在没有任何修改的情况下重启了nginx进程，这里使用了Ansible的handler机制。在这个Playbook中，存在两个notify选项，以及一个handler选项。无论是nginx的配置文件，还是定制首页发生了修改，我们都会重启nginx进程。由于我们使用了Ansible的handlers机制，因此，在没有任何修改的情况下，Ansible并不会重启nginx进程。使用handler机制还有一个好处，notify多次，handler也只会执行一次，避免了反复多次重启nginx进程。</strong></p>
<p><strong>在这个部署nginx服务的Playbook中，我们用到了nginx.conf.j2这个配置模板。这个模板使用的是Jinja2的语法，所以后缀名为j2。模板的内容如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@python ~]# mkdir test_ansible<br>[root@python ~]# vim /root/test_ansible/nginx.conf.j2<br>worker_processes  &#123;&#123; worker_prosess &#125;&#125;;<br>worker_rlimit_nofile &#123;&#123; max_open_files &#125;&#125;;<br><br>events &#123;<br>    worker_connections  &#123;&#123; worker_connections &#125;&#125;;<br>&#125;<br><br>http &#123;<br>trueserver &#123;<br>        listen       80;<br>truetrue<br>truetruelisten	443 ssl;<br>truetrue<br>        server_name  localhost;<br>truetrue<br>        location / &#123;<br>            root   /usr/share/nginx/www;<br>            index  index.html index.htm;<br>truetruetrue<br>truetruetruetr_files $uri $uri/ =404;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>Ansible会使用我们在Playbook的vars字段中定义的变量，将Jinja2模板渲染成真实的配置文件。</strong></p>
<p><strong>我们的Playbook还用到了一个名为index.html.j2的模板，该模板用于渲染网站首页。index.html.j2的内容如下：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs html">[root@python ~]# vim /root/test_ansible/index.html.j2<br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span><br>true<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>wellcome to ansible<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>true<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>true<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>nginx, configured by ansible<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>如果你能看到这个页面，说明ansible自动部署nginx成功了！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>truetrue<br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; ansible_hostname &#125;&#125;<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>true<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name"><code class="language-hljs html">[root@python ~]# vim /root/test_ansible/index.html.j2<br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span><br>true<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>wellcome to ansible<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>true<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>true<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>nginx, configured by ansible<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>如果你能看到这个页面，说明ansible自动部署nginx成功了！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>truetrue<br>truetrue<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; ansible_hostname &#125;&#125;<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>true<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>></span><br></code></pre></td></tr></table></figure>
<p><strong>在index.html.j2中，我们用到了一个名为ansible_hostname的变量。这个变量是Facts变量，是Ansible在执行Playbook之前从远程服务器获取到的信息。因此，我们不需要定义，直接使用即可。</strong></p>
<p><strong>有了Playbook以后，使用ansible-playbook命令进行部署。如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre class=" language-hljs python">[root@python ~]<span class="hljs-comment"># pip install Jinja2</span><br>[root@python ~]<span class="hljs-comment"># vim /etc/ansible/ansible.cfg </span><br><br>[defaults]<br>inventory = /root/hosts<br><br>[root@bogon ~]<span class="hljs-comment"># ansible-playbook nginx.yml</span><br><br>PLAY [webservers] **********************************************************************************************************<br><br>TASK [Gathering Facts] *****************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [install nginx] *******************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [copy nginx config file] **********************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [copy index.html] *****************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>PLAY RECAP *****************************************************************************************************************<br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>                  : ok=<span class="hljs-number">4</span>    changed=<span class="hljs-number">0</span>    unreachable=<span class="hljs-number">0</span>    failed=<span class="hljs-number">0</span>    skipped=<span class="hljs-number">0</span>    rescued=<span class="hljs-number">0</span>    ignored=<span class="hljs-number">0</span>   <br><br>[root@bogon ~]<span class="hljs-comment"><code class="language-hljs python">[root@python ~]<span class="hljs-comment"># pip install Jinja2</span><br>[root@python ~]<span class="hljs-comment"># vim /etc/ansible/ansible.cfg </span><br><br>[defaults]<br>inventory = /root/hosts<br><br>[root@bogon ~]<span class="hljs-comment"># ansible-playbook nginx.yml</span><br><br>PLAY [webservers] **********************************************************************************************************<br><br>TASK [Gathering Facts] *****************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [install nginx] *******************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [copy nginx config file] **********************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [copy index.html] *****************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>PLAY RECAP *****************************************************************************************************************<br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>                  : ok=<span class="hljs-number">4</span>    changed=<span class="hljs-number">0</span>    unreachable=<span class="hljs-number">0</span>    failed=<span class="hljs-number">0</span>    skipped=<span class="hljs-number">0</span>    rescued=<span class="hljs-number">0</span>    ignored=<span class="hljs-number">0</span>   <br><br>[root@bogon ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>
<p><strong>如果安装失败，可能是端口被占用，可以停止使用该端口的服务，或者更改nginx端口。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre class=" language-hljs python">[root@bogon ~]<span class="hljs-comment"># netstat -ntlp</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">111</span>             <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">1</span>/systemd           <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">6000</span>            <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7470</span>/X              <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">192.168</span><span class="hljs-number">.122</span><span class="hljs-number">.1</span>:<span class="hljs-number">53</span>        <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7654</span>/dnsmasq        <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">22</span>              <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7337</span>/sshd           <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">631</span>           <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7340</span>/cupsd          <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6010</span>          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6011</span>          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6012</span>          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">111</span>                  :::*                    LISTEN      <span class="hljs-number">1</span>/systemd           <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">80</span>                   :::*                    LISTEN      <span class="hljs-number">17867</span>/httpd         <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">6000</span>                 :::*                    LISTEN      <span class="hljs-number">7470</span>/X              <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">22</span>                   :::*                    LISTEN      <span class="hljs-number">7337</span>/sshd           <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">631</span>                 :::*                    LISTEN      <span class="hljs-number">7340</span>/cupsd          <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">6010</span>                :::*                    LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">6011</span>                :::*                    LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">6012</span>                :::*                    LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>[root@bogon ~]<span class="hljs-comment"><code class="language-hljs python">[root@bogon ~]<span class="hljs-comment"># netstat -ntlp</span><br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">111</span>             <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">1</span>/systemd           <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">6000</span>            <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7470</span>/X              <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">192.168</span><span class="hljs-number">.122</span><span class="hljs-number">.1</span>:<span class="hljs-number">53</span>        <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7654</span>/dnsmasq        <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">22</span>              <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7337</span>/sshd           <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">631</span>           <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">7340</span>/cupsd          <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6010</span>          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6011</span>          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">6012</span>          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:*               LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">111</span>                  :::*                    LISTEN      <span class="hljs-number">1</span>/systemd           <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">80</span>                   :::*                    LISTEN      <span class="hljs-number">17867</span>/httpd         <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">6000</span>                 :::*                    LISTEN      <span class="hljs-number">7470</span>/X              <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">22</span>                   :::*                    LISTEN      <span class="hljs-number">7337</span>/sshd           <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">631</span>                 :::*                    LISTEN      <span class="hljs-number">7340</span>/cupsd          <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">6010</span>                :::*                    LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">6011</span>                :::*                    LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-number">1</span>:<span class="hljs-number">6012</span>                :::*                    LISTEN      <span class="hljs-number">31653</span>/sshd: root@pt <br>[root@bogon ~]<span class="hljs-comment"># systemctl stop httpd.service</span><br></code></pre></td></tr></table></figure>
<h3 id="第二台服务器启动一下nginx">第二台服务器启动一下nginx</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs shell"><code class="language-hljs shell">[root@192 ~]# nginx -t<br>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br>nginx: configuration file /etc/nginx/nginx.conf test is successful<br>[root@192 ~]# nginx<br>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>nginx: [emerg] still could not bind()<br></code></pre></td></tr></table></figure>
<h4 id="浏览器访问一下">浏览器访问一下</h4>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200521170355706.png" alt="image-20200521170355706"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wu Shao Dong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wsdlxgp.top/posts/1331.html">https://wsdlxgp.top/posts/1331.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wsdlxgp.top" target="_blank">Xgp & Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nfs/">nfs</a><a class="post-meta__tags" href="/tags/deployment/">deployment</a><a class="post-meta__tags" href="/tags/pv/">pv</a><a class="post-meta__tags" href="/tags/pvc/">pvc</a><a class="post-meta__tags" href="/tags/dashboard/">dashboard</a><a class="post-meta__tags" href="/tags/helm/">helm</a><a class="post-meta__tags" href="/tags/StorageClass/">StorageClass</a></div><div class="post_share"><div class="social-share" data-image="http://xgp-cunchu.test.upcdn.net/k8s/325738.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/3.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/1.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/2.jpg" alt="QQ支付"/><div class="post-qr-code__desc">QQ支付</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/1332.html"><img class="prev_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq79p.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Python的SaltStack</div></div></a></div><div class="next-post pull_right"><a href="/posts/5017.html"><img class="next_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq77p.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">python自动化管理Ansible</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/e939.html" title="初识python"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq46p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">初识python</div></div></a></div><div class="relatedPosts_item"><a href="/posts/h8er.html" title="k8s复习"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq45p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">k8s复习</div></div></a></div><div class="relatedPosts_item"><a href="/posts/9a1f.html" title="python变量"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq47p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">python变量</div></div></a></div><div class="relatedPosts_item"><a href="/posts/9b8f.html" title="布尔表达式"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq49p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">布尔表达式</div></div></a></div><div class="relatedPosts_item"><a href="/posts/46cd.html" title="Python 列表"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq48p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">Python 列表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/7b33.html" title="python的input和while循环"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq51p.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-30</div><div class="relatedPosts_title">python的input和while循环</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM0NS8yNTgzNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/qweq128p.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Wu Shao Dong</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="ypy"><a href="https://console.upyun.com/services/file/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/1591433700(1).png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>