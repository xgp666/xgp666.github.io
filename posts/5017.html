<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>python自动化管理Ansible | Xgp &amp; Blog</title><meta name="description" content="一、Ansible介绍 Ansible是一个简单的自动化运维工具，可完成配置管理、应用部署、服务编排以及其他各种IT需求。Ansible也是一款基于Python语言实现的开源软件，其依赖Jinja2、paramiko和PYYAML这几个Python库。 1Ansible的作者是Michael Dehaan，Michael Dehaan同时也是知名软件Cobber的作者和Func的共同作者。Mich"><meta name="keywords" content="nfs,pv,pvc,dashboard,helm,StorageClass,python"><meta name="author" content="Wu Shao Dong"><meta name="copyright" content="Wu Shao Dong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://gitee.com/xgpqq/tuchuang/raw/master/img/Yun.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="rPK0WSwqdm"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="python自动化管理Ansible"><meta name="twitter:description" content="一、Ansible介绍 Ansible是一个简单的自动化运维工具，可完成配置管理、应用部署、服务编排以及其他各种IT需求。Ansible也是一款基于Python语言实现的开源软件，其依赖Jinja2、paramiko和PYYAML这几个Python库。 1Ansible的作者是Michael Dehaan，Michael Dehaan同时也是知名软件Cobber的作者和Func的共同作者。Mich"><meta name="twitter:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (77).jpg"><meta property="og:type" content="article"><meta property="og:title" content="python自动化管理Ansible"><meta property="og:url" content="https://wsdlxgp.top/posts/5017.html"><meta property="og:site_name" content="Xgp &amp; Blog"><meta property="og:description" content="一、Ansible介绍 Ansible是一个简单的自动化运维工具，可完成配置管理、应用部署、服务编排以及其他各种IT需求。Ansible也是一款基于Python语言实现的开源软件，其依赖Jinja2、paramiko和PYYAML这几个Python库。 1Ansible的作者是Michael Dehaan，Michael Dehaan同时也是知名软件Cobber的作者和Func的共同作者。Mich"><meta property="og:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (77).jpg"><meta property="article:published_time" content="2019-10-15T16:00:00.000Z"><meta property="article:modified_time" content="2020-06-19T05:11:52.139Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://wsdlxgp.top/posts/5017.html"><link rel="prev" title="python中Ansible模块的Playbook理解" href="https://wsdlxgp.top/posts/1331.html"><link rel="next" title="python自动化管理sshy与paramiko" href="https://wsdlxgp.top/posts/d003.html"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cad0cd04042fcca2c687648c42a45fc9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Xgp & Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/666.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">125</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">87</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">1.</span> <span class="toc-text">一、Ansible介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、Ansible的优点"><span class="toc-number">1.1.</span> <span class="toc-text">1、Ansible的优点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ansible具有以下几个优点："><span class="toc-number">1.1.1.</span> <span class="toc-text">Ansible具有以下几个优点：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）部署简单"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">（1）部署简单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）基于ssh进行配置管理，充分利用现成的机制"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">（2）基于ssh进行配置管理，充分利用现成的机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（3）Ansible不需要守护进程"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">（3）Ansible不需要守护进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（4）日志集中存储"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">（4）日志集中存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（5）Ansible简单易用"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">（5）Ansible简单易用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（6）Ansible功能强大"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">（6）Ansible功能强大</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（7）Ansible设计优秀，便于分享"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">（7）Ansible设计优秀，便于分享</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（8）Ansible对云计算和大数据平台都有很好的支持"><span class="toc-number">1.1.1.8.</span> <span class="toc-text">（8）Ansible对云计算和大数据平台都有很好的支持</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Ansible与Fabric之间的比较"><span class="toc-number">1.2.</span> <span class="toc-text">2、Ansible与Fabric之间的比较</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）Fabric与Ansible之间的共同点"><span class="toc-number">1.2.1.</span> <span class="toc-text">（1）Fabric与Ansible之间的共同点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）Fabric与Ansible之间的主要区别"><span class="toc-number">1.2.2.</span> <span class="toc-text">（2）Fabric与Ansible之间的主要区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">2.</span> <span class="toc-text">二、Ansible使用入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ansible使用原则："><span class="toc-number">2.0.1.</span> <span class="toc-text">ansible使用原则：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于hosts文件："><span class="toc-number">2.0.2.</span> <span class="toc-text">关于hosts文件：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1、安装Ansible"><span class="toc-number">2.1.</span> <span class="toc-text">1、安装Ansible</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Ansible的架构"><span class="toc-number">2.2.</span> <span class="toc-text">2、Ansible的架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、Ansible的运行环境"><span class="toc-number">2.3.</span> <span class="toc-text">3、Ansible的运行环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改test的权限"><span class="toc-number">2.4.</span> <span class="toc-text">修改test的权限</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#再次测试一下"><span class="toc-number">2.4.1.</span> <span class="toc-text">再次测试一下</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#常见错误解决方案如下："><span class="toc-number">2.4.1.0.1.</span> <span class="toc-text">常见错误解决方案如下：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#（1）ansible管理节点生成ssh-key"><span class="toc-number">2.4.1.0.1.1.</span> <span class="toc-text">（1）ansible管理节点生成ssh-key</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#（2）添加目标节点的ssh认证信息"><span class="toc-number">2.4.1.0.1.2.</span> <span class="toc-text">（2）添加目标节点的ssh认证信息</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#（3）测试"><span class="toc-number">2.4.1.0.1.3.</span> <span class="toc-text">（3）测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、Ansible的ad-hoc模式"><span class="toc-number">2.5.</span> <span class="toc-text">4、Ansible的ad-hoc模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）创建ansible-cfg文件"><span class="toc-number">2.5.1.</span> <span class="toc-text">（1）创建ansible.cfg文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#再次测试一下-2"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">再次测试一下</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）将本地文件拷贝到服务器"><span class="toc-number">2.5.2.</span> <span class="toc-text">（2）将本地文件拷贝到服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#进行拷贝"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">进行拷贝</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看一下是否有拷贝的文件"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">查看一下是否有拷贝的文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-创建剧本（拷贝）"><span class="toc-number">2.5.3.</span> <span class="toc-text">&lt;1&gt;创建剧本（拷贝）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#执行一下"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">执行一下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看是否有拷贝的文件"><span class="toc-number">2.5.3.2.</span> <span class="toc-text">查看是否有拷贝的文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）在远程服务器中安装软件"><span class="toc-number">2.5.4.</span> <span class="toc-text">（3）在远程服务器中安装软件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、使用playbook控制服务器"><span class="toc-number">2.6.</span> <span class="toc-text">5、使用playbook控制服务器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">3.</span> <span class="toc-text">三、Inventory管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、hosts文件位置"><span class="toc-number">3.1.</span> <span class="toc-text">1、hosts文件位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、灵活定义hosts文件内容"><span class="toc-number">3.2.</span> <span class="toc-text">2、灵活定义hosts文件内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）分组定义服务器"><span class="toc-number">3.2.1.</span> <span class="toc-text">（1）分组定义服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）查看单个分组的服务器列表"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">1）查看单个分组的服务器列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）查看多个分组的服务器列表（冒号分隔组名）"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">2）查看多个分组的服务器列表（冒号分隔组名）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3）使用all和星号匹配服务器"><span class="toc-number">3.2.1.3.</span> <span class="toc-text">3）使用all和星号匹配服务器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）Ansible定义组匹配服务器"><span class="toc-number">3.2.2.</span> <span class="toc-text">（2）Ansible定义组匹配服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看服务器列表"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">查看服务器列表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）批量定义服务器"><span class="toc-number">3.2.3.</span> <span class="toc-text">（3）批量定义服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看服务列表"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">查看服务列表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、灵活匹配hosts文件内容"><span class="toc-number">3.3.</span> <span class="toc-text">3、灵活匹配hosts文件内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、Inventory行为参数"><span class="toc-number">3.4.</span> <span class="toc-text">4、Inventory行为参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、改变行为参数的默认值"><span class="toc-number">3.5.</span> <span class="toc-text">5、改变行为参数的默认值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6、定义服务器变量"><span class="toc-number">3.6.</span> <span class="toc-text">6、定义服务器变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）变量的取值不同"><span class="toc-number">3.6.1.</span> <span class="toc-text">（1）变量的取值不同</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）变量的取值相同"><span class="toc-number">3.6.2.</span> <span class="toc-text">（2）变量的取值相同</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">4.</span> <span class="toc-text">四、YAML语法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、YAML语法规则"><span class="toc-number">4.1.</span> <span class="toc-text">1、YAML语法规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、YAML支持的3中格式数据"><span class="toc-number">4.2.</span> <span class="toc-text">2、YAML支持的3中格式数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、安装PyYAML库"><span class="toc-number">4.3.</span> <span class="toc-text">3、安装PyYAML库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、定义与解析YAML文件"><span class="toc-number">4.4.</span> <span class="toc-text">4、定义与解析YAML文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）数组格式"><span class="toc-number">4.4.1.</span> <span class="toc-text">（1）数组格式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#解析结果："><span class="toc-number">4.4.1.1.</span> <span class="toc-text">解析结果：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）对象"><span class="toc-number">4.4.2.</span> <span class="toc-text">（2）对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#解析结果：-2"><span class="toc-number">4.4.2.1.</span> <span class="toc-text">解析结果：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）对象和数组嵌套"><span class="toc-number">4.4.3.</span> <span class="toc-text">（3）对象和数组嵌套</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（4）注意事项"><span class="toc-number">4.4.4.</span> <span class="toc-text">（4）注意事项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number">5.</span> <span class="toc-text">五、Ansible模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、Ansible的模块工作原理"><span class="toc-number">5.1.</span> <span class="toc-text">1、Ansible的模块工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、模块列表与帮助信息"><span class="toc-number">5.2.</span> <span class="toc-text">2、模块列表与帮助信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、常用的Ansible模块"><span class="toc-number">5.3.</span> <span class="toc-text">3、常用的Ansible模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）ping"><span class="toc-number">5.3.1.</span> <span class="toc-text">（1）ping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）远程命令模块"><span class="toc-number">5.3.2.</span> <span class="toc-text">（2）远程命令模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）command模块"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">1）command模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）raw模块"><span class="toc-number">5.3.2.2.</span> <span class="toc-text">2）raw模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3）shell模块"><span class="toc-number">5.3.2.3.</span> <span class="toc-text">3）shell模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#统计某个文件有多少行"><span class="toc-number">5.3.2.4.</span> <span class="toc-text">统计某个文件有多少行</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#（3）file"><span class="toc-number">5.3.2.4.1.</span> <span class="toc-text">（3）file</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file模块使用示例："><span class="toc-number">5.3.2.5.</span> <span class="toc-text">file模块使用示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#file模块中重要选项："><span class="toc-number">5.3.2.6.</span> <span class="toc-text">file模块中重要选项：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-创建文件"><span class="toc-number">5.3.2.7.</span> <span class="toc-text">&lt;1&gt;创建文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#查看一下"><span class="toc-number">5.3.2.7.1.</span> <span class="toc-text">查看一下</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-创建目录"><span class="toc-number">5.3.2.8.</span> <span class="toc-text">&lt;2&gt;创建目录</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#查看一下-2"><span class="toc-number">5.3.2.8.1.</span> <span class="toc-text">查看一下</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-创建并删除文件"><span class="toc-number">5.3.2.9.</span> <span class="toc-text">&lt;3&gt;创建并删除文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#查看一下-3"><span class="toc-number">5.3.2.9.1.</span> <span class="toc-text">查看一下</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-创建并改变文件所有者"><span class="toc-number">5.3.2.10.</span> <span class="toc-text">&lt;4&gt;创建并改变文件所有者</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（4）copy"><span class="toc-number">5.3.3.</span> <span class="toc-text">（4）copy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（5）user-group"><span class="toc-number">5.3.4.</span> <span class="toc-text">（5）user&#x2F;group</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（6）yum"><span class="toc-number">5.3.5.</span> <span class="toc-text">（6）yum</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（7）get-url"><span class="toc-number">5.3.6.</span> <span class="toc-text">（7）get_url</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（8）unarchive"><span class="toc-number">5.3.7.</span> <span class="toc-text">（8）unarchive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（9）git"><span class="toc-number">5.3.8.</span> <span class="toc-text">（9）git</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（10）stat"><span class="toc-number">5.3.9.</span> <span class="toc-text">（10）stat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（11）cron"><span class="toc-number">5.3.10.</span> <span class="toc-text">（11）cron</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（12）service"><span class="toc-number">5.3.11.</span> <span class="toc-text">（12）service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（13）sysctl"><span class="toc-number">5.3.12.</span> <span class="toc-text">（13）sysctl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（14）setup"><span class="toc-number">5.3.13.</span> <span class="toc-text">（14）setup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（15）mount"><span class="toc-number">5.3.14.</span> <span class="toc-text">（15）mount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（16）synchronize"><span class="toc-number">5.3.15.</span> <span class="toc-text">（16）synchronize</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4、模块的返回值"><span class="toc-number">5.3.15.1.</span> <span class="toc-text">4、模块的返回值</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (77).jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Xgp &amp; Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">python自动化管理Ansible</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-10-16 00:00:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-10-16</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-19 13:11:52"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-19</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/python/">python</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon far fa-file-word" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">12.2k</span><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-clock" aria-hidden="true"></i><span>阅读时长: 47 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1>一、Ansible介绍</h1>
<p><strong>Ansible是一个简单的自动化运维工具，可完成配置管理、应用部署、服务编排以及其他各种IT需求。Ansible也是一款基于Python语言实现的开源软件，其依赖Jinja2、paramiko和PYYAML这几个Python库。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs txt">Ansible的作者是Michael Dehaan，Michael Dehaan同时也是知名软件Cobber的作者和Func的共同作者。Michael Dehaan与2012年创建了AnsibleWorks公司，之后改名为Ansible公司。Ansible公司与2015年10月被红帽公司（Red Hat）收购。<br></code></pre></td></tr></table></figure>
<p><strong>在这一小节，我们将首先介绍Ansible的优点，然后比较Ansible与Fabric之间的差异。</strong></p>
<h2 id="1、Ansible的优点">1、Ansible的优点</h2>
<p><strong>Ansible作为配置工具，通常与Puppet、Chef、Saltstack进行比较，如下所示：</strong></p>
<table>
<thead>
<tr>
<th>工具</th>
<th>发布时间</th>
<th>语言</th>
<th>架构</th>
<th>协议</th>
</tr>
</thead>
<tbody>
<tr>
<td>Puppet</td>
<td>2005年</td>
<td>Ruby</td>
<td>C/S</td>
<td>http</td>
</tr>
<tr>
<td>Chef</td>
<td>2008年</td>
<td>Ruby</td>
<td>C/S</td>
<td>http</td>
</tr>
<tr>
<td>Saltstack</td>
<td>2012年</td>
<td>Python</td>
<td>C/S（可无Client）</td>
<td>ssh/zmq/raet</td>
</tr>
<tr>
<td>Ansible</td>
<td>2013年</td>
<td>Python</td>
<td>无Client</td>
<td>ssh</td>
</tr>
</tbody>
</table>
<p><strong>从发布时间来看，Ansible完全没有优势，那么，是什么特性让Ansible进入了工程师的视野，并且逐步获得青睐呢？我们需要了解一下Ansible有哪些优点。</strong></p>
<h3 id="Ansible具有以下几个优点："><strong>Ansible具有以下几个优点：</strong></h3>
<h4 id="（1）部署简单">（1）部署简单</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">只需要在主控端部署Ansible环境，被控端无须做任何操作。换句话说，在安装Ansible时，远程服务器无烦安装任何依赖。因此，相对于其他配置管理器，Ansible安装部署非常简单，省去了客户端的安装。在数千台规模的大型数据中心意味着少了一些路由和安全策略的配置，省去了很多不必要的麻烦。<br></code></pre></td></tr></table></figure>
<h4 id="（2）基于ssh进行配置管理，充分利用现成的机制">（2）基于ssh进行配置管理，充分利用现成的机制</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">Ansible不依赖与客户端，直接使用ssh进行配置管理，在Ansible早期版本中，默认使用paramiko进行配置管理，从Ansible1.3版本开始，Ansible默认使用OpenSSH实现个服务器间通信。<br></code></pre></td></tr></table></figure>
<h4 id="（3）Ansible不需要守护进程">（3）Ansible不需要守护进程</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">因为Ansible依赖OpenSSH进行通信，不需要安装客户端，因此服务端也不需要像其他配置管理一样使用一个守护进程。Ansible的安装和维护都变得更加简单，系统更加安全可靠。<br></code></pre></td></tr></table></figure>
<h4 id="（4）日志集中存储">（4）日志集中存储</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">所有操作日志都存储在Ansible发起服务器，可以采用自定义的格式，这样可以很方便地知晓哪些服务器操作有问题，哪些已经成功，也便于日后追溯。<br></code></pre></td></tr></table></figure>
<h4 id="（5）Ansible简单易用">（5）Ansible简单易用</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">Ansible和其他配置管理工具一样，运行一个部署命令就可以完成应用部署，使用非常简单。此外，Ansible使用YAML语法管理配置，YAML本身是一种可读性非常强的标记语言，工程师几乎像阅读英文一样阅读YAML的配置文件。因为Ansible使用YAML管理配置，所以使用Ansible不需要使用者具有任何编程背景。运维自动化工具本身是用来简化运维工作的，如果本身比较复杂（如Puppet），甚至需要一定的程序开发能力，那么就会增加使用者的使用难度和犯错的概率。<br></code></pre></td></tr></table></figure>
<h4 id="（6）Ansible功能强大">（6）Ansible功能强大</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">Ansible通过模块来实现各种功能，目前，Ansible已经有了950多个模块，工程师也可以使用任何语言编写自定义的Ansible模块。<br></code></pre></td></tr></table></figure>
<h4 id="（7）Ansible设计优秀，便于分享">（7）Ansible设计优秀，便于分享</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">Ansible使用role组织Playbook，并提供了分享role的平台（galaxy.ansible.com），便于大家分享和复用。充分使用role，可以编写可读性更强的配置文件。使用开源的role，能够有效节省编写Playbook的时间。<br></code></pre></td></tr></table></figure>
<h4 id="（8）Ansible对云计算和大数据平台都有很好的支持">（8）Ansible对云计算和大数据平台都有很好的支持</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">从Ansible的模块列表可以看到，Ansible包含了大量与云服务、AWS、OpenStack、Docker等相关的模块。并且，Ansible便于扩展，当出现新事务时可以根据需要编写自定义的模块。<br></code></pre></td></tr></table></figure>
<p><strong>Ansible作为自动化系统运维的一大利器，在构建整个体系过程中有着举足轻重的地位。其简单易用、易于安装、功能强大、便于分享、内含大量模板等都是它的魅力所在，再加上易封装、接口调用方便，Ansible正在被越来越多的大公司采用。</strong></p>
<h2 id="2、Ansible与Fabric之间的比较">2、Ansible与Fabric之间的比较</h2>
<p><strong>简单来说，Fabric像是一个工具箱，提供了很多好用的工具，用于在远程服务器执行命令。而Ansible则提供了一套简单的流程，只需要按照它的流程来做就能轻松完成任务。这就像是库和框架的关系一样，其中，Fabric是库，Ansible是框架。</strong></p>
<h3 id="（1）Fabric与Ansible之间的共同点">（1）Fabric与Ansible之间的共同点</h3>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex">1.都是基于paramiko开发；<br>2.都使用ssh和远程服务器通讯，不需要在远程服务器上安装客户端。<br></code></pre></td></tr></table></figure>
<h3 id="（2）Fabric与Ansible之间的主要区别">（2）Fabric与Ansible之间的主要区别</h3>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. Fabric简单，Ansible复杂。因此，Fabric学习成本低，Ansible的学习成本高；<br>2. Fabric通过ssh执行简单的命令，Ansible将模块拷贝到远程服务器后执行，执行完成以后删除模块；<br>3. 使用Fabric需要具有Python编程背景，使用Ansible则不需要；<br>4. Fabric对常用的管理操作和ssh连接操作进行了封装，工程师通过编写简单的代码就能完成要做的事情。Ansible不需要工程师编写任何代码，直接编写YAML格式的配置文件来描述要做的事情；<br>5. Fabric提供了基本的接口，业务逻辑需要用户自己实现；Ansible提供了大量的模块，用户只需要学习模块的用法即可完成复杂的任务。<br></code></pre></td></tr></table></figure>
<h1>二、Ansible使用入门</h1>
<p><strong>在这一小节我们介绍Ansible的安装与基本使用，然后在接下来的章节中介绍Ansible的高级用法。</strong></p>
<h3 id="ansible使用原则：">ansible使用原则：</h3>
<ul>
<li><strong>确定要操作哪些服务器（服务器列表）</strong></li>
<li><strong>确定对这些服务器进行什么样的操作（命令</strong>）</li>
</ul>
<h3 id="关于hosts文件：">关于hosts文件：</h3>
<ul>
<li><strong>默认读取/etc/ansible/hosts文件</strong></li>
<li><strong>通过命令行参数-i指定hosts文件</strong></li>
<li><strong>通过/etc/ansible/ansible.cfg里面的inventory选项指定hosts文件</strong></li>
</ul>
<h2 id="1、安装Ansible"><strong>1、安装Ansible</strong></h2>
<p><strong>Ansible不需要安装客户端，因此，相对于其他配置管理工具，Ansible的安装简单得多，只需要在控制端安装Ansible即可。Ansible使用Python语言开发，我们可以直接使用pip进行安装，也可以使用Linux下的包管理工具(如yumI、apt-get)进行安装。如下所示:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# pip3 install ansible<br></code></pre></td></tr></table></figure>
<p><strong>检查Ansible是否安装成功，如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible --version<br>ansible 2.9.9<br>  config file = /etc/ansible/ansible.cfg<br>  configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules']<br>  ansible python module location = /usr/lib/python2.7/site-packages/ansible<br>  executable location = /usr/bin/ansible<br>  python version = 2.7.5 (default, Aug  7 2019, 00:51:29) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)]<br></code></pre></td></tr></table></figure>
<p><strong>Ansible依赖Python与SSH，因此服务器需要安装SSH和Python 2.5或2.5以上版本的Python。SSH和Python是大多数操作系统中默认安装的软件，这进一步降低了Ansible安装部署的难度。除了SSH和Python以外，服务器端不需要再预装任何软件。在控制端（Ansible命令运行的那台机器）需要安装Python 2.6或更高版本的Python程序，且Ansible的控制端只能运行在Linux下。</strong><br>
<strong>与其他库和工具不同的是，Ansible包含了多个工具。安装完Ansible以后，控制端会增加以下几个可执行程序：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tex">ansible<br>ansible-doc<br>ansible-playbook<br>ansible-vault<br>ansible-console<br>ansible-galaxy<br>ansible-pull<br></code></pre></td></tr></table></figure>
<p><strong>这些可执行程序将在之后使用时进行详细介绍。</strong></p>
<h2 id="2、Ansible的架构">2、Ansible的架构</h2>
<p><strong>为了更好的理解Ansible，在介绍Ansible的使用之前，我们先看一下Ansible的架构图，如下所示：</strong></p>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520221310187.png" alt="image-20200520221310187"></p>
<p><strong>在Ansible中，用户通过编排引擎操作主机。其中，主机可以通过配置文件配置，调用云计算的接口获取，或者访问CMDB中的数据库。Ansible的编排引擎有Inventory、API、Modules（模块）和Plugins组成。Ansible的典型用法是：工程师将需要远程服务器执行的操作写在Ansible Playbook中，然后使用Ansible执行Playbook中的操作。</strong></p>
<h2 id="3、Ansible的运行环境"><strong>3、Ansible的运行环境</strong></h2>
<p><strong>使用Ansible操作远程服务器时，首先需要确定的是操作哪些服务器，然后再确定对这些服务器执行哪些操作。</strong></p>
<p><strong>Ansible会默认读取/etc/ansible/hosts文件中配置的远程服务器列表。在我们这一小节，/etc/ansible/hosts文件内容如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# mkdir /etc/ansible<br>[root@python ~]# vim /etc/ansible/hosts<br><br>[test]<br>127.0.0.1<br>192.168.1.80<br></code></pre></td></tr></table></figure>
<p><strong>Ansible中存在一个名为ping的模块，该模块并不是测试服务器的网络是否连接，而是尝试建立SSH连接，以便验证用户的SSH是否已经正确配置。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -m ping<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518155344725.png" alt="image-20200518155344725"></p>
<h2 id="修改test的权限">修改test的权限</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# chmod  755 /etc/sudoers<br>[root@python ~]# vim /etc/sudoers<br>test    ALL=(ALL)       ALL                   #92行左右添加<br>[root@python ~]# vim /etc/ansible/hosts<br><br>[test]<br>127.0.0.1 ansible_user=root ansible_port=22<br>192.168.1.80<br></code></pre></td></tr></table></figure>
<h3 id="再次测试一下">再次测试一下</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@python ~]# ansible test -m ping<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518160500524.png" alt="image-20200518160500524"></p>
<h5 id="常见错误解决方案如下：">常见错误解决方案如下：</h5>
<h6 id="（1）ansible管理节点生成ssh-key">（1）ansible管理节点生成ssh-key</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ssh-keygen</span><br></code></pre></td></tr></table></figure>
<p><strong>执行成功后，将会在~/.ssh目录下生成2个文件：id_rsa和id_rsa.pub</strong></p>
<h6 id="（2）添加目标节点的ssh认证信息">（2）添加目标节点的ssh认证信息</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ssh-copy-id root@47.100.98.242</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ssh-copy-id root@192.168.79.133</span><br></code></pre></td></tr></table></figure>
<h6 id="（3）测试">（3）测试</h6>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ansible test -m ping</span><br>192.168.79.133 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">"ansible_facts"</span>: &#123;<br>        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span><br>    &#125;,<br>    <span class="hljs-string">"changed"</span>: false,<br>    <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span><br>&#125;<br>47.100.98.242 | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">"ansible_facts"</span>: &#123;<br>        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span><br>    &#125;,<br>    <span class="hljs-string">"changed"</span>: false,<br>    <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>Ansible默认使用当前用户和默认的22端口号与远程服务器建立SSH连接。如果需要使用其他用户，或者使用非默认的SSH端口号，可以在host之后增加用户名和端口号的配置。如下所示：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pypthon">[root@192 ~]# cat &#x2F;etc&#x2F;ansible&#x2F;hosts<br>[test]<br>192.168.79.133 ansible_user&#x3D;test ansible_port&#x3D;22<br>47.100.98.242 ansible_user&#x3D;laoyu ansible_port&#x3D;80<br></code></pre></td></tr></table></figure>
<p><strong>一般情况下，工作环境的服务器ssh用户名和ssh端口号都是相同的。如果我们有很多的远程服务器，每一台服务器都需要配置ansible_user或ansible_port参数，如果依然使用前面的配置方式进行配置，会显得非常冗余。对于这种情况，可以在Ansible配置文件中修改相应的配置。</strong></p>
<p><strong>Ansible默认使用/etc/ansible/ansible.cfg文件，我们可以在ansible.cfg中设定一些默认值，这样就需要对同样的内容输入多次。如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># cat /etc/ansible/ansible.cfg</span><br>[defaults]<br>remote_port = <span class="hljs-number">2090</span><br>remote_user = test<br></code></pre></td></tr></table></figure>
<h2 id="4、Ansible的ad-hoc模式">4、Ansible的ad-hoc模式</h2>
<p><strong>ping模块是Ansible中最简单的模块，而command模块则是工程师最熟悉的模块。command模块的作用非常简单，就是在服务器中执行shell命令。在Ansible中，通过-m参数指定模块名称，通过-a参数指定模块的参数。因此，使用command模块在远程服务器执行shell命令的语句如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -m command -a "hostname"<br>127.0.0.1 | CHANGED | rc=0 &gt;&gt;<br>python<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>python<br>[root@python ~]# ansible test -m command -a "whoami"<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>root<br>127.0.0.1 | CHANGED | rc=0 &gt;&gt;<br>root<br></code></pre></td></tr></table></figure>
<p><strong>command是Ansible中的默认模块，当我们省略-m参数时，默认使用command模块。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -m command -a "whoami"<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>root<br>127.0.0.1 | CHANGED | rc=0 &gt;&gt;<br>root<br></code></pre></td></tr></table></figure>
<p><strong>大部分情况下，Ansible的模块包含多个参数，参数使用“key=value”的形式表示，各个参数之间使用空格分隔。如下所示：</strong></p>
<h3 id="（1）创建ansible-cfg文件">（1）创建ansible.cfg文件</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim /etc/ansible/ansible.cfg<br>[defaults]<br>remote_port = 22<br>remote_user = root<br></code></pre></td></tr></table></figure>
<h4 id="再次测试一下-2">再次测试一下</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -m ping<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518155344725.png" alt="image-20200518155344725"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -m command -a "hostname"<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518162026972.png" alt="image-20200518162026972"></p>
<h3 id="（2）将本地文件拷贝到服务器">（2）将本地文件拷贝到服务器</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# cd /tmp/<br>[root@python tmp]# mkdir abc<br>[root@python tmp]# cd abc/<br>[root@python abc]# ls<br>nginx.conf  restart.sh     #要拷贝的文件<br></code></pre></td></tr></table></figure>
<h4 id="进行拷贝">进行拷贝</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python abc]# ansible test -m copy -a "src=/tmp/abc/nginx.conf dest=/opt/nginx.conf"<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518162720950.png" alt="image-20200518162720950"></p>
<h4 id="查看一下是否有拷贝的文件">查看一下是否有拷贝的文件</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python abc]# ls /opt/ | grep nginx.conf<br>nginx.conf<br></code></pre></td></tr></table></figure>
<h3 id="1-创建剧本（拷贝）">&lt;1&gt;创建剧本（拷贝）</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python abc]# vim test_playbook.yml<br><br>---<br>- hosts: test<br>  become: yes               #是否支持root权限<br>  become_method: sudo<br>  tasks:                    #任务<br>  - name: copy file         #描叙<br>    copy: src=/opt/nginx.conf dest=/tmp/abc/nginx.conf #拷贝的<br><br>  - name: package install   #描叙<br>    yum: name=&#123;&#123;item&#125;&#125; state=present        #安装的<br>    with_items:<br>      - tmux<br></code></pre></td></tr></table></figure>
<h4 id="执行一下">执行一下</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python abc]# ansible-playbook test_playbook.yml<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518164022081.png" alt="image-20200518164022081"></p>
<h4 id="查看是否有拷贝的文件">查看是否有拷贝的文件</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python abc]# ls | grep nginx.conf <br>nginx.conf<br></code></pre></td></tr></table></figure>
<h3 id="（3）在远程服务器中安装软件">（3）在远程服务器中安装软件</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python abc]# ansible test -m yum -a "name=tmux state=present" -become<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200518163338271.png" alt="image-20200518163338271"></p>
<h2 id="5、使用playbook控制服务器">5、使用playbook控制服务器</h2>
<p><strong>前面通过Ansible命令执行操作的方式，称为ad-hoc。我们可以使用ad-hoc来执行非常简单的操作，也可以使用ad-hoc的方式来学习模块的使用方式。但是，在实际的生产环境中，我们一般将远程服务器需要做的事情写在一个YAML配置文件中。</strong></p>
<p><strong>例如，将本地文件拷贝到远程服务器并修改文件所有者，然后安装软件的功能，写在YAML的配置文件中以后，其内容如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">[root@192</span> <span class="hljs-string">~]#</span> <span class="hljs-string">cat</span> <span class="hljs-string">test_playbook.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">test</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">become_method:</span> <span class="hljs-string">sudo</span><br>  <span class="hljs-attr">tasks:</span><br>true<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">file</span><br>      <span class="hljs-attr">copy:</span> <span class="hljs-string">src=~/s.txt</span> <span class="hljs-string">dest=/opt/s.txt</span><br>true<br>true<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">change</span> <span class="hljs-string">mode</span><br>      <span class="hljs-attr">file:</span> <span class="hljs-string">dest=/opt/s.txt</span> <span class="hljs-string">mode=500</span> <span class="hljs-string">owner=root</span> <span class="hljs-string">group=root</span><br>true<br>true<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ensure</span> <span class="hljs-string">packages</span> <span class="hljs-string">installed</span><br>      <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;item&#125;&#125;</span> <span class="hljs-string">state=present</span><br>true  <span class="hljs-attr">with_items:</span><br>true    <span class="hljs-bullet">-</span> <span class="hljs-string">git</span><br>true    <span class="hljs-bullet">-</span> <span class="hljs-string">tmux</span><br></code></pre></td></tr></table></figure>
<p><strong>这个YAML文件称为Ansible Playbook。Playbook中首先包含了一些声明信息，如hosts关键字声明该Playbook应用的服务器列表，become和become_method表示在远程服务器通过sudo执行操作。Playbook最后包含了若干个task，每一个task对应于前面的一条ad-hoc命令。具体执行时，多个task按序执行。如果你不能完全理解YAML文件，现在只需要对Ansible的执行方式有一个认识即可。后续小节将会详细讲解如何编写Ansible Playbook。</strong></p>
<p><strong>有了Playbook以后，通过ansible-playbook命令执行，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ansible-playbook test_palybook.yml</span><br>PLAY [test] ****************************************************************************************************************<br><br>TASK [Gathering Facts] *****************************************************************************************************<br>ok: [<span class="hljs-number">47.100</span><span class="hljs-number">.98</span><span class="hljs-number">.242</span>]<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br><br>TASK [copy file] ***********************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br>ok: [<span class="hljs-number">47.100</span><span class="hljs-number">.98</span><span class="hljs-number">.242</span>]<br><br>TASK [change mode] *********************************************************************************************************<br>ok: [<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>]<br>ok: [<span class="hljs-number">47.100</span><span class="hljs-number">.98</span><span class="hljs-number">.242</span>]<br><br>TASK [ensure packages installed] *******************************************************************************************<br>[DEPRECATION WARNING]: Invoking <span class="hljs-string">"yum"</span> only once <span class="hljs-keyword">while</span> using a loop via squash_actions <span class="hljs-keyword">is</span> deprecated. Instead of using a <br>loop to supply multiple items <span class="hljs-keyword">and</span> specifying `name: <span class="hljs-string">"&#123;&#123;item&#125;&#125;"</span>`, please use `name: [<span class="hljs-string">'git'</span>, <span class="hljs-string">'tmux'</span>]` <span class="hljs-keyword">and</span> remove the loop. <br>This feature will be removed <span class="hljs-keyword">in</span> version <span class="hljs-number">2.11</span>. Deprecation warnings can be disabled by setting deprecation_warnings=<span class="hljs-literal">False</span> <span class="hljs-keyword">in</span><br> ansible.cfg.<br>[DEPRECATION WARNING]: Invoking <span class="hljs-string">"yum"</span> only once <span class="hljs-keyword">while</span> using a loop via squash_actions <span class="hljs-keyword">is</span> deprecated. Instead of using a <br>loop to supply multiple items <span class="hljs-keyword">and</span> specifying `name: <span class="hljs-string">"&#123;&#123;item&#125;&#125;"</span>`, please use `name: [<span class="hljs-string">'git'</span>, <span class="hljs-string">'tmux'</span>]` <span class="hljs-keyword">and</span> remove the loop. <br>This feature will be removed <span class="hljs-keyword">in</span> version <span class="hljs-number">2.11</span>. Deprecation warnings can be disabled by setting deprecation_warnings=<span class="hljs-literal">False</span> <span class="hljs-keyword">in</span><br> ansible.cfg.<br>changed: [47.100.98.242] =&gt; (item=['git', 'tmux'])<br>changed: [127.0.0.1] =&gt; (item=['git', 'tmux'])<br><br>PLAY RECAP *****************************************************************************************************************<br><span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>                  : ok=<span class="hljs-number">4</span>    changed=<span class="hljs-number">1</span>    unreachable=<span class="hljs-number">0</span>    failed=<span class="hljs-number">0</span>    skipped=<span class="hljs-number">0</span>    rescued=<span class="hljs-number">0</span>    ignored=<span class="hljs-number">0</span>   <br><span class="hljs-number">47.100</span><span class="hljs-number">.98</span><span class="hljs-number">.242</span>              : ok=<span class="hljs-number">4</span>    changed=<span class="hljs-number">1</span>    unreachable=<span class="hljs-number">0</span>    failed=<span class="hljs-number">0</span>    skipped=<span class="hljs-number">0</span>    rescued=<span class="hljs-number">0</span>    ignored=<span class="hljs-number">0</span>   <br><br>[root@desktop-kh5f5dc ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>
<p><strong>上面这条命令的效果与上一小节中多条ad-hoc命令的效果是一样的。关于YAML的语法，如何编写playbook以及模块的使用方式等，将在本章的后续小节中进行详细讲解。在这一小节中，我们只需要知道Ansible有两种操作远程服务器的方式，分别是：ad-hoc与Playbook。</strong></p>
<h1>三、Inventory管理</h1>
<p><strong>在Ansible中，将可管理的服务器的集合称为Inventory。因此，Inventory管理便是服务器管理。这一节中，我们将会详细讨论Inventory管理。</strong></p>
<h2 id="1、hosts文件位置">1、hosts文件位置</h2>
<p><strong>我们已经演示了Ansible如何对远程服务器执行操作，可以看到，Ansible在执行操作是，首先需要确定对哪些服务器执行操作。默认情况下，Ansible读取/etc/ansible/hosts文件中的服务器配置，获取需要操作的服务器列表。Ansible定义与获取服务器列表的方式比这个要灵活得多。</strong></p>
<p><strong>在Ansible中，有3种方式制定hosts文件，分别是：</strong></p>
<blockquote>
<ul>
<li><strong>默认读取/etc/ansible/hosts文件；</strong></li>
</ul>
<ol start="2">
<li><strong>通过命令行参数-i指定hosts文件；</strong></li>
<li><strong>通过ansible.cfg文件中的inventory选项（老版本的Ansible中通过hostfile选项指定）指定hosts文件。</strong></li>
</ol>
</blockquote>
<p><strong>例如：当前系统中除了/etc/ansible/hosts文件以外，在test用户的home目录下也存在一个名为hosts的文件，该hosts文件的内容如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[test]<br>127.0.0.1<br>192.168.1.80<br></code></pre></td></tr></table></figure>
<p><strong>使用/etc/ansible/hosts文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test --list-hosts<br>  hosts (2):<br>    127.0.0.1<br>    192.168.1.80<br></code></pre></td></tr></table></figure>
<p><strong>-i选项指定hosts文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -i hosts --list-hosts<br>  hosts (2):<br>    127.0.0.1<br>    192.168.1.80<br></code></pre></td></tr></table></figure>
<p><strong>修改ansible.cfg文件，添加inventory选项，指定hosts文件的路径</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim /etc/ansible/ansible.cfg <br><br>[defaults]<br>remote_user = root<br>remote_port = 22<br>inventory = /etc/ansible/hosts<br></code></pre></td></tr></table></figure>
<h2 id="2、灵活定义hosts文件内容">2、灵活定义hosts文件内容</h2>
<h3 id="（1）分组定义服务器">（1）分组定义服务器</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim /etc/ansible/hosts <br><br>[demo]<br>127.0.0.1<br>[xgp]<br>192.168.1.80<br>[wsd]<br>192.168.1.60<br></code></pre></td></tr></table></figure>
<h4 id="1）查看单个分组的服务器列表">1）查看单个分组的服务器列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible demo --list-hosts<br>  hosts (1):<br>    127.0.0.1<br>[root@python ~]# ansible xgp --list-hosts<br>  hosts (1):<br>    192.168.1.80<br>[root@python ~]# ansible wsd --list-hosts<br>  hosts (1):<br>    192.168.1.60<br>[root@python ~]# ansible all --list-hosts<br>  hosts (3):<br>    127.0.0.1<br>    192.168.1.80<br>    192.168.1.60<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200519163251885.png" alt="image-20200519163251885"></p>
<h4 id="2）查看多个分组的服务器列表（冒号分隔组名）">2）查看多个分组的服务器列表（冒号分隔组名）</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible xgp:wsd -i hosts --list-hosts<br>  hosts (2):<br>    192.168.1.80<br>    192.168.1.60<br></code></pre></td></tr></table></figure>
<h4 id="3）使用all和星号匹配服务器">3）使用all和星号匹配服务器</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible '*' -i hosts --list-hosts<br>[root@python ~]# ansible 'all' -i hosts --list-hosts<br>  hosts (3):<br>    127.0.0.1<br>    192.168.1.60<br>    192.168.1.80<br></code></pre></td></tr></table></figure>
<h3 id="（2）Ansible定义组匹配服务器">（2）Ansible定义组匹配服务器</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim hosts<br>[demo]<br>127.0.0.1<br>[xgp]<br>192.168.1.80<br>[wsd]<br>192.168.1.60<br>[common:children]<br>xgp<br>wsd<br></code></pre></td></tr></table></figure>
<h4 id="查看服务器列表">查看服务器列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible common -i hosts --list-hosts<br>  hosts (2):<br>    192.168.1.80<br>    192.168.1.60<br></code></pre></td></tr></table></figure>
<h3 id="（3）批量定义服务器">（3）批量定义服务器</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim hosts<br><br>[demo]<br>127.0.0.1<br>[xgp]<br>192.168.1.80<br>[1:3].xgp.top<br>[wsd]<br>192.168.1.60<br>[a:d].xgp.top<br>[common:children]<br>xgp<br>wsd<br></code></pre></td></tr></table></figure>
<h4 id="查看服务列表">查看服务列表</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible xgp:wsd -i hosts --list-hosts<br>  hosts (9):<br>    192.168.1.80<br>    1.xgp.top<br>    2.xgp.top<br>    3.xgp.top<br>    192.168.1.60<br>    a.xgp.top<br>    b.xgp.top<br>    c.xgp.top<br>    d.xgp.top<br></code></pre></td></tr></table></figure>
<h2 id="3、灵活匹配hosts文件内容">3、灵活匹配hosts文件内容</h2>
<p><strong>Ansible还支持通配符和正则表达式等更灵活的方式来匹配服务器。</strong></p>
<p><strong>Ansible官方给出了ansible命令的语法格式：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible &lt;pattern_goes_here&gt; -m &lt;module_name&gt; -a &lt;arguments&gt;<br></code></pre></td></tr></table></figure>
<p><strong>例如：重启所有web服务器中的Apache进程：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">ansible webservers -m service -a <span class="hljs-string">"name=httpd state=restarted"</span><br>ansible web*.duxuejun.com =-m service -a <span class="hljs-string">"name=httpd state=restarted"</span><br></code></pre></td></tr></table></figure>
<p><strong>远程服务器匹配规则：</strong></p>
<table>
<thead>
<tr>
<th>匹配规则</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.1.10 或者 <a href="http://web.duxuejun.com" target="_blank" rel="noopener">web.duxuejun.com</a></td>
<td>匹配目标IP地址或服务器名称，如果含有多个IP或服务器，使用“:”分隔</td>
</tr>
<tr>
<td>webservers</td>
<td>匹配目标为webservers，多个分组使用“:”分隔</td>
</tr>
<tr>
<td>all或者&quot;*&quot;</td>
<td>匹配所有的服务器</td>
</tr>
<tr>
<td>webservers:!dbservers</td>
<td>匹配在webservers中，不在dbservers组中的服务器</td>
</tr>
<tr>
<td>webservers:&amp;dbservers</td>
<td>匹配同时在webservers组以及dbservers组中的服务器</td>
</tr>
<tr>
<td>*.duxujun.com或192.168.*</td>
<td>使用通配符进行匹配</td>
</tr>
<tr>
<td>webservers[0],webservers[1:],webservers[-1]</td>
<td>使用索引或切片操作的方式匹配组中的服务器</td>
</tr>
<tr>
<td>~(web|db).*.duxuejun.com</td>
<td>以~开头的匹配，表示使用正则表达式匹配</td>
</tr>
</tbody>
</table>
<h2 id="4、Inventory行为参数">4、Inventory行为参数</h2>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">参数</span>                             <span class="hljs-string">默认值                说明</span><br><span class="hljs-attr">ansible_ssh_host</span>                <span class="hljs-string">主机的名字            ssh的目的主机或ip</span><br><span class="hljs-attr">ansible_ssh_port</span>                <span class="hljs-string">22                  ssh目的端口</span><br><span class="hljs-attr">ansible_ssh_user</span>                <span class="hljs-string">root                ssh登陆使用的用户名</span><br><span class="hljs-attr">ansible_ssh_pass</span>                <span class="hljs-string">none                ssh认证所使用的密码</span><br><span class="hljs-attr">ansible_connection</span>              <span class="hljs-string">smart               Ansible使用何种连接模式连接到主机</span><br><span class="hljs-attr">ansible_ssh_private_key_file</span>    <span class="hljs-string">none                ssh认证所使用的私钥</span><br><span class="hljs-attr">ansible_shell_type</span>              <span class="hljs-string">sh                  命令所使用的shell</span><br><span class="hljs-attr">ansible_python_interpreter</span>      <span class="hljs-string">/usr/bin/python     主机上的python解释器</span><br><span class="hljs-meta">ansible_*_interpreter</span>           <span class="hljs-string">none                类似python解释器的其他语言版</span><br></code></pre></td></tr></table></figure>
<h2 id="5、改变行为参数的默认值">5、改变行为参数的默认值</h2>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">可以在ansible.cfg文件的[defaults]部分更改一些行为参数的默认值</span>              <span class="hljs-string"></span><br><span class="hljs-meta">ansible.cfg文件</span>				  <span class="hljs-string">inventory文件     </span><br><span class="hljs-attr">ansible_ssh_user</span>                <span class="hljs-string">remote_user</span><br><span class="hljs-attr">ansible_ssh_port</span>                <span class="hljs-string">remote_port</span><br><span class="hljs-attr">ansible_ssh_private_key_file</span>    <span class="hljs-string">private_key_file</span><br><span class="hljs-attr">ansible_shell_type</span>              <span class="hljs-string">executable</span><br></code></pre></td></tr></table></figure>
<h2 id="6、定义服务器变量">6、定义服务器变量</h2>
<p><strong>在hosts文件中，除了定义行为参数以外，还可以定义普通的变量，以便在不同的服务器中使用不同的配置。比如：可以在2台服务器中分别启动MySQL，1台服务器的MySQL的端口是3306，另一台服务器MySQL的端口是3307。定义普通参数和定义行为参数的方法是一样的，只是行为参数的名字有Ansible预先定义，普通参数的名称有我们自己定义。在Ansible中，参数名必须为字母、数字和下划线的组合，并且首字符必须为字母。</strong></p>
<h3 id="（1）变量的取值不同"><strong>（1）变量的取值不同</strong></h3>
<p><strong>假定，我们在/etc/ansible/hosts文件中为不同的服务器定义一个相同的变量名，但是取值不同。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim hosts<br><br>[test]<br>192.168.1.60 ansible_port=22<br>192.168.1.80 ansible_port=22<br></code></pre></td></tr></table></figure>
<p><strong>在测试环境中，我们可以通过echo方式显示变量的值。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  test -i ./hosts -a 'echo &#123;&#123;ansible_port&#125;&#125;' <br>192.168.1.60 | CHANGED | rc=0 &gt;&gt;<br>22<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>22<br></code></pre></td></tr></table></figure>
<h3 id="（2）变量的取值相同">（2）变量的取值相同</h3>
<p><strong>如果test组下的两个服务器mysql_port变量取值相同，我们也可以通过组的名称加上“:vars”后缀来定义变量，如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim hosts<br><br>[test]<br>192.168.1.40<br>192.168.1.80<br><br>[test:vars]<br>ansible_port = 22<br></code></pre></td></tr></table></figure>
<p><strong>随着业务的发展，管理的hosts文件越来越大，使用的变量越来越多了，依然使用一个hosts文件管理服务器和变量的话，就会逐渐变得难以管理。</strong></p>
<p><strong>Ansible提供了更好的方法来管理服务器和群组的变量，即：为每个服务器和群组创建独立的变量文件。其定义方式是，将组的变量存放在一个名为group_vars命令下，目录下的文件名与组的名称相同，文件的扩展名可以是.yml或.yaml，也可以没有任何扩展名。服务器的变量存放在一个名为host_vars目录下，该目录下的文件名为服务器的名称。</strong></p>
<p><strong>Ansible将依次在Playbook所在的目录、hosts文件所在的目录和/etc/ansible目录下寻找group_vars目录和host_vars目录。目前，假设group_vars目录和host_var目录都位于/etc/ansible目录下。</strong></p>
<p><strong>对于我们前面定义mysql_port变量的例子，将变量存放在独立的文件以后，/etc/ansible目录的结构如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@192 ansible]# tree<br>.<br>├── ansible.cfg<br>├── group_vars<br>│   └── test.yaml<br>├── hosts<br>└── host_vars<br>    └── 127.0.0.1.yaml<br></code></pre></td></tr></table></figure>
<p><strong>其中，test.yaml文件定义了hosts文件中test组的变量，127.0.0.1.yaml文件定义了hosts文件中127.0.0.1这台服务器使用的变量。如：test.yaml文件的内容如下：</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-string">[root@192</span> <span class="hljs-string">ansible]#</span> <span class="hljs-string">cat</span> <span class="hljs-string">group_vars/test.yaml</span> <br><span class="hljs-attr">ansible_port:</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure>
<p><strong>注意：我们在hosts文件中定义变量时，使用的是“var = value”格式定义。将变量保存在一个独立的文件时，使用的是“var:value”格式定义。这是因为Ansible解析这两个文件时，认为hosts是一个ini格式的文件，而保存变量的文件是一个YAML格式的文件。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  test -i ./hosts -a 'echo &#123;&#123;ansible_port&#125;&#125;' <br>192.168.1.40 | CHANGED | rc=0 &gt;&gt;<br>22<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>22<br></code></pre></td></tr></table></figure>
<h1>四、YAML语法</h1>
<h2 id="1、YAML语法规则">1、YAML语法规则</h2>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. YAML文件第一行为“---”，表示这是一个YAML文件；<br>2. YAML中字段大小写敏感；<br>3. YAML与Python一样，通过缩进来表示层级关系；<br>4. YAML的缩进不允许使用Tab键，只允许使用空格，且空格的数目不重要，只要相同层级的元素左侧对齐即可；<br>5. “#”表示注释，从这个字符一直到行尾都会被解析器忽略<br></code></pre></td></tr></table></figure>
<h2 id="2、YAML支持的3中格式数据">2、YAML支持的3中格式数据</h2>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. 对象：键值对的集合，有称为映射，类似于Python中的字典；<br>2. 数组：一组按次序排列的值，有称为序列（sequence），类似于Python的列表；<br>3. 纯量（scalars）：单个的、不可再分的值，比如：字符串、布尔值与数字。<br></code></pre></td></tr></table></figure>
<h2 id="3、安装PyYAML库">3、安装PyYAML库</h2>
<p><strong>Python标准库没有包含解析YAML格式的库，需要安装第三方的PyYAML库。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pip3 install -i https://pypi.douban.com/simple/ PyYAML<br></code></pre></td></tr></table></figure>
<h2 id="4、定义与解析YAML文件"><strong>4、定义与解析YAML文件</strong></h2>
<h3 id="（1）数组格式"><strong>（1）数组格式</strong></h3>
<p><strong>使用YAML表示数组非常容易，只需要用“-”将元素按序列出即可。假设我们有下面这样一个YAML文件，文件的内容保存在一个名为data.yaml的文件中，如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># 一个美味的水果列表</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Apple</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Orange</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Strawberry</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Mango</span><br></code></pre></td></tr></table></figure>
<h4 id="解析结果：">解析结果：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">1</span>]: <span class="hljs-keyword">import</span> yaml                                                                <br><br>In [<span class="hljs-number">2</span>]: <span class="hljs-keyword">with</span> open(<span class="hljs-string">'data.yaml'</span>) <span class="hljs-keyword">as</span> f: <br>   ...:     print(yaml.load(f)) <br>   ...:                                                                            <br>[<span class="hljs-string">'Apple'</span>, <span class="hljs-string">'Orange'</span>, <span class="hljs-string">'Strawberry'</span>, <span class="hljs-string">'Mango'</span>]<br></code></pre></td></tr></table></figure>
<h3 id="（2）对象">（2）对象</h3>
<p><strong>在YAML中，对象以“key:value”的形式进行定义，如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># 一个职工的记录</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">爱运维</span><br><span class="hljs-attr">job:</span> <span class="hljs-string">devops</span><br><span class="hljs-attr">skill:</span> <span class="hljs-string">Elite</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">23</span><br><span class="hljs-attr">knowoop:</span> <span class="hljs-literal">True</span><br><span class="hljs-attr">likes_emacs:</span> <span class="hljs-literal">TRUE</span><br><span class="hljs-attr">users_cvs:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>
<h4 id="解析结果：-2">解析结果：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">3</span>]: <span class="hljs-keyword">with</span> open(<span class="hljs-string">'dev.yaml'</span>) <span class="hljs-keyword">as</span> f: <br>   ...:     print(yaml.load(f)) <br>   ...:<br>&#123;<span class="hljs-string">'name'</span>: <span class="hljs-string">'爱运维'</span>, <span class="hljs-string">'job'</span>: <span class="hljs-string">'devops'</span>, <span class="hljs-string">'skill'</span>: <span class="hljs-string">'Elite'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'knowoop'</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">'likes_emacs'</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">'users_cvs'</span>: <span class="hljs-literal">False</span>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>YAML中可以使用多种方式制定布尔值，如以上YAML文件中的“True”、“TRUE”、“false”，转换为Python代码后，对变量的取值进行了格式化。</strong></p>
<h3 id="（3）对象和数组嵌套">（3）对象和数组嵌套</h3>
<p><strong>YAML中的对象和数组是可以任意嵌套的，如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-comment"># 一个职工的记录</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">爱运维</span><br><span class="hljs-attr">job:</span> <span class="hljs-string">devops</span><br><span class="hljs-attr">skill:</span> <span class="hljs-string">Elite</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">23</span><br><span class="hljs-attr">knowoop:</span> <span class="hljs-literal">True</span><br><span class="hljs-attr">likes_emacs:</span> <span class="hljs-literal">TRUE</span><br><span class="hljs-attr">users_cvs:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">foods:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Apple</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Orange</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Strawberry</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Mango</span><br><span class="hljs-attr">languages:</span><br>    <span class="hljs-attr">ruby:</span> <span class="hljs-string">Elite</span><br>    <span class="hljs-attr">python:</span> <span class="hljs-string">Elite</span><br>    <span class="hljs-attr">shell:</span> <span class="hljs-string">Lame</span><br></code></pre></td></tr></table></figure>
<h3 id="（4）注意事项">（4）注意事项</h3>
<p><strong>在YAML中定义字符串的时候，不需要使用单引号或者双引号，直接将字符串写在文件中即可。如下所示：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">str:</span> <span class="hljs-string">this</span> <span class="hljs-string">is</span> <span class="hljs-string">a</span> <span class="hljs-string">string</span><br></code></pre></td></tr></table></figure>
<p><strong>如果字符串中包含了特殊字符，需要使用双引号包含起来。比如：字符串中包含冒号。冒号是YAML中的特殊字符，因此需要使用双引号包含起来。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">foo:</span> <span class="hljs-string">"somebody said I should put a colon here: so I did"</span><br></code></pre></td></tr></table></figure>
<p><strong>如果字符串内容比较长，可以使用“&gt;”来折叠换行。</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">that:</span> <span class="hljs-string">&gt;</span><br>    <span class="hljs-string">Foo</span><br>    <span class="hljs-string">Bar</span><br></code></pre></td></tr></table></figure>
<p><strong>将以上YAML文件转换为Python的内部对象后，“Foo”和“Bar”都是字符串的一部分。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;<span class="hljs-string">'that'</span>: <span class="hljs-string">'Foo Bar\n'</span>&#125;<br></code></pre></td></tr></table></figure>
<h1>五、Ansible模块</h1>
<h2 id="1、Ansible的模块工作原理">1、Ansible的模块工作原理</h2>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. 将模块拷贝到远程服务器<br>2. 执行模块定义的操作，完成对服务器的修改<br>3. 在远程服务器删除模块<br></code></pre></td></tr></table></figure>
<p><strong>Ansible中的模块是幂等的，也就是说，多次执行相同的操作，只有第一次会起作用。这也是在编写自定义的Ansible模块的时候需要注意的。</strong></p>
<h2 id="2、模块列表与帮助信息"><strong>2、模块列表与帮助信息</strong></h2>
<p><strong>Ansible模块非常多，如果以模块的功能进行分类的话，可以分为以下模块：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs txt">云模块<br>命令模块<br>数据库模块<br>文件模块<br>资产模块<br>消息模块<br>监控模块<br>网络模块<br>通知模块<br>包管理模块<br>源码控制模块<br>系统模块<br>单元模块<br>web设施模块<br>Windows模块<br>……<br></code></pre></td></tr></table></figure>
<p><strong>查看Ansible模块帮助信息，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@python ~]<span class="hljs-comment"># ansible-doc -l</span><br></code></pre></td></tr></table></figure>
<p><strong>查看指定模块的帮助信息，如下所示</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@python ~]<span class="hljs-comment"># ansible file</span><br>[WARNING]: Could <span class="hljs-keyword">not</span> match supplied host pattern, ignoring: file<br>[WARNING]: No hosts matched, nothing to do<br>usage: ansible [-h] [--version] [-v] [-b] [--become-method BECOME_METHOD] [--become-user BECOME_USER] [-K] [-i INVENTORY]<br>               [--list-hosts] [-l SUBSET] [-P POLL_INTERVAL] [-B SECONDS] [-o] [-t TREE] [-k]<br>               [--private-key PRIVATE_KEY_FILE] [-u REMOTE_USER] [-c CONNECTION] [-T TIMEOUT]<br>               [--ssh-common-args SSH_COMMON_ARGS] [--sftp-extra-args SFTP_EXTRA_ARGS] [--scp-extra-args SCP_EXTRA_ARGS]<br>               [--ssh-extra-args SSH_EXTRA_ARGS] [-C] [--syntax-check] [-D] [-e EXTRA_VARS] [--vault-id VAULT_IDS]<br>               [--ask-vault-<span class="hljs-keyword">pass</span> | --vault-password-file VAULT_PASSWORD_FILES] [-f<br></code></pre></td></tr></table></figure>
<h2 id="3、常用的Ansible模块">3、常用的Ansible模块</h2>
<p><strong>Ansible提供的功能越丰富，所需要的模块也就越多。默认情况下，模块存储在/usr/share/ansible目录中。</strong></p>
<h3 id="（1）ping">（1）ping</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible test -m ping<br>192.168.1.40 | SUCCESS =&gt; &#123;<br>    "ansible_facts": &#123;<br>        "discovered_interpreter_python": "/usr/bin/python"<br>    &#125;, <br>    "changed": false, <br>    "ping": "pong"<br>&#125;<br>Enter passphrase for key '/root/.ssh/id_rsa': <br>192.168.1.80 | SUCCESS =&gt; &#123;<br>    "ansible_facts": &#123;<br>        "discovered_interpreter_python": "/usr/bin/python"<br>    &#125;, <br>    "changed": false, <br>    "ping": "pong"<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="（2）远程命令模块">（2）远程命令模块</h3>
<h4 id="1）command模块">1）command模块</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">ansible test -m command -a <span class="hljs-string">'hostname'</span><br>ansible test -m command -a <span class="hljs-string">'/sbin/shutdown -t now'</span><br>ansible test -a <span class="hljs-string">'hostname'</span><br></code></pre></td></tr></table></figure>
<p><strong>command模块在执行Linux命令时，不能使用管道。如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">ansible test -m command -a <span class="hljs-string">'cat /etc/passwd | wc -l'</span><br></code></pre></td></tr></table></figure>
<p><strong>执行后报错如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.40</span> | FAILED | rc=<span class="hljs-number">1</span> &gt;&gt;<br>cat：无效选项 -- l<br>Try <span class="hljs-string">'cat --help'</span> <span class="hljs-keyword">for</span> more information.non-zero <span class="hljs-keyword">return</span> code<br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.80</span> | FAILED | rc=<span class="hljs-number">1</span> &gt;&gt;<br>cat：无效选项 -- l<br>Try <span class="hljs-string">'cat --help'</span> <span class="hljs-keyword">for</span> more information.non-zero <span class="hljs-keyword">return</span> code<br></code></pre></td></tr></table></figure>
<h4 id="2）raw模块">2）raw模块</h4>
<p><strong>如果执行的命令需要使用管道，可以使用raw模块，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@python ~]<span class="hljs-comment">#  ansible test -m raw -a 'cat /etc/passwd | wc -l'</span><br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.80</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br><span class="hljs-number">45</span><br>Shared connection to <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.80</span> closed.<br><br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.40</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br><span class="hljs-number">44</span><br>Shared connection to <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.40</span> closed.<br></code></pre></td></tr></table></figure>
<p><strong>raw模块相当于使用ssh直接执行Linux命令，不会进入到Ansible的模块的子系统中。</strong></p>
<h4 id="3）shell模块">3）shell模块</h4>
<p><strong>除了使用raw模块以外，也可以使用shell模块，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@python ~]<span class="hljs-comment"># ansible test -m shell -a 'cat /etc/passwd | wc -l'</span><br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.40</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br><span class="hljs-number">44</span><br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.80</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br><span class="hljs-number">45</span><br></code></pre></td></tr></table></figure>
<p><strong>shell模块还可以执行远程服务器上的shell脚本，其中，脚本文件的路径需要使用绝对路径，如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ansible test -m shell -a '/home/test/test.sh'<br></code></pre></td></tr></table></figure>
<h4 id="统计某个文件有多少行">统计某个文件有多少行</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible common -m raw -a 'cat /etc/passwd | wc -l'<br>192.168.1.40 | CHANGED | rc=0 &gt;&gt;<br>43<br>Shared connection to 192.168.1.40 closed.<br><br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>45<br>Shared connection to 192.168.1.80 closed.<br><br>[root@python ~]# ansible common -m shell -a 'cat /etc/passwd | wc -l'<br>192.168.1.40 | CHANGED | rc=0 &gt;&gt;<br>43<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>45<br></code></pre></td></tr></table></figure>
<p><strong>引用文件的方式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim test.sh <br><br><span class="hljs-meta">#</span><span class="bash">!/usr/bin/bash</span><br>cat /etc/passwd | wc -l<br>[root@python ~]# ansible common -m script -a 'test.sh'<br>192.168.1.40 | CHANGED =&gt; &#123;<br>    "changed": true, <br>    "rc": 0, <br>    "stderr": "Shared connection to 192.168.1.40 closed.\r\n", <br>    "stderr_lines": [<br>        "Shared connection to 192.168.1.40 closed."<br>    ], <br>    "stdout": "43\r\n", <br>    "stdout_lines": [<br>        "43"<br>    ]<br>&#125;<br>192.168.1.80 | CHANGED =&gt; &#123;<br>    "changed": true, <br>    "rc": 0, <br>    "stderr": "Shared connection to 192.168.1.80 closed.\r\n", <br>    "stderr_lines": [<br>        "Shared connection to 192.168.1.80 closed."<br>    ], <br>    "stdout": "45\r\n", <br>    "stdout_lines": [<br>        "45"<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="（3）file">（3）file</h5>
<p><strong>file模块主要用于对远程服务器上的文件（包括链接和目录）进行操作，包括修改文件的权限、修改文件的所有者、创建文件、删除文件等。</strong></p>
<h4 id="file模块使用示例："><strong>file模块使用示例：</strong></h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建一个目录</span><br>ansible test -m file -a <span class="hljs-string">'path=/tmp/dd state=directory mode=0o755'</span><br><br><span class="hljs-comment"># 修改文件的权限</span><br>ansible test -m file -a <span class="hljs-string">"path=/tmp/dd state=touch mode='u=rw,g=r,o=r'"</span><br><br><span class="hljs-comment"># 创建一个软链接</span><br>ansible test -m file -a <span class="hljs-string">'src=/tmp/dd dest=/tmp/dd1 state=link owner=root group=root'</span><br><br><span class="hljs-comment"># 修改一个文件的所有者</span><br>ansible test -m file -a <span class="hljs-string">"path=/tmp/dd owner=root group=root mode=0o644"</span> -become<br></code></pre></td></tr></table></figure>
<h4 id="file模块中重要选项："><strong>file模块中重要选项：</strong></h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. path: 指定文件/目录的路径<br>2. recurse: 递归设置文件属性，只对目录有效<br>3. group: 定义文件/目录的组<br>4. mode: 定义文件/目录的权限<br>5. owner: 定义文件/目录的所有者<br>6. src: 要被链接的源文件路径，只应用于state为link的情况<br>7. dest: 被链接到的路径，只应用于state为link的情况<br>8. force: 在两种情况下会强制创建软链接，一种情况是源文件不存在，但之后会建立的情况；另一种情况是目标软链接已经存在，需要先取消了之前的软链接，然后再创建新的软链接，默认取值为no<br>9. state: 该选项有多个取值，包括directory、file、link、hard、touch、absent。各个取值的含义如下：取值为directory，如果目录不存在，创建目录；取值为file时，即使文件不存在也不会被创建；取值为link时，创建软链接；取值为hard时，创建硬链接；取值为touch时，如果文件不存就创建一个新文件，如果文件或目录已经存在，更新其最后访问时间和修改时间；取值为absent时，删除目录、文件或者链接<br></code></pre></td></tr></table></figure>
<h4 id="1-创建文件">&lt;1&gt;创建文件</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  common -m file -a 'path=/opt/test.md state=touch'<br></code></pre></td></tr></table></figure>
<h5 id="查看一下">查看一下</h5>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520213902203.png" alt="image-20200520213902203"></p>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520213917288.png" alt="image-20200520213917288"></p>
<h4 id="2-创建目录">&lt;2&gt;创建目录</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  common -m file -a 'path=/opt/test mode=0755 state=directory'<br></code></pre></td></tr></table></figure>
<h5 id="查看一下-2">查看一下</h5>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520214344689.png" alt="image-20200520214344689"></p>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520214401233.png" alt="image-20200520214401233"></p>
<h4 id="3-创建并删除文件">&lt;3&gt;创建并删除文件</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  common -m file -a 'path=/opt/abc mode=0640 state=touch'<br>//创建<br></code></pre></td></tr></table></figure>
<h5 id="查看一下-3"><strong>查看一下</strong></h5>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520215349872.png" alt="image-20200520215349872"></p>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520215415349.png" alt="image-20200520215415349"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  common -m file -a 'path=/opt/abc mode=0640 state=absent'<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520215645645.png" alt="image-20200520215645645"></p>
<h4 id="4-创建并改变文件所有者">&lt;4&gt;创建并改变文件所有者</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  common -m file -a 'path=/opt/abc mode=0640 state=touch'<br><br>[root@python ~]# ansible  common -m file -a 'path=/opt/abc mode=0640 owner=test group=root' -become<br></code></pre></td></tr></table></figure>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200520220049916.png" alt="image-20200520220049916"></p>
<h3 id="（4）copy">（4）copy</h3>
<p><strong>copy模块用来将主控节点的文件或者目录拷贝到远程服务器上，类似于Linux下的scp命令。但是，copy模块比scp命令更强大，在拷贝文件到远程服务器上的同时，也可以设置文件在远程服务器上的权限和所有者。</strong></p>
<p><strong>copy模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 拷贝文件到远程服务器</span><br>ansible test -m copy -a <span class="hljs-string">'src=test.sh dest=/tmp/test.sh'</span><br><br><span class="hljs-comment"># 拷贝文件到远程服务器，如果远程服务器已经存在这个文件，则备份文件</span><br>ansible test -m copy -a <span class="hljs-string">'src=test.sh dest=/tmp/test.sh backup=yes force=yes'</span><br><br><span class="hljs-comment"># 拷贝文件到远程服务器，并且修改文件的所有者和权限</span><br>ansible test -m copy -a <span class="hljs-string">'src=tes.sh dest=/tmp/tes.sh owner=root group=root mode=644 force=yes'</span> -become<br></code></pre></td></tr></table></figure>
<p><strong>copy模块中重要选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. src：要复制到远程服务器的文件地址，可以是绝对路径，也可以是相对路径。如果路径时一个目录，将递归复制。在这种情况下，如果使用“/”结尾，则复制目录里的内容；如果没有用“/”来结尾，则将包含目录在内的整个内容复制，类似于rsync<br>2. dest：文件要复制到的目的地，必须是一个绝对路径，如果源文件是一个目录，那么dest指向的也必须是一个目录<br>3. force：默认取值为yes，表示目标主机包含该文件，但是内容不同时，会强制覆盖；如果该选项设置为no，只有当目标主机的目标位置不存在该文件时，才会进行复制<br>4. backup：默认取值为no，如果取值为yes，那么在覆盖之前将原文件进行备份<br>5. directory_mode：递归设定目录权限，默认为系统默认权限<br>6. others：所有file模块里的选项都可以在这里使用<br></code></pre></td></tr></table></figure>
<h3 id="（5）user-group"><strong>（5）user/group</strong></h3>
<p><strong>user模块请求的是useradd、userdel、usermod这三个指令，group模块请求的是groupadd、groupdel、groupmod这三个指令。</strong></p>
<p><strong>user/group模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建一个用户</span><br>ansible test -m user -a <span class="hljs-string">'name=John comment="John Doe" uid=1239 group=root'</span> -become<br><br><span class="hljs-comment"># 删除一个用户</span><br>ansible test -m user -a <span class="hljs-string">'name=John state=absent'</span> -become<br><br><span class="hljs-comment"># 创建一个用户，并且产生一对密钥</span><br>ansible test -m user -a <span class="hljs-string">'name=John comment="John Doe" generate_ssh_key=yes ssh_key_bits=2048'</span> -become<br><br><span class="hljs-comment"># 创建群组</span><br>ansible test -m group -a <span class="hljs-string">'name=ansible state=present gid=1234'</span> -become<br><br><span class="hljs-comment"># 删除群组</span><br>ansible test -m group -a <span class="hljs-string">'name=ansible state=absent'</span> -become<br></code></pre></td></tr></table></figure>
<p><strong>user/group模块重要选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. name：需要操作的用户名或群组名<br>2. comment：用户的描述信息<br>3. createhome：创建用户时，是否创建家目录，默认为yes<br>4. home：指定用户的家目录，需要与createhome选项配合使用<br>5. group：指定用户的属组<br>6. uid：设置用户的id<br>7. gid：设置群组的id<br>8. password：设置用户的密码<br>9. state：是创建用户或群组，还是删除用户后群组，取值包括present和absent<br>10. expires：用户的过期时间<br>11. shell：指定用户的shell环境<br></code></pre></td></tr></table></figure>
<h3 id="（6）yum"><strong>（6）yum</strong></h3>
<p><strong>yum模块可以帮助我们在远程主机上通过yum源管理软件包。</strong></p>
<p><strong>yum模块使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 安装软件包</span><br>ansible test -m yum -a <span class="hljs-string">'name=nginx disable_gpg_check=yes'</span><br>ansible test -m yum -a <span class="hljs-string">'name=nginx state=present disable_gpg_check=yes'</span><br>ansible test -m yum -a <span class="hljs-string">'name=nginx state=installed disable_gpg_check=yes'</span><br>ansible test -m yum -a <span class="hljs-string">'name=nginx state=latest disable_gpg_check=yes'</span><br><br><span class="hljs-comment"># 卸载软件包</span><br>ansible test70 -m yum -a <span class="hljs-string">'name=nginx state=absent'</span><br>ansible test70 -m yum -a <span class="hljs-string">'name=nginx state=removed'</span><br></code></pre></td></tr></table></figure>
<p><strong>yum模块重要选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. name：必须参数，用于指定需要管理的软件包，比如nginx<br>2. state：用于指定软件包的状态 ，默认值为present，表示确保软件包已经安装，除了present，其他可用值有installed、latest、absent、removed，其中installed与present等效，latest表示安装yum中最新的版本，absent和removed等效，表示删除对应的软件包<br>3. disable_gpg_check：用于禁用对rpm包的公钥gpg验证，默认值为no，表示不禁用验证，设置为yes表示禁用验证，即不验证包，直接安装，在对应的yum源没有开启gpg验证的情况下，需要将此参数的值设置为yes，否则会报错而无法进行安装<br>4. enablerepo：用于指定安装软件包时临时启用的yum源，假如你想要从A源中安装软件，但是你不确定A源是否启用了，你可以在安装软件包时将此参数的值设置为yes，即使A源的设置是未启用，也可以在安装软件包时临时启用A源<br>5. disablerepo：用于指定安装软件包时临时禁用的yum源，某些场景下需要此参数，比如，当多个yum源中同时存在要安装的软件包时，你可以使用此参数临时禁用某个源，这样设置后，在安装软件包时则不会从对应的源中选择安装包<br>6. enablerepo参数和disablerepo参数可以同时使用<br></code></pre></td></tr></table></figure>
<h3 id="（7）get-url"><strong>（7）get_url</strong></h3>
<p><strong>从互联网上下载数据到本地，作用类似于Linux下的curl命令。get_url模块比curl命令更加灵活，可以控制下载以后的数据所有者、权限以及检查下载数据的checksum等。</strong></p>
<p><strong>get_url模块使用示例：</strong></p>
<blockquote>
<p><strong>为了进行get_url测试，使用命令“python -m http.server”启动一个下载服务器，将下载服务器中的文件地址传给url选项。</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 下载文件到远程服务器</span><br>ansible test -m get_url -a <span class="hljs-string">'url=http://localhost:8000/data.tar.gz dest=/tmp/data.tar.gz'</span><br><br><span class="hljs-comment"># 下载文件到远程服务器，并且修改文件的权限</span><br>ansible test -m get_url -a <span class="hljs-string">'url=http://localhost:8000/data.tar.gz dest=/tmp/data.tar.gz mode=0777'</span><br><br><span class="hljs-comment"># 下载文件到远程服务器，并且检查文件的MD5校验是否与控制端的MD5校验相同</span><br>[root@bogon ~]<span class="hljs-comment"># md5sum s.txt</span><br>d41d8cd98f00b204e9800998ecf8427e  s.txt<br>[root@bogon ~]<span class="hljs-comment"># ansible 127.0.0.1 -m get_url -a 'url=http://localhost:8000/s.txt dest=/tmp/s.txt checksum=md5:d41d8cd98f00b204e9800998ecf8427e'</span><br>127.0.0.1 | CHANGED =&gt; &#123;<br>    <span class="hljs-string">"ansible_facts"</span>: &#123;<br>        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span><br>    &#125;,<br>    <span class="hljs-string">"changed"</span>: true,<br>    <span class="hljs-string">"checksum_dest"</span>: null,<br>    <span class="hljs-string">"checksum_src"</span>: <span class="hljs-string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span>,<br>    <span class="hljs-string">"dest"</span>: <span class="hljs-string">"/tmp/s.txt"</span>,<br>    <span class="hljs-string">"elapsed"</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">"gid"</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">"group"</span>: <span class="hljs-string">"root"</span>,<br>    <span class="hljs-string">"md5sum"</span>: <span class="hljs-string">"d41d8cd98f00b204e9800998ecf8427e"</span>,<br>    <span class="hljs-string">"mode"</span>: <span class="hljs-string">"0644"</span>,<br>    <span class="hljs-string">"msg"</span>: <span class="hljs-string">"OK (0 bytes)"</span>,<br>    <span class="hljs-string">"owner"</span>: <span class="hljs-string">"root"</span>,<br>    <span class="hljs-string">"secontext"</span>: <span class="hljs-string">"unconfined_u:object_r:admin_home_t:s0"</span>,<br>    <span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">"src"</span>: <span class="hljs-string">"/root/.ansible/tmp/ansible-tmp-1584171703.8607588-137457225931919/tmpG3otIP"</span>,<br>    <span class="hljs-string">"state"</span>: <span class="hljs-string">"file"</span>,<br>    <span class="hljs-string">"status_code"</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-string">"uid"</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:8000/s.txt"</span><br>&#125;<br>[root@bogon ~]<span class="hljs-comment"># ansible 127.0.0.1 -m get_url -a 'url=http://localhost:8000/s.txt dest=/tmp/s.txt checksum=md5:d41d8cd98f00b204e9800998ecf84270'</span><br>127.0.0.1 | FAILED! =&gt; &#123;<br>    <span class="hljs-string">"ansible_facts"</span>: &#123;<br>        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span><br>    &#125;,<br>    <span class="hljs-string">"changed"</span>: false,<br>    <span class="hljs-string">"checksum_dest"</span>: <span class="hljs-string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span>,<br>    <span class="hljs-string">"checksum_src"</span>: <span class="hljs-string">"da39a3ee5e6b4b0d3255bfef95601890afd80709"</span>,<br>    <span class="hljs-string">"dest"</span>: <span class="hljs-string">"/tmp/s.txt"</span>,<br>    <span class="hljs-string">"elapsed"</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">"msg"</span>: <span class="hljs-string">"The checksum for /tmp/s.txt did not match d41d8cd98f00b204e9800998ecf84277e; it was d41d8cd98f00b204e9800998ecf8427e."</span>,<br>    <span class="hljs-string">"src"</span>: <span class="hljs-string">"/root/.ansible/tmp/ansible-tmp-1584171717.7448506-78799482489470/tmpyczfH3"</span>,<br>    <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:8000/s.txt"</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>get_url模块重要选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. dest：必传选项，指定将文件下载的绝对路径<br>2. url：必传选项，文件的下载地址（网址）<br>3. url_username: 用于http基本认证的用户名<br>4. url_password： 用于http基本认证的密码<br>5. validate_certs： 如果否，SSL证书将不会验证。这只应在使用自签名证书的个人控制站点上使用<br>6. owner： 指定属主<br>7. group： 指定属组<br>8. mode： 指定权限<br>9. checksum：文件的校验码<br>10. headers：传递给下载服务器的HTTP Headers<br>11. backup：如果本地已经存在同名文件，备份文件<br>12. timeout：下载的超时时间<br></code></pre></td></tr></table></figure>
<h3 id="（8）unarchive"><strong>（8）unarchive</strong></h3>
<p><strong>unarchive模块用于解压文件，其作用类似于Linux下的tar命令。默认情况下，unarchive的作用是将控制节点的压缩包拷贝到远程服务器，然后进行解压。</strong></p>
<p><strong>unarchive模块使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 先创建一个目录</span><br>ansible test - m file -a <span class="hljs-string">'path=/tmp/data state=directory'</span><br><br><span class="hljs-comment"># 解压本地文件</span><br>ansible test - m unarchive -a <span class="hljs-string">'src=data.tar.gz dest=/tmp/data list_files=yes'</span><br><br><span class="hljs-comment"># 将本地文件拷贝到远程服务器</span><br>ansible test -m copy -a <span class="hljs-string">'src=data.tar.bz2 dest=/tmp/data.tar.bz2'</span><br><br><span class="hljs-comment"># 解压远程的文件</span><br>ansible test -m unarchive -a <span class="hljs-string">'src=/tmp/data.tar.bz2 dest=/tmp remote_src=yes'</span><br></code></pre></td></tr></table></figure>
<p><strong>unarchive模块重要选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. remote_src：该选项可以取值为yes或no，用来表示解压的文件存在远程服务器中，还是存在控制节点所在的服务器中。默认取值为no，表示在解压文件之前，先将控制节点的文件复制到远程主机中，然后在进行解压<br>2. src：指定压缩文件的路径，该选项的取值取决于remote_src的取值。如果remote_src取值为yes，则src指定的是远程服务器中压缩包的地址；如果remote_src的取值为no，则src指向的是控制节点中的路径<br>3. dest：该选项指定的是远程服务器上的绝对路径，表示压缩文件解压的路径<br>4. list_files：默认情况下该选项取值为no，如果该选项取值为yes，也会解压文件，并且在ansible的返回值中列出压缩包里的文件<br>5. exclude：解压文件时排除exclude选项指定的文件或目录列表<br>6. keep_newer：默认取值为False，如果该选项取值为True，那么当目标地址中存在同名的文件，并且文件比压缩包中的文件更新时，不进行覆盖<br>7. owner：文件或目录解压以后的所有者<br>8. group：文件或目录解压以后所属的群组<br>9. mode：文件或目录解压以后的权限<br></code></pre></td></tr></table></figure>
<h3 id="（9）git"><strong>（9）git</strong></h3>
<p><strong>git模块非常好理解，就是在远程服务器执行git相关的操作。该模块一般应用于需要源码安装软件时，从github这样的源码托管网站将软件下载到本地，然后执行命令进行源码安装。需要注意的是，该模块依赖于git软件，因此在使用该模块前应该使用yum模块先安装git软件。</strong></p>
<p><strong>git模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#将requests克隆到/tmp/requests目录下</span><br>ansible test -m git -a <span class="hljs-string">'repo=https://github.com/psf/requests.git dest=/tmp/requests version=HEAD'</span><br><br><span class="hljs-comment"># 从源码安装requests</span><br>ansible test -a <span class="hljs-string">'python setup.py install chdir=/tmp/requests'</span> -become<br><br><span class="hljs-comment"># 验证requests是否安装成功</span><br>ansible test -a <span class="hljs-string">"python -c 'import requests'"</span><br></code></pre></td></tr></table></figure>
<p><strong>git模块常用选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. repo：远程git库的地址，可以是一个git协议、ssh协议或http协议的git库地址<br>2. dest：必选选项，git库clone到本地服务器以后保存的绝对路径<br>3. version：克隆远程git库的版本，取值可以为HEAD、分支的名称、tag的名称，也可以是一个commit的hash值<br>4. force：默认取值为no，当该选项取值为yes时，如果本地的git库有修改，将会抛弃本地的修改<br>5. accept_hostkey：当该选项取值为yes时，如果git库的服务器不在know_hosts中，则添加到konw_hosts中，key_file指定克隆远程git库地址是使用的私钥<br></code></pre></td></tr></table></figure>
<h3 id="（10）stat"><strong>（10）stat</strong></h3>
<p><strong>stat模块用于获取远程服务器上的文件信息，其作用类似于Linux下的stat命令。stat模块可以获取atime、ctime、mtime、checksum、size、uid、gid等信息。</strong></p>
<p><strong>stat只有path这一个必选选项，用来指定文件或目录的路径。stat模块的使用方法如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取文件的详细信息</span><br>ansible test -m stat -a <span class="hljs-string">'path=/etc/passwd'</span><br></code></pre></td></tr></table></figure>
<h3 id="（11）cron"><strong>（11）cron</strong></h3>
<p><strong>顾名思义，cron是管理Linux下计划任务的模块。</strong></p>
<p><strong>cron模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 增加一个crontab任务</span><br>ansible test -m cron -a <span class="hljs-string">'backup=yes name="测试计划任务" minute=*/2 hour=* job="ls /tmp &gt;/dev/null"'</span><br><br><span class="hljs-comment"># 进入服务器，查看新增的crontab任务</span><br>crontab -l<br></code></pre></td></tr></table></figure>
<p><strong>该模块包含以下重要选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. backup：取值为yes或no，默认为no，表示修改之前先做备份<br>2. state：取值为present或absent，用来确认该任务计划是创建还是删除<br>3. name：该任务的描述<br>4. job：添加或删除任务，主要取决于state的取值<br>5. user：操作哪一个用户的crontab<br>6. cron_file：如果指定该选项，则用该文件替换远程主机上cron.d命令下的用户任务计划<br>7. month weekday 打印minute hour：取值与crontab类似。例如：对于minute的取值范围0~59，也可以选择“*”表示每分钟运行，或者“*/5”表示每5分钟运行<br></code></pre></td></tr></table></figure>
<h3 id="（12）service"><strong>（12）service</strong></h3>
<p><strong>service模块的作用类似于Linux下的service命令，用来启动、停止、重启服务。</strong></p>
<p><strong>service模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 安装Apache，默认情况下，Apache安装完成以后就会启动</span><br>ansible test -m yum -a <span class="hljs-string">'name=httpd state=present'</span> -become<br><br><span class="hljs-comment"># 停止Apache</span><br>ansible test -m service -a <span class="hljs-string">'name=httpd state=stopped'</span><br><br><span class="hljs-comment"># 重启Apache</span><br>ansible <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> -m service -a <span class="hljs-string">'name=httpd state=restarted'</span><br></code></pre></td></tr></table></figure>
<p><strong>service模块的常用选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. name：服务的名称，该选项为必选项<br>2. state：可以取值为started、stopped、restarted和reload。其中，started和stopped是幂等的，也就是说，如果服务已经启动了，执行started不会执行任何操作<br>3. sleep：重启的过程中，先停止服务，然后sleep几秒在启动<br>4. pattern：定义一个模式，ansible首先通过status命令查看服务的状态，依次判断服务是否在运行。如果通过status查看服务状态时没有响应，ansible会尝试匹配ps命令的输出，当匹配到相应模式时，认为服务已经启动，否则认为服务没有启动<br>5. enabled：取值为yes或no，用来设置服务是否开机启动<br></code></pre></td></tr></table></figure>
<h3 id="（13）sysctl"><strong>（13）sysctl</strong></h3>
<p><strong>该模块的作用与Linux下的sysctl命令相似，用于控制Linux的内核参数。</strong></p>
<p><strong>sysctl模块使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 设置overcommit_memory参数的值为1</span><br>ansible test -m sysctl -a <span class="hljs-string">'name=vm.overcommit_memory value=1'</span> -become<br></code></pre></td></tr></table></figure>
<p><strong>sysctl模块的常用选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. name：需要设置的参数<br>2. value：需要设置的值<br>3. sysctl_file：sysctl.conf文件的绝对路径，默认路径是/etc/sysctl.conf<br>4. reload：该选项可以取值为yes或no，默认为yes，用于表示设置完成以后是否需要执行sysctl -p操作<br></code></pre></td></tr></table></figure>
<h3 id="（14）setup"><strong>（14）setup</strong></h3>
<p><strong>setup模块用于收集远程主机的信息</strong></p>
<p><strong>setup模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取IP地址</span><br>ansible test -m setup -a <span class="hljs-string">'filter=ansible_default_ipv4'</span><br><br><span class="hljs-comment"># 获取内存信息</span><br>ansible test -m setup -a <span class="hljs-string">'filter=ansible_memory_mb'</span><br><br><span class="hljs-comment"># 获取主机完整信息</span><br>ansible test -m setup<br></code></pre></td></tr></table></figure>
<h3 id="（15）mount"><strong>（15）mount</strong></h3>
<p><strong>在远程服务器上挂载磁盘，当进行挂盘操作是，如果挂载点指定的路径不存在，将创建该路径。</strong></p>
<p><strong>mount模块使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 挂载/dev/vda盘到/mnt/data目录</span><br>ansible test -m mount -a <span class="hljs-string">'name=/mnt/data src=/dev/vda fstype=ext4 state=mounted'</span><br></code></pre></td></tr></table></figure>
<p><strong>mount模块常用选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. name：挂载点的路径<br>2. state：可以取值为present、absent、mounted、unmounted，其中，mounted与unmounted用来处理磁盘的挂载和卸载，并且会正确配置fstab文件，present与absent只会设置fstab文件，不会去操作磁盘<br>3. fstype：指定文件系统类型，当state取值为present或mounted时，该选项为必填选项<br>4. src：挂载的设备<br></code></pre></td></tr></table></figure>
<h3 id="（16）synchronize"><strong>（16）synchronize</strong></h3>
<p><strong>synchronize模块是对rsync命令的封装，以便对常见的rsync任务进行处理。我们也可以使用command模块调用rsync命令执行相应的操作。rsync是一个比较复杂的命令，相对来说，使用synchronize简单一些。</strong></p>
<p><strong>synchronize模块的使用示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#  同步本地目录到远程服务器</span><br>ansible test -m synchronize -a <span class="hljs-string">'src=test dest=/tmp'</span><br></code></pre></td></tr></table></figure>
<p><strong>synchronize模块的常用选项：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. src：需要同步到远程服务器的文件和目录<br>2. dest：远程服务器保存数据的路径<br>3. archive：默认取值为yes，相当于同时开启recursive、links、perms、times、owner、group、-D等选项<br>4. compress：默认为yes，表示在文件同步过程中是否启用压缩<br>5. delete：默认为no，当取值为yes时，表示删除dest中存在而src中不存在的文件<br></code></pre></td></tr></table></figure>
<h4 id="4、模块的返回值"><strong>4、模块的返回值</strong></h4>
<p><strong>Ansible通过模块来执行具体的操作，由于模块的功能千差万别，所以执行模块操作后，Ansible会根据不同的需要返回不同的结果。虽然如此，Ansible中也有一些常见的返回值。如下所示：</strong></p>
<table>
<thead>
<tr>
<th><strong>返回值的名称</strong></th>
<th><strong>返回值的含义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>changed</strong></td>
<td><strong>几乎所有的Ansible模块都会返回该变量，表示模块是否对远程主机执行了修改操作</strong></td>
</tr>
<tr>
<td><strong>failed</strong></td>
<td><strong>如果模块未能执行完成，将返回failed为True</strong></td>
</tr>
<tr>
<td><strong>msg</strong></td>
<td><strong>模块执行失败的原因，常见的错误如ssh连接失败，没有权限执行模块等</strong></td>
</tr>
<tr>
<td><strong>rc</strong></td>
<td><strong>与命令行工具相关的模块会返回rc，表示执行Linux命令的返回码</strong></td>
</tr>
<tr>
<td><strong>stdout</strong></td>
<td><strong>与rc类似，返回的是标准输出的结果</strong></td>
</tr>
<tr>
<td><strong>stderr</strong></td>
<td><strong>与rc类似，返回的是错误输出的结果</strong></td>
</tr>
<tr>
<td><strong>backup_file</strong></td>
<td><strong>所有存在backup选项的模块，用来返回备份文件的路径</strong></td>
</tr>
<tr>
<td><strong>results</strong></td>
<td><strong>应用在Playbook中存在循环的情况，返回多个结果</strong></td>
</tr>
</tbody>
</table>
<p><strong>错误的</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# ansible  test -i hosts -a 'echo &#123;&#123;ansible_port&#125;&#125;'192.168.1.60 | CHANGED | rc=0 &gt;&gt;<br>22<br>192.168.1.80 | CHANGED | rc=0 &gt;&gt;<br>22<br></code></pre></td></tr></table></figure>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wu Shao Dong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wsdlxgp.top/posts/5017.html">https://wsdlxgp.top/posts/5017.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wsdlxgp.top" target="_blank">Xgp & Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nfs/">nfs</a><a class="post-meta__tags" href="/tags/pv/">pv</a><a class="post-meta__tags" href="/tags/pvc/">pvc</a><a class="post-meta__tags" href="/tags/dashboard/">dashboard</a><a class="post-meta__tags" href="/tags/helm/">helm</a><a class="post-meta__tags" href="/tags/StorageClass/">StorageClass</a><a class="post-meta__tags" href="/tags/python/">python</a></div><div class="post_share"><div class="social-share" data-image="http://xgp-cunchu.test.upcdn.net/k8s/qq%20(11).jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/3.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/1.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/2.jpg" alt="QQ支付"/><div class="post-qr-code__desc">QQ支付</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/1331.html"><img class="prev_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (128).jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">python中Ansible模块的Playbook理解</div></div></a></div><div class="next-post pull_right"><a href="/posts/d003.html"><img class="next_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (76).jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">python自动化管理sshy与paramiko</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/e939.html" title="初识python"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (46).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">初识python</div></div></a></div><div class="relatedPosts_item"><a href="/posts/h8er.html" title="k8s复习"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (45).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">k8s复习</div></div></a></div><div class="relatedPosts_item"><a href="/posts/9a1f.html" title="python变量"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (47).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">python变量</div></div></a></div><div class="relatedPosts_item"><a href="/posts/46cd.html" title="Python 列表"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (48).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">Python 列表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/9b8f.html" title="布尔表达式"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (49).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">布尔表达式</div></div></a></div><div class="relatedPosts_item"><a href="/posts/8e0b.html" title="Python 字典"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (50).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">Python 字典</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM0NS8yNTgzNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (77).jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Wu Shao Dong</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="ypy"><a href="https://console.upyun.com/services/file/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/1591433700(1).png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>