<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Python的SaltStack | Xgp &amp; Blog</title><meta name="description" content="SaltStack Ansible和SaltStack的区别   Ansible安装部署简单。默认情况下，SaltStack需要安装客户端接收服务器发送过来的命令。Ansible不需要在被控服务器上部署任何的客户端，直接使用ssh通道进行远程命令的执行或者下发配置。   SaltStack响应速度快。默认情况下，Ansible使用的是标准的SSH协议，而SaltStack使用ZeroMQ进行通信和"><meta name="keywords" content="nfs,pv,pvc,dashboard,helm,deployment,StorageClass"><meta name="author" content="Wu Shao Dong"><meta name="copyright" content="Wu Shao Dong"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://gitee.com/xgpqq/tuchuang/raw/master/img/Yun.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://hm.baidu.com"/><link rel="dns-prefetch" href="https://hm.baidu.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="rPK0WSwqdm"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python的SaltStack"><meta name="twitter:description" content="SaltStack Ansible和SaltStack的区别   Ansible安装部署简单。默认情况下，SaltStack需要安装客户端接收服务器发送过来的命令。Ansible不需要在被控服务器上部署任何的客户端，直接使用ssh通道进行远程命令的执行或者下发配置。   SaltStack响应速度快。默认情况下，Ansible使用的是标准的SSH协议，而SaltStack使用ZeroMQ进行通信和"><meta name="twitter:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (79).jpg"><meta property="og:type" content="article"><meta property="og:title" content="Python的SaltStack"><meta property="og:url" content="https://wsdlxgp.top/posts/1332.html"><meta property="og:site_name" content="Xgp &amp; Blog"><meta property="og:description" content="SaltStack Ansible和SaltStack的区别   Ansible安装部署简单。默认情况下，SaltStack需要安装客户端接收服务器发送过来的命令。Ansible不需要在被控服务器上部署任何的客户端，直接使用ssh通道进行远程命令的执行或者下发配置。   SaltStack响应速度快。默认情况下，Ansible使用的是标准的SSH协议，而SaltStack使用ZeroMQ进行通信和"><meta property="og:image" content="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (79).jpg"><meta property="article:published_time" content="2019-10-15T16:02:00.000Z"><meta property="article:modified_time" content="2020-06-19T05:12:08.916Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://wsdlxgp.top/posts/1332.html"><link rel="prev" title="python的迭代器" href="https://wsdlxgp.top/posts/1333.html"><link rel="next" title="python中Ansible模块的Playbook理解" href="https://wsdlxgp.top/posts/1331.html"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cad0cd04042fcca2c687648c42a45fc9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Xgp & Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/666.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">125</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">87</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SaltStack"><span class="toc-number">1.</span> <span class="toc-text">SaltStack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ansible和SaltStack的区别"><span class="toc-number">1.1.</span> <span class="toc-text">Ansible和SaltStack的区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">一、安装SaltStack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、实验环境："><span class="toc-number">1.</span> <span class="toc-text">1、实验环境：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2、安装EPEL-都要"><span class="toc-number">1.1.</span> <span class="toc-text">2、安装EPEL(都要)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、安装SaltStack"><span class="toc-number">1.2.</span> <span class="toc-text">3、安装SaltStack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）主服务器安装（主控端）"><span class="toc-number">1.2.1.</span> <span class="toc-text">（1）主服务器安装（主控端）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）从服务器安装（被控端）"><span class="toc-number">1.2.2.</span> <span class="toc-text">（2）从服务器安装（被控端）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、SaltStack防火墙配置-master"><span class="toc-number">1.3.</span> <span class="toc-text">4、SaltStack防火墙配置(master)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、更新Saltstack配置及安装校验"><span class="toc-number">1.4.</span> <span class="toc-text">5、更新Saltstack配置及安装校验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）master主控端配置"><span class="toc-number">1.4.1.</span> <span class="toc-text">（1）master主控端配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1）更新主控端关键项配置"><span class="toc-number">1.4.2.</span> <span class="toc-text">1）更新主控端关键项配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）重启saltstack-salt-master服务，使新配置生效"><span class="toc-number">1.4.3.</span> <span class="toc-text">2）重启saltstack salt-master服务，使新配置生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）minion被控制端配置"><span class="toc-number">1.4.4.</span> <span class="toc-text">（2）minion被控制端配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1）更新被控端关键项配置"><span class="toc-number">1.4.5.</span> <span class="toc-text">1）更新被控端关键项配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）重启saltstack-salt-minion服务，使新配置生效"><span class="toc-number">1.4.6.</span> <span class="toc-text">2）重启saltstack salt-minion服务，使新配置生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（3）校验安装结果"><span class="toc-number">1.4.7.</span> <span class="toc-text">（3）校验安装结果</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">二、使用saltstack远程执行命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、salt命令格式"><span class="toc-number">1.</span> <span class="toc-text">1、salt命令格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、常用的具体参数"><span class="toc-number">2.</span> <span class="toc-text">2、常用的具体参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）-E-–pcre"><span class="toc-number">2.1.</span> <span class="toc-text">（1）-E,–pcre</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）-L-–list"><span class="toc-number">2.2.</span> <span class="toc-text">（2）-L,–list</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）-G-–grain"><span class="toc-number">2.3.</span> <span class="toc-text">（3）-G,–grain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（4）-I-–pillar"><span class="toc-number">2.4.</span> <span class="toc-text">（4）-I,–pillar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（5）-N-–nodegroup"><span class="toc-number">2.5.</span> <span class="toc-text">（5）-N,–nodegroup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（6）-C-–compound"><span class="toc-number">2.6.</span> <span class="toc-text">（6）-C,–compound</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#（7）-S-–ipcidr"><span class="toc-number">2.6.0.1.</span> <span class="toc-text">（7）-S,–ipcidr</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">三、saltstack常用模块及API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、Archive模块"><span class="toc-number">1.</span> <span class="toc-text">1、Archive模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例："><span class="toc-number">1.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API："><span class="toc-number">1.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、cmd模块"><span class="toc-number">2.</span> <span class="toc-text">2、cmd模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-2"><span class="toc-number">2.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-2"><span class="toc-number">2.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、cp模块"><span class="toc-number">3.</span> <span class="toc-text">3、cp模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-3"><span class="toc-number">3.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-3"><span class="toc-number">3.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、cron模块"><span class="toc-number">4.</span> <span class="toc-text">4、cron模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-4"><span class="toc-number">4.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-4"><span class="toc-number">4.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、dnsutil模块"><span class="toc-number">5.</span> <span class="toc-text">5、dnsutil模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-5"><span class="toc-number">5.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-5"><span class="toc-number">5.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6、file模块"><span class="toc-number">6.</span> <span class="toc-text">6、file模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-6"><span class="toc-number">6.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-6"><span class="toc-number">6.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7、iptables模块"><span class="toc-number">7.</span> <span class="toc-text">7、iptables模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-7"><span class="toc-number">7.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-7"><span class="toc-number">7.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8、network模块"><span class="toc-number">8.</span> <span class="toc-text">8、network模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-8"><span class="toc-number">8.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-8"><span class="toc-number">8.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9、pkg包管理模块"><span class="toc-number">9.</span> <span class="toc-text">9、pkg包管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-9"><span class="toc-number">9.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调用API：-9"><span class="toc-number">9.0.2.</span> <span class="toc-text">调用API：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10、Service服务模块"><span class="toc-number">10.</span> <span class="toc-text">10、Service服务模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：-10"><span class="toc-number">10.0.1.</span> <span class="toc-text">示例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API调用："><span class="toc-number">10.0.2.</span> <span class="toc-text">API调用：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11、其他模块"><span class="toc-number">11.</span> <span class="toc-text">11、其他模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">四、grains组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、grains常用操作命令"><span class="toc-number">1.</span> <span class="toc-text">1、grains常用操作命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、定义grains数据"><span class="toc-number">2.</span> <span class="toc-text">2、定义grains数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）被控端主机定制grains数据"><span class="toc-number">2.1.</span> <span class="toc-text">（1）被控端主机定制grains数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）主控端主机定制grains数据"><span class="toc-number">2.2.</span> <span class="toc-text">（2）主控端主机定制grains数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现步骤："><span class="toc-number">2.2.1.</span> <span class="toc-text">实现步骤：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上面代码说明："><span class="toc-number">2.2.2.</span> <span class="toc-text">上面代码说明：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1）-同步模块"><span class="toc-number">2.2.3.</span> <span class="toc-text">1） 同步模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）刷新模块"><span class="toc-number">2.2.4.</span> <span class="toc-text">2）刷新模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3）校验数据"><span class="toc-number">2.2.5.</span> <span class="toc-text">3）校验数据</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">五、pillar组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、pillar的定义"><span class="toc-number">1.</span> <span class="toc-text">1、pillar的定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1）主配置文件定义"><span class="toc-number">1.1.</span> <span class="toc-text">1）主配置文件定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）SLS文件定义"><span class="toc-number">1.2.</span> <span class="toc-text">2）SLS文件定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-定义pillar的主目录"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 定义pillar的主目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-定义入口文件top-sls"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 定义入口文件top.sls</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-校验pillar"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 校验pillar</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、pillar的使用"><span class="toc-number">2.</span> <span class="toc-text">2、pillar的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、操作主机"><span class="toc-number">2.1.</span> <span class="toc-text">1、操作主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、结合grains处理数据的差异性"><span class="toc-number">2.2.</span> <span class="toc-text">2、结合grains处理数据的差异性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#"><span class="toc-number"></span> <span class="toc-text">六、state介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、state的定义"><span class="toc-number">1.</span> <span class="toc-text">1、state的定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、state的使用"><span class="toc-number">2.</span> <span class="toc-text">2、state的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#（1）定义pillar"><span class="toc-number">2.1.</span> <span class="toc-text">（1）定义pillar</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1）创建apache目录："><span class="toc-number">2.1.1.</span> <span class="toc-text">1）创建apache目录：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2）在apache目录创建init-sls"><span class="toc-number">2.1.2.</span> <span class="toc-text">2）在apache目录创建init.sls</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3）测试pillar数据"><span class="toc-number">2.1.3.</span> <span class="toc-text">3）测试pillar数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（2）定义state"><span class="toc-number">2.2.</span> <span class="toc-text">（2）定义state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#（3）执行state"><span class="toc-number">2.3.</span> <span class="toc-text">（3）执行state</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (79).jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Xgp &amp; Blog</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 其他</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 视频</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Python的SaltStack</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2019-10-16 00:02:00"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-10-16</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-19 13:12:08"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-19</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/python/">python</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon far fa-file-word" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">7k</span><span class="post-meta__separator">|</span><i class="post-meta__icon far fa-clock" aria-hidden="true"></i><span>阅读时长: 28 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="SaltStack">SaltStack</h2>
<h3 id="Ansible和SaltStack的区别">Ansible和SaltStack的区别</h3>
<ul>
<li>
<p><strong>Ansible安装部署简单。默认情况下，SaltStack需要安装客户端接收服务器发送过来的命令。Ansible不需要在被控服务器上部署任何的客户端，直接使用ssh通道进行远程命令的执行或者下发配置。</strong></p>
</li>
<li>
<p><strong>SaltStack响应速度快。默认情况下，Ansible使用的是标准的SSH协议，而SaltStack使用ZeroMQ进行通信和传输。因此，仅仅从响应速度来讲，SaltStack比Ansible快很多，甚至快十几倍。在一般运维场景下，Ansible的响应速度完全可以满足需求。</strong></p>
</li>
<li>
<p><strong>Ansible更安全。Ansible使用标准的SSH连接传输数据，不需要在远程主机上启动守护进程。此外，标准的SSH数据传输本身就是加密传输，远程主机不易被攻击。</strong></p>
</li>
<li>
<p><strong>对Windows的支持。SaltStack对Windows的支持比较友好，Ansible从1.7版本开始加入了对Windows的支持。由于Windows默认没有SSH，而Ansible有依赖SSH进行通信，所以在Windows下Ansible需要依赖PowerShell来实现远程管理。Ansible必须使用Linux系统运行控制端。</strong></p>
</li>
<li>
<p><strong>Ansible自身运维比较简单。SaltStack需要在Master和Minion主机启动一个守护进程，自身需要检测守护进程的运行状态，增加了运维成本。Ansible和服务器之间用SSH进行通信，服务器上值需要运行SSH进程就可以进行运维操作。因此，从工具本身的运维角度来说，Ansible要比SaltStack简单很多。</strong></p>
</li>
</ul>
<h1>一、安装SaltStack</h1>
<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200522142601976.png" alt="image-20200522142601976"></p>
<h2 id="1、实验环境：">1、实验环境：</h2>
<table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>id(minion id)</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>python</td>
<td>SN-2020-03-01</td>
<td>192.168.1.80</td>
</tr>
<tr>
<td>minion</td>
<td>192.168.1.40</td>
<td>SN-2020-03-11</td>
<td>192.168.1.40</td>
</tr>
</tbody>
</table>
<h3 id="2、安装EPEL-都要">2、安装EPEL(都要)</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install epel<br>或<br>yum install epel-release -y<br></code></pre></td></tr></table></figure>
<h3 id="3、安装SaltStack">3、安装SaltStack</h3>
<h4 id="（1）主服务器安装（主控端）">（1）主服务器安装（主控端）</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install salt-master<br>chkconfig salt-master on<br>service salt-master start<br></code></pre></td></tr></table></figure>
<h4 id="（2）从服务器安装（被控端）">（2）从服务器安装（被控端）</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install salt-minion<br>chkconfig salt-minion on<br>service salt-minion start<br></code></pre></td></tr></table></figure>
<h3 id="4、SaltStack防火墙配置-master">4、SaltStack防火墙配置(master)</h3>
<p><strong>在主控端添加TCP 4505、TCP 4506的规则，而在被控端无须配置防火墙，原理是被控端直接与主控端的zeromq建立长链接，接收广播到的任务信息并执行，具体操作是添加两条iptables规则:</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]#  iptables -I INPUT -m state --state new -m tcp -p tcp --dport 4505 -j ACCEPT<br>[root@python ~]# iptables -I INPUT -m state --state new -m tcp -p tcp --dport 4506 -j ACCEPT<br></code></pre></td></tr></table></figure>
<h3 id="5、更新Saltstack配置及安装校验">5、更新Saltstack配置及安装校验</h3>
<p><strong>Saltstack分两种角色，一种为master（主控端），另一种为minion（被控端），安装完毕后需要对两种角色的配置文件进行修改。下面具体说明：</strong></p>
<h4 id="（1）master主控端配置">（1）master主控端配置</h4>
<h4 id="1）更新主控端关键项配置">1）更新主控端关键项配置</h4>
<blockquote>
<p>/etc/salt/master</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# vim test.ping<br><span class="hljs-meta">#</span><span class="bash"> 绑定Master通信IP</span><br>interface: 192.168.79.143  # 15行<br><span class="hljs-meta">#</span><span class="bash"> 自动认证，避免手动运行salt-key来确认证书信任</span><br>auto_accept: True         #215<br><span class="hljs-meta">#</span><span class="bash"> 指定saltstack文件根目录的位置</span><br>file_roots:               #406<br>  base:<br>    - /srv/salt<br></code></pre></td></tr></table></figure>
<p><strong>当/etc/salt/master没有配置auto_accept: True时，需要通过salt-key命令来进行证书认证操作，具体操作如下：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tex">salt-key -L:显示已经或未认证的被控端id,Accepted Keys为已认证清单，Unaccepted Kys为未认证的清单<br>salt-key -D:删除所有认证主机id证书<br>salt-key -d id:删除单个id证书<br>salt-key -A:接受所有id证书请求<br>salt-key -a id:接受单个id证书请求<br></code></pre></td></tr></table></figure>
<h4 id="2）重启saltstack-salt-master服务，使新配置生效">2）重启saltstack salt-master服务，使新配置生效</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">service salt-master restart<br></code></pre></td></tr></table></figure>
<h4 id="（2）minion被控制端配置">（2）minion被控制端配置</h4>
<h4 id="1）更新被控端关键项配置">1）更新被控端关键项配置</h4>
<blockquote>
<p><strong>/etc/salt/minion</strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@192 ~]# vim test.ping<br><span class="hljs-meta">#</span><span class="bash"> 指定master主机IP地址</span><br>master: 192.168.79.143    # 15行<br><span class="hljs-meta">#</span><span class="bash"> 修改被控制端主机识别ID，建议使用操作系统主机名来配置</span><br>id: XGP<br></code></pre></td></tr></table></figure>
<h4 id="2）重启saltstack-salt-minion服务，使新配置生效">2）重启saltstack salt-minion服务，使新配置生效</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">service salt-minion restart<br></code></pre></td></tr></table></figure>
<h4 id="（3）校验安装结果">（3）校验安装结果</h4>
<p><strong>通过test模块的ping方法，可以确认指定被控端设备与主控端是否建立信任关系，及连通性是否正常，探测所有被控端采用“*”来代替“SN-2020-03-20”即可。如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@192 ~]# salt 'XGP' test.ping<br>XGP:<br>    True<br></code></pre></td></tr></table></figure>
<h1>二、使用saltstack远程执行命令</h1>
<p><strong>saltstack的一个比较突出的优势是，具备执行远程命令的功能，可以帮助运维人员完成集中化的操作平台。</strong></p>
<h2 id="1、salt命令格式">1、salt命令格式</h2>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">salt '&lt;操作目标&gt;' &lt;方法&gt;[参数]<br></code></pre></td></tr></table></figure>
<p><strong>示例：查看被控主机的内存使用情况</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# salt 'XGP' cmd.run 'free -m'<br>XGP:<br>                  total        used        free      shared  buff/cache   available<br>    Mem:            976         500          94           2         381         260<br>    Swap:          2047         267        1780<br></code></pre></td></tr></table></figure>
<h2 id="2、常用的具体参数">2、常用的具体参数</h2>
<p><strong>针对&lt;操作目标&gt;，saltstack提供了多种方法对被控端主机（id）进行过滤。</strong></p>
<h3 id="（1）-E-–pcre">（1）-E,–pcre</h3>
<p><strong>通过正则表达式进行匹配。示例：监控SN-2020字符开头的主机id名是否连通，如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# salt -E '^XG*' test.ping<br>XGP:<br>    True<br></code></pre></td></tr></table></figure>
<h3 id="（2）-L-–list">（2）-L,–list</h3>
<p><strong>以主机名id列表的形式进行过滤，格式与Python的列表相似，即不同的主机id名称使用逗号进行分隔。示例：获取主机id名为XGP；获取完整操作系统发行版本名称。如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@python ~]<span class="hljs-comment"># salt -L 'XGP' grains.item osfullname</span><br>XGP:<br>    ----------<br>    osfullname:<br>        CentOS Linux<br></code></pre></td></tr></table></figure>
<h3 id="（3）-G-–grain">（3）-G,–grain</h3>
<p><strong>根据被控主机的grain信息进行匹配过滤，格式为’<grain value>:<glob expression>’，例如：过滤内核为Linux的主机可以写成‘kernel:Linux’，如果同时需要正则表达式的支持，可切换成–grain-pcre参数来执行。示例：获取主机发行版本号为7.5的Python版本号。</glob></grain></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# salt -G 'osrelease:6.5' cmd.run 'python -V'<br><br>saltstack_web1group_1:    Python 2.6.6<br>saltstack_web1group_2:    Python 2.6.6<br></code></pre></td></tr></table></figure>
<h3 id="（4）-I-–pillar">（4）-I,–pillar</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# salt -I 'httpd:root:/data' test.ping<br><br>saltstack_web1group_1:    True<br>saltstack_web1group_2:    True<br><span class="hljs-meta">#</span><span class="bash">其中pillar属性配置文件如下：httpd:root: /data</span><br></code></pre></td></tr></table></figure>
<h3 id="（5）-N-–nodegroup">（5）-N,–nodegroup</h3>
<p><strong>根据主控端master配置文件中的分组名称进行过滤。如下所示：</strong></p>
<blockquote>
<p>/etc/salt/master</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@python ~]<span class="hljs-comment"># vim /etc/salt/master </span><br>nodegroups:                   <span class="hljs-comment">#710</span><br>  group1: <span class="hljs-string">'L@XGP，WSD'</span>             <span class="hljs-comment">#如果有多个可用逗号隔开</span><br>  group2: <span class="hljs-string">'L@XGP'</span><br>        <br>[root@python ~]<span class="hljs-comment"># service salt-master restart</span><br>Redirecting to /bin/systemctl restart salt-master.service<br><br>[root@python ~]<span class="hljs-comment"># salt -N group1 test.ping</span><br>XGP:<br>    <span class="hljs-literal">True</span><br>[root@python ~]<span class="hljs-comment"># salt -N group2 test.ping</span><br>XGP:<br>    <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>
<h3 id="（6）-C-–compound">（6）-C,–compound</h3>
<p><strong>根据条件运算符not、and、or去匹配不同规则的主机信息。示例：探测SN-2020开头，并且操作系统版本为CentOS的主机连通性。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@python ~]# salt -C 'E@XG* and G@os:CentOS' test.ping<br>XGP:<br>    True<br></code></pre></td></tr></table></figure>
<p><strong>其中，not语句不能作为第一个条件执行，不过可以通过以下方式来规避。示例：探测非SN-2023开头的主机连通性。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt -C '* and not E@^SN-2023*' test.ping</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>
<h5 id="（7）-S-–ipcidr">（7）-S,–ipcidr</h5>
<p><strong>根据被控主机的IP地址或IP子网进行匹配，示例如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt -S 192.168.0.0/16 test.ping</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt -S 192.168.79.164 test.ping</span><br></code></pre></td></tr></table></figure>
<h1>三、saltstack常用模块及API</h1>
<p><strong>saltstack提供了非常丰富的功能模块，设计操作系统的基础功能、常用工具支持等。使用sys模块可以列出当前版本支持的模块。</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt '*' sys.list_modules</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    - acl<br>    - aliases<br>    - alternatives<br>    - archive<br>    - artifactory<br>    &lt;!--省略部分输出--&gt;<br></code></pre></td></tr></table></figure>
<p><strong>APId的原理是通过调用master client模块，实例化一个LocalClient对象，再调用cmd()方法实现的。以下是API实现test.ping的示例：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> salt.client<br><br>clinet = salt.client.LocalClient()<br>result  = client.cmd(<span class="hljs-string">'*'</span>, <span class="hljs-string">'test.ping'</span>)<br>print(result)<br></code></pre></td></tr></table></figure>
<p><strong>结果以一个标准的Python字典形式的字符串返回，可以通过eval()函数转换成Python的字典类型，方便后续的业务u逻辑处理。程序运行结果如下：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">&#123;'SN-2020-03-20':True&#125;<br></code></pre></td></tr></table></figure>
<h2 id="1、Archive模块">1、Archive模块</h2>
<p><strong>功能：实现系统层面的压缩包调用，支持gunzip、gzip、rar、tar、unrar、unzip等。</strong></p>
<h4 id="示例：">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 采用gzip解压 /tmp/data.txt文件</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' archive.gzip  /tmp/data.txt</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br><br><span class="hljs-comment"># 采用tar压缩 /tmp/data.txt文件</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' archive.tar cvf /tmp/data.txt.tar /tmp/data.txt</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    - tar: Removing leading `/<span class="hljs-string">' from member names</span><br><span class="hljs-string">    - /tmp/data.txt</span><br></code></pre></td></tr></table></figure>
<h4 id="调用API：">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-2020-03-20'</span>,<span class="hljs-string">'archive.gzip'</span>,[<span class="hljs-string">'/tmp/data.txt'</span>])<br></code></pre></td></tr></table></figure>
<h2 id="2、cmd模块">2、cmd模块</h2>
<p><strong>实现远程的命令行调用执行（默认具备root操作权限，慎用！）</strong></p>
<h4 id="示例：-2">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取所有被控主机的内存情况</span><br>salt <span class="hljs-string">'*'</span> cmd.run <span class="hljs-string">"free -m"</span><br><br><span class="hljs-comment"># 在SN-2020-03-20主机运行test.sh脚本，</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> cmd.script salt://script/test.sh<br>    <br><span class="hljs-comment"># 其中script/test.sh脚本存放在file_roots指定的目录:/srv/salt</span><br>mkdir -p /srv/salt/script<br>vim /srv/salt/script/test.sh<br><span class="hljs-comment"># 该命令会做2个动作：</span><br><span class="hljs-comment"># 	1.首先同步test.sh到minion的cache目录（如：同步到</span><br><span class="hljs-comment"># 	/var/cache/salt/minion/files/base/script/test.sh）；</span><br><span class="hljs-comment"># 	2.其次运行该脚本。</span><br></code></pre></td></tr></table></figure>
<h4 id="调用API：-2">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-2020-03-20'</span>,<span class="hljs-string">'cmd.run'</span>,[<span class="hljs-string">'free -m'</span>])<br></code></pre></td></tr></table></figure>
<h2 id="3、cp模块">3、cp模块</h2>
<p><strong>实现远程文件、目录的复制，以及下载URL文件等操作。</strong></p>
<h4 id="示例：-3">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 将指定被控主机的/etc/hosts文件复制到被控主机本地的salt的cache目录（/var/cache/salt/minion/localfiles/）</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt '*' cp.cache_local_file /etc/hosts</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    /var/cache/salt/minion/localfiles/etc/hosts<br><br><span class="hljs-comment"># 将主服务器file_roots指定位置下的目录复制到被控主机，空目录不复制</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" cp.get_dir salt://ccc /tmp</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    - /tmp/ccc/ccc.txt<br><br><span class="hljs-comment"># 将主服务器file_roots指定位置下的文件复制到被控主机</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" cp.get_file salt://test.sh /tmp/test.sh</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    /tmp/test.sh<br><br><span class="hljs-comment"># 下载URL内容到被控主机指定位置</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" cp.get_url https://slashdot.org/ /tmp/index.html</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    /tmp/index.html<br></code></pre></td></tr></table></figure>
<h4 id="调用API：-3">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-2020-03-20'</span>, <span class="hljs-string">'cp.get_file, ['</span>salt://path/to/file<span class="hljs-string">' ,'</span>/minion/dest<span class="hljs-string">'])</span><br></code></pre></td></tr></table></figure>
<h2 id="4、cron模块">4、cron模块</h2>
<p><strong>实现被控主机的crontab操作。</strong></p>
<h4 id="示例：-4">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 查看指定被控主机、root用户的crontab清单</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" cron.raw_cron root</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-comment"># Lines below here are managed by Salt, do not edit</span><br>    * * * * * /usr/bin/date<br><br><span class="hljs-comment"># 为指定的被控主机、root用户添加/usr/bin/date任务作业    </span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" cron.set_job root '*' '*' '*' '*' '*' /usr/bin/date</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    new<br><br><span class="hljs-comment"># 删除指定的被控主机、root用户crontab的/usr/bin/date任务作业</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" cron.rm_job root /usr/bin/date</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    removed<br></code></pre></td></tr></table></figure>
<h4 id="调用API：-4">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-03-2020-20'</span>, <span class="hljs-string">'cron.set_job'</span>, [<span class="hljs-string">'root'</span>,<span class="hljs-string">'*'</span>,<span class="hljs-string">'*'</span>,<span class="hljs-string">'*'</span>,<span class="hljs-string">'*'</span>,<span class="hljs-string">'*'</span>,<span class="hljs-string">'/usr/bin/date'</span>])<br></code></pre></td></tr></table></figure>
<h2 id="5、dnsutil模块">5、dnsutil模块</h2>
<p><strong>实现被控主机通用DNS相关操作。</strong></p>
<h4 id="示例：-5">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 添加指定被控主机hosts的主机配置项</span><br>salt <span class="hljs-string">'*'</span> dnsutil.hosts_append /etc/hosts <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> ad1.yk.com,ad2,yk.com<br><br><span class="hljs-comment"># 删除指定被控主机hosts的主机配置项</span><br>salt <span class="hljs-string">'*'</span> dnsutil.hosts_remove /etc/hosts ad1.yk.com<br></code></pre></td></tr></table></figure>
<h4 id="调用API：-5">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'*'</span>, <span class="hljs-string">'dnsutil.hosts_append'</span>, [<span class="hljs-string">'/etc/hosts'</span>,<span class="hljs-string">'127.0.0.1'</span>,<span class="hljs-string">'ad1.yk.com'</span>])<br></code></pre></td></tr></table></figure>
<h2 id="6、file模块">6、file模块</h2>
<p><strong>被控主机文件常见的操作，包括文件读写、权限、查找、校验等。</strong></p>
<h4 id="示例：-6">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 校验所有被控主机/etc/fstab文件的MD5，一致则返回True</span><br><br><span class="hljs-comment"># 修改所有别空主机文件的属组、用户权限，等价于chown test:root /tmp/test.sh</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.chown /tmp/test.sh test root</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># 复制被控主机本地文件到本地的文件</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.copy /tmp/ccc/ccc.txt /tmp/c.txt</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># 检查所有被控主机/etc目录是否存在，存在则返回True，检查文件是否存在使用file.file_exists方法</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.directory_exists /etc</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.file_exists /etc/passwd</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 获取所有被控主机/etc/passwd的stats信息</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.stats /etc/passwd</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    atime:<br>        <span class="hljs-number">1585115927.94</span><br>    ctime:<br>        <span class="hljs-number">1572940727.67</span><br>    gid:<br>        <span class="hljs-number">0</span><br>    group:<br>        root<br>    inode:<br>        <span class="hljs-number">19172097</span><br>    mode:<br>        <span class="hljs-number">0644</span><br>    mtime:<br>        <span class="hljs-number">1572940727.67</span><br>    size:<br>        <span class="hljs-number">2349</span><br>    target:<br>        /etc/passwd<br>    type:<br>        file<br>    uid:<br>        <span class="hljs-number">0</span><br>    user:<br>        root<br><br><span class="hljs-comment"># 获取所有被控主机/etc/passwd的权限mode，如：755,644</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.get_mode /etc/passwd</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-number">0644</span><br><br><span class="hljs-comment"># 修改所有被控主机/etc/passwd的权限mode为644</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.set_mode /etc/passwd 644</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-number">0644</span><br><br><span class="hljs-comment"># 在所有被控主机创建目录</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.mkdir /opt/test</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># 将所有被控主机/etc/httpd/httpd.conf文件的LogLevel参数warn值修改为info</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.sed /tmp/date.log "内容" "content"</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    pid:<br>        <span class="hljs-number">15581</span><br>    retcode:<br>        <span class="hljs-number">0</span><br>    stderr:<br>    stdout:<br><br><span class="hljs-comment"># 给所有被控主机的/tmp/test/test.conf文件追加内容“maxclient 100”</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.append /tmp/date.log "追加内容"</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    Wrote <span class="hljs-number">1</span> lines to <span class="hljs-string">"/tmp/date.log"</span><br><br><span class="hljs-comment"># 删除所有被控主机的/tmp/foo文件</span><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt "SN-2020-03-20" file.remove /tmp/c.txt</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>
<h4 id="调用API：-6">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'*'</span>, <span class="hljs-string">'file.remove'</span>, [<span class="hljs-string">'/tmp/foo'</span>])<br></code></pre></td></tr></table></figure>
<h2 id="7、iptables模块">7、iptables模块</h2>
<p><strong>被控主机ilptables支持。</strong></p>
<h4 id="示例：-7">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 在所有被控主机追加、插入iptables规则，其中INPUT为输入链</span><br>salt <span class="hljs-string">'*'</span> iptables.append filter INPUT rule=<span class="hljs-string">'-m state --state RELATED,ESTABLISHED -j ACCEPT'</span><br><br>salt <span class="hljs-string">'*'</span> iptables.insert filter INPUT position=<span class="hljs-number">3</span> rule=<span class="hljs-string">'-m state --state RELATED,ESTABLISHED -j ACCEPT'</span><br><br><span class="hljs-comment"># 在所有被控主机删除指定链编号为3（position=3）或者指定存在的规则</span><br>salt <span class="hljs-string">'*'</span> iptables.delete filter INPUT position=<span class="hljs-number">3</span><br>salt <span class="hljs-string">'*'</span> iptables.delete filter INPUT rule=<span class="hljs-string">'-m state --state RELATED,ESTABLISHED -j ACCEPT'</span><br><br><span class="hljs-comment"># 保存所有被控主机规则到本地硬盘（/etc/sysconfig/iptables）</span><br>salt <span class="hljs-string">'*'</span> iptables.save /etc/sysconfig/iptables<br></code></pre></td></tr></table></figure>
<h4 id="调用API：-7">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-2020-03-20'</span>, <span class="hljs-string">'iptables.append'</span>, [<span class="hljs-string">'filter'</span>, <span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'rule=\'-p tcp--sport 80 -j ACCEPT\''</span>])<br></code></pre></td></tr></table></figure>
<h2 id="8、network模块">8、network模块</h2>
<p><strong>返回被控主机网络信息。</strong></p>
<h4 id="示例：-8">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 在指定被控主机“SN-2020-03-20”获取dig、ping、traceroute目录域名信息</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.dig www.qq.com<br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.ping www.qq.com<br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.traceroute www.qq.com<br><br><span class="hljs-comment"># 获取指定被控主机“SN-2020-03-20”的MAC地址</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.hwaddr ens33<br><br><span class="hljs-comment"># 检测指定被控主机“SN-2020-03-20”是否属于10.0.0.0/16子网范围，属于则返回True</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.in_subnet <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">16</span><br><br><span class="hljs-comment"># 获取指定被控主机“SN-2020-03-20”的网卡配置信息</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.interfaces<br><br><span class="hljs-comment"># 获取指定被控主机“SN-2020-03-20”的IP地址配置信息</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.ip_addrs<br><br><span class="hljs-comment"># 获取指定被控主机“SN-2020-03-20”的子网信息</span><br>salt <span class="hljs-string">'SN-2020-03-20'</span> network.subnets<br></code></pre></td></tr></table></figure>
<h4 id="调用API：-8">调用API：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-2020-03-20'</span>,<span class="hljs-string">'network.subnets'</span>)<br></code></pre></td></tr></table></figure>
<h2 id="9、pkg包管理模块">9、pkg包管理模块</h2>
<p><strong>被控主机程序包管理，如yum、apt-get等。</strong></p>
<h4 id="示例：-9">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 为所有被控主机安装PHP环境，根据不同系统发行版调用不同的安装工具进行部署，如Redhat平台的yum，等价于yum -y install php</span><br>salt <span class="hljs-string">'*'</span> pkg.install php<br><br><span class="hljs-comment"># 卸载所有被控主机的PHP环境</span><br>salt <span class="hljs-string">'*'</span> pkg.remove php<br><br><span class="hljs-comment"># 升级所有被控主机的软件包</span><br>salt <span class="hljs-string">'*'</span> pkg.upgrade<br></code></pre></td></tr></table></figure>
<h4 id="调用API：-9">调用API：</h4>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pypthon">client.cm(&#39;SN-2020-03-20&#39;,&#39;pgk.remove&#39;, [&#39;php&#39;])<br></code></pre></td></tr></table></figure>
<h2 id="10、Service服务模块">10、Service服务模块</h2>
<p><strong>被控主机程序包的服务管理。</strong></p>
<h4 id="示例：-10">示例：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 开启（enable）、禁用（disable）nginx开机自启动服务</span><br>salt <span class="hljs-string">'*'</span> service.enable nginx<br>salt <span class="hljs-string">'*'</span> service.disable nginx<br><br><span class="hljs-comment"># 针对nginx服务的reload、restart、start、stop、status操作</span><br>salt <span class="hljs-string">'*'</span> service.reload nginx<br>salt <span class="hljs-string">'*'</span> service.restart nginx<br>salt <span class="hljs-string">'*'</span> service.start nginx<br>salt <span class="hljs-string">'*'</span> service.stop nginx<br>salt <span class="hljs-string">'*'</span> service.staus nginx<br></code></pre></td></tr></table></figure>
<h4 id="API调用：">API调用：</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">client.cmd(<span class="hljs-string">'SN-2020-03-20'</span>, <span class="hljs-string">'service.stop'</span>, [<span class="hljs-string">'nginx'</span>])<br></code></pre></td></tr></table></figure>
<h2 id="11、其他模块">11、其他模块</h2>
<p><strong>通过上面介绍的10个常用的模块，基本上已经覆盖了日常的运维操作。saltstack还提供了其他模块，如下所示：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tex">user：系统用户模块<br>group：系统组模块<br>partition：系统分区模块<br>puppet：puppet管理模块<br>system：系统重启、关机模块<br>timezone：时区管理模块<br>nginx：NGINX管理模块<br>mount：文件系统挂载模块<br>……<br></code></pre></td></tr></table></figure>
<p><strong>更多的模块介绍请查阅官网。</strong></p>
<h1>四、grains组件</h1>
<p><strong>grains是saltstack最重要的组件之一，grains的作用是手机被控主机的基本信息，这些信息通常都是一些静态类的数据，包括CPU、内核、操作系统、虚拟化等，在服务器端可以根据这些信息进行灵活定制，管理员可以利用这些信息对不同业务进行个性化配置。官网提供的用来区分不同操作系统的示例如下（采用jinja模板）：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;% <span class="hljs-keyword">if</span> grains[<span class="hljs-string">'os'</span>] == <span class="hljs-string">'Ubuntu'</span> %&#125;<br>host: &#123;&#123; grains[<span class="hljs-string">'host'</span>] &#125;&#125;<br>&#123;% <span class="hljs-keyword">elif</span> grains[<span class="hljs-string">'os'</span>] == <span class="hljs-string">'CentOSu'</span> %&#125;<br>host: &#123;&#123; grains[<span class="hljs-string">'fqdn'</span>] &#125;&#125;<br>&#123;% endif %&#125;<br></code></pre></td></tr></table></figure>
<p><strong>示例中CentOS发行版主机将被“host: {{ grains['fqdn'] }}”匹配，同时，命令行的匹配操作系统发行版本为CentOS的被控端可以通过-G参数来过滤，如salt -G ‘os:CentOS’ test.ping。</strong></p>
<h2 id="1、grains常用操作命令">1、grains常用操作命令</h2>
<p><strong>匹配内核版本为3.10.0-957.el7.x86_64的主机：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt -G 'kernelrelease:3.10.0-957.el7.x86_64' cmd.run 'uname -a'</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    Linux <span class="hljs-number">192.168</span><span class="hljs-number">.79</span><span class="hljs-number">.146</span> <span class="hljs-number">3.10</span><span class="hljs-number">.0</span><span class="hljs-number">-957.</span>el7.x86_64 <span class="hljs-comment">#1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br></code></pre></td></tr></table></figure>
<p><strong>获取所有主机的grains项信息：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' grains.ls</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    - SSDs<br>    - biosreleasedate<br>    - biosversion<br>    - cpu_flags<br>    - cpu_model<br>    - cpuarch<br>    - domain<br>    - fqdn<br>    - fqdn_ip4<br>    - fqdn_ip6<br>    - gpus<br>    - host<br>    - hwaddr_interfaces<br>    - id<br>    - init<br>    - ip4_interfaces<br>    - ip6_interfaces<br>    - ip_interfaces<br>    - ipv4<br>    - ipv6<br>    - kernel<br>    - kernelrelease<br>    - locale_info<br>    - localhost<br>    - lsb_distrib_id<br>    - machine_id<br>    - manufacturer<br>    - master<br>    - mdadm<br>    - mem_total<br>    - nodename<br>    - num_cpus<br>    - num_gpus<br>    - os<br>    - os_family<br>    - osarch<br>    - oscodename<br>    - osfinger<br>    - osfullname<br>    - osmajorrelease<br>    - osrelease<br>    - osrelease_info<br>    - path<br>    - productname<br>    - ps<br>    - pythonexecutable<br>    - pythonpath<br>    - pythonversion<br>    - saltpath<br>    - saltversion<br>    - saltversioninfo<br>    - selinux<br>    - serialnumber<br>    - server_id<br>    - shell<br>    - systemd<br>    - virtual<br>    - zmqversion<br></code></pre></td></tr></table></figure>
<p><strong>当然，也可以获取主机单项grains数据，如获取操作系统发行版本，执行命令：<code>salt 'SN-2020-03-20' grains.item os</code>，结果如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' grains.item os</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    os:<br>        CentOS<br></code></pre></td></tr></table></figure>
<p><strong>如果要获取主机id为“SN-2020-03-20”的所有grains键及值信息，执行以下命令：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">salt <span class="hljs-string">'SN-2020-03-20'</span> grains.items<br></code></pre></td></tr></table></figure>
<h2 id="2、定义grains数据">2、定义grains数据</h2>
<p><strong>定义grains数据的方法有两种，其中一种为在被控主机定制配置文件，另一种是通过主</strong><br>
<strong>控端扩展模块API实现，区别是模块更灵活。可以通过Python编程动态定义，而配置文件</strong><br>
<strong>只适合相对固定的键与值，下面分别举例说明。</strong></p>
<h3 id="（1）被控端主机定制grains数据">（1）被控端主机定制grains数据</h3>
<p><strong>SSH登录一台被控机，如：SN-2020-03-20，配置文件定制的路径为/etc/salt/minion.d/hostinfo.conf，具体操作如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@192 ~]# vim /etc/salt/minion.d/hostinfo.conf<br>grains:<br>  roles:<br>    - webserver<br>    - redis<br>  deployment: datacenter4<br>  cabinet: 13<br>[root@192 ~]# service salt-minion restart<br></code></pre></td></tr></table></figure>
<p><strong>重启被控主机salt-minion服务，使配置生效。验证结果在主控机运行：<code>salt 'SN-2020-03-20' grains.item roles deployment cabinet</code>，观察配置的键和值，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' grains.item roles deployment cabinet</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    cabinet:<br>        <span class="hljs-number">13</span><br>    deployment:<br>        datacenter4<br>    roles:<br>        - webserver<br>        - redis<br></code></pre></td></tr></table></figure>
<h3 id="（2）主控端主机定制grains数据">（2）主控端主机定制grains数据</h3>
<h4 id="实现步骤：">实现步骤：</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. 首先在主控端编写Python代码，<br>2. 然后将Python文件同步到被控主机，<br>3. 最后刷新生效。<br></code></pre></td></tr></table></figure>
<p><strong>在主控端base目录（默认的base配置在/srv/salt）下生成_grains目录，编写Python代码，事项获取主控机系统允许最大打开文件数的grains数据。</strong></p>
<blockquote>
<p><strong>/srv/salt/_grains/sysprocess.py</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os,sys,commands<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">grains_openfile</span><span class="hljs-params">()</span>:</span><br>    grains = &#123;&#125;<br>    _open_file = <span class="hljs-number">65536</span><br>    getulimit = <span class="hljs-number">0</span> <br><br>    <span class="hljs-keyword">try</span>:<br>        getulimit = commands.getstatusoutout(<span class="hljs-string">'source /etc/profile;ulimit -n'</span>)<br>true<span class="hljs-keyword">if</span> getulimit[<span class="hljs-number">0</span>] == <span class="hljs-number">0</span>:<br>        	_open_file = int(getulimit[<span class="hljs-number">1</span>])<br><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">pass</span><br>    <br>    grains[<span class="hljs-string">'max_open_file'</span>] = _open_file<br>    <span class="hljs-keyword">return</span> grains<br></code></pre></td></tr></table></figure>
<h4 id="上面代码说明：">上面代码说明：</h4>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">1. grains_open_file()：定义一个获取最大打开文件数的函数，函数名称没有要求，符合Python的函数命名规则即可；<br>2. grains&#123;&#125;：初始化一个grains字典，变量名一定要用grains，以便SaltStack识别；<br>3. grains['max_open_file']=_open_file：将获取的“ulimit -n”的结果赋值给grains['max_open_file']，其中“max_open_file”就是grains的项，“_open_file”就是grains的值。<br></code></pre></td></tr></table></figure>
<p><strong>最后同步模块到指定被控端主机，并刷新生效。因为grains比较适合采集静态类数据，比如：硬件、内核信息等。当有动态类的功能需求是，需要执行刷新，具体操作如下：</strong></p>
<h4 id="1）-同步模块">1） 同步模块</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' saltutil.sync_all</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    beacons:<br>    grains:<br>        - grains.sysprocess<br>    modules:<br>    output:<br>    renderers:<br>    returners:<br>    sdb:<br>    states:<br>    utils:<br></code></pre></td></tr></table></figure>
<p><strong>文件被同步到控端主机的minion cache目录下，如下所示：</strong></p>
<blockquote>
<p><strong>/var/cache/salt/minion/extmods/grains/为扩展模块文件最终存放位置，刷新模块后将在同路径下生成字节码pyc；</strong></p>
<p><strong>/var/cache/salt/minion/files/base/_grains/为临时存放位置。</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ll /var/cache/salt/minion/extmods/grains/</span><br>总用量 <span class="hljs-number">8</span><br>-rw-------. <span class="hljs-number">1</span> root root <span class="hljs-number">362</span> <span class="hljs-number">3</span>月  <span class="hljs-number">27</span> <span class="hljs-number">14</span>:<span class="hljs-number">22</span> sysprocess.py<br>    <br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ll /var/cache/salt/minion/files/base/_grains/</span><br>总用量 <span class="hljs-number">4</span><br>-rw-------. <span class="hljs-number">1</span> root root <span class="hljs-number">362</span> <span class="hljs-number">3</span>月  <span class="hljs-number">27</span> <span class="hljs-number">14</span>:<span class="hljs-number">22</span> sysprocess.py<br></code></pre></td></tr></table></figure>
<h4 id="2）刷新模块">2）刷新模块</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' sys.reload_modules</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>
<p><strong>在被控端主机的/var/cache/salt/minion/extmods/grains/位置多了一个编译后的字节码文件sysprocess.pyc。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ll /var/cache/salt/minion/extmods/grains/</span><br>总用量 <span class="hljs-number">8</span><br>-rw-------. <span class="hljs-number">1</span> root root <span class="hljs-number">362</span> <span class="hljs-number">3</span>月  <span class="hljs-number">27</span> <span class="hljs-number">14</span>:<span class="hljs-number">22</span> sysprocess.py<br>-rw-------. <span class="hljs-number">1</span> root root <span class="hljs-number">646</span> <span class="hljs-number">3</span>月  <span class="hljs-number">27</span> <span class="hljs-number">14</span>:<span class="hljs-number">22</span> sysprocess.pyc<br>    <br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># ll /var/cache/salt/minion/files/base/_grains/</span><br>总用量 <span class="hljs-number">4</span><br>-rw-------. <span class="hljs-number">1</span> root root <span class="hljs-number">362</span> <span class="hljs-number">3</span>月  <span class="hljs-number">27</span> <span class="hljs-number">14</span>:<span class="hljs-number">22</span> sysprocess.py<br></code></pre></td></tr></table></figure>
<h4 id="3）校验数据">3）校验数据</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' grains.item max_open_file</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    max_open_file:<br>        <span class="hljs-number">65536</span><br></code></pre></td></tr></table></figure>
<h1>五、pillar组件</h1>
<p><strong>pillar也是Saltstack最重要的组件之一其作用是定义与被控主机相关的任何数据，定义好的数据可以被其他组件使用，如模板、state,、API等。在pillar中定义的数据与不同业务特性的被控主机相关联，这样不同被控主机只能看到自己匹配的数据，因此pillar安全性很高，适用于一些比较敏感的数据，这也是区别于grains最关键的一点。如定义不同业务组主机的用户id、组id、读写权限、程序包等信息。定义的规范是采用Python字典形式，即键/值。最上层的键一般为主机的id或组名称。下面详细描述如何进行pillar的定义和使用。</strong></p>
<h2 id="1、pillar的定义">1、pillar的定义</h2>
<h3 id="1）主配置文件定义">1）主配置文件定义</h3>
<p><strong>Saltstack默认将主控端配置文件中的所有数据都定义到pillar中，而且对所有被控主机开放，可通过修改<code>/etc/salt/master</code>配置中的<code>pillar opts:</code> Ture或False来定义是否开启或禁用这项功能，修改后执行<code>salt '*' pillar.data</code>来观察效果。以主机“SN2013-08-022”为例，执行salt ‘SN2013-08-022’ pillar.data。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' pillar.data</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    appname:<br>        website<br>    flow:<br>        ----------<br>        maxconn:<br>            <span class="hljs-number">30000</span><br>        maxmem:<br>            <span class="hljs-number">6</span>G<br></code></pre></td></tr></table></figure>
<h3 id="2）SLS文件定义">2）SLS文件定义</h3>
<p><strong>pillar支持在sls文件中定义数据，格式须符合YAM L规范，与Saltstack的state组件十分相似，新人容易将两者混淆，两者文件的配置格式、入口文件top.sls都是一致的。下面详细介绍pillar使用sls定义的配置过程。</strong></p>
<h4 id="1-定义pillar的主目录">1. 定义pillar的主目录</h4>
<p><strong>修改主配置文件<code>/etc/salt/master</code>的pillar_roots参数，定义pillar的主目录，格式如下：</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">pillar_roots:<br>  base:<br>    - /srv/pillar<br></code></pre></td></tr></table></figure>
<p><strong>同时创建pillar目录，执行命令：<code>install -d /srv/pillar</code>。</strong></p>
<h4 id="2-定义入口文件top-sls">2. 定义入口文件top.sls</h4>
<p><strong>入口文件的作用一般是定义pillar的数据覆盖被控主机的有效范围，“*”代表任意主机，其中包括了一个data.sls文件，具体内容如下：</strong></p>
<blockquote>
<p>/srv/pillar/top.sls</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">base:<br>  '*':<br>    - data<br></code></pre></td></tr></table></figure>
<blockquote>
<p>/srv/pillar/data.sls</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">appname: website<br>flow:<br>  maxconn: 30000<br>  maxmem: 6G<br></code></pre></td></tr></table></figure>
<h4 id="3-校验pillar">3. 校验pillar</h4>
<p><strong>通过查看&quot; SN2020-03-20”主机的pillar数据，可以看到多出了data.sls数据项，原因是我们定义top.sls时使用‘*’覆盖了所有主机，这样当查看’‘ SN2020-03-20”的pillar数据时可以看到我们定义的数据。</strong></p>
<p><strong>如果结果不符合预期，可以尝试刷新被控主机pillar数据，运行salt ’*’ saltutil.refresh_pillar即可。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt '*' saltutil.refresh_pillar</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br><br>[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' pillar.data appname flow</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    appname:<br>        website<br>    flow:<br>        ----------<br>        maxconn:<br>            <span class="hljs-number">30000</span><br>        maxmem:<br>            <span class="hljs-number">6</span>G<br></code></pre></td></tr></table></figure>
<h2 id="2、pillar的使用">2、pillar的使用</h2>
<p><strong>完成pillar配置后，接下来介绍使用方法。</strong></p>
<p><strong>我们可以在state、模块文件中引用，模块格式为“”，例如：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tex">&#123;&#123; pillar['appname'] &#125;&#125; #一级字典<br>&#123;&#123; pillar['flow']['maxconn'] &#125;&#125; #二级字典<br></code></pre></td></tr></table></figure>
<p><strong>PythonAPI格式如下：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pypthon">pillar[&#39;flow&#39;][&#39;maxconn&#39;]<br>pillar.get(&#39;flow:appname&#39;, &#123;&#125;)<br></code></pre></td></tr></table></figure>
<h3 id="1、操作主机">1、操作主机</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt -I 'appname:website' test.ping</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    <span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure>
<h3 id="2、结合grains处理数据的差异性">2、结合grains处理数据的差异性</h3>
<p><strong>首先通过结合grains的id信息来区分不同id的maxcpu的值，其次进行引用观察匹配的信息，将data.sls修改成如下形式.其中，“if … else…endfi”为jinja2的模板语法，更多信息请访问Jinja2官网语法介绍，网址为http://jinja.pocoo.</strong><br>
<strong>org/docs/templates/。</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini">appname: website<br>flow:<br>  maxconn: 30000<br>  maxmem: 6G<br>  &#123;% if grains['id'] == 'SN-2020-03-20' %&#125;<br>  maxcpu: 8<br>  &#123;% else %&#125;<br>  maxcpu: 4<br>  &#123;% endif %&#125;<br></code></pre></td></tr></table></figure>
<p><strong>通过查看被控主机的pillar数据，可以看到maxcpu的差异，如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' pillar.data flow</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    flow:<br>        ----------<br>        maxconn:<br>            <span class="hljs-number">30000</span><br>        maxcpu:<br>            <span class="hljs-number">8</span><br>        maxmem:<br>            <span class="hljs-number">6</span>G<br><br>            [root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-21' pillar.data flow</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    flow:<br>        ----------<br>        maxconn:<br>            <span class="hljs-number">30000</span><br>        maxcpu:<br>            <span class="hljs-number">4</span><br>        maxmem:<br>            <span class="hljs-number">6</span>G<br></code></pre></td></tr></table></figure>
<h1>六、state介绍</h1>
<p><strong>state是Saltstack最核心的功能。通过预先定制好的sls (salt state file)文件对被控主机进行状态管理，支持包括程序包(pkg)、文件(file)、网络配置(network)、系统服务(service)，系统用户(user)等，更多状态对象见http://docs.sai <a href="http://tstack.com/ref/states/all/index.html%E3%80%82" target="_blank" rel="noopener">tstack.com/ref/states/all/index.html。</a></strong></p>
<h2 id="1、state的定义">1、state的定义</h2>
<p><strong>state的定义是通过sls文件进行描述的，支持YAML语法，定义的规则如下：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-formula">$ID:</span><br><span class="hljs-formula">  $</span>State:<br>    - <span class="hljs-formula">$state: states</span><br></code></pre></td></tr></table></figure>
<p><strong>其中：</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex"><span class="hljs-formula">$ID：定义state的名称，通常采用与描述的对象保持一致的方法，如apache, nginx等;</span><br><span class="hljs-formula">$</span>State：须管理对象的类型<br><span class="hljs-formula">$state:states：定制对象的状态。</span><br></code></pre></td></tr></table></figure>
<p><strong>官网提供的示例如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apache:</span><br>  <span class="hljs-attr">pkg:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">installed</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">running</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">require</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">pkg:</span> <span class="hljs-string">apache</span><br></code></pre></td></tr></table></figure>
<p><strong>上述代码检查apache软件包是否已安装状态，如果未安装，将通过yum或apt进行安装；检查服务apache进程是否处于运行状态。下面详细进行说明:</strong></p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tex">第1行用于定义state的名称，此示例为apache，当然也可以取其他相关的名称。<br><br>第2行和第4行表示state声明开始，使用了pkg和service这两个状态对象。pkg使用系统本地的软件包管理器(yum或apt)管理将要安装的软件，service管理系统守护进程。<br><br>第3行和第5行是要执行的方法。这些方法定义了pache软件包和服务目标状态，此示例要求软件包应当处于已安装状态，服务必须运行，如未安装将会被安装并启动。<br><br>第6行是关键字require，它确保了apache服务只有在成功安装软件包后才会启动。<br></code></pre></td></tr></table></figure>
<h2 id="2、state的使用">2、state的使用</h2>
<p><strong>state的入口文件与pillar一样，文件名称都是top.sls，但state要求sls文件必须存放在saltstack base定义的目录下，默认为/srv/salt。state描述配置.sls支持jinjia模板、grains、pillar引用等。在state的逻辑层次定义完成后，再通过salt ‘*’ state.highstate执行生效。</strong></p>
<p><strong>下面结合grains与pillar，实现一个根据不同操作系统类型部署apache环境的任务。</strong></p>
<h3 id="（1）定义pillar">（1）定义pillar</h3>
<blockquote>
<p><strong>/srv/pillar/top.sls</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">base:</span><br>  <span class="hljs-string">'*'</span><span class="hljs-string">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">apache</span><br></code></pre></td></tr></table></figure>
<p><strong>在top.sls中引用二级配置有两种方式：一种是直接引用，如直接引用apache.sls；另一种是创建apache目录，再引用目录中的init.sls文件，两者的效果是一样的。为了规范起见，我们采用二级配置形式。同理，state的top.sls也采用如此方式。</strong></p>
<h4 id="1）创建apache目录：">1）创建apache目录：</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir /srv/pillar/apache<br></code></pre></td></tr></table></figure>
<h4 id="2）在apache目录创建init-sls">2）在apache目录创建init.sls</h4>
<p><strong>内容如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">pkgs:</span><br>  <span class="hljs-string">&#123;%</span> <span class="hljs-string">if</span> <span class="hljs-string">grains['os_family']</span> <span class="hljs-string">==</span> <span class="hljs-string">'Debian'</span> <span class="hljs-string">%&#125;</span><br>true<span class="hljs-attr">apache:</span> <span class="hljs-string">apache2</span><br>  <span class="hljs-string">&#123;%</span> <span class="hljs-string">elif</span> <span class="hljs-string">grains['os_family']</span> <span class="hljs-string">==</span> <span class="hljs-string">'RedHat'</span> <span class="hljs-string">%&#125;</span><br>true<span class="hljs-attr">apache:</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-string">&#123;%</span> <span class="hljs-string">elif</span> <span class="hljs-string">grains['os']</span> <span class="hljs-string">==</span> <span class="hljs-string">'Arch'</span> <span class="hljs-string">%&#125;</span><br>true<span class="hljs-attr">apache:</span> <span class="hljs-string">apache</span><br>  <span class="hljs-string">&#123;%</span> <span class="hljs-string">endif</span> <span class="hljs-string">%&#125;</span><br></code></pre></td></tr></table></figure>
<h4 id="3）测试pillar数据">3）测试pillar数据</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' pillar.data pkgs</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>    ----------<br>    pkgs:<br>        ----------<br>        apache:<br>            httpd<br></code></pre></td></tr></table></figure>
<h3 id="（2）定义state">（2）定义state</h3>
<blockquote>
<p><strong>/srv/salt/top.sls</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">base:</span><br>  <span class="hljs-string">'*'</span><span class="hljs-string">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">apache</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p><strong>/srv/salt/apache/init.sls</strong></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apache:</span><br>  <span class="hljs-attr">pkg:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">installed</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">pillar['pkgs']['apache']</span> <span class="hljs-string">&#125;&#125;</span><br>  <span class="hljs-string">service：</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">running</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">pillar['pkgs']['apache']</span> <span class="hljs-string">&#125;&#125;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">pgk:</span> <span class="hljs-string">&#123;&#123;</span> <span class="hljs-string">pillar['pkgs']['apache']</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure>
<p><strong>在配置中，{{ pillar\['pkgs']['apache'] }}将引用匹配到操作系统发行版对应的pillar数据，我的环境为CentOS，故将匹配为httpd，检查目标主机是否已经安装，没有则进行安装( yum -y install httpd)。同时检查apache服务是否已经启动，没有则启动(/etc/init.d/httpd start)。</strong></p>
<h3 id="（3）执行state">（3）执行state</h3>
<p><strong>执行state及返回信息如下所示：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python">[root@<span class="hljs-number">192</span> ~]<span class="hljs-comment"># salt 'SN-2020-03-20' state.highstate</span><br>SN<span class="hljs-number">-2020</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>:<br>----------<br>          ID: apache<br>    Function: pkg.installed<br>        Name: httpd<br>      Result: <span class="hljs-literal">True</span><br>     Comment: The following packages were installed/updated: httpd<br>     Started: <span class="hljs-number">17</span>:<span class="hljs-number">24</span>:<span class="hljs-number">45.296375</span><br>    Duration: <span class="hljs-number">38108.261</span> ms<br>     Changes:   <br>              ----------<br>              httpd:<br>                  ----------<br>                  new:<br>                      <span class="hljs-number">2.4</span><span class="hljs-number">.6</span><span class="hljs-number">-90.</span>el7.centos<br>                  old:<br>----------<br>          ID: apache<br>    Function: service.running<br>        Name: httpd<br>      Result: <span class="hljs-literal">False</span><br>     Comment: The following requisites were <span class="hljs-keyword">not</span> found:<br>                                 require:<br>                                     pgk: httpd<br>     Started: <br>    Duration: <br>     Changes:   <br><br>Summary<br>------------<br>Succeeded: <span class="hljs-number">1</span> (changed=<span class="hljs-number">1</span>)<br>Failed:    <span class="hljs-number">1</span><br>------------<br>Total states run:     <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<p><strong>可以看出，结果返回两种对象类型结果，分别为pkg与service，执行的结果是自动部署apache 2.4.6-90环境，但是启动apache服务失败，因为“<code>/etc/init.d/httpd start</code>”无法执行，只能手动启动了。</strong></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Wu Shao Dong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wsdlxgp.top/posts/1332.html">https://wsdlxgp.top/posts/1332.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wsdlxgp.top" target="_blank">Xgp & Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nfs/">nfs</a><a class="post-meta__tags" href="/tags/pv/">pv</a><a class="post-meta__tags" href="/tags/pvc/">pvc</a><a class="post-meta__tags" href="/tags/dashboard/">dashboard</a><a class="post-meta__tags" href="/tags/helm/">helm</a><a class="post-meta__tags" href="/tags/deployment/">deployment</a><a class="post-meta__tags" href="/tags/StorageClass/">StorageClass</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/xgpqq/tuchuang/raw/master/img/aaaaaaaa.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/3.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/1.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li><li class="reward-item"><img class="post-qr-code__img" src="http://xgp-cunchu.test.upcdn.net/k8s/2.jpg" alt="QQ支付"/><div class="post-qr-code__desc">QQ支付</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/1333.html"><img class="prev_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (80).jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">python的迭代器</div></div></a></div><div class="next-post pull_right"><a href="/posts/1331.html"><img class="next_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (128).jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">python中Ansible模块的Playbook理解</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/e939.html" title="初识python"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (46).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">初识python</div></div></a></div><div class="relatedPosts_item"><a href="/posts/h8er.html" title="k8s复习"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (45).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">k8s复习</div></div></a></div><div class="relatedPosts_item"><a href="/posts/9a1f.html" title="python变量"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (47).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">python变量</div></div></a></div><div class="relatedPosts_item"><a href="/posts/46cd.html" title="Python 列表"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (48).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">Python 列表</div></div></a></div><div class="relatedPosts_item"><a href="/posts/9b8f.html" title="布尔表达式"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (49).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">布尔表达式</div></div></a></div><div class="relatedPosts_item"><a href="/posts/7b33.html" title="python的input和while循环"><img class="relatedPosts_cover" src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (51).jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-history fa-fw" aria-hidden="true"></i> 2020-06-19</div><div class="relatedPosts_title">python的input和while循环</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="lv-container" data-id="city" data-uid="MTAyMC80OTM0NS8yNTgzNw=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></article></main><footer id="footer" style="background-image: url(https://gitee.com/xgpqq/tuchuang/raw/master/img/5 (79).jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By Wu Shao Dong</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="ypy"><a href="https://console.upyun.com/services/file/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/1591433700(1).png"/><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode far fa-moon" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script><script src="/js/search/local-search.js"></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>