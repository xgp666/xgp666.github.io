<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Xgp &amp; Blog</title>
  
  <subtitle>Today is still beautiful</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wsdlxgp.top/"/>
  <updated>2020-12-16T09:14:06.600Z</updated>
  <id>https://wsdlxgp.top/</id>
  
  <author>
    <name>Wu Shao Dong</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>上传视频总流程二</title>
    <link href="https://wsdlxgp.top/posts/d049.html"/>
    <id>https://wsdlxgp.top/posts/d049.html</id>
    <published>2020-12-16T09:05:12.767Z</published>
    <updated>2020-12-16T09:14:06.600Z</updated>
    
    <content type="html"><![CDATA[<h1>一、中心配置</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144910.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144922.png" alt></p><h2 id="1、数据库配置">1、数据库配置</h2><p><strong>安装ITOS和server 2012数据库</strong></p><h2 id="2、管理平台配置">2、管理平台配置</h2><h3 id="（1）连接数据库">（1）连接数据库</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216150309.png" alt></p><h3 id="（2）执行数据库脚本">（2）执行数据库脚本</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216133725.png" alt></p><h3 id="（3）注册组件">（3）注册组件</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216133755.png" alt></p><h3 id="（4）先保存再注册">（4）先保存再注册</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216145343.png" alt></p><h3 id="（5）注册所需要的服务">（5）注册所需要的服务</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216145511.png" alt></p><h3 id="（6）添加所需的程序">（6）添加所需的程序</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216145751.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216145939.png" alt></p><h3 id="（7）注册所需监控程序">（7）注册所需监控程序</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216150032.png" alt></p><h3 id="（8）创建启动程序并安装字体">（8）创建启动程序并安装字体</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216135049.png" alt></p><h4 id="可看到快捷方式">可看到快捷方式</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216135231.png" alt></p><h3 id="（9）运行所需服务">（9）运行所需服务</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216135500.png" alt></p><h2 id="3、配置端配置">3、配置端配置</h2><h3 id="（1）添加企业">（1）添加企业</h3><p>![image-20201216150427667](G:\捷诺视讯\文本\11 上传视频总流程二.assets\image-20201216150427667.png)</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216150507.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216150529.png" alt></p><h3 id="（2）添加国标流媒体">（2）添加国标流媒体</h3><p><strong>中心为主流码</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216151208.png" alt></p><h3 id="（3）添加巡检客户端">（3）添加巡检客户端</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216151514.png" alt></p><h3 id="（4）添加数据提供服务">（4）添加数据提供服务</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216151558.png" alt></p><h3 id="（5）添加中心信令">（5）添加中心信令</h3><p>![image-20201216152533393](G:\捷诺视讯\文本\11 上传视频总流程二.assets\image-20201216152533393.png)</p><h3 id="（6）创建本上网关">（6）创建本上网关</h3><p>![image-20201216153448678](G:\捷诺视讯\文本\11 上传视频总流程二.assets\image-20201216153448678.png)</p><h3 id="（7）创建外界下级的网关">（7）创建外界下级的网关</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216154004.png" alt></p><h4 id="外界下级的网关-会同步到-本上网关上">外界下级的网关  会同步到   本上网关上</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216154205.png" alt></p><h3 id="（8）进程和服务相互关联">（8）进程和服务相互关联</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216154419.png" alt></p><h3 id="（9）填写中心信令、国标流媒体、本上">（9）填写中心信令、国标流媒体、本上</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216160730.png" alt></p><p>![image-20201216160648558](G:\捷诺视讯\文本\11 上传视频总流程二.assets\image-20201216160648558.png)</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、中心配置&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144910.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgp
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="视频" scheme="https://wsdlxgp.top/tags/%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>上传视频总流程一</title>
    <link href="https://wsdlxgp.top/posts/b548.html"/>
    <id>https://wsdlxgp.top/posts/b548.html</id>
    <published>2020-12-16T09:05:12.757Z</published>
    <updated>2020-12-16T09:14:06.599Z</updated>
    
    <content type="html"><![CDATA[<h1>一、本下配置</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144910.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144922.png" alt></p><h2 id="1、数据库配置">1、数据库配置</h2><p><strong>安装ITOS和server 2012数据库</strong></p><h2 id="2、管理平台配置">2、管理平台配置</h2><h3 id="（1）连接数据库">（1）连接数据库</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216133440.png" alt></p><h3 id="（2）执行数据库脚本">（2）执行数据库脚本</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216133725.png" alt></p><h3 id="（3）注册组件">（3）注册组件</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216133755.png" alt></p><h3 id="（4）先保存再注册">（4）先保存再注册</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216134051.png" alt></p><h3 id="（5）注册所需要的服务">（5）注册所需要的服务</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216134201.png" alt></p><h3 id="（6）添加所需的程序">（6）添加所需的程序</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216134542.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216134830.png" alt></p><h3 id="（7）注册所需监控程序">（7）注册所需监控程序</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216134934.png" alt></p><h3 id="（8）创建启动程序并安装字体">（8）创建启动程序并安装字体</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216135049.png" alt></p><h4 id="可看到快捷方式">可看到快捷方式</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216135231.png" alt></p><h3 id="（9）运行所需服务">（9）运行所需服务</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216135500.png" alt></p><h2 id="3、配置端的配置">3、配置端的配置</h2><h3 id="（1）添加企业">（1）添加企业</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216140011.png" alt></p><h3 id="（2）创建企业分组">（2）创建企业分组</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216140307.png" alt></p><h3 id="（3）添加设备">（3）添加设备</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216140855.png" alt></p><h3 id="（4）设备分组">（4）设备分组</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216141140.png" alt></p><h3 id="（5）获取OSD">（5）获取OSD</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216141551.png" alt></p><h4 id="如不出意外可看到视频">如不出意外可看到视频</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216141742.png" alt></p><h3 id="（6）添加流媒体V2">（6）添加流媒体V2</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216142041.png" alt></p><h3 id="（7）添加巡检客户端">（7）添加巡检客户端</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216142213.png" alt></p><h3 id="（8）添加本下">（8）添加本下</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216142530.png" alt></p><h3 id="（9）添加本上的网关（外接上级）">（9）添加本上的网关（外接上级）</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216142932.png" alt></p><h3 id="（10）填写本下编号">（10）填写本下编号</h3><p><em><strong>注意：流媒体是国标的需要填写</strong></em></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216150915.png" alt></p><h3 id="（11）进程和程序相互关联">（11）进程和程序相互关联</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216143254.png" alt></p><h3 id="（12）流媒体关联设备">（12）流媒体关联设备</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216143541.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216143431.png" alt></p><h4 id="可看到（关联成功）">可看到（关联成功）</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216143620.png" alt></p><h3 id="（13）重启流媒体服务-再次查看视频">（13）重启流媒体服务 再次查看视频</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144427.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144458.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、本下配置&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216144910.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgp
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="视频" scheme="https://wsdlxgp.top/tags/%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>rtsp平台</title>
    <link href="https://wsdlxgp.top/posts/c1b.html"/>
    <id>https://wsdlxgp.top/posts/c1b.html</id>
    <published>2020-12-16T09:05:12.733Z</published>
    <updated>2020-12-16T09:14:06.595Z</updated>
    
    <content type="html"><![CDATA[<h3 id="部署rtsp流平台">部署rtsp流平台</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1607926690(1).jpg" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092150.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142116.png" alt></p><h3 id="安装托管捆绑包">安装托管捆绑包</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092859.png" alt></p><h2 id="创建RRSP网站">创建RRSP网站</h2><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142153.png" alt></p><p><strong>端口为19303</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142201.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142214.png" alt></p><h2 id="修改RRSP网址">修改RRSP网址</h2><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142223.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142231.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142238.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142300.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142312.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142319.png" alt></p><h3 id="配置管理-服务器管理-流媒体服务外网地址一定要设置，有外网填写外网，无外网填写内网，不能为空"><em>配置管理-服务器管理-流媒体服务外网地址一定要设置，有外网填写外网，无外网填写内网，不能为空!</em></h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214150624.png" alt></p><h1>500.30</h1><p><a href="https://www.cnblogs.com/ricolee/p/HTTP-Error-500-30.html" target="_blank" rel="noopener">https://www.cnblogs.com/ricolee/p/HTTP-Error-500-30.html</a></p><p><a href="https://dotnet.microsoft.com/download/dotnet-core/thank-you/runtime-aspnetcore-3.0.0-windows-x64-installer" target="_blank" rel="noopener">https://dotnet.microsoft.com/download/dotnet-core/thank-you/runtime-aspnetcore-3.0.0-windows-x64-installer</a></p><h3 id="网站链接-http-10-5-65-229-19304-login-html-用户名：admin-密码-admin">网站链接:<a href="http://10.5.65.229:19304/login.html" target="_blank" rel="noopener">http://10.5.65.229:19304/login.html</a> 用户名：admin 密码:admin</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142339.png" alt></p><h3 id="出现下图网站部署成功。">出现下图网站部署成功。</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142352.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;部署rtsp流平台&quot;&gt;部署rtsp流平台&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/1607926690(1).jpg&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="数据库" scheme="https://wsdlxgp.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>web api</title>
    <link href="https://wsdlxgp.top/posts/ca48.html"/>
    <id>https://wsdlxgp.top/posts/ca48.html</id>
    <published>2020-12-16T09:05:12.703Z</published>
    <updated>2020-12-16T09:14:06.597Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1607926690(1).jpg" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092150.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142116.png" alt></p><h3 id="安装托管捆绑包">安装托管捆绑包</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214142143.png" alt></p><h1>实施webapi</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092418.png" alt></p><h1>打开IIs平台</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092502.png" alt></p><h1>创建web网站</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092326.png" alt></p><h1>访问网站</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201215092650.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/1607926690(1).jpg&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/m
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="数据库" scheme="https://wsdlxgp.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>redis安装</title>
    <link href="https://wsdlxgp.top/posts/4640.html"/>
    <id>https://wsdlxgp.top/posts/4640.html</id>
    <published>2020-12-16T09:05:12.671Z</published>
    <updated>2020-12-16T09:14:06.589Z</updated>
    
    <content type="html"><![CDATA[<h1>一、Redis安装</h1><p><strong>第一步我们首先在Redis官网下载Redis，这里提供一个下载地址https://pan.baidu.com/s/1wxgWVtswnRHfTc1ldVlHrw，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214132742.png" alt></p><p><strong>第二步下载下来之后，新建一个redis文件夹，然后将压缩包中的文件解压到redis文件夹中，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133038.png" alt></p><p><strong>第三步在我们的电脑上打开命令行窗口，进去之后，切换到redis存放的路径，使用&quot;e:&quot;进去e盘,&quot;cd e:\redis&quot;进去redis目录，输入命令&quot;redis-server.exe redis.windows.conf &quot;，按回车键，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133212.png" alt></p><p><strong>第四步按回车键之后，出现上面图形之后，重新打开一个命令行窗口，进去redis存放的路径，输入“redis-cli.exe -h 127.0.0.1 -p 6379”，按回车键，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133329.png" alt></p><p><strong>第五步输入“set myKey xx”进行设置键值对，“get myKey”取出键值对，这样就安装完成了，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133411.png" alt></p><h1>二、启动服务：</h1><h3 id="1、-在redis-server-exe文件所在的目录下cmd执行">1、 在redis-server.exe文件所在的目录下cmd执行</h3><p><strong>安装命令:</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs cmd"><code class="language-hljs cmd">redis-server.exe --service-install redis.windows.conf --loglevel verbose<br></code></pre></td></tr></table></figure><p><strong>卸载命令：</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs cmd"><code class="language-hljs cmd">redis-server --service-uninstall<br></code></pre></td></tr></table></figure><h1>三、Redis Desktop Manager的安装</h1><h3 id="1-安装Redis-Desktop-Manager">1.安装Redis Desktop Manager</h3><p><strong>傻瓜式安装，点击下一步即可（注意更改安装目录）</strong></p><h3 id="2、连接Redis服务器">2、连接Redis服务器</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133721.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133741.png" alt></p><h3 id="3、Redis-Desktop-Manager的使用">3、Redis Desktop Manager的使用</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133811.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133819.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133828.png" alt></p><h3 id="4、与Redis连接注意事项">4、与Redis连接注意事项</h3><h4 id="（1）连接IP和端口号、连接密码的修改">（1）连接IP和端口号、连接密码的修改</h4><p>​      <strong>通过Redis服务器的ip地址和端口号，在本机，则默认为127.0.0.1(localhost)，端口号默认是6379。</strong></p><p><strong>所有的修改内容都在这里边的。 打开redis.conf文件，搜索如下内容进行修改，如下：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214133903.png" alt></p><h4 id="（2）修改后的登录要求">（2）修改后的登录要求</h4><p>​     <strong>注意默认连接密码是没有的，即上边的requirepass foobared为注释状态，footbared为现在的密码。如果这 里为注释状态，那客户端连接是不用输入密码的。但是如果这里注释放开了，就需要登录的时候加上密码，如下：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214134058.png" alt></p><p>​    <strong>如上图所示，没有密码虽然可以登录，但是获取数据是不被允许的（get lsf 的意思是获取名字为lsf的key对应的value值，set key value，是相反，比如 set lsf “lingshufeng” 表示存入一个key为lsf,value为lingshufeng的键值对）</strong></p><p>​    <strong>没有密码登录直接报错说不被允许，这就说明需要密码登录了，具体为上图的操作，在后边加上-a foobared，也就是-a password,即可登录。</strong></p><p><strong>另外，后边可以获取lsf相对应的数据，这里为什么是“\xc1\xec…”那种状态，其实我这里存入的lsf为汉字形式，在这里存储的即变成这样，但是实际上就是汉字，只是这里显示为这样的，如果想让它显示出来，可在客户端登录的时候加上–raw即可。如下：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214134132.png" alt></p><h1>连接到itos管理平台</h1><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214134438.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、Redis安装&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;第一步我们首先在Redis官网下载Redis，这里提供一个下载地址https://pan.baidu.com/s/1wxgWVtswnRHfTc1ldVlHrw，如下图所示：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img s
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="数据库" scheme="https://wsdlxgp.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>influxdb数据库</title>
    <link href="https://wsdlxgp.top/posts/6120.html"/>
    <id>https://wsdlxgp.top/posts/6120.html</id>
    <published>2020-12-16T09:05:12.641Z</published>
    <updated>2020-12-16T09:14:06.588Z</updated>
    
    <content type="html"><![CDATA[<h1>一、安装influxdb数据库</h1><h2 id="InfluxDB初始化配置">InfluxDB初始化配置</h2><h4 id="1、解压InfluxDB程序包至程序运行目录（推荐解压至非系统盘），如：D-influxdb。应用程序包内文件如下：">1、解压InfluxDB程序包至程序运行目录（推荐解压至非系统盘），如：D:\influxdb。应用程序包内文件如下：</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214094250.png" alt></p><h4 id="2、首先备份【influxdb-conf】文件。">2、首先备份【influxdb.conf】文件。</h4><h4 id="3、打开influxdb-conf文件，修改以下节点的文件夹路径（注意：文件夹路径使用斜杠【-】而不是反斜杠【-】）：">3、打开influxdb.conf文件，修改以下节点的文件夹路径（注意：文件夹路径使用斜杠【/】而不是反斜杠【\】）：</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214094612.png" alt></p><h2 id="运行InfluxDB">运行InfluxDB</h2><p><strong>在Influx程序目录下，按住【shift】点击右键，点击“在此处打开Powershell窗口”或“在此处打开命令行窗口”，输入【.\influxd.exe -config .\influxdb.conf】，回车，显示如下界面并且没有退出表示Influx数据库运行成功。</strong></p><p>![image-20201214095458979](G:\捷诺视讯\文本\06 webapi接口.assets\image-20201214095458979.png)</p><h2 id="添加itos用户">添加itos用户</h2><h4 id="通过命令方式添加">通过命令方式添加</h4><p><strong>双击Influx安装目录下的【influx.exe】文件，打开Influx控制窗口，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214095617.png" alt></p><p><strong>首先输入 show users，查看要添加的用户是否存在，如下图所示：</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214095647.png" alt></p><p><strong>输入<code>CREATE USER &quot;username&quot; WITH PASSWORD 'password'</code>，创建用户名为<code>username</code>，密码为<code>password</code>的普通用户；输入<code>CREATE USER &lt;username&gt; WITH PASSWORD '&lt;password&gt;'</code> WITH ALL PRIVILEGES，创建用户名为username，密码为password的管理员用户，此处添加itos管理员用户，密码为jnvision，并验证用户是否添加，如下图所示：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs mysql"><code class="language-hljs mysql">CREATE USER itos WITH PASSWORD 'jnvision' with all privileges;<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1607911149(1).jpg" alt></p><h2 id="修改其它权限">修改其它权限</h2><p><strong>在Influx数据库运行目录下，打开【Influxdb.conf】文件：</strong></p><h4 id="1、在根级别下，取消注释远程节点上的绑定地址配置设置，并将IP地址改为本机地址，确保配置开启，如下图所示：">1、在根级别下，取消注释远程节点上的绑定地址配置设置，并将IP地址改为本机地址，确保配置开启，如下图所示：</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214114206.png" alt></p><h4 id="2、在【monitor】节点下，取消注释【store-enabled】、【store-database】、【store-interval】，如下图所示：">2、在【monitor】节点下，取消注释【store-enabled】、【store-database】、【store-interval】，如下图所示：</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214114306.png" alt></p><h4 id="3、在【http】节点下，取消注释【enabled】、【bind-address】、【log-enabled】、【write-traceing】、【pprof-enabled】、【https-enabled】，如下图所示：">3、在【http】节点下，取消注释【enabled】、【bind-address】、【log-enabled】、【write-traceing】、【pprof-enabled】、【https-enabled】，如下图所示：</h4><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214114454.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214114558.png" alt></p><p><strong>配置完成后，使用<a href="#_2%E8%BF%90%E8%A1%8CInfluxDB">步骤2</a>的方式，重启数据库。</strong></p><h2 id="将InfluxDB的-exe-变成一个服务">将InfluxDB的 exe 变成一个服务</h2><p><strong>在InfluxDB安装目录新建一个文本(InfluxDB.bat)内容如下：</strong></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs cmd">@<span class="hljs-built_in">echo</span> off  <br><span class="hljs-built_in">set</span> configfile=<span class="hljs-variable">%cd%</span>\influxdb.conf<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">%configfile%</span><br>nssm.exe  install  ITOS_Integrate_influxdb  influxd.exe  -config  <span class="hljs-variable">%configfile%</span><br><span class="hljs-comment">rem </span><br><span class="hljs-comment">rem nssm.exe  set ITOS_Integrate_influxdb  Description  "influxDB数据库服务后台程序"</span><br>nssm <span class="hljs-built_in">set</span> PAWLW_Influxd  AppDirectory <span class="hljs-variable">%cd%</span><br>nssm.exe <span class="hljs-built_in">set</span> ITOS_Integrate_influxdb  AppStdout  <span class="hljs-variable">%cd%</span>\log\influxd.log<br>nssm.exe <span class="hljs-built_in">set</span> ITOS_Integrate_influxdb  AppStderr  <span class="hljs-variable"><code class="language-hljs cmd">@<span class="hljs-built_in">echo</span> off  <br><span class="hljs-built_in">set</span> configfile=<span class="hljs-variable">%cd%</span>\influxdb.conf<br><span class="hljs-built_in">echo</span> <span class="hljs-variable">%configfile%</span><br>nssm.exe  install  ITOS_Integrate_influxdb  influxd.exe  -config  <span class="hljs-variable">%configfile%</span><br><span class="hljs-comment">rem </span><br><span class="hljs-comment">rem nssm.exe  set ITOS_Integrate_influxdb  Description  "influxDB数据库服务后台程序"</span><br>nssm <span class="hljs-built_in">set</span> PAWLW_Influxd  AppDirectory <span class="hljs-variable">%cd%</span><br>nssm.exe <span class="hljs-built_in">set</span> ITOS_Integrate_influxdb  AppStdout  <span class="hljs-variable">%cd%</span>\log\influxd.log<br>nssm.exe <span class="hljs-built_in">set</span> ITOS_Integrate_influxdb  AppStderr  <span class="hljs-variable">%cd%</span>\log\influxd_err.log<br></code></pre></td></tr></table></figure><p><strong>管理员执行即可</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214123849.png" alt></p><h2 id="连接到itos管理平台">连接到itos管理平台</h2><p>![image-20201214114925688](G:\捷诺视讯\文本\06 webapi接口.assets\image-20201214114925688.png)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs plain"><code class="language-hljs plain"><br><br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、安装influxdb数据库&lt;/h1&gt;
&lt;h2 id=&quot;InfluxDB初始化配置&quot;&gt;InfluxDB初始化配置&lt;/h2&gt;
&lt;h4 id=&quot;1、解压InfluxDB程序包至程序运行目录（推荐解压至非系统盘），如：D-influxdb。应用程序包内文件如下：&quot;&gt;1、解压I
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="数据库" scheme="https://wsdlxgp.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>更新编码</title>
    <link href="https://wsdlxgp.top/posts/28ad.html"/>
    <id>https://wsdlxgp.top/posts/28ad.html</id>
    <published>2020-12-16T09:05:12.610Z</published>
    <updated>2020-12-16T09:14:06.593Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/34cfe74c73468ae09da2bce08ad023d3_.png" alt></p><p>ID：355 575 521<br>验证码：wkk@123</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/ea1dddeefc1dbdb926ddc9fc2d933a19_.png" alt></p><h3 id="1，进入企业-，首先-进入-要做的-。">1，进入企业 ，首先 进入  要做的 。</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/25de42ec754b53225f1c8fc98dd17a63_.png" alt></p><h3 id="2，然后-进入通道-更改通道的共享编码第-18位">2，然后 进入通道 更改通道的共享编码第 18位</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/bce792861857ec288295d0ecda9a6e59_.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/c5efbdbe3c65bf1dfba657efc1a604f1_.png" alt></p><h3 id="参考这个-定义-18位的值。">参考这个 定义 18位的值。</h3><h3 id="3，进入平台级联-，取消-监控点的取消-共享。">3，进入平台级联 ，取消  监控点的取消 共享。</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5b1efc727ae5ee4793ce4e54c2860f71_.png" alt></p><h3 id="4，进入本下-进行刷新数据库">4，进入本下  进行刷新数据库</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1606783980(1).png" alt></p><h3 id="5，然后回到平台级联的-重新共享通道编码">5，然后回到平台级联的 重新共享通道编码</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/7b7dca20171019286abdf9d3f742090f_.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/43c0d15aad0ee56870c29d1993d94e7d_.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/ba4b7ab149729e5aa77a89a9d1da55f5_.png" alt></p><h3 id="在省厅-平台-先删除-视频设备-。">在省厅  平台   先删除 视频设备 。</h3><h3 id="然后再删除-分组">然后再删除 分组</h3><h3 id="启动或者重启中心的本下网关">启动或者重启中心的本下网关</h3><h3 id="然后-进行查询-保存">然后 进行查询 保存</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/01deedbda470088f55e83a90a91d41fd_.png" alt></p><h3 id="进入配置管理">进入配置管理</h3><h3 id="组织结构-分组管理-找到刚推上的企业-进行修改-分组">组织结构 -分组管理  找到刚推上的企业   进行修改 分组</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/09a5b17e04c6e2eca6380011965f37e9_.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/b9f9924e4bb68a0e310d221287566869_.png" alt></p><h3 id="整理编码">整理编码</h3><h3 id="平台级联-进行给上级推送共享-。">平台级联 进行给上级推送共享 。</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/e3057f57ddc66cb6f0efd2c52d0d4160_.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1b2996a66b9f41dad9245d1930220683_.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/34cfe74c73468ae09da2bce08ad023d3_.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;ID：355 575 521&lt;br&gt;
验证码：wkk@1
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="视频" scheme="https://wsdlxgp.top/tags/%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>上传视频</title>
    <link href="https://wsdlxgp.top/posts/f51a.html"/>
    <id>https://wsdlxgp.top/posts/f51a.html</id>
    <published>2020-12-16T09:05:12.606Z</published>
    <updated>2020-12-16T09:14:06.584Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/9b2ac8f4f98f6e610887a142efa3aa4.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/d09e2c183fc0fbf3bf29c2543130cfd.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/0f31d6d86f45b8798fadc6d696806bb.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/60dce521e673726ad8b78716b8050f0.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/04659c1e7c48648b3273de98f1dfca8.png" alt></p><h1>开始</h1><p>![image-20201130113239813](G:\捷诺视讯\文本\04 上传视频.assets\image-20201130113239813.png)</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/0e52cf29565734c045736aa9af9178b.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/f6ee114c5590f4105344ad682c9e51a.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/d299cbb077632381bf2678736f679b4.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/71621188532f6e815b1a24973f23fca.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/7291d53e710b18489c889064a9c2b70.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/33df852d093e7d6aff08834b0b92309.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/934275e0b0e42b7a00cbe091feec71a.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201130113452.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/8d5f210930ad68dc8da1ba3579ff928.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/a1e53019d5d6fe3e5d5eea4dc64c50d.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201130130113.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/35a3262f18db39bf68461acac04d421.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/ec6b0c611e3996d1a6d998d52ccaf8b.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/734491342f802458229c2c570eecad2.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/4c4be41cdc7e4cf0bfb43d3223507c4.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/e6fec833d694bed1a3e2e843c4be6e5.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/ddebb050df5841e28d40695fb6a213f.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/e9d108ba763026ac2c8cffdda5d8868.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/f10bf3ac6ca71e33b9cf87deee4267f.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/a7342d19dd1a60e3b8678d83c3d66b2.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/fc5a3328653c35594ff8516d460dcac.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/d221ed707995b218609510e06cc0fd3.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/822410656628d4e9867dd5a9bebbfdf.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/e5720922091c5df77bc931c6cac9bc0.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/c7046b05520c267dc60a67eb3f01916.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/069f1382f917255b8734fe00ca28378.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/5489a4622cf5fe1c2858852a4c7b203.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/e8f69c244fed7d9eca0bc376a6c0e21.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/b37417855cd7c9d8f4e9030e0f9d529.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/3fa877d1d2b7329b68ac1cc7bb39d77.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/a489af0c1625368fd98dcdfe40428d7.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/eb0624c4fe7847640620975524c455f.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/49d4a172d23f2d4a0f6f86185ecd2f1.png" alt=" "></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/9b2ac8f4f98f6e610887a142efa3aa4.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xg
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="视频" scheme="https://wsdlxgp.top/tags/%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>升级软件</title>
    <link href="https://wsdlxgp.top/posts/cdf1.html"/>
    <id>https://wsdlxgp.top/posts/cdf1.html</id>
    <published>2020-12-16T09:05:12.603Z</published>
    <updated>2020-12-16T09:14:06.586Z</updated>
    
    <content type="html"><![CDATA[<p>“向日葵”连接上远程电脑------查看是否安装sql</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201127223356084.png" alt></p><p>下载更新包并解压</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201127223810779.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127224209.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127224236.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127224307.png" alt></p><p>打开D盘</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127224342.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127224540.png" alt></p><p>可以删除一下快捷键</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127224954.png" alt></p><p><img src="/posts/G:%5C%E6%8D%B7%E8%AF%BA%E8%A7%86%E8%AE%AF%5C%E6%96%87%E6%9C%AC%5C03.assets%5Cimage-20201127225119995.png" alt="image-20201127225119995"></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127225232.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127225548.png" alt></p><p>IP是</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201127225703.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128162154.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128162327.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201128162510780.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128162638.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128162750.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128162932.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128163021.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128163324.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128163241.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128170428.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128163458.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1606552664(1).png" alt></p><p>记得保存啊</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128164034.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1606553009(1).jpg" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128165250.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128165436.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128165546.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128165724.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128170036.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128165546.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128165914.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128170228.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201128170333.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201130085551.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201130085636.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;“向日葵”连接上远程电脑------查看是否安装sql&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201127223356084.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;下载更
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="软件" scheme="https://wsdlxgp.top/tags/%E8%BD%AF%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>数据库</title>
    <link href="https://wsdlxgp.top/posts/f7a2.html"/>
    <id>https://wsdlxgp.top/posts/f7a2.html</id>
    <published>2020-12-16T09:05:12.598Z</published>
    <updated>2020-12-16T09:14:06.583Z</updated>
    
    <content type="html"><![CDATA[<p>安装数据库（略）</p><p>执行数据库脚本的时候只需这步操作即可</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214091826.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;安装数据库（略）&lt;/p&gt;
&lt;p&gt;执行数据库脚本的时候只需这步操作即可&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuchuang/raw/master/img/20201214091826.png&quot; alt&gt;&lt;/p&gt;

      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="数据库" scheme="https://wsdlxgp.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>测试主板</title>
    <link href="https://wsdlxgp.top/posts/cc1.html"/>
    <id>https://wsdlxgp.top/posts/cc1.html</id>
    <published>2020-12-16T09:05:12.568Z</published>
    <updated>2020-12-16T09:14:06.574Z</updated>
    
    <content type="html"><![CDATA[<p>ctrl + c 进入另主类模式</p><p>配置</p><p>copy tftp DB53344ZN_LOGO0_v1.1.7_CN_2020_10_13_10_5.img 192.168.0.39 flash</p><p>进入网页升级采集插件（192.168.19.16）im开头的</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201119110728082.png" alt></p><p>注册</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201119112029984.png" alt></p><p>重启天数 -1</p><p>导入数据  356</p><p>重启主板</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs cmd"><code class="language-hljs cmd">admin  #用户名<br>admin  #密码<br>quit_hl  #切换目录<br><br>isolate disablet  #切换目录<br><br>config reboot  #重启主板<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/dddd.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ctrl + c 进入另主类模式&lt;/p&gt;
&lt;p&gt;配置&lt;/p&gt;
&lt;p&gt;copy tftp DB53344ZN_LOGO0_v1.1.7_CN_2020_10_13_10_5.img 192.168.0.39 flash&lt;/p&gt;
&lt;p&gt;进入网页升级采集插件（192.168.19
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="视频" scheme="https://wsdlxgp.top/tags/%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>上传视频总流程三</title>
    <link href="https://wsdlxgp.top/posts/b388.html"/>
    <id>https://wsdlxgp.top/posts/b388.html</id>
    <published>2020-12-16T09:05:12.564Z</published>
    <updated>2020-12-16T09:14:06.603Z</updated>
    
    <content type="html"><![CDATA[<h1>本下</h1><p>![image-20201216163253291](G:\捷诺视讯\文本\12 上传三.assets\image-20201216163253291.png)</p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216163727.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216163759.png" alt></p><h1>本上</h1><h3 id="启动本上网关">启动本上网关</h3><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20201216164556441.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216164708.png" alt></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216164851.png" alt></p><h3 id="查看一下">查看一下</h3><p><strong>有可能需要重启流媒体</strong></p><p><img src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20201216164930.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;本下&lt;/h1&gt;
&lt;p&gt;![image-20201216163253291](G:\捷诺视讯\文本\12 上传三.assets\image-20201216163253291.png)&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://gitee.com/xgpqq/tuc
      
    
    </summary>
    
    
      <category term="捷诺" scheme="https://wsdlxgp.top/categories/%E6%8D%B7%E8%AF%BA/"/>
    
    
      <category term="视频" scheme="https://wsdlxgp.top/tags/%E8%A7%86%E9%A2%91/"/>
    
  </entry>
  
  <entry>
    <title>132</title>
    <link href="https://wsdlxgp.top/posts/eac4.html"/>
    <id>https://wsdlxgp.top/posts/eac4.html</id>
    <published>2020-07-10T15:01:28.309Z</published>
    <updated>2020-07-11T08:10:33.691Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">www</span> ~]<span class="hljs-comment"># vim /usr/local/http-2.4.23/conf/httpd.conf</span><br>LoadModule mpm_prefork_module modules/mod_mpm_prefork.so <span class="hljs-comment">#67取消注释</span><br>Include conf/extra/httpd<span class="hljs-literal">-mpm</span>.conf <span class="hljs-comment"><code class="language-hljs powershell">[<span class="hljs-type">root</span>@<span class="hljs-type">www</span> ~]<span class="hljs-comment"># vim /usr/local/http-2.4.23/conf/httpd.conf</span><br>LoadModule mpm_prefork_module modules/mod_mpm_prefork.so <span class="hljs-comment">#67取消注释</span><br>Include conf/extra/httpd<span class="hljs-literal">-mpm</span>.conf <span class="hljs-comment">#468取消注释</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs php">[root@www ~]<span class="hljs-comment"># vim /usr/local/http-2.4.23/conf/httpd.conf</span><br>LoadModule mpm_prefork_module modules/mod_mpm_prefork.so <span class="hljs-comment">#67取消注释</span><br><span class="hljs-keyword">Include</span> conf/extra/httpd-mpm.conf <span class="hljs-comment"><code class="language-hljs php">[root@www ~]<span class="hljs-comment"># vim /usr/local/http-2.4.23/conf/httpd.conf</span><br>LoadModule mpm_prefork_module modules/mod_mpm_prefork.so <span class="hljs-comment">#67取消注释</span><br><span class="hljs-keyword">Include</span> conf/extra/httpd-mpm.conf <span class="hljs-comment">#468取消注释</span><br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight powershell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>131</title>
    <link href="https://wsdlxgp.top/posts/eb84.html"/>
    <id>https://wsdlxgp.top/posts/eb84.html</id>
    <published>2020-07-10T15:01:28.306Z</published>
    <updated>2020-07-11T08:09:50.514Z</updated>
    
    <content type="html"><![CDATA[<h1>一、 安装 apache2.4.23</h1><h4 id="新版本的-httpd-2-4-新增以下特性；新增模块；">新版本的 httpd-2.4 新增以下特性；新增模块；</h4><ul><li><strong>mod_proxy_fcgi(可提供 fcgi 代理）</strong></li><li><strong>mod_ratelimit（限制用户带宽）</strong></li><li><strong>mod_request（请求模块，对请求做过滤）</strong></li><li><strong>mod_remoteip（匹配客户端的 IP 地址）</strong></li></ul><p><strong>对于基于 IP 的访问控制做了修改，不再支持 allow,deny,order 机制，而是统一使用 requ进行</strong></p><h4 id="还新增以下几条新特性；">还新增以下几条新特性；</h4><ul><li><strong>MPM 支持在运行时装载;不过要开启这种特性，在编译安装要启用这三种功能；</strong></li><li><ul><li><strong>–enable-mpms-shared=all --with-mpm=event</strong></li></ul></li><li><strong>支持 event</strong></li><li><strong>支持异步读写</strong></li><li><strong>在每个模块及每个目录上指定日志级别</strong></li><li><strong>增强版的表达式分析器</strong></li><li><strong>每请求配置： <If>, <Elseif></Elseif></If></strong></li><li><strong>毫秒级别的 keepalive timeout</strong></li><li><strong>基于 FQDN 的虚拟主机不再需要 NameVirtualHost 指令</strong></li><li><strong>支持使用自定义变量</strong></li></ul><h3 id="安装环境：操作系统：-Centos7-2，关闭-selinux">安装环境：操作系统： Centos7.2，关闭 selinux</h3><h3 id="检查-httpd-包是否安装，如查安装则卸载"><strong>检查 httpd 包是否安装，如查安装则卸载</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# rpm -q httpd<br></code></pre></td></tr></table></figure><h2 id="1、-安装-apache2-4-23">1、 安装 apache2.4.23</h2><h4 id="下载源码包：">下载源码包：</h4><ul><li><a href="http://httpd.apache.org/" target="_blank" rel="noopener"><strong>httpd-2.4.23.tar.gz</strong></a></li><li><a href="http://apr.apache.org/download.cgi" target="_blank" rel="noopener"><strong>apr-1.7.0.tar.gz</strong></a></li><li><a href="http://apr.apache.org/download.cgi" target="_blank" rel="noopener"><strong>apr-util-1.6.1.tar.gz</strong></a></li><li><a href="http://zlib.net/" target="_blank" rel="noopener"><strong>zlib-1.2.11.tar.gz</strong></a></li><li><a href="http://www.pcre.org/" target="_blank" rel="noopener"><strong>pcre-8.44.tar.gz</strong></a></li><li><a href="https://www.openssl.org/source/" target="_blank" rel="noopener"><strong>openssl-1.1.1g.tar.gz</strong></a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# hostnamectl set-hostname www<br>[root@www ~]# su -<br>[root@www ~]# cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;<br>[root@www src]# wget https:&#x2F;&#x2F;mirror.bit.edu.cn&#x2F;apache&#x2F;&#x2F;httpd&#x2F;httpd-2.4.43.tar.gz<br>[root@www src]# wget https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;apache&#x2F;&#x2F;apr&#x2F;apr-1.7.0.tar.gz<br>[root@www src]# wget https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;apache&#x2F;&#x2F;apr&#x2F;apr-util-1.6.1.tar.gz<br>[root@www src]# wget http:&#x2F;&#x2F;zlib.net&#x2F;zlib-1.2.11.tar.gz<br>[root@www src]# wget https:&#x2F;&#x2F;ftp.pcre.org&#x2F;pub&#x2F;pcre&#x2F;pcre-8.44.tar.gz<br>[root@www src]# wget https:&#x2F;&#x2F;www.openssl.org&#x2F;source&#x2F;openssl-1.1.1g.tar.gz<br></code></pre></td></tr></table></figure><h3 id="（1）安装-apr-和-apr-util">（1）安装 apr 和 apr-util</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www src]# tar zxf apr-1.7.0.tar.gz <br>[root@www src]# cd apr-1.7.0&#x2F;<br>[root@www apr-1.7.0]#  .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;apr && make && make install<br>[root@www apr-1.7.0]# cd ..<br>[root@www src]# tar zxf apr-util-1.6.1.tar.gz <br>[root@www src]# cd apr-util-1.6.1&#x2F;<br>[root@www apr-util-1.6.1]#  .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;apr-util --with-apr&#x3D;&#x2F;usr&#x2F;local&#x2F;apr && make && make install<br>xml&#x2F;apr_xml.c:35:19: 致命错误：expat.h：没有那个文件或目录<br> #include <expat.h><br>                   ^<br>编译中断。<br>make[1]: *** [xml&#x2F;apr_xml.lo] 错误 1<br>make[1]: 离开目录“&#x2F;usr&#x2F;local&#x2F;src&#x2F;apr-util-1.6.1”<br>make: *** [all-recursive] 错误 1<br><br>[root@www apr-util-1.6.1]# yum -y install expat-devel<br>[root@www apr-util-1.6.1]#  .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;apr-util --with-apr&#x3D;&#x2F;usr&#x2F;local&#x2F;apr && make && make install<br></code></pre></td></tr></table></figure><h3 id="（2）安装-zlib">（2）安装 zlib</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www apr-util-1.6.1]# cd ..<br>[root@www src]# tar zxf zlib-1.2.11.tar.gz <br>[root@www src]# cd zlib-1.2.11&#x2F;<br>[root@www zlib-1.2.11]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;zlib && make&& make install<br></code></pre></td></tr></table></figure><h3 id="（3）安装-pcre">（3）安装 pcre</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www zlib-1.2.11]# cd ..<br>[root@www src]# tar zxf pcre-8.44.tar.gz <br>[root@www src]# cd pcre-8.44&#x2F;<br>[root@www pcre-8.44]#  .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;pcre && make && make install<br></code></pre></td></tr></table></figure><h3 id="（4）安装-openssl">（4）安装 openssl</h3><p><strong>安装 apache2.4.23 时提示 openssl 版本过低， centos7 自带版本 openssl-1.0.1e</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www pcre-8.44]# cd ..<br>[root@www src]# tar zxf openssl-1.1.1g.tar.gz <br>[root@www src]# cd openssl-1.1.1g&#x2F;<br>[root@www openssl-1.1.1g]# .&#x2F;config -fPIC --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;openssl enable-shared && make && make install<br>[root@www httpd-2.4.43]# rpm -qa| grep openssl<br>[root@www openssl-1.1.1g]# mv &#x2F;usr&#x2F;bin&#x2F;openssl &#x2F;usr&#x2F;bin&#x2F;openssl.1.0.1e<br>[root@www openssl-1.1.1g]# ln -s &#x2F;usr&#x2F;local&#x2F;openssl &#x2F;usr&#x2F;bin&#x2F;openssl<br></code></pre></td></tr></table></figure><h3 id="（5）安装-apache">（5）<a href="http://httpd.apache.org/docs/2.4/" target="_blank" rel="noopener">安装 apache</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www src]# tar zxf httpd-2.4.43.tar.gz <br>[root@www src]# cd httpd-2.4.43&#x2F;<br>[root@www httpd-2.4.43]# .&#x2F;configure --help<br>&#x2F;&#x2F;查看安装的参数<br>[root@www httpd-2.4.23]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;http-2.4.23 --enable-modules&#x3D;most --enable-so --enable-cgi --enable-cgid --enable-ssl --with-ssl&#x3D;&#x2F;usr&#x2F;local&#x2F;openssl --enable-rewrite --with-pcre&#x3D;&#x2F;usr&#x2F;local&#x2F;pcre --with-z&#x3D;&#x2F;usr&#x2F;local&#x2F;zlib --with-apr&#x3D;&#x2F;usr&#x2F;local&#x2F;apr --with-apr-util&#x3D;&#x2F;usr&#x2F;local&#x2F;apr-util  --enable-mods-shared&#x3D;most --enable-mpms-shared&#x3D;all --with-mpm&#x3D;event --enable-proxy --enable-proxy-fcgi --enable-expires --enable-deflate<br></code></pre></td></tr></table></figure><h4 id="相关参数解释：">相关参数解释：</h4><ul><li><p><strong>–enable-so：支持动态共享模块（即打开 DSO 支持）</strong></p></li><li><p><strong>–enable-rewrite：支持 url 重写</strong></p></li><li><p><strong>–enable-ssl：支持 ssl</strong></p></li><li><p><strong>–with-ssl=/usr/local/openssl:指定 ssl 安装位置</strong></p></li><li><p><strong>–enable-cgi：启用 cgi</strong></p></li><li><p><strong>–enable-cgid:MPM 使用的是 event 或 worker 要启用 cgid</strong></p></li><li><p><strong>–enable-modules=most:明确指明要静态编译到 httpd 二进制文件的模块， <MODULE-LIST>为空格分隔的模块名列表、 all 或者 most， all 表示包含所有模块， most 表示包含大部分常用模块</MODULE-LIST></strong></p></li><li><p><strong>–enable-mods-shared=most:明确指明要以 DSO 方式编译的模块， <MODULE-LIST>为空格分隔的模块名列表、 all 或者 most， all 表示包含所有模 块， most 表示包含大部分模块</MODULE-LIST></strong></p></li><li><p><strong>–enable-mpms-shared=all:启用 MPM 所有支持的模式，这样 event、 worker、 prefork 就会以模块化的方式安装，要用哪个就在 httpd.conf 里配置就好了。</strong></p></li><li><p><strong>–with-mpm=event:指定启用的 mpm 模式， 默认使用 enevt 模式， 在 apache 的早期版本 2.0默认 prefork,2.2 版本是 worker， 2.4 版本是 event.</strong></p></li><li><p><strong>–with-pcre=/usr/local/pcre:支持 pcre</strong></p></li><li><p><strong>–with-z=/usr/local/zlib:使用 zlib 压缩库</strong></p></li><li><p><strong>–with-apr=/usr/local/apr:指定 apr 的安装路径</strong></p></li><li><p><strong>–with-apr-util=/usr/local/apr-util:指定 apr-util 的安装路径</strong></p></li><li><p><strong>–enable-expires:激活彧通过配置文件控制 HTTP 的“Expires:”和“Cache-Control:”头内容，即对网站图片、 js、 css 等内容，提供客户端浏览器缓存的设置。这个是 apache 调优的一个重要选项之一。</strong></p></li><li><p><strong>–enable-deflate:提供对内容的压缩传输编码支持，一般是 html、 js、 css 等内容的站点。使用此参数会打打提高传输速度，提升访问者访问的体验。在生产环境中，这是 apache 调优的一个重要选项之一。</strong></p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.23]# make && make install<br></code></pre></td></tr></table></figure><h4 id="优化-http-程序执行路径">优化 http 程序执行路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.23]# ln -s &#x2F;usr&#x2F;local&#x2F;http-2.4.23&#x2F;bin&#x2F;* &#x2F;usr&#x2F;local&#x2F;bin&#x2F;<br></code></pre></td></tr></table></figure><h4 id="修改配置文件-httpd-conf，设置其中的-ServerName-值">修改配置文件 httpd.conf，设置其中的 ServerName 值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.43]# vim  &#x2F;usr&#x2F;local&#x2F;http-2.4.23&#x2F;conf&#x2F;httpd.conf<br>ServerName www.example.com:80           #203取消注释<br></code></pre></td></tr></table></figure><h2 id="2、开启-apache-服务器：">2、开启 apache 服务器：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.43]# &#x2F;usr&#x2F;local&#x2F;http-2.4.23&#x2F;bin&#x2F;apachectl start<br>httpd (pid 75297) already running<br></code></pre></td></tr></table></figure><h3 id="（1）开机后自动启动">（1）开机后自动启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.43]#  cp &#x2F;usr&#x2F;local&#x2F;http-2.4.23&#x2F;bin&#x2F;apachectl &#x2F;etc&#x2F;init.d&#x2F;httpd<br></code></pre></td></tr></table></figure><p><strong>编辑 /etc/init.d/httpd 文件，在首行 #!/bin/sh 下面加入两行：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.23]# vi &#x2F;etc&#x2F;init.d&#x2F;httpd<br># chkconfig: 35 85 15 （在 3 和 5 启动模式下的--启动优先级）<br># description: apache 2.4.23<br></code></pre></td></tr></table></figure><h3 id="（2）将-Apache-加入开机自动启动">（2）将 Apache 加入开机自动启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.23]# chkconfig --add httpd<br>[root@www httpd-2.4.23]# chkconfig httpd on<br></code></pre></td></tr></table></figure><h4 id="启动编译好的-Apache-2-4-23：">启动编译好的 Apache 2.4.23：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www httpd-2.4.23]# service httpd start<br>[root@www httpd-2.4.23]# netstat -anplt | grep 80<br>tcp6 0 0 :::80 :::* LISTEN 4807&#x2F;httpd<br></code></pre></td></tr></table></figure><h3 id="（3）客户端测试访问（注意防火墙）">（3）客户端测试访问（注意防火墙）</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200708112259460.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、 安装 apache2.4.23&lt;/h1&gt;
&lt;h4 id=&quot;新版本的-httpd-2-4-新增以下特性；新增模块；&quot;&gt;新版本的 httpd-2.4 新增以下特性；新增模块；&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;mod_proxy_fcgi(可提供 fcgi 代
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>130 httpd</title>
    <link href="https://wsdlxgp.top/posts/fb33.html"/>
    <id>https://wsdlxgp.top/posts/fb33.html</id>
    <published>2020-07-10T15:01:28.304Z</published>
    <updated>2020-07-11T08:09:47.457Z</updated>
    
    <content type="html"><![CDATA[<p>/fiddler_cn.rar</p><h1>下载<a href="https://www.telerik.com/download/fiddler" target="_blank" rel="noopener">fiddler</a>抓包工具</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# hostnamectl set-hostname www<br>[root@www ~]# su -<br>[root@www~]# yum -y install httpd<br>&#x2F;&#x2F;安装httpd<br>[root@www ~]# systemctl start httpd<br>&#x2F;&#x2F;启动httpd<br></code></pre></td></tr></table></figure><p>给本机防火墙开放80端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# firewall-cmd --add-port&#x3D;80&#x2F;tcp --permanent<br>[root@www ~]# firewall-cmd --add-port&#x3D;80&#x2F;tcp<br></code></pre></td></tr></table></figure><p>访问一下</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200708120348.png" alt="ccc"></p><h1>小练习</h1><p><strong>部署一个web （nginx、apache）</strong></p><h3 id="（1）安装nginx依赖库">（1）安装nginx依赖库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# yum -y install gcc pcre-devel zlib-devel openssl openssl-devel<br></code></pre></td></tr></table></figure><h3 id="（2）解压安装">（2）解压安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# tar zxf nginx-1.2.4.tar.gz<br>[root@www ~]# cd nginx-1.2.4&#x2F;<br>[root@www ~]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx && make && make install<br>&#x2F;&#x2F;编译安装<br>[root@www nginx-1.2.4]#  ln -s &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;bin&#x2F;<br>&#x2F;&#x2F;配置下的目录做软链接<br></code></pre></td></tr></table></figure><h3 id="（3）启动nginx">（3）启动nginx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# nginx<br></code></pre></td></tr></table></figure><h4 id="重启：">重启：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# nginx -s reload<br></code></pre></td></tr></table></figure><h4 id="测试nginx文件：">测试nginx文件：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# nginx -t<br>nginx: the configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf syntax is ok<br>nginx: configuration file &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf test is successful<br></code></pre></td></tr></table></figure><h3 id="（4）编写页面">（4）编写页面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@www ~]# vim &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;test.html<br></code></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>marydb<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>your name:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"test"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>your password:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"pwd"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"submit"</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name"><code class="language-hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>marydb<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>your name:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"test"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>your password:<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"pwd"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"submit"</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>></span><br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/image-20200708145509971.png" alt></p><h3 id="一次-Web-资源请求的具体过程">一次 Web 资源请求的具体过程</h3><ul><li><strong>客户端在 Web 浏览器输入需要访问的地址</strong></li><li><strong>Web 浏览器会请求 DNS 服务器，查询解析到指定域名和 Web 服务器的地址</strong></li><li><strong>客户端与请求的 Web 服务器端建立连接（TCP 三次握手）</strong></li><li><strong>TCP 建立成功之后，发起 HTTP 请求</strong></li><li><strong>服务器端收到客户端 HTTP 请求之后，会处理该请求</strong></li><li><strong>处理客户端指定请求的资源</strong></li><li><strong>服务器构建响应报文，响应给客户端</strong></li><li><strong>服务器端将此信息记录到日志中</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;/fiddler_cn.rar&lt;/p&gt;
&lt;h1&gt;下载&lt;a href=&quot;https://www.telerik.com/download/fiddler&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;fiddler&lt;/a&gt;抓包工具&lt;/h1&gt;
&lt;figure 
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>MySQL高可用之MHA+keepalived/脚本启动虚拟ip</title>
    <link href="https://wsdlxgp.top/posts/ber8.html"/>
    <id>https://wsdlxgp.top/posts/ber8.html</id>
    <published>2020-07-01T16:02:00.000Z</published>
    <updated>2020-07-11T08:09:42.081Z</updated>
    
    <content type="html"><![CDATA[<h1>一、配置VIP</h1><h4 id="vip配置可以采用两种方式">vip配置可以采用两种方式</h4><ul><li><strong>一种通过keepalived的方式管理虚拟ip的浮动；</strong></li><li><strong>另外一种通过脚本方式启动虚拟ip的方式（即不需要keepalived或者heartbeat类似的软件）。</strong></li></ul><h2 id="1、keepalived方式管理虚拟ip">1、keepalived方式管理虚拟ip</h2><h4 id="keepalived配置方法如下：">keepalived配置方法如下：</h4><p><strong>下载软件进行并进行安装</strong></p><p><strong>（两台master，准确的说一台是master，另外一台是备选master，在没有切换以前是slave）</strong></p><h3 id="（1）在masterB和mysqlD上安装软件包keepalived">（1）在masterB和mysqlD上安装软件包keepalived</h3><h4 id="获取keepalived的安装包">获取keepalived的安装包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# wget https:&#x2F;&#x2F;www.keepalived.org&#x2F;software&#x2F;keepalived-2.0.20.tar.gz<br></code></pre></td></tr></table></figure><h4 id="安装依赖库">安装依赖库</h4><p><strong>安装keepalived软件包与服务控制 在编译安装Keepalived之前，必须先安装内核开发包kernel-devel以及openssl-devel、popt-devel等支持库。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# yum -y install kernel-devel openssl-devel popt-devel<br></code></pre></td></tr></table></figure><p><strong>若没有安装则通过rpm或yum工具进行安装，编译安装Keepalived 使用指定的linux内核位置对keepalived进行配置，并将安装路径指定为根目录，这样就无需额外创建链接文件了，配置完成后，依次执行make、makeinstall进行安装。</strong></p><h4 id="解压">解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# tar -zxf keepalived-2.0.20.tar.gz<br></code></pre></td></tr></table></figure><h4 id="安装">安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]#  cd keepalived-2.0.20&#x2F;<br>[root@masterA ~]#  .&#x2F;configure --prefix&#x3D;&#x2F; && make && make install<br></code></pre></td></tr></table></figure><p><strong>注意：如不知道keepalived需要哪些依赖包，可到下载后的源码解压目录下查看INSTALL 文件内容， 执行make install操作之后，会自动生成/etc/init.d/keepalived脚本文件，但还需要手动添加为系统服务，这样就可以使用 service、chkconfig工具来对keepalived服务程序进行管理了。</strong></p><h4 id="可能出现的错误">可能出现的错误</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">.&#x2F;configure 后显示<br>checking forgcc... no<br>checking forcc... no<br>checking for cl.exe... noconfigure.sh:error:no acceptable C compiler found in$PATH<br>See 'config.log'for more details. <br><br>解决办法：yum -y install gcc<br></code></pre></td></tr></table></figure><p><strong>注意：如不知道keepalived需要哪些依赖包，可到下载后的源码解压目录下查看INSTALL 文件内容， 执行make install操作之后，会自动生成/etc/init.d/keepalived脚本文件，但还需要手动添加为系统服务，这样就可以使用 service、chkconfig工具来对keepalived服务程序进行管理了。</strong></p><h3 id="（2）使用keepalived服务">（2）使用keepalived服务</h3><p><strong>执行make install操作之后，会自动生成/etc/init.d/keepalived脚本文件，但还需要手动添加为系统服务，这样就可以使用service、chkconfig工具来对keepalived服务程序进行管理了。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# systemctl enable keepalived.service<br></code></pre></td></tr></table></figure><p><strong>mysqlC主机也完成keepalived安装，与masterB一样，安装过程略</strong></p><p><em><strong>注：若开启了防火墙，需要关闭防火墙或创建规则。</strong></em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet"># firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT<br># firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT<br># firewall-cmd --reload<br></code></pre></td></tr></table></figure><h3 id="（3）修改Keepalived的配置文件（在master上配置）">（3）修改Keepalived的配置文件（在master上配置）</h3><h4 id="在master上配置（192-168-1-11）">在master上配置（192.168.1.11）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# vim &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf<br>! Configuration File for keepalived<br><br>global_defs &#123;<br>        router_id mysql-ha1<br>&#125;<br>vrrp_instance VI_1 &#123;<br>        state BACKUP<br>        interface ens33<br>        virtual_router_id 51<br>        priority 100<br>        nopreempt<br>        advert_int 1<br>        authentication &#123;<br>                auth_type PASS<br>                auth_pass 1111<br>        &#125;<br>        virtual_ipaddress &#123;<br>                192.168.1.200<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="在Candicate-master上配置（192-168-1-12）">在Candicate  master上配置（192.168.1.12）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# vim &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf<br><br>! Configuration File for keepalived<br><br>global_defs &#123;<br>        router_id mysql-ha2<br>&#125;<br>vrrp_instance VI_1 &#123;<br>        state BACKUP<br>        interface ens33<br>        virtual_router_id 51<br>        priority 50<br>        nopreempt<br>        advert_int 1<br>        authentication &#123;<br>                auth_type PASS<br>                auth_pass 1111<br>        &#125;<br>        virtual_ipaddress &#123;<br>                192.168.1.200<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="（4）启动keepalived服务，在master上启动并查看日志">（4）启动keepalived服务，在master上启动并查看日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# systemctl start keepalived.service<br>[root@masterB ~]# ps -ef |grep keep<br>root      73024      1  0 16:48 ?        00:00:00 &#x2F;&#x2F;sbin&#x2F;keepalived -D<br>root      73025  73024  0 16:48 ?        00:00:00 &#x2F;&#x2F;sbin&#x2F;keepalived -D<br>root      73035  54421  0 16:48 pts&#x2F;0    00:00:00 grep --color&#x3D;auto keep<br>[root@mysqlB ~]# ip a |grep 200<br>    inet 192.168.1.200&#x2F;32 scope global ens33<br><br># tail -f &#x2F;var&#x2F;log&#x2F;messages<br>查看ens33网卡是否绑定了VIP<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200707182547.png" alt></p><h3 id="（5）在候选master上启动keepalived服务，并观察">（5）在候选master上启动keepalived服务，并观察</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# systemctl start keepalived.service<br>[root@mysqlC ~]# tail -f &#x2F;var&#x2F;log&#x2F;messages<br></code></pre></td></tr></table></figure><p>查看ens33网卡绑定情况</p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200707182646.png" alt></p><p><strong>从上面的信息可以看到keepalived已经配置成功</strong></p><blockquote><p><strong>注意： 上面两台服务器的keepalived都设置为了BACKUP模式，</strong></p><p><strong>在keepalived中2种模式，分别是master-&gt;backup模式和backup-&gt;backup模式。这两种模式有很大区别。</strong></p><p><strong>在master-&gt;backup模式下，一旦主库宕机，虚拟ip会自动漂移到从库，当主库修复后，keepalived启动后，还会把虚拟ip抢占过来，即使设置了非抢占模式（nopreempt）抢占ip的动作也会发生。</strong></p><p><strong>在backup-&gt;backup模式下，当主库宕机后虚拟ip会自动漂移到从库上，当原主库恢复和keepalived服务启动后，并不会抢占新主的虚拟ip，即使是优先级高于从库的优先级别，也不会发生抢占。为了减少ip漂移次数，通常是把修复好的主库当做新的备库。</strong></p></blockquote><h1>二、MHA引入keepalived（manager）</h1><p><strong>（MySQL服务进程挂掉时通过MHA 停止keepalived）: 要想把keepalived服务引入MHA，我们只需要修改切换时触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</strong></p><h2 id="1、编辑脚本-scripts-master-ip-failover，修改后如下。">1、编辑脚本/scripts/master_ip_failover，修改后如下。</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;scripts&#x2F;master_ip_failover<br>#!&#x2F;usr&#x2F;bin&#x2F;env perl<br><br>use strict;<br>use warnings FATAL &#x3D;> 'all';<br><br>use Getopt::Long;<br><br>my (<br>  $command,        $ssh_user,         $orig_master_host,<br>  $orig_master_ip, $orig_master_port, $new_master_host,<br>  $new_master_ip,  $new_master_port<br>);<br><br>my $vip &#x3D; '192.168.1.200';<br>my $ssh_start_vip &#x3D; "systemctl start keepalived.service";<br>my $ssh_stop_vip &#x3D; "systemctl stop keepalived.service";<br><br>GetOptions(<br>  'command&#x3D;s'             &#x3D;> \$command,<br>  'ssh_user&#x3D;s'            &#x3D;> \$ssh_user,<br>  'orig_master_host&#x3D;s'    &#x3D;> \$orig_master_host,<br>  'orig_master_ip&#x3D;s'      &#x3D;> \$orig_master_ip,<br>  'orig_master_port&#x3D;i'    &#x3D;> \$orig_master_port,<br>  'new_master_host&#x3D;s'     &#x3D;> \$new_master_host,<br>  'new_master_ip&#x3D;s'       &#x3D;> \$new_master_ip,<br>  'new_master_port&#x3D;i'     &#x3D;> \$new_master_port<br>);<br><br>exit &main();<br><br>sub main &#123;<br>  print "\n\nIN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;$ssh_stop_vip&#x3D;&#x3D;$ssh_start_vip&#x3D;&#x3D;&#x3D;\n\n";<br>  if ( $command eq "stop" || $command eq "stopssh" ) &#123;<br><br>    my $exit_code &#x3D; 1;<br>    eval &#123;<br>      print "Disabling the VIP on old master: $orig_master_host \n";<br>      &stop_vip();<br>      $exit_code &#x3D; 0;<br>    &#125;;<br>    if ($@) &#123;<br>      warn "Got Error: $@\n";<br>      exit $exit_code;<br>    &#125;<br>    exit $exit_code;<br>  &#125;<br>  elsif ( $command eq "start" ) &#123;<br><br>    my $exit_code &#x3D; 10;<br>    eval &#123;<br><br>      print "Enabling the VIP - $vip on the new master - $new_master_host \n";<br>      &start_vip();<br>      $exit_code &#x3D; 0;<br>    &#125;;<br>    if ($@) &#123;<br>      warn $@;<br>      exit $exit_code;<br>    &#125;<br>    exit $exit_code;<br>  &#125;<br>  elsif ( $command eq "status" ) &#123;<br>    print "Checking the Status of the script.. OK \n";<br>    # do nothing<br>    exit 0;<br>  &#125;<br>  else &#123;<br>    &usage();<br>    exit 1;<br>  &#125;<br>&#125;<br><br># A simple system call that enable the VIP on the new master<br>sub start_vip() &#123;<br> &#96;ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"&#96;;<br>&#125;<br># A simple system call that disable the VIP on the old_master<br>sub stop_vip() &#123;<br>  return 0 unless ($ssh_user);<br> &#96;ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"&#96;;<br>&#125;<br><br>sub usage &#123;<br>  print<br>"Usage: master_ip_failover --command&#x3D;start|stop|stopssh|status --orig_master_host&#x3D;host --orig_master_ip&#x3D;ip --orig_master_port&#x3D;port --new_master_host&#x3D;host --new_master_ip&#x3D;ip --new_master_port&#x3D;port\n";<br>&#125;<br>[root@masterA ~]# chmod 777 &#x2F;scripts&#x2F;master_ip_failover<br></code></pre></td></tr></table></figure><h2 id="2、现在已经修改这个脚本了，接下来我们在-etc-masterha-app1-cnf-中调用故障切换脚本">2、现在已经修改这个脚本了，接下来我们在/etc/masterha/app1.cnf 中调用故障切换脚本</h2><h3 id="（1）停止MHA：">（1）停止MHA：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_stop --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>Stopped app1 successfully.<br>[1]+  退出 1                nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf &>&#x2F;tmp&#x2F;mha_manager.log<br></code></pre></td></tr></table></figure><p><strong>在配置文件/etc/masterha/app1.cnf 中启用下面的参数(在[server default下面添加])</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br><br>[server default]<br>manager_workdir&#x3D;&#x2F;masterha&#x2F;app1<br>manager_log&#x3D;&#x2F;masterha&#x2F;app1&#x2F;manager.log<br>user&#x3D;manager<br>password&#x3D;xgp1234<br>ssh_user&#x3D;root<br>repl_user&#x3D;mharep<br>repl_password&#x3D;xgp1234<br>ping_interval&#x3D;1<br>master_ip_failover_script&#x3D;&#x2F;scripts&#x2F;master_ip_failover  #添加<br></code></pre></td></tr></table></figure><h3 id="（2）启动MHA：">（2）启动MHA：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# rm -fr &#x2F;masterha&#x2F;app1&#x2F;app1.failover.complete<br>[root@masterA ~]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf &>&#x2F;tmp&#x2F;mha_manager.log &<br>[1] 55692<br></code></pre></td></tr></table></figure><h3 id="（3）检查状态：">（3）检查状态：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>app1 (pid:60878) is running(0:PING_OK), master:192.168.1.11<br></code></pre></td></tr></table></figure><h3 id="（4）再检查集群状态，看是否会报错。">（4）再检查集群状态，看是否会报错。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# rm -fr &#x2F;masterha&#x2F;app1&#x2F;app1.failover.complete<br>[root@masterA ~]# masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>Tue Jul  7 17:13:40 2020 - [info] Slaves settings check done.<br>Tue Jul  7 17:13:40 2020 - [info] <br>192.168.1.12(192.168.1.12:3306) (current master)<br> +--192.168.1.11(192.168.1.11:3306)<br> +--192.168.1.13(192.168.1.13:3306)<br><br>Tue Jul  7 17:13:40 2020 - [info] Checking replication health on 192.168.1.11..<br>Tue Jul  7 17:13:40 2020 - [info]  ok.<br>Tue Jul  7 17:13:40 2020 - [info] Checking replication health on 192.168.1.13..<br>Tue Jul  7 17:13:40 2020 - [info]  ok.<br>Tue Jul  7 17:13:40 2020 - [warning] master_ip_failover_script is not defined.<br>Tue Jul  7 17:13:40 2020 - [warning] shutdown_script is not defined.<br>Tue Jul  7 17:13:40 2020 - [info] Got exit code 0 (Not master dead).<br></code></pre></td></tr></table></figure><p><strong>可以看见已经没有报错了。 /scripts/master_ip_failover添加或者修改的内容意思是当主库数据库发生故障时，会触发MHA切换，MHA Manager会停掉主库上的keepalived服务，触发虚拟ip漂移到备选从库，从而完成切换。 当然可以在keepalived里面引入脚本，这个脚本监控mysql是否正常运行，如果不正常，则调用该脚本杀掉keepalived进程（参考MySQL 高可用性keepalived+mysql双主）。</strong></p><h2 id="3、测试：">3、测试：</h2><p><strong>在master上停止mysqld服务 到slave(192.168.1.13)查看slave的状态：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# systemctl stop mysqld<br>&#x2F;&#x2F;在192.168.1.11上操作<br><br>mysql> show slave status\G<br>&#x2F;&#x2F;在192.168.1.12上操作<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: 192.168.1.12<br>                  Master_User: mharep<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000002<br>          Read_Master_Log_Pos: 154<br>               Relay_Log_File: relay-bin.000002<br>                Relay_Log_Pos: 320<br>        Relay_Master_Log_File: mysql-bin.000002<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><p><strong>从上图可以看出slave指向了新的master服务器192.168.1.12(在故障切换前指向的是192.168.1.11)</strong></p><h4 id="在192-168-1-11上查看vip绑定">在192.168.1.11上查看vip绑定</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# ip a | grep 200<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200707204546.png" alt></p><h4 id="在192-168-1-12上查看vip绑定">在192.168.1.12上查看vip绑定</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# ip a | grep 200<br>    inet 192.168.1.200&#x2F;32 scope global ens33<br></code></pre></td></tr></table></figure><p>**从上面的显示结果可以看出vip地址漂移到了192.168.1.12 **</p><h1>三、主从切换后续工作（重构）</h1><p><strong>重构就是你的主挂了，切换到Candicate master上，Candicate master变成了主，因此重构的一种方案原主库修复成一个新的slave 主库切换后，把原主库修复成新从库，原主库数据文件完整的情况下，可通过以下方式找出最后执行的CHANGEMASTER命令：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# grep "CHANGE MASTER TO MASTER" &#x2F;masterha&#x2F;app1&#x2F;manager.log | tail -1<br><br>Tue Jul  7 20:32:26 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST&#x3D;'192.168.1.12', MASTER_PORT&#x3D;3306, MASTER_LOG_FILE&#x3D;'mysql-bin.000004', MASTER_LOG_POS&#x3D;154, MASTER_USER&#x3D;'mharep', MASTER_PASSWORD&#x3D;'xxx';<br></code></pre></td></tr></table></figure><h2 id="1、将192-168-1-11（原主库）修复成从库">1、将192.168.1.11（原主库）修复成从库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlB ~]# systemctl start mysqld<br>[root@mysqlB ~]# mysql -uroot -p123<br>mysql> CHANGE MASTER TO MASTER_HOST&#x3D;'192.168.1.12', MASTER_PORT&#x3D;3306, MASTER_LOG_FILE&#x3D;'mysql-bin.000004', MASTER_LOG_POS&#x3D;154, MASTER_USER&#x3D;'mharep', MASTER_PASSWORD&#x3D;'xgp1234';<br>Query OK, 0 rows affected, 2 warnings (0.01 sec)<br><br>mysql> start slave;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql> show slave status\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: 192.168.1.12<br>                  Master_User: mharep<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000006<br>          Read_Master_Log_Pos: 154<br>               Relay_Log_File: relay-bin.000004<br>                Relay_Log_Pos: 367<br>        Relay_Master_Log_File: mysql-bin.000006<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><h2 id="2、重启mha-manager">2、重启mha manager:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# rm -fr &#x2F;masterha&#x2F;app1&#x2F;app1.failover.complete<br>[root@masterA ~]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf --ignore_fail_on_start &>&#x2F;tmp&#x2F;mha_manager.log &<br>[1] 61968<br>[root@masterA ~]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>.app1 (pid:61968) is running(0:PING_OK), master:192.168.1.12<br><br>[root@masterA ~]# masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>Tue Jul  7 21:04:39 2020 - [info] Slaves settings check done.<br>Tue Jul  7 21:04:39 2020 - [info] <br>192.168.1.12(192.168.1.12:3306) (current master)<br> +--192.168.1.11(192.168.1.11:3306)<br> +--192.168.1.13(192.168.1.13:3306)<br><br>Tue Jul  7 21:04:39 2020 - [info] Checking replication health on 192.168.1.11..<br>Tue Jul  7 21:04:39 2020 - [info]  ok.<br>Tue Jul  7 21:04:39 2020 - [info] Checking replication health on 192.168.1.13..<br>Tue Jul  7 21:04:39 2020 - [info]  ok.<br>Tue Jul  7 21:04:39 2020 - [info] Checking master_ip_failover_script status:<br>Tue Jul  7 21:04:39 2020 - [info]   &#x2F;scripts&#x2F;master_ip_failover --command&#x3D;status --ssh_user&#x3D;root --orig_master_host&#x3D;192.168.1.12 --orig_master_ip&#x3D;192.168.1.12 --orig_master_port&#x3D;3306<br></code></pre></td></tr></table></figure><h1>四、通过脚本实现VIP切换</h1><p><strong>通过脚本的方式管理VIP。这里是修改/scripts/master_ip_failover，也可以使用其他的语言完成，比如php语言。使用php脚本编写的failover这里就不介绍了。修改完成后内容如下，而且如果使用脚本管理vip的话，需要手动在目前的master服务器上绑定一个vip</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterC ~]# ifconfig ens33:0 192.168.1.200&#x2F;24<br></code></pre></td></tr></table></figure><h2 id="1、在mha-manager上修改-scripts-master-ip-failover，内容如下">1、在mha-manager上修改/scripts/master_ip_failover，内容如下</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;scripts&#x2F;master_ip_failover<br>#!&#x2F;usr&#x2F;bin&#x2F;env perl<br><br>use strict;<br>use warnings FATAL &#x3D;> 'all';<br><br>use Getopt::Long;<br><br>my (<br>  $command,        $ssh_user,         $orig_master_host,<br>  $orig_master_ip, $orig_master_port, $new_master_host,<br>  $new_master_ip,  $new_master_port<br>);<br><br>my $vip &#x3D; '192.168.1.200';<br>my $key &#x3D; '0';<br>my $ssh_start_vip &#x3D; "&#x2F;sbin&#x2F;ifconfig ens33:$key $vip";<br>my $ssh_stop_vip &#x3D; "&#x2F;sbin&#x2F;ifconfig ens33:$key down";<br><br>GetOptions(<br>  'command&#x3D;s'             &#x3D;> \$command,<br>  'ssh_user&#x3D;s'            &#x3D;> \$ssh_user,<br>  'orig_master_host&#x3D;s'    &#x3D;> \$orig_master_host,<br>  'orig_master_ip&#x3D;s'      &#x3D;> \$orig_master_ip,<br>  'orig_master_port&#x3D;i'    &#x3D;> \$orig_master_port,<br>  'new_master_host&#x3D;s'     &#x3D;> \$new_master_host,<br>  'new_master_ip&#x3D;s'       &#x3D;> \$new_master_ip,<br>  'new_master_port&#x3D;i'     &#x3D;> \$new_master_port<br>);<br><br>exit &main();<br><br>sub main &#123;<br>  print "\n\nIN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;$ssh_stop_vip&#x3D;&#x3D;$ssh_start_vip&#x3D;&#x3D;&#x3D;\n\n";<br>  if ( $command eq "stop" || $command eq "stopssh" ) &#123;<br><br>    my $exit_code &#x3D; 1;<br>    eval &#123;<br>      print "Disabling the VIP on old master: $orig_master_host \n";<br>      &stop_vip();<br>      $exit_code &#x3D; 0;<br>    &#125;;<br>    if ($@) &#123;<br>      warn "Got Error: $@\n";<br>      exit $exit_code;<br>    &#125;<br>    exit $exit_code;<br>  &#125;<br>  elsif ( $command eq "start" ) &#123;<br><br>    my $exit_code &#x3D; 10;<br>    eval &#123;<br><br>      print "Enabling the VIP - $vip on the new master - $new_master_host \n";<br>      &start_vip();<br>      $exit_code &#x3D; 0;<br>    &#125;;<br>    if ($@) &#123;<br>      warn $@;<br>      exit $exit_code;<br>    &#125;<br>    exit $exit_code;<br>  &#125;<br>  elsif ( $command eq "status" ) &#123;<br>    print "Checking the Status of the script.. OK \n";<br>    # do nothing<br>    exit 0;<br>  &#125;<br>  else &#123;<br>    &usage();<br>    exit 1;<br>  &#125;<br>&#125;<br><br># A simple system call that enable the VIP on the new master<br>sub start_vip() &#123;<br> &#96;ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"&#96;;<br>&#125;<br># A simple system call that disable the VIP on the old_master<br>sub stop_vip() &#123;<br>  return 0 unless ($ssh_user);<br> &#96;ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"&#96;;<br>&#125;<br><br>sub usage &#123;<br>  print<br>"Usage: master_ip_failover --command&#x3D;start|stop|stopssh|status --orig_master_host&#x3D;host --orig_master_ip&#x3D;ip --orig_master_port&#x3D;port --new_master_host&#x3D;host --new_master_ip&#x3D;ip --new_master_port&#x3D;port\n";<br>&#125;<br>[root@masterA ~]# chmod 777 &#x2F;scripts&#x2F;master_ip_failover<br></code></pre></td></tr></table></figure><p><strong>查看是否修改了/etc/masterha/app1.cnf，如果没有请添加</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# grep "master_ip_failover_script" &#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>master_ip_failover_script&#x3D;&#x2F;scripts&#x2F;master_ip_failover<br></code></pre></td></tr></table></figure><h2 id="2、停止MHA">2、停止MHA</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_stop --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>Stopped app1 successfully.<br>[1]+  退出 1                nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf --ignore_fail_on_start &>&#x2F;tmp&#x2F;mha_manager.log<br></code></pre></td></tr></table></figure><h2 id="3、启动MHA">3、启动MHA</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# rm -fr &#x2F;masterha&#x2F;app1&#x2F;app1.failover.complete<br>[root@masterA ~]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf &>&#x2F;tmp&#x2F;mha_manager.log &<br>[1] 63215<br></code></pre></td></tr></table></figure><h2 id="4、检查状态：">4、检查状态：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>app1 (pid:63215) is running(0:PING_OK), master:192.168.1.12<br></code></pre></td></tr></table></figure><h3 id="再检查集群状态，看是否会报错。">再检查集群状态，看是否会报错。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br><br>Tue Jul  7 21:23:37 2020 - [info] <br>192.168.1.12(192.168.1.12:3306) (current master)<br> +--192.168.1.11(192.168.1.11:3306)<br> +--192.168.1.13(192.168.1.13:3306)<br><br>Tue Jul  7 21:23:37 2020 - [info] Checking replication health on 192.168.1.11..<br>Tue Jul  7 21:23:37 2020 - [info]  ok.<br>Tue Jul  7 21:23:37 2020 - [info] Checking replication health on 192.168.1.13..<br>Tue Jul  7 21:23:37 2020 - [info]  ok.<br>Tue Jul  7 21:23:37 2020 - [info] Checking master_ip_failover_script status:<br>Tue Jul  7 21:23:37 2020 - [info]   &#x2F;scripts&#x2F;master_ip_failover --command&#x3D;status --ssh_user&#x3D;root --orig_master_host&#x3D;192.168.1.12 --orig_master_ip&#x3D;192.168.1.12 --orig_master_port&#x3D;3306 <br><br><br>IN SCRIPT TEST&#x3D;&#x3D;&#x3D;&#x3D;systemctl stop keepalived.service&#x3D;&#x3D;systemctl start keepalived.service&#x3D;&#x3D;&#x3D;<br><br>Checking the Status of the script.. OK <br>Tue Jul  7 21:23:37 2020 - [info]  OK.<br>Tue Jul  7 21:23:37 2020 - [warning] shutdown_script is not defined.<br>Tue Jul  7 21:23:37 2020 - [info] Got exit code 0 (Not master dead).<br><br>MySQL Replication Health is OK.<br></code></pre></td></tr></table></figure><h2 id="5、测试">5、测试</h2><h3 id="（1）在Candicate-master上停掉mysql服务">（1）在Candicate  master上停掉mysql服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# systemctl stop mysqld<br></code></pre></td></tr></table></figure><h4 id="到slave-192-168-1-13-查看slave的状态：">到slave(192.168.1.13)查看slave的状态：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: 192.168.1.11<br>                  Master_User: mharep<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000005<br>          Read_Master_Log_Pos: 154<br>               Relay_Log_File: relay-bin.000002<br>                Relay_Log_Pos: 320<br>        Relay_Master_Log_File: mysql-bin.000005<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><p><strong>从上图可以看出slave指向了新的master服务器（192.168.1.11） 查看VIP</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# ip a | grep 200<br>    inet 192.168.1.200&#x2F;24 brd 192.168.1.255 scope global secondary ens33:0<br></code></pre></td></tr></table></figure><p><strong>从上图可以看到mysqlC(原来的master)释放了VIP，masterB(新的master)接管了VIP地址</strong></p><h2 id="6、主从切换后续工作">6、主从切换后续工作</h2><p><strong>主库切换后，把原主库修复成新从库，相关操作请参考前面相关操作。 为了防止脑裂发生，推荐生产环境采用脚本的方式来管理虚拟ip，而不是使用keepalived来完成。到此为止，基本MHA集群已经配置完毕。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# grep "CHANGE MASTER TO MASTER" &#x2F;masterha&#x2F;app1&#x2F;manager.log | tail -1<br>Tue Jul  7 22:43:34 2020 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST&#x3D;'192.168.1.11', MASTER_PORT&#x3D;3306, MASTER_LOG_FILE&#x3D;'mysql-bin.000003', MASTER_LOG_POS&#x3D;154, MASTER_USER&#x3D;'mharep', MASTER_PASSWORD&#x3D;'xxx';<br></code></pre></td></tr></table></figure><h3 id="（1）将192-168-1-12（原主库）修复成从库">（1）将192.168.1.12（原主库）修复成从库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# systemctl start mysqld<br>[root@mysqlC ~]# mysql -uroot -p123<br>mysql> CHANGE MASTER TO MASTER_HOST&#x3D;'192.168.1.11', MASTER_PORT&#x3D;3306, MASTER_LOG_FILE&#x3D;'mysql-bin.000003', MASTER_LOG_POS&#x3D;154, MASTER_USER&#x3D;'mharep', MASTER_PASSWORD&#x3D;'xgp1234';<br>Query OK, 0 rows affected, 2 warnings (0.01 sec)<br><br>mysql> start slave;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql> show slave status\G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: 192.168.1.11<br>                  Master_User: mharep<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000003<br>          Read_Master_Log_Pos: 154<br>               Relay_Log_File: relay-bin.000001<br>                Relay_Log_Pos: 4<br>        Relay_Master_Log_File: mysql-bin.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><h3 id="（2）重启mha-manager">（2）重启mha manager:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# rm -fr &#x2F;masterha&#x2F;app1&#x2F;app1.failover.complete<br>[root@masterA ~]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf --ignore_fail_on_start &>&#x2F;tmp&#x2F;mha_manager.log &<br>[1] 61968<br>[root@masterA ~]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>app1 (pid:55806) is running(0:PING_OK), master:192.168.1.11<br><br>[root@masterA ~]# masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>Tue Jul  7 21:04:39 2020 - [info] Slaves settings check done.<br>Tue Jul  7 21:04:39 2020 - [info] <br>192.168.1.12(192.168.1.12:3306) (current master)<br> +--192.168.1.11(192.168.1.11:3306)<br> +--192.168.1.13(192.168.1.13:3306)<br><br>Tue Jul  7 21:04:39 2020 - [info] Checking replication health on 192.168.1.11..<br>Tue Jul  7 21:04:39 2020 - [info]  ok.<br>Tue Jul  7 21:04:39 2020 - [info] Checking replication health on 192.168.1.13..<br>Tue Jul  7 21:04:39 2020 - [info]  ok.<br>Tue Jul  7 21:04:39 2020 - [info] Checking master_ip_failover_script status:<br>Tue Jul  7 21:04:39 2020 - [info]   &#x2F;scripts&#x2F;master_ip_failover --command&#x3D;status --ssh_user&#x3D;root --orig_master_host&#x3D;192.168.1.12 --orig_master_ip&#x3D;192.168.1.12 --orig_master_port&#x3D;3306<br></code></pre></td></tr></table></figure><h1>五、mysql必备技能掌握：</h1><h4 id="1、MySQL架构-对mysql的架构，整体有个印象，才能不断的加深对mysql的理解和后继的学习。">1、MySQL架构:对mysql的架构，整体有个印象，才能不断的加深对mysql的理解和后继的学习。</h4><h4 id="2、用各种姿势备份MySQL数据库-数据备份是DBA或运维工程师日常工作之一，如果让你来备份，你会用什么方式备份，在时间时间备份，使用什么策略备份">2、用各种姿势备份MySQL数据库 数据备份是DBA或运维工程师日常工作之一，如果让你来备份，你会用什么方式备份，在时间时间备份，使用什么策略备份</h4><h4 id="3、mysql主从复制及读写分离-mysql的主从复制及读写分离是DBA必备技能之一">3、mysql主从复制及读写分离 mysql的主从复制及读写分离是DBA必备技能之一</h4><h4 id="4、MySQL-MariaDB数据库基于SSL实现主从复制-加强主从复制的安全性">4、MySQL/MariaDB数据库基于<strong>SSL实现主从复制 加强主从复制的安全性</strong></h4><h4 id="5、MySQL高可用-数据的高可用如何保证">5、MySQL高可用 数据的高可用如何保证</h4><h4 id="6、数据库Sharding的基本思想和切分策略-随着数据量的不断攀升，从性能和可维护的角度，需要进行一些Sharding-，也就是数据库的切分，有垂直切分和水平切分"><strong>6、数据库Sharding的基本思想和切分策略 随着数据量的不断攀升，从性能和可维护的角度，需要进行一些</strong>Sharding**，也就是数据库的切分，有垂直切分和水平切分**</h4><h4 id="7、MySQL-MariaDB-性能调整和优化技巧-掌握优化思路和技巧，对数据库的不断优化是一项长期工程">7、MySQL/MariaDB 性能调整和优化技巧 掌握优化思路和技巧，对数据库的不断优化是一项长期工程</h4>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、配置VIP&lt;/h1&gt;
&lt;h4 id=&quot;vip配置可以采用两种方式&quot;&gt;vip配置可以采用两种方式&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;一种通过keepalived的方式管理虚拟ip的浮动；&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;另外一种通过脚本方式
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://wsdlxgp.top/categories/mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQL高可用之MHA(1)</title>
    <link href="https://wsdlxgp.top/posts/ber7.html"/>
    <id>https://wsdlxgp.top/posts/ber7.html</id>
    <published>2020-06-30T16:02:00.000Z</published>
    <updated>2020-07-11T08:09:35.753Z</updated>
    
    <content type="html"><![CDATA[<h1>mha简介</h1><p><strong>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。 MHA里有两个角色一个是MHA Node（数据节点）另一个是MHA Manager（管理节点）。 MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明</strong></p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200706140224.png" alt></p><p><strong>MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据的不丢失，但这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。</strong></p><blockquote><p><strong>注：从MySQL5.5开始，MySQL以插件的形式支持半同步复制</strong></p></blockquote><p><strong>如何理解半同步呢？首先我们来看看异步，全同步的概念： 异步复制（Asynchronous replication） MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。 全同步复制（Fully synchronous replication） 指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。 半同步复制（Semisynchronous replication） 介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。 下面来看看半同步复制的原理图：</strong></p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200706141520.png" alt></p><blockquote><p><strong>总结：异步与半同步异同 默认情况下MySQL的复制是异步的，Master上所有的更新操作写入Binlog之后并不确保所有的更新都被复制到Slave之上。异步操作虽然效率高，但是在Master/Slave出现问题的时候，存在很高数据不同步的风险，甚至可能丢失数据。 MySQL5.5引入半同步复制功能的目的是为了保证在master出问题的时候，至少有一台Slave的数据是完整的。在超时的情况下也可以临时转入异步复制，保障业务的正常使用，直到一台salve追赶上之后，继续切换到半同步模式。</strong></p></blockquote><p><strong>工作原理 相较于其它HA软件，MHA的目的在于维持MySQL Replication中Master库的高可用性，其最大特点是可以修复多个Slave之间的差异日志，最终使所有Slave保持数据一致，然后从中选择一个充当新的Master，并将其它Slave指向它。 -从宕机崩溃的master保存二进制日志事件(binlogevents)。 -识别含有最新更新的slave。应用差异的中继日志(relay log)到其它slave。 -应用从master保存的二进制日志事件(binlogevents)。 -提升一个slave为新master。 -使其它的slave连接新的master进行复制。</strong></p><p><strong>目前MHA主要支持一主多从的架构，要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二<br>从，即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器。</strong></p><table><thead><tr><th>角色</th><th>IP</th><th>主机名</th><th>Server ID</th><th>类型</th><th>os</th></tr></thead><tbody><tr><td>Manager</td><td>192.168.1.10</td><td>masterA</td><td></td><td>管理节点</td><td>centos7</td></tr><tr><td>Master</td><td>192.168.1.11</td><td>masterB</td><td>1</td><td>主mysql(写入)</td><td>centos7</td></tr><tr><td>Candicate Master</td><td>192.168.1.12</td><td>mysqlC</td><td>2</td><td>从mysql(读)</td><td>centos7</td></tr><tr><td>slave</td><td>192.168.1.13</td><td>mysqlD</td><td>3</td><td>从mysql(读)</td><td>centos7</td></tr></tbody></table><p><strong>其中master对外提供写服务，备选master（实际的slave，主机名centos3）提供读服务，slave也提供相关的读服务，一旦master宕机，将会把备选master提升为新的master，slave指向新的master，manager作为管理服务器。</strong></p><h1>一、基础环境准备</h1><p><strong>在配置好IP地址后检查selinux，iptables设置，</strong></p><p><strong>关闭 selinux ，iptables 服务以便后期主从同步不出错</strong></p><p><strong>注：时间要同步</strong></p><h2 id="1、-在四台机器都配置epel源">1、 在四台机器都配置epel源</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# rpm -ivh http:&#x2F;&#x2F;dl.fedoraproject.org&#x2F;pub&#x2F;epel&#x2F;6&#x2F;x86_64&#x2F;epel-release-6-8.noarch.rpm<br><br>[root@masterA ~]# wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo<br></code></pre></td></tr></table></figure><h2 id="2、配置hosts环境">2、配置hosts环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;etc&#x2F;hosts<br><br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.1.10 masterA<br>192.168.1.11 masterB<br>192.168.1.12 mysqlC<br>192.168.1.13 mysqlD<br></code></pre></td></tr></table></figure><h2 id="3、建立ssh无交互登录环境-Manager主机：">3、建立ssh无交互登录环境 Manager主机：</h2><p><strong>MHA集群中的各节点彼此之间均需要基于ssh互信通信，以实现远程控制及数据管理功能。简单起见，可在Manager节点生成密钥对儿，并设置其可远程连接本地主机后， 将私钥文件及authorized_keys文件复制给余下的所有节点即可。</strong></p><h4 id="下面操作在所有节点上操作：">下面操作在所有节点上操作：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# ssh-keygen -t rsa<br>[root@masterA ~]# ssh-copy-id -i .ssh&#x2F;id_rsa.pub root@masterA<br></code></pre></td></tr></table></figure><h4 id="当四台机器都进行了上述操作以后，我们可以在-manager-机器上看到如下文件：">当四台机器都进行了上述操作以后，我们可以在 manager 机器上看到如下文件：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# cat  .ssh&#x2F;authorized_keys<br></code></pre></td></tr></table></figure><p><strong>四台机器的公钥都已经在<code>authorized_keys</code>这个文件中了，接着，我们只需要把这个文件发送至另外三台机器，这四台机器就可以实现 ssh 无密码互通了</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA .ssh]# scp authorized_keys root@masterB:~&#x2F;.ssh&#x2F;<br>[root@masterA .ssh]# scp authorized_keys root@mysqlC:~&#x2F;.ssh&#x2F;<br>[root@masterA .ssh]# scp authorized_keys root@mysqlD:~&#x2F;.ssh&#x2F;<br></code></pre></td></tr></table></figure><h1>二、配置mysql半同步复制</h1><p><strong>为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时建议配置成MySQL的半同步复制。</strong></p><p><strong>注：mysql半同步插件是由谷歌提供，具体位置/usr/local/mysql/lib/plugin/下，一个是master用的semisync_master.so，一个是slave用的semisync_slave.so，下面我们就来具体配置一下。 如果不清楚Plugin的目录，用如下查找</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show variables like '%plugin_dir%';<br>+---------------+------------------------------+<br>| Variable_name | Value                        |<br>+---------------+------------------------------+<br>| plugin_dir    | &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;lib&#x2F;plugin&#x2F; |<br>+---------------+------------------------------+<br>1 row in set (0.02 sec)<br></code></pre></td></tr></table></figure><h2 id="1、分别在主从节点上安装相关的插件（master-Candicate-master-slave）">1、分别在主从节点上安装相关的插件（master, Candicate master,slave）</h2><h4 id="在MySQL上安装插件需要数据库支持动态载入。检查是否支持，用如下检测："><strong>在MySQL上安装插件需要数据库支持动态载入。检查是否支持，用如下检测：</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show variables like '%have_dynamic%';<br>+----------------------+-------+<br>| Variable_name | Value |<br>+----------------------+-------+<br>| have_dynamic_loading | YES |<br>+----------------------+-------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="所有mysql数据库服务器，安装半同步插件-semisync-master-so-semisync-slave-so">所有mysql数据库服务器，安装半同步插件(semisync_master.so,semisync_slave.so)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql> INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="其他mysql主机采用同样的方法安装-检查Plugin是否已正确安装：">其他mysql主机采用同样的方法安装 检查Plugin是否已正确安装：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show plugins;<br>或<br>mysql> select * from information_schema.plugins;<br></code></pre></td></tr></table></figure><h4 id="查看半同步相关信息">查看半同步相关信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show variables like '%rpl_semi_sync%';<br>+-------------------------------------------+------------+<br>| Variable_name                             | Value      |<br>+-------------------------------------------+------------+<br>| rpl_semi_sync_master_enabled              | OFF        |<br>| rpl_semi_sync_master_timeout              | 10000      |<br>| rpl_semi_sync_master_trace_level          | 32         |<br>| rpl_semi_sync_master_wait_for_slave_count | 1          |<br>| rpl_semi_sync_master_wait_no_slave        | ON         |<br>| rpl_semi_sync_master_wait_point           | AFTER_SYNC |<br>| rpl_semi_sync_slave_enabled               | OFF        |<br>| rpl_semi_sync_slave_trace_level           | 32         |<br>+-------------------------------------------+------------+<br>8 rows in set (0.01 sec)<br></code></pre></td></tr></table></figure><p><strong>上图可以看到半同复制插件已经安装，只是还没有启用，所以是off</strong></p><h2 id="2、修改my-cnf文件，配置主从同步：">2、修改my.cnf文件，配置主从同步：</h2><blockquote><p><strong>注：若主MYSQL服务器已经存在，只是后期才搭建从MYSQL服务器，在置配数据同步前应先将主MYSQL服务器的要同步的数据库拷贝到从MYSQL服务器上（如先在主MYSQL上备份数据库，再用备份在从MYSQL服务器上恢复）</strong></p></blockquote><h3 id="（1）master-mysql主机：">（1）master mysql主机：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# vim &#x2F;etc&#x2F;my.cnf<br><br>server-id &#x3D; 1<br>log-bin&#x3D;mysql-bin<br>binlog_format&#x3D;mixed<br>log-bin-index&#x3D;mysql-bin.index<br>rpl_semi_sync_master_enabled&#x3D;1<br>rpl_semi_sync_master_timeout&#x3D;1000<br>rpl_semi_sync_slave_enabled&#x3D;1<br>relay_log_purge&#x3D;0<br>relay-log &#x3D; relay-bin<br>relay-log-index &#x3D; slave-relay-bin.index<br><br>[root@masterB ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><blockquote><p><strong>注： rpl_semi_sync_master_enabled=1 1表是启用，0表示关闭 rpl_semi_sync_master_timeout=10000：毫秒单位 ，该参数主服务器等待确认消息10秒后，不再等待，变为异步方式。</strong></p></blockquote><h3 id="（2）Candicate-master主机：">（2）Candicate master主机：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# vim &#x2F;etc&#x2F;my.cnf<br>server-id &#x3D; 2<br>log-bin&#x3D;mysql-bin<br>binlog_format&#x3D;mixed<br>log-bin-index&#x3D;mysql-bin.index<br>relay_log_purge&#x3D;0<br>relay-log &#x3D; relay-bin<br>relay-log-index &#x3D; slave-relay-bin.index<br>rpl_semi_sync_master_enabled&#x3D;1<br>rpl_semi_sync_master_timeout&#x3D;10000<br>rpl_semi_sync_slave_enabled&#x3D;1<br><br>[root@mysqlC ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><blockquote><p><strong>注：relay_log_purge=0，禁止 SQL 线程在执行完一个 relay log 后自动将其删除，对于MHA场景下，对于某些滞后从库的恢复依赖于其他从库的relay log，因此采取禁用自动删除功能机</strong></p></blockquote><h3 id="（3）Slave主机：">（3）Slave主机：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlD ~]# vim &#x2F;etc&#x2F;my.cnf<br>server-id &#x3D; 3<br>log-bin &#x3D; mysql-bin<br>relay-log &#x3D; relay-bin<br>relay-log-index &#x3D; slave-relay-bin.index<br>read_only &#x3D; 1<br>rpl_semi_sync_slave_enabled&#x3D;1<br><br>[root@mysqlD ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h3 id="（4）查看半同步相关信息">（4）查看半同步相关信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show variables like '%rpl_semi_sync%';<br>+-------------------------------------------+------------+<br>| Variable_name                             | Value      |<br>+-------------------------------------------+------------+<br>| rpl_semi_sync_master_enabled              | ON         |<br>| rpl_semi_sync_master_timeout              | 1000       |<br>| rpl_semi_sync_master_trace_level          | 32         |<br>| rpl_semi_sync_master_wait_for_slave_count | 1          |<br>| rpl_semi_sync_master_wait_no_slave        | ON         |<br>| rpl_semi_sync_master_wait_point           | AFTER_SYNC |<br>| rpl_semi_sync_slave_enabled               | ON         |<br>| rpl_semi_sync_slave_trace_level           | 32         |<br>+-------------------------------------------+------------+<br>8 rows in set (0.01 sec)<br></code></pre></td></tr></table></figure><h3 id="（5）查看半同步状态：">（5）查看半同步状态：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show status like '%rpl_semi_sync%';<br>+--------------------------------------------+-------+<br>| Variable_name                              | Value |<br>+--------------------------------------------+-------+<br>| Rpl_semi_sync_master_clients               | 0     |<br>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |<br>| Rpl_semi_sync_master_net_wait_time         | 0     |<br>| Rpl_semi_sync_master_net_waits             | 0     |<br>| Rpl_semi_sync_master_no_times              | 0     |<br>| Rpl_semi_sync_master_no_tx                 | 0     |<br>| Rpl_semi_sync_master_status                | ON    |<br>| Rpl_semi_sync_master_timefunc_failures     | 0     |<br>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |<br>| Rpl_semi_sync_master_tx_wait_time          | 0     |<br>| Rpl_semi_sync_master_tx_waits              | 0     |<br>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |<br>| Rpl_semi_sync_master_wait_sessions         | 0     |<br>| Rpl_semi_sync_master_yes_tx                | 0     |<br>| Rpl_semi_sync_slave_status                 | OFF   |<br>+--------------------------------------------+-------+<br>15 rows in set (0.01 sec)<br></code></pre></td></tr></table></figure><h4 id="有几个状态参数值得关注的：">有几个状态参数值得关注的：</h4><ul><li><strong>rpl_semi_sync_master_status ：显示主服务是异步复制模式还是半同步复制模式</strong></li><li><strong>rpl_semi_sync_master_clients ：显示有多少个从服务器配置为半同步复制模式</strong></li><li><strong>rpl_semi_sync_master_yes_tx ：显示从服务器确认成功提交的数量</strong></li><li><strong>rpl_semi_sync_master_no_tx ：显示从服务器确认不成功提交的数量</strong></li><li><strong>rpl_semi_sync_master_tx_avg_wait_time ：事务因开启 semi_sync ，平均需要额外等待的时间</strong></li><li><strong>rpl_semi_sync_master_net_avg_wait_time ：事务进入等待队列后，到网络平均等待时间</strong></li></ul><h3 id="（6）master主机（创建用户，查看状态码）">（6）master主机（创建用户，查看状态码）</h3><h3 id><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/1594097786(1).png" alt></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave on *.* to mharep@'192.168.1.%' identified by 'xgp1234';<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br>mysql> grant all privileges on *.* to manager@'192.168.1.%' identified by 'xgp1234'; <br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br>mysql> show master status;<br>+------------------+----------+--------------+------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |<br>+------------------+----------+--------------+------------------+-------------------+<br>| mysql-bin.000001 |      742 |              |                  |                   |<br>+------------------+----------+--------------+------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><ul><li><strong>第一条grant命令是创建一个用于主从复制的帐号，在master和candicate master的主机上创建即可。</strong></li><li><strong>第二条grant命令是创建MHA管理账号，所有mysql服务器上都需要执行。MHA会在配置文件里要求能远程登录到数据库，所以要进行必要的赋权。</strong></li></ul><h3 id="（7）Candicate-master主机（配置从）">（7）Candicate master主机（配置从）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave on *.* to mharep@'192.168.1.%' identified by '123';<br>Query OK, 0 rows affected, 1 warning (0.01 sec)<br><br>mysql> grant all privileges on *.* to manager@'192.168.1.%' identified by '123'; <br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br>mysql> change master to master_host&#x3D;'192.168.1.11',master_port&#x3D;3306,master_user&#x3D;'mharep',master_password&#x3D;'xgp1234',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;742;<br>Query OK, 0 rows affected, 2 warnings (0.01 sec)<br><br>mysql> start slave;<br>mysql> show slave status \G<br>.......<br>   Slave_IO_Running: Yes<br>   Slave_SQL_Running: Yes<br>......<br></code></pre></td></tr></table></figure><p><strong>查看从的状态，以下两个值必须为yes,代表从服务器能正常连接主服务器</strong></p><h3 id="（8）Slave主机（配置从）">（8）Slave主机（配置从）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant all privileges on *.* to manager@'192.168.1.%' identified by '123';<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br>mysql> change master to master_host&#x3D;'192.168.1.11',master_port&#x3D;3306,master_user&#x3D;'mharep',master_password&#x3D;'xgp1234',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;742;<br>Query OK, 0 rows affected, 2 warnings (0.01 sec)<br><br>mysql> start slave;<br>mysql> show slave status \G<br>.......<br>   Slave_IO_Running: Yes<br>   Slave_SQL_Running: Yes<br>......<br></code></pre></td></tr></table></figure><p><strong>查看从的状态，以下两个值必须为yes,代表从服务器能正常连接主服务器</strong></p><h3 id="查看master服务器的半同步状态：">查看master服务器的半同步状态：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> show status like '%rpl_semi_sync%';<br>+--------------------------------------------+-------+<br>| Variable_name                              | Value |<br>+--------------------------------------------+-------+<br>| Rpl_semi_sync_master_clients               | 2     |<br>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |<br>| Rpl_semi_sync_master_net_wait_time         | 0     |<br>| Rpl_semi_sync_master_net_waits             | 0     |<br>| Rpl_semi_sync_master_no_times              | 1     |<br>| Rpl_semi_sync_master_no_tx                 | 2     |<br>| Rpl_semi_sync_master_status                | ON    |<br>| Rpl_semi_sync_master_timefunc_failures     | 0     |<br>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |<br>| Rpl_semi_sync_master_tx_wait_time          | 0     |<br>| Rpl_semi_sync_master_tx_waits              | 0     |<br>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |<br>| Rpl_semi_sync_master_wait_sessions         | 0     |<br>| Rpl_semi_sync_master_yes_tx                | 0     |<br>| Rpl_semi_sync_slave_status                 | OFF   |<br>+--------------------------------------------+-------+<br>15 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure><h1>三、配置mysql-mha mha包括manager节点和data节点</h1><p><strong>data节点包括原有的MySQL复制结构中的主机，至少3台，即1主2从，当masterfailover后，还能保证主从结构；只需安装node包。</strong></p><p><strong>manager server：运行监控脚本，负责monitoring 和 auto-failover；需要安装node包和manager包。</strong></p><h2 id="1、-在所有主机上安装mha所依赖的软件包（需要系统自带的yum源并联网）">1、 在所有主机上安装mha所依赖的软件包（需要系统自带的yum源并联网）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-ParallelForkManager perl-Config-IniFiles ncftp perl-Params-Validate perl-CPAN perl-TestMock-LWP.noarch perl-LWP-Authen-Negotiate.noarch perl-devel perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker<br></code></pre></td></tr></table></figure><h2 id="2、-以下操作管理节点需要两个都安装，-在3台数据库节点只要安装MHA的node节点：">2、 以下操作管理节点需要两个都安装， 在3台数据库节点只要安装MHA的node节点：</h2><blockquote><p><strong>软件下载 <a href="https://github.com/yoshinorim" target="_blank" rel="noopener">https://github.com/yoshinorim</a></strong></p></blockquote><h3 id="在所有数据库节点上安装mha4mysql-node-0-56-tar-gz">在所有数据库节点上安装mha4mysql-node-0.56.tar.gz</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA  src]# tar zxf mha4mysql-node-0.58.tar.gz<br>[root@masterA  src]# cd mha4mysql-node-0.58<br>[root@masterA  mha4mysql-node-0.58]# perl Makefile.PL<br>[root@masterA  mha4mysql-node-0.58]# make && make install<br></code></pre></td></tr></table></figure><h3 id="在管理节点安装：mha4mysql-manager-0-56-tar-gz">在管理节点安装：mha4mysql-manager-0.56.tar.gz</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# tar zxf mha4mysql-manager-0.58.tar.gz <br>[root@masterA ~]# cd mha4mysql-manager-0.58&#x2F;<br>[root@masterA mha4mysql-manager-0.58]# perl Makefile.PL<br>[root@masterA mha4mysql-manager-0.58]# make && make install<br></code></pre></td></tr></table></figure><h4 id="根据提示输入：">根据提示输入：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA mha4mysql-manager-0.58]# mkdir &#x2F;etc&#x2F;masterha<br>[root@masterA mha4mysql-manager-0.58]# mkdir -p &#x2F;masterha&#x2F;app1<br>[root@masterA mha4mysql-manager-0.58]# mkdir &#x2F;scripts<br>[root@masterA mha4mysql-manager-0.58]# cp samples&#x2F;conf&#x2F;* &#x2F;etc&#x2F;masterha&#x2F;<br>[root@masterA mha4mysql-manager-0.58]# cp samples&#x2F;scripts&#x2F;* &#x2F;scripts&#x2F;<br></code></pre></td></tr></table></figure><h2 id="3、-配置mha">3、 配置mha</h2><p><strong>与绝大多数Linux应用程序类似，MHA的正确使用依赖于合理的配置文件。MHA的配置文件与mysql的my.cnf文件配置相似，采取的是param=value的方式来配置，配置文件位于管理节点，通常包括每一个mysql server的主机名，mysql用户名，密码，工作目录等等。</strong></p><h4 id="编辑-etc-masterha-app1-conf，内容如下：">编辑/etc/masterha/app1.conf，内容如下：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA mha4mysql-manager-0.58]# vim &#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br><br>[server default]<br>manager_log&#x3D;&#x2F;masterha&#x2F;app1&#x2F;manager.log<br>user&#x3D;manager<br>password&#x3D;xgp1234<br>ssh_user&#x3D;root<br>repl_user&#x3D;mharep<br>repl_password&#x3D;xgp1234<br>ping_interval&#x3D;1<br><br>[server1]<br>hostname&#x3D;192.168.1.11<br>port&#x3D;3306<br>master_binlog_dir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data<br>candidate_master&#x3D;1<br><br>[server2]<br>hostname&#x3D;192.168.1.12<br>port&#x3D;3306<br>master_binlog_dir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data<br>candidate_master&#x3D;1<br><br>[server3]<br>hostname&#x3D;192.168.1.13<br>port&#x3D;3306<br>master_binlog_dir&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;data<br>no_master&#x3D;1<br></code></pre></td></tr></table></figure><h4 id="配关配置项的解释：">配关配置项的解释：</h4><ul><li><strong>manager_workdir=/masterha/app1 //设置manager的工作目录</strong></li><li><strong>manager_log=/masterha/app1/manager.log //设置manager的日志</strong></li><li><strong>user=manager //设置监控用户manager</strong></li><li><strong>password=123456 //监控用户manager的密码</strong></li><li><strong>ssh_user=root //ssh连接用户</strong></li><li><strong>repl_user=mharep //主从复制用户</strong><br><strong>repl_password=123.abc //主从复制用户密码</strong></li><li><strong>ping_interval=1 //设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进railover</strong></li><li><strong>master_binlog_dir=/usr/local/mysql/data //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</strong></li><li><strong>candidate_master=1 //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库。</strong></li></ul><h2 id="4、SSH-有效性验证：">4、SSH 有效性验证：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA masterha]# masterha_check_ssh --global_conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;masterha_default.cnf --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br><br>Mon Jul  6 18:41:51 2020 - [debug]  Connecting via SSH from root@192.168.1.11(192.168.1.11:22) to root@192.168.1.12(192.168.1.12:22)..<br>Mon Jul  6 18:41:51 2020 - [debug]   ok.<br>Mon Jul  6 18:41:51 2020 - [debug]  Connecting via SSH from root@192.168.1.11(192.168.1.11:22) to root@192.168.1.13(192.168.1.13:22)..<br>Mon Jul  6 18:41:52 2020 - [debug]   ok.<br>Mon Jul  6 18:41:52 2020 - [debug] <br>Mon Jul  6 18:41:52 2020 - [debug]  Connecting via SSH from root@192.168.1.12(192.168.1.12:22) to root@192.168.1.11(192.168.1.11:22)..<br>Mon Jul  6 18:41:52 2020 - [debug]   ok.<br>Mon Jul  6 18:41:52 2020 - [debug]  Connecting via SSH from root@192.168.1.12(192.168.1.12:22) to root@192.168.1.13(192.168.1.13:22)..<br>Mon Jul  6 18:41:52 2020 - [debug]   ok.<br>Mon Jul  6 18:41:53 2020 - [debug] <br>Mon Jul  6 18:41:52 2020 - [debug]  Connecting via SSH from root@192.168.1.13(192.168.1.13:22) to root@192.168.1.11(192.168.1.11:22)..<br>Mon Jul  6 18:41:52 2020 - [debug]   ok.<br>Mon Jul  6 18:41:52 2020 - [debug]  Connecting via SSH from root@192.168.1.13(192.168.1.13:22) to root@192.168.1.12(192.168.1.12:22)..<br>Mon Jul  6 18:41:53 2020 - [debug]   ok.<br>Mon Jul  6 18:41:53 2020 - [info] All SSH connection tests passed successfully.<br></code></pre></td></tr></table></figure><h2 id="5、集群复制的有效性验证：-mysql必须都启动">5、集群复制的有效性验证： mysql必须都启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA masterha]# masterha_check_repl --global_conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;masterha_default.cnf --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br><br>。。。省略好多数据<br>Mon Jul  6 18:47:47 2020 - [info] Checking replication health on 192.168.1.12..<br>Mon Jul  6 18:47:47 2020 - [info]  ok.<br>Mon Jul  6 18:47:47 2020 - [info] Checking replication health on 192.168.1.13..<br>Mon Jul  6 18:47:47 2020 - [info]  ok.<br>Mon Jul  6 18:47:47 2020 - [warning] master_ip_failover_script is not defined.<br>Mon Jul  6 18:47:47 2020 - [warning] shutdown_script is not defined.<br>Mon Jul  6 18:47:47 2020 - [info] Got exit code 0 (Not master dead).<br><br>MySQL Replication Health is OK.<br></code></pre></td></tr></table></figure><p><strong>验证成功的话会自动识别出所有服务器和主从状况</strong></p><blockquote><p><strong>注：验证成功的话会自动识别出所有服务器和主从状况 在验证时，若遇到这个错误：Can’t exec “mysqlbinlog” … 解决方法是在所有服务器上执行：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">ln -s &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;* &#x2F;usr&#x2F;local&#x2F;bin&#x2F;<br></code></pre></td></tr></table></figure></blockquote><h1>四、mha的使用</h1><h2 id="1、启动-manager：">1、启动 manager：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA masterha]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf &>&#x2F;tmp&#x2F;mha_manager.log &<br>[1] 49677<br></code></pre></td></tr></table></figure><blockquote><p><strong>注：在应用Unix/Linux时，我们一般想让某个程序在后台运行，于是我们将常会用 &amp; 在程序结尾来让程序自动运行。比如我们要运行mysql在后台： /usr/local/mysql/bin/mysqld_safe –user=mysql &amp;。可是*有很多程序并不想mysqld一样，这样我们就需要nohup命令，</strong></p></blockquote><h2 id="2、状态检查：">2、状态检查：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA masterha]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf <br>app1 (pid:49677) is running(0:PING_OK), master:192.168.1.11<br></code></pre></td></tr></table></figure><h2 id="3、故障转移验证：">3、故障转移验证：</h2><p>**(自动failover) master dead后，MHA当时已经开启，候选Master库（Slave）会自动failover为Master. 验证的方式是先停掉 master（masterB），因为之前的配置文件中，把Candicate master(mysqlC)作为了候选人，那么就到 slave(mysqlD) 上查看 master 的 IP 是否变为了 centos3 的 IP **</p><h4 id="1-停掉-master-在masterB（192-168-1-11）-上把-mysql-停掉">1)停掉 master 在masterB（192.168.1.11） 上把 mysql 停掉</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# systemctl stop mysqld<br></code></pre></td></tr></table></figure><h4 id="2-查看-MHA-日志-上面的配置文件中指定了日志位置为-masterha-app1-manager-log">2)查看 MHA 日志 上面的配置文件中指定了日志位置为/masterha/app1/manager.log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# cat &#x2F;masterha&#x2F;app1&#x2F;manager.log<br>----- Failover Report -----<br><br>app1: MySQL Master failover 192.168.1.11(192.168.1.11:3306) to 192.168.1.12(192.168.1.12:3306) succeeded<br><br>Master 192.168.1.11(192.168.1.11:3306) is down!<br><br>Check MHA Manager logs at masterA:&#x2F;masterha&#x2F;app1&#x2F;manager.log for details.<br><br>Started automated(non-interactive) failover.<br>The latest slave 192.168.1.12(192.168.1.12:3306) has all relay logs for recovery.<br>Selected 192.168.1.12(192.168.1.12:3306) as a new master.<br>192.168.1.12(192.168.1.12:3306): OK: Applying all logs succeeded.<br>192.168.1.13(192.168.1.13:3306): This host has the latest relay log events.<br>Generating relay diff files from the latest slave succeeded.<br>192.168.1.13(192.168.1.13:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.1.12(192.168.1.12:3306)<br>192.168.1.12(192.168.1.12:3306): Resetting slave info succeeded.<br>Master failover to 192.168.1.12(192.168.1.12:3306) completed successfully.<br></code></pre></td></tr></table></figure><p><strong>从日志信息中可以看到 master failover 已经成功了，并可以看出故障转移的大体流程</strong></p><h4 id="3-检查-slave2-的复制-登录-slave（192-168-1-13）-的Mysql，查看-slave-状态">3)检查 slave2 的复制 登录 slave（192.168.1.13） 的Mysql，查看 slave 状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql>  show slave status \G<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: 192.168.1.12<br>                  Master_User: mharep<br>                  Master_Port: 3306<br>                Connect_Retry: 60<br>              Master_Log_File: mysql-bin.000001<br>          Read_Master_Log_Pos: 742<br>               Relay_Log_File: relay-bin.000002<br>                Relay_Log_Pos: 320<br>        Relay_Master_Log_File: mysql-bin.000001<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><p><strong>可以看到 master 的 IP 现在为 192.168.1.12, 已经切换到和192.168.1.12同步了，本来是和192.168.1.11同步的，说明 MHA 已经把Candicate master(mysqlC) 提升为了新的 master，IO线程和SQL线程也正确运行，MHA搭建成功</strong></p><h1>五、MHA Manager 端日常主要操作步骤</h1><h2 id="1、检查是否有下列文件，有则删除。">1、检查是否有下列文件，有则删除。</h2><p><strong>发生主从切换后，MHAmanager服务会自动停掉，且在manager_workdir（/masterha/app1）目录下面生成文件app1.failover.complete，若要启动MHA，必须先确保无此文件) 如果有这个提示，那么删除此文件</strong></p><p><strong>/masterha/app1/app1.failover.complete [error]</strong></p><p><strong>[/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln298] Last failover was done at 2015/01/09 10:00:47.</strong></p><p><strong>Current time is too early to do failover again. If you want to do failover, manually remove /</strong></p><p><strong>masterha/app1/app1.failover.complete and run this script again.</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# ll &#x2F;masterha&#x2F;app1&#x2F;app1.failover.complete<br>[root@masterA ~]# ll &#x2F;masterha&#x2F;app1&#x2F;app1.failover.error<br></code></pre></td></tr></table></figure><h2 id="2、检查MHA复制检查：（需要把master设置成candicatade的从服务器）">2、检查MHA复制检查：（需要把master设置成candicatade的从服务器）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> CHANGE MASTER TO MASTER_HOST&#x3D;'192.168.1.12', MASTER_PORT&#x3D;3306, MASTER_LOG_FILE&#x3D;'mysql-bin.000002', MASTER_LOG_POS&#x3D;154, MASTER_USER&#x3D;'mharep', MASTER_PASSWORD&#x3D;'xgp1234';<br>Query OK, 0 rows affected, 2 warnings (0.01 sec)<br><br>[root@masterA ~]# masterha_check_repl --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>&#x2F;&#x2F;测试一下<br></code></pre></td></tr></table></figure><h2 id="3、停止MHA：">3、停止MHA：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_stop --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br></code></pre></td></tr></table></figure><h2 id="4、启动MHA：">4、启动MHA：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf &>&#x2F;tmp&#x2F;mha_manager.log &<br></code></pre></td></tr></table></figure><p><strong>当有slave 节点宕掉时，默认是启动不了的，加上 --ignore_fail_on_start 即使有节点宕掉也能启动MHA，如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf --ignore_fail_on_start &>&#x2F;tmp&#x2F;mha_manager.log &<br></code></pre></td></tr></table></figure><h2 id="5、检查状态：">5、检查状态：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha &#x2F;app1.cnf<br></code></pre></td></tr></table></figure><h2 id="6、检查日志：">6、检查日志：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# tail -f &#x2F;masterha&#x2F;app1&#x2F;manager.log<br></code></pre></td></tr></table></figure><h2 id="7、主从切换后续工作">7、主从切换后续工作</h2><p><strong>重构： 重构就是你的主挂了，切换到Candicate master上，Candicate master变成了主，因此重构的一种方案原主库修复成一个新的slave 主库切换后，把原主库修复成新从库，然后重新执行以上5步。原主库数据文件完整的情况下，可通过以下方式找出最后执行的CHANGE MASTER命令：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# grep "CHANGE MASTER TO MASTER" &#x2F;masterha&#x2F;app1&#x2F;manager.log | tail -1<br></code></pre></td></tr></table></figure><h4 id="配置从服务">配置从服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# mysql -u root -p123<br>mysql> CHANGE MASTER TO MASTER_HOST&#x3D;'192.168.1.12', MASTER_PORT&#x3D;3306, MASTER_LOG_FILE&#x3D;'mysql-bin.000001', MASTER_LOG_POS&#x3D;742, MASTER_USER&#x3D;'mharep',MASTER_PASSWORD&#x3D;'xgp1234';<br>Query OK, 0 rows affected, 2 warnings (0.00 sec)<br><br>mysql> start slave;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql> show slave status\G<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br></code></pre></td></tr></table></figure><h3 id="启动manager">启动manager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]#  nohup masterha_manager --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf &>&#x2F;tmp&#x2F;mha_manager.log &<br>[1] 50826<br><br>[root@masterA ~]# masterha_check_status --conf&#x3D;&#x2F;etc&#x2F;masterha&#x2F;app1.cnf<br>app1 (pid:50826) is running(0:PING_OK), master:192.168.1.12<br></code></pre></td></tr></table></figure><p><strong>注意：如果正常，会显示&quot;PING_OK&quot;，否则会显示&quot;NOT_RUNNING&quot;，这代表MHA监控没有开启。</strong></p><p><strong>定期删除中继日志 在配置主从复制中，slave上设置了参数relay_log_purge=0，所以slave节点需要定期删除中继日志，建议每个slave节点删除中继日志的时间错开。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# corntab -e 0 5 * * * &#x2F;usr&#x2F;local&#x2F;bin&#x2F;purge_relay_logs - -user&#x3D;root --password&#x3D;pwd123 --port&#x3D;3306 --disable_relay_log_purge >> &#x2F;var&#x2F;log&#x2F;purge_relay.log 2>&1<br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;mha简介&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://wsdlxgp.top/categories/mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQL高可用集群之MySQL-MMM（2）</title>
    <link href="https://wsdlxgp.top/posts/bert.html"/>
    <id>https://wsdlxgp.top/posts/bert.html</id>
    <published>2020-06-29T16:02:00.000Z</published>
    <updated>2020-07-11T08:09:21.770Z</updated>
    
    <content type="html"><![CDATA[<h1>一 MMM 高可用mysql简介</h1><p>MMM(Master-Master Replication mananger for mysql)，由一个管理端（monitor）和多个代理端（agent）构成。通过MMM可以实现监控和管理Mysql主主复制和服务状态，同时也可监控多个Slave节点的复制以及运行状态，并且可以做到任何节点发生故障时实现自动化切换的功能。<br>MMM套件三个主要脚本：<br>mmm_mond:监控进程，运行在管理节点，主要负责对所有数据库的监控工作，同时决定和处理所有节点的角色切换。<br>mmm_agent:代理进程，运行在每台Mysql服务器，完成监控的测试工作和执行远程服务设置。<br>mmm_control:管理脚本，查看和管理集群运行状态，同时管理mmm_mond进程。</p><h1>二 MMM典型应用架构</h1><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200702205836.png" alt></p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200702205910.png" alt></p><h1>三 MMM双主多从Mysql架构配置</h1><p>架构图如上图</p><p>双主双从应用架构读、写分离IP列表</p><p>角色物理IPserver_id虚拟IP地址IP角色功能<br>Master1192.168.1.1661192.168.1.150writer IP写入VIP,单点写入<br>192.168.1.151reader IP读查询VIP,每个节点一个读VIP,可通过负载均衡软件对读负载均衡<br>Master2 192.168.1.1682192.168.1.152<br>Slave1  192.168.1.1863192.168.1.153<br>Slave2  192.168.1.1884192.168.1.154<br>Monitor 192.168.1.180</p><h2 id="1、配置前准备">1、配置前准备</h2><h3 id="（1）校时操作">（1）校时操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs plain"><code class="language-hljs plain">#安装ntpdate工具<br>yum install ntpdate -y<br>#使用ntpdate校时（后面的是ntp服务器）<br>ntpdate pool.ntp.org<br></code></pre></td></tr></table></figure><h3 id="（2）关闭selinux">（2）关闭selinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs plain"><code class="language-hljs plain">setenforce 0<br>sed -i 's&#x2F;enforcing&#x2F;disabled&#x2F;g' &#x2F;etc&#x2F;selinux&#x2F;config<br></code></pre></td></tr></table></figure><h2 id="2、MMM的安装配置">2、MMM的安装配置</h2><h3 id="（1）MMM套件安装">（1）MMM套件安装</h3><h4 id="在Monitor端安装所有MMM组件">在Monitor端安装所有MMM组件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs plain"><code class="language-hljs plain">yum install epel-release.noarch -y<br>yum install mysql-mmm mysql-mmm-agent mysql-mmm-tools mysql-mmm-monitor -y<br></code></pre></td></tr></table></figure><h4 id="在其他所有节点安装mysql-mmm-agent">在其他所有节点安装mysql-mmm-agent</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs plain"><code class="language-hljs plain">yum install epel-release.noarch -y<br>yum install mysql-mmm-agent -y<br></code></pre></td></tr></table></figure><h1>三、masterB和mysqlC的主主配置和masterB和mysqlD的主从配置</h1><p><strong>首先在3台主机上安装mysql和搭建复制（192.168.1.11和192.168.1.12互为主从，192.168.1.13为192.168.1.11的从）具体的复制搭建这里就省略，要是这都不会，那么该文章对你就没意思了。然后在每个mysql的配置文件中加入以下内容，<code>注意server_id 不能重复</code>。</strong></p><h3 id="masterB（192-168-1-11）上：">masterB（192.168.1.11）上：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# vi &#x2F;etc&#x2F;my.cnf   #添加如下<br>[mysqld]<br>binlog-do-db&#x3D;test           #需要记录二进制日志的数据库，多个用逗号隔开<br>binlog-ignore-db&#x3D;mysql，information_schema  #不需要记录二进制日志的数据库，多个用逗号隔开<br>auto_increment_increment&#x3D;2  #字段一次递增多少<br>auto_increment_offset&#x3D;1     #自增字段的起始值，值设置不同<br>replicate-do-db&#x3D;test        #同步的数据库，多个写多行<br>replicate-ignore-db &#x3D; information_schema #不同步的数据库，多个写多行<br>server_id &#x3D; 1               #每台设置不同<br>log_bin &#x3D; mysql-bin<br>log_slave_updates           #当一个主故障，另一个立即接管<br>sync-binlog&#x3D;1               #每条自动更新，安全性高，默认是0<br>[root@masterB ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h3 id="mysqlC（192-168-1-11）上：">mysqlC（192.168.1.11）上：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# vim &#x2F;etc&#x2F;my.cnf   <br>[mysqld]<br>binlog-do-db&#x3D;test           <br>binlog-ignore-db&#x3D;mysql，information_schema  <br>auto_increment_increment&#x3D;2  <br>auto_increment_offset&#x3D;2     <br>replicate-do-db&#x3D;test        #同步的数据库，多个写多行<br>replicate-ignore-db &#x3D; information_schema <br>server_id &#x3D; 2               <br>log_bin &#x3D; mysql-bin<br>log_slave_updates           <br>sync-binlog&#x3D;1               <br>[root@mysqlC ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h3 id="mysqlD（192-168-1-11）上：">mysqlD（192.168.1.11）上：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlD ~]# vim &#x2F;etc&#x2F;my.cnf   <br>[mysqld]<br>binlog-do-db&#x3D;test           <br>binlog-ignore-db&#x3D;mysql，information_schema  <br>auto_increment_increment&#x3D;2 <br>auto_increment_offset&#x3D;3    <br>replicate-do-db&#x3D;test       <br>replicate-ignore-db &#x3D; information_schema<br>server_id &#x3D; 3               <br>log_bin &#x3D; mysql-bin<br>log_slave_updates           <br>sync-binlog&#x3D;1               <br>[root@mysqlD ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h2 id="1、设置masterB和mysqlC双主复制">1、设置masterB和mysqlC双主复制</h2><h3 id="（1）masterB操作">（1）masterB操作</h3><h4 id="查看log-bin日志和pos值位置"><strong>查看log bin日志和pos值位置</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave ,replication client on *.* to repl@'192.168.1.12' identified by "repl123";<br><br>mysql> flush privileges;<br><br># 注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！<br>mysql> FLUSH TABLES WITH READ LOCK;<br><br>mysql> show master status;  <br>+------------------+----------+--------------+----------------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB           | Executed_Gtid_Set |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| mysql-bin.000001 |     2058 | test         | mysql，information_schema  |                   |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="（2）mysqlC操作">（2）mysqlC操作</h3><p><strong>查看log bin日志和pos值位置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave ,replication client on *.* to repl@'192.168.1.11' identified by "repl123";<br>mysql> flush privileges;<br><br># 注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！<br>mysql> FLUSH TABLES WITH READ LOCK;<br><br>mysql> show master status;  <br>+------------------+----------+--------------+----------------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB           | Executed_Gtid_Set |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| mysql-bin.000001 |      630 | test         | mysql，information_schema  |                   |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="（3）mysqlC同步masterB">（3）mysqlC同步masterB</h3><p><strong>确保mysqlC上要同步的数据，提前在masterB上存在，最好双方数据保持一致。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#先解锁，将对方数据同步到自己的数据库中<br>mysql> unlock tables; <br>mysql> stop slave;<br>mysql> change master to master_host&#x3D;'192.168.1.11',master_user&#x3D;'repl',master_password&#x3D;'repl123',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;2058;<br><br><br>mysql> start slave;<br>mysql> show slave status \G<br>true  ..................<br>      Slave_IO_Running: Yes<br>      Slave_SQL_Running: Yes<br>      ..................<br></code></pre></td></tr></table></figure><p><strong>这样就实现了slave－&gt;master的同步环境。</strong></p><h2 id="（4）masterB同步mysqlC">（4）masterB同步mysqlC</h2><p><strong>确保mysqlC上要同步的数据，提前在masterB上存在，最好双方数据保持一致。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#先解锁，将对方数据同步到自己的数据库中<br>mysql> unlock tables; <br>mysql> stop slave;<br>mysql> change master to master_host&#x3D;'192.168.1.12',master_user&#x3D;'repl',master_password&#x3D;'repl123',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;630;<br><br><br>mysql> start slave;<br>mysql> show slave status \G<br>true  ..................<br>      Slave_IO_Running: Yes<br>      Slave_SQL_Running: Yes<br>      ..................<br></code></pre></td></tr></table></figure><h3 id="测试一下双主">测试一下双主</h3><p><strong>masterB插入数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> use test<br>mysql> create table xgp (xm int(10));<br>mysql> insert into xgp(xm)<br>    -> VALUES(10);<br>Query OK, 1 row affected (0.01 sec)<br></code></pre></td></tr></table></figure><p><strong>mysqlC查看数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> select * from test.xgp;<br>+------+<br>| xm   |<br>+------+<br>|   10 |<br>+------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>可以看到已经成功同步过去，同样在test插入到xgp表数据，也能同步过去。我们的双主就成功了，开始做主从复制。</strong></p><h2 id="2、设置mysqlD为masterB的从服务器">2、设置mysqlD为masterB的从服务器</h2><h3 id="（1）查看一下masterB的log-bin日志和pos值位置">（1）查看一下masterB的log bin日志和pos值位置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave ,replication client on *.* to repl@'192.168.1.11' identified by "repl123";<br>mysql> flush privileges;<br><br># 注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！<br>mysql> FLUSH TABLES WITH READ LOCK;<br><br>mysql> show master status;<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB           | Executed_Gtid_Set |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| mysql-bin.000001 |     2825 | test         | mysql，information_schema  |                   |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="（2）mysqlD的操作">（2）mysqlD的操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> unlock tables; <br>mysql> stop slave;  #执行同步前，要先关闭slave<br>mysql> change master to master_host&#x3D;'192.168.1.11',master_user&#x3D;'repl',master_password&#x3D;'repl123',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;2825;<br>  <br>mysql> start slave;<br>mysql> show slave status \G<br>.......<br>   Slave_IO_Running: Yes<br>   Slave_SQL_Running: Yes<br>......<br></code></pre></td></tr></table></figure><h3 id="测试一下主从">测试一下主从</h3><p><strong>masterB插入数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> create table wer (xm int(10));<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql> insert into wer(xm) VALUES(10);<br>Query OK, 1 row affected (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>mysqlD查看数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql>  select * from test.wer;<br>+------+<br>| xm   |<br>+------+<br>|   10 |<br>+------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h2 id="3、在所有MySQL节点的-etc-my-cnf中增加参数（要重启）">3、在所有MySQL节点的/etc/my.cnf中增加参数（要重启）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs plain"><code class="language-hljs plain">[root@mysqlD ~]# vim &#x2F;etc&#x2F;my.cnf<br>read_only&#x3D;1<br>#read_only是因为MMM对数据需严格的读写控制<br>#此参数不影响replication;root用户依然可写。<br><br>[root@mysqlD ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h2 id="4、所有MySQL节点创建monitor-user（健康检测）和monitor-agent（切换只读模式和同步Master信息）帐号（仅在mysql写入主节点-其他节点会自动复制）">4、所有MySQL节点创建monitor user（健康检测）和monitor agent（切换只读模式和同步Master信息）帐号（仅在mysql写入主节点,其他节点会自动复制）</h2><h3 id="（1）mysql-mmm配置：在3台mysql节点上创建用户创建代理账号：">（1）mysql-mmm配置：在3台mysql节点上创建用户创建代理账号：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant super,replication client,process on *.* to 'mmm_agent'@'192.168.1.%' identified by '123456';<br></code></pre></td></tr></table></figure><h3 id="（2）创建监控账号（3台mysql节点）：">（2）创建监控账号（3台mysql节点）：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication client on *.* to 'mmm_monitor'@'192.168.1.%' identified by '123456';<br></code></pre></td></tr></table></figure><p><strong>因为之前的主主复制，以及主从已经是ok的，所以我在masterB服务器执行就ok了。 检查mysqlC、mysqlD两台db上是否都存在监控和代理账号</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> select user,host from mysql.user where user in ('mmm_monitor','mmm_agent');<br>+-------------+-------------+<br>| user        | host        |<br>+-------------+-------------+<br>| mmm_agent   | 192.168.1.% |<br>| mmm_monitor | 192.168.1.% |<br>+-------------+-------------+<br>2 rows in set (0.00 sec)<br><br>或<br><br>mysql>  show grants for 'mmm_agent'@'192.168.1.%';<br>+------------------------------------------------------------------------------+<br>| Grants for mmm_agent@192.168.1.%                                             |<br>+------------------------------------------------------------------------------+<br>| GRANT PROCESS, SUPER, REPLICATION CLIENT ON *.* TO 'mmm_agent'@'192.168.1.%' |<br>+------------------------------------------------------------------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>**mmm_monitor用户：mmm监控用于对mysql服务器进程健康检查 **</p><p><strong>mmm_agent用户：mmm代理用来更改只读模式，复制的主服务器等。</strong></p><h2 id="5、在所有MMM节点配置mmm-common-conf">5、在所有MMM节点配置mmm_common.conf</h2><p><strong>（注意以下所有配置文件中不能以下注释，会报错 使用<code>sed -i '/^#/d;s/#.*//g' file</code> 清除注释）</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#当设置此参数，所有mysql节点都设置为"read_only&#x3D;1",MMM会根据Mysql角色来决定是否执行"set global read_only&#x3D;0".<br>active_master_role      writer<br><br><br><host default><br>        cluster_interface               eno16777736<br><br>        pid_path                        &#x2F;var&#x2F;run&#x2F;mmm_agentd.pid<br>        bin_path                        &#x2F;usr&#x2F;libexec&#x2F;mysql-mmm&#x2F;<br><br>    replication_user        replication<br>    replication_password    123456<br><br>        agent_user                      mmm_agent<br>        agent_password                  123456<br><&#x2F;host><br><br><host masterB><br>        ip                              192.168.1.11<br>        mode                            master<br>        peer                            mysqlC<br><&#x2F;host><br><br><host mysqlC><br>        ip                              192.168.1.12<br>        mode                            master<br>        peer                            masterB<br><&#x2F;host><br><br><host mysqlD><br>        ip                              192.168.1.13<br>        mode                            slave<br><&#x2F;host><br><br><br><role writer><br>        hosts                           masterB,mysqlC<br>        ips                             192.168.1.100<br>        mode                            exclusive<br><&#x2F;role><br><br><role reader><br>        hosts                           mysqlC,mysqlD<br>        ips                             192.168.1.110,192.168.1.111<br>        mode                            balanced<br><&#x2F;role><br></code></pre></td></tr></table></figure><h2 id="6、在仅在MMM管理节点配置mmm-mom-conf">6、在仅在MMM管理节点配置mmm_mom.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">include mmm_common.conf<br><monitor><br>    ip                  127.0.0.1<br>    pid_path            &#x2F;var&#x2F;run&#x2F;mysql-mmm&#x2F;mmm_mond.pid<br>    bin_path            &#x2F;usr&#x2F;libexec&#x2F;mysql-mmm<br>    status_path         &#x2F;var&#x2F;lib&#x2F;mysql-mmm&#x2F;mmm_mond.status<br>    ping_ips            192.168.1.11,192.168.1.12,192.168.1.13<br>    auto_set_online     10 <br><&#x2F;monitor><br><check default><br>truecheck_period 5<br>truetrap_period 10<br>truetimeout 2<br>true#restart_after 10000<br>truemax_backlog 86400 <br><&#x2F;check><br><host default><br>    monitor_user        mmm_monitor<br>    monitor_password    123456<br><&#x2F;host><br>debug 0<br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一 MMM 高可用mysql简介&lt;/h1&gt;
&lt;p&gt;MMM(Master-Master Replication mananger for mysql)，由一个管理端（monitor）和多个代理端（agent）构成。通过MMM可以实现监控和管理Mysql主主复制和服务状态，同
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://wsdlxgp.top/categories/mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>MySQL高可用集群之MySQL-MMM(1)</title>
    <link href="https://wsdlxgp.top/posts/b9cm.html"/>
    <id>https://wsdlxgp.top/posts/b9cm.html</id>
    <published>2020-06-28T16:02:00.000Z</published>
    <updated>2020-07-11T08:09:09.399Z</updated>
    
    <content type="html"><![CDATA[<h1>一、MMM简介</h1><p><strong>MMM即Multi-Master Replication Manager for MySQL:mysql多主复制管理器,基于perl实现,关于mysql主主复制置的监控、故障转移和管理的一套可伸缩的脚本套件（在任何时候只有一个节点可以被写入），MMM也能对从服务器进行读负载均衡，所以可以用它来在一组用于复制的服务器启动虚拟ip，除此之外，它还有实现数<br>据备份、节点之间重新同步功能的脚本。MySQL本身没有提供replication failover的解决方案，通过MMM方案能实现服务器的故障转移，从而实现mysql的高可用。MMM不仅能提供浮动IP的功能，如果当前的主服务器挂掉后，会将你后端的从服务器自动转向新的主服务器进行同步复制，不用手工更改同步配置。这个方案是目前比较成熟的解决方案。详情请看官网：<a href="http://mysql-mmm.org" target="_blank" rel="noopener">http://mysql-mmm.org</a></strong></p><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200703150904.png" alt></p><h2 id="1、MySQL-MMM优缺点">1、MySQL-MMM优缺点</h2><h3 id="优点："><strong>优点：</strong></h3><ul><li><strong>高可用性，扩展性好，出现故障自动切换，对于主主同步，在同一时间只提供一台数据库写操作，保证的数据的一致性。</strong></li><li><strong>当主服务器挂掉以后，另一个主立即接管，其他的从服务器能自动切换，不用人工干预。</strong></li></ul><h3 id="缺点："><strong>缺点：</strong></h3><p><strong>Monitor节点是单点，可以结合Keepalived或者haertbeat实现高可用。</strong></p><p><strong>至少三个节点，对主机的数量有要求，需要实现读写分离,还需要在前端编写读写分离程序。</strong></p><p><strong>在读写非常繁忙的业务系统下表现不是很稳定，可能会出现复制延时、切换失效等问题。</strong></p><p>**MMM方案并不太适应于对数据安全性要求很高，并且读、写繁忙的环境中。   **</p><h3 id="适用场景">适用场景:</h3><ul><li><strong>MMM的适用场景为数据库访问量大，并且能实现读写分离的场景。</strong></li><li><strong>Mmm主要功能由下面三个脚本提供:</strong></li><li><ul><li><strong>mmm_mond 负责所有的监控工作的监控守护进程，决定节点的移除(mmm_mond进程定时心跳检测，失败则将write ip浮动到另外一台master)等等</strong></li></ul></li><li><ul><li><strong>mmm_agentd 运行在mysql服务器上的代理守护进程，通过简单远程服务集提供给监控节点</strong></li></ul></li><li><ul><li><strong>mmm_control 通过命令行管理mmm_mond进程 在整个监管过程中，需要在mysql中添加相关授权用户，授权的用户包括一个mmm_monitor用户和一个mmm_agent用户，如果想使用mmm的备份工具则还要添加一个mmm_tools用户。</strong></li></ul></li></ul><h2 id="2、MySQL-MMM工作原理">2、MySQL-MMM工作原理</h2><p><strong>MMM(Master-Master replication managerfor Mysql，Mysql主主复制管理器)是一套灵活的脚本程序，基于perl实现，用来对mysql replication进行监控和故障迁移，并能管理mysql Master-Master复制的配置(同一时间只有一个节点是可写的)。</strong></p><ul><li><p><strong>mmm_mond：监控进程，负责所有的监控工作，决定和处理所有节点角色活动。此脚本需要在监管机上运行。</strong></p></li><li><p><strong>mmm_agentd：运行在每个mysql服务器上的代理进程，完成监控的探针工作和执行简单的远端服务设置。此脚本需要在被监管机上运行,通过简单远程服务集提供给监控节点。</strong></p></li><li><p><strong>mmm_control：一个简单的脚本，提供管理mmm_mond进程的命令(通过命令行管理mmm_mond进程 在整个监管过程中，需要在mysql中添加相关授权用户，授权的用户包括一个mmm_monitor用户和一个mmm_agent用户，如果想使用mmm的备份工具则还要添加一个mmm_tools用户)。</strong></p></li><li><p><strong>mysql-mmm的监管端会提供多个虚拟IP（VIP），包括一个可写VIP，多个可读VIP，通过监管的管理，这些IP会绑定在可用mysql之上，当某一台mysql宕机时，监管会将VIP迁移至其他mysql。</strong></p></li></ul><p><strong>在整个监管过程中，需要在mysql中添加相关授权用户，以便让mysql可以支持监理机的维护。授权的用户包括一个mmm_monitor用户和一个mmm_agent用户，如果想使用mmm的备份工具则还要添加一个mmm_tools用户。</strong></p><h2 id="3、实验环境">3、实验环境</h2><table><thead><tr><th>主机</th><th>角色</th><th>IP</th><th>server id</th><th>Write IP</th><th>Read IP</th><th>备注</th></tr></thead><tbody><tr><td>masterA</td><td>monitoring</td><td>192.168.1.10</td><td>——</td><td></td><td></td><td>监控机，运行MMM  Daemon程序</td></tr><tr><td>masterB</td><td>master1</td><td>192.168.1.11</td><td>1</td><td>192.168.1.100</td><td>192.168.1.110</td><td>默认为active Master，运行mmm agent</td></tr><tr><td>mysqlC</td><td>master2</td><td>192.168.1.12</td><td>2</td><td></td><td>192.168.1.111</td><td>默认为passive  Master，运行mmm agent</td></tr><tr><td>mysqlD</td><td>slave1</td><td>192.168.1.13</td><td>3</td><td></td><td>192.168.1.112</td><td>Slave，由MMM维护，运行mmm agent</td></tr></tbody></table><p><strong>业务中的服务ip信息如下所示：</strong></p><table><thead><tr><th>ip地址</th><th>角色</th><th>描述</th></tr></thead><tbody><tr><td>192.168.1.100</td><td>write</td><td>应用程序连接该ip对主库进行写请求</td></tr><tr><td>192.168.1.110</td><td>read</td><td>应用程序连接该ip进行读请求</td></tr><tr><td>192.168.1.111</td><td>read</td><td>应用程序连接该ip进行读请求</td></tr><tr><td>192.168.1.112</td><td>read</td><td>应用程序连接该ip进行读请求</td></tr></tbody></table><p><strong>数据库同步需要的用户：</strong></p><table><thead><tr><th><strong>function</strong></th><th><strong>description</strong></th><th><strong>privileges</strong></th></tr></thead><tbody><tr><td>monitor user</td><td>mmm监控用于对mysql服务器进程健康检查</td><td>REPLICATION  CLIENT</td></tr><tr><td>agent user</td><td>mmm代理用来更改只读模式，复制的主服务器等</td><td>SUPER,  REPLICATION CLIENT, PROCESS</td></tr><tr><td>replication user</td><td>用于复制</td><td>REPLICATION SLAVE</td></tr></tbody></table><h1>二、部署主从服务</h1><h2 id="1、在所有主机上配置">1、在所有主机上配置</h2><h3 id="（1）修改-etc-hosts文件">（1）修改/etc/hosts文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;etc&#x2F;hosts<br>192.168.1.10 masterA<br>192.168.1.11 masterB<br>192.168.1.12 mysqlC<br>192.168.1.13 mysqlD<br></code></pre></td></tr></table></figure><h3 id="（2）校时操作">（2）校时操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#安装ntpdate工具<br>yum install ntpdate -y<br>#使用ntpdate校时（后面的是ntp服务器）<br>ntpdate pool.ntp.org<br></code></pre></td></tr></table></figure><h3 id="（3）关闭selinux">（3）关闭selinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">setenforce 0<br>sed -i 's&#x2F;enforcing&#x2F;disabled&#x2F;g' &#x2F;etc&#x2F;selinux&#x2F;config<br></code></pre></td></tr></table></figure><h2 id="2、首先在3台主机上安装mysql和搭建复制（192-168-1-11和192-168-1-12互为主从，192-168-1-13为192-168-1-11的从）具体的复制搭建这里就省略，要是这都不会，那么该文章对你就没意思了。然后在每个mysql的配置文件中加入以下内容，注意server-id-不能重复。">2、首先在3台主机上安装mysql和搭建复制（192.168.1.11和192.168.1.12互为主从，192.168.1.13为192.168.1.11的从）具体的复制搭建这里就省略，要是这都不会，那么该文章对你就没意思了。然后在每个mysql的配置文件中加入以下内容，<code>注意server_id 不能重复</code>。</h2><h3 id="masterB（192-168-1-11）上：">masterB（192.168.1.11）上：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# vi &#x2F;etc&#x2F;my.cnf   #添加如下<br>[mysqld]<br>binlog-do-db&#x3D;test           #需要记录二进制日志的数据库，多个用逗号隔开<br>binlog-ignore-db&#x3D;mysql，information_schema  #不需要记录二进制日志的数据库，多个用逗号隔开<br>auto_increment_increment&#x3D;2  #字段一次递增多少<br>auto_increment_offset&#x3D;1     #自增字段的起始值，值设置不同<br>replicate-do-db&#x3D;test        #同步的数据库，多个写多行<br>replicate-ignore-db &#x3D; information_schema #不同步的数据库，多个写多行<br>server_id &#x3D; 1               #每台设置不同<br>log_bin &#x3D; mysql-bin<br>log_slave_updates           #当一个主故障，另一个立即接管<br>sync-binlog&#x3D;1               #每条自动更新，安全性高，默认是0<br>[root@masterB ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h3 id="mysqlC（192-168-1-11）上：">mysqlC（192.168.1.11）上：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# vim &#x2F;etc&#x2F;my.cnf   <br>[mysqld]<br>binlog-do-db&#x3D;test           <br>binlog-ignore-db&#x3D;mysql，information_schema  <br>auto_increment_increment&#x3D;2  <br>auto_increment_offset&#x3D;2     <br>replicate-do-db&#x3D;test        #同步的数据库，多个写多行<br>replicate-ignore-db &#x3D; information_schema <br>server_id &#x3D; 2               <br>log_bin &#x3D; mysql-bin<br>log_slave_updates           <br>sync-binlog&#x3D;1               <br>[root@mysqlC ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h3 id="mysqlD（192-168-1-11）上：">mysqlD（192.168.1.11）上：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlD ~]# vim &#x2F;etc&#x2F;my.cnf   <br>[mysqld]<br>binlog-do-db&#x3D;test           <br>binlog-ignore-db&#x3D;mysql，information_schema  <br>auto_increment_increment&#x3D;2 <br>auto_increment_offset&#x3D;3    <br>replicate-do-db&#x3D;test       <br>replicate-ignore-db &#x3D; information_schema<br>server_id &#x3D; 3               <br>log_bin &#x3D; mysql-bin<br>log_slave_updates           <br>sync-binlog&#x3D;1               <br>[root@mysqlD ~]# systemctl restart mysqld<br></code></pre></td></tr></table></figure><h2 id="3、设置masterB和mysqlC双主复制">3、设置masterB和mysqlC双主复制</h2><h3 id="（1）masterB操作">（1）masterB操作</h3><h4 id="查看log-bin日志和pos值位置"><strong>查看log bin日志和pos值位置</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave ,replication client on *.* to repl@'192.168.1.12' identified by "repl123";<br><br>mysql> flush privileges;<br><br># 注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！<br>mysql> FLUSH TABLES WITH READ LOCK;<br><br>mysql> show master status;  <br>+------------------+----------+--------------+----------------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB           | Executed_Gtid_Set |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| mysql-bin.000001 |     2058 | test         | mysql，information_schema  |                   |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="（2）mysqlC操作">（2）mysqlC操作</h3><p><strong>查看log bin日志和pos值位置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave ,replication client on *.* to repl@'192.168.1.11' identified by "repl123";<br>mysql> flush privileges;<br><br># 注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！<br>mysql> FLUSH TABLES WITH READ LOCK;<br><br>mysql> show master status;  <br>+------------------+----------+--------------+----------------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB           | Executed_Gtid_Set |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| mysql-bin.000001 |      630 | test         | mysql，information_schema  |                   |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="（3）mysqlC同步masterB">（3）mysqlC同步masterB</h3><p><strong>确保mysqlC上要同步的数据，提前在masterB上存在，最好双方数据保持一致。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#先解锁，将对方数据同步到自己的数据库中<br>mysql> unlock tables; <br>mysql> stop slave;<br>mysql> change master to master_host&#x3D;'192.168.1.11',master_user&#x3D;'repl',master_password&#x3D;'repl123',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;2058;<br><br><br>mysql> start slave;<br>mysql> show slave status \G<br>true  ..................<br>      Slave_IO_Running: Yes<br>      Slave_SQL_Running: Yes<br>      ..................<br></code></pre></td></tr></table></figure><p><strong>这样就实现了slave－&gt;master的同步环境。</strong></p><h2 id="（4）masterB同步mysqlC">（4）masterB同步mysqlC</h2><p><strong>确保mysqlC上要同步的数据，提前在masterB上存在，最好双方数据保持一致。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#先解锁，将对方数据同步到自己的数据库中<br>mysql> unlock tables; <br>mysql> stop slave;<br>mysql> change master to master_host&#x3D;'192.168.1.12',master_user&#x3D;'repl',master_password&#x3D;'repl123',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;630;<br><br><br>mysql> start slave;<br>mysql> show slave status \G<br>true  ..................<br>      Slave_IO_Running: Yes<br>      Slave_SQL_Running: Yes<br>      ..................<br></code></pre></td></tr></table></figure><h3 id="测试一下双主">测试一下双主</h3><p><strong>masterB插入数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> use test<br>mysql> create table xgp (xm int(10));<br>mysql> insert into xgp(xm)<br>    -> VALUES(10);<br>Query OK, 1 row affected (0.01 sec)<br></code></pre></td></tr></table></figure><p><strong>mysqlC查看数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> select * from test.xgp;<br>+------+<br>| xm   |<br>+------+<br>|   10 |<br>+------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>可以看到已经成功同步过去，同样在test插入到xgp表数据，也能同步过去。我们的双主就成功了，开始做主从复制。</strong></p><h2 id="4、设置mysqlD为masterB的从服务器">4、设置mysqlD为masterB的从服务器</h2><h3 id="（1）查看一下masterB的log-bin日志和pos值位置">（1）查看一下masterB的log bin日志和pos值位置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication slave ,replication client on *.* to repl@'192.168.1.11' identified by "repl123";<br>mysql> flush privileges;<br><br># 注意该参数设置后，如果自己同步对方数据，同步前一定要记得先解锁！<br>mysql> FLUSH TABLES WITH READ LOCK;<br><br>mysql> show master status;<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB           | Executed_Gtid_Set |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>| mysql-bin.000001 |     2825 | test         | mysql，information_schema  |                   |<br>+------------------+----------+--------------+----------------------------+-------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h3 id="（2）mysqlD的操作">（2）mysqlD的操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> unlock tables; <br>mysql> stop slave;  #执行同步前，要先关闭slave<br>mysql> change master to master_host&#x3D;'192.168.1.11',master_user&#x3D;'repl',master_password&#x3D;'repl123',master_log_file&#x3D;'mysql-bin.000001',master_log_pos&#x3D;2825;<br>  <br>mysql> start slave;<br>mysql> show slave status \G<br>.......<br>   Slave_IO_Running: Yes<br>   Slave_SQL_Running: Yes<br>......<br></code></pre></td></tr></table></figure><h3 id="测试一下主从">测试一下主从</h3><p><strong>masterB插入数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> create table wer (xm int(10));<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql> insert into wer(xm) VALUES(10);<br>Query OK, 1 row affected (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>mysqlD查看数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql>  select * from test.wer;<br>+------+<br>| xm   |<br>+------+<br>|   10 |<br>+------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><h1>三、在四台db节点授权monitor访问</h1><h3 id="1、mysql-mmm配置：在3台mysql节点上创建用户创建代理账号：">1、mysql-mmm配置：在3台mysql节点上创建用户创建代理账号：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant super,replication client,process on *.* to 'mmm_agent'@'192.168.1.%' identified by '123456';<br></code></pre></td></tr></table></figure><h3 id="2、创建监控账号（3台mysql节点）：">2、创建监控账号（3台mysql节点）：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> grant replication client on *.* to 'mmm_monitor'@'192.168.1.%' identified by '123456';<br></code></pre></td></tr></table></figure><p><strong>因为之前的主主复制，以及主从已经是ok的，所以我在masterB服务器执行就ok了。 检查mysqlC、mysqlD两台db上是否都存在监控和代理账号</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">mysql> select user,host from mysql.user where user in ('mmm_monitor','mmm_agent');<br>+-------------+-------------+<br>| user        | host        |<br>+-------------+-------------+<br>| mmm_agent   | 192.168.1.% |<br>| mmm_monitor | 192.168.1.% |<br>+-------------+-------------+<br>2 rows in set (0.00 sec)<br><br>或<br><br>mysql> show grants for 'mmm_agent'@'192.168.1.%';<br>+------------------------------------------------------------------------------+<br>| Grants for mmm_agent@192.168.1.%                                             |<br>+------------------------------------------------------------------------------+<br>| GRANT PROCESS, SUPER, REPLICATION CLIENT ON *.* TO 'mmm_agent'@'192.168.1.%' |<br>+------------------------------------------------------------------------------+<br>1 row in set (0.00 sec)<br></code></pre></td></tr></table></figure><p>**mmm_monitor用户：mmm监控用于对mysql服务器进程健康检查 **</p><p><strong>mmm_agent用户：mmm代理用来更改只读模式，复制的主服务器等。</strong></p><h1>四、MySQL-MMM安装配置</h1><p><strong>CentOS默认没有mysql-mmm软件包，官方推荐使用epel的网络源，四台都安装epel：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">rpm -ivh http:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;fedora&#x2F;epel&#x2F;6&#x2F;x86_64&#x2F;epel-release-6-8.noarch.rpm<br></code></pre></td></tr></table></figure><h2 id="安装方法一（目前可以）">安装方法一（目前可以）</h2><h3 id="（1）在所有主机上安装perl-perl-devel-perl-CPAN-libart-lgpl-x86-64-rrdtool-x86-64-rrdtool-perl-x86-64包">（1）在所有主机上安装perl perl-devel perl-CPAN libart_lgpl.x86_64 rrdtool.x86_64 rrdtool-perl.x86_64包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet"># 安装阿里云的 网络yum 源  <br>[root@masterA ~]# wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo<br><br>#安装perl依赖（可能会失败）<br>[root@masterA ~]# yum -y install perl-*  libart_lgpl.x86_64  rrdtool.x86_64  rrdtool-perl.x86_64 <br><br>#安装perl的相关库，默认为国外的源，可以直接使用如下命令进行安装<br>[root@masterA ~]# cpan -i Algorithm::Diff Class::Singleton DBI DBD::mysql Log::Dispatch Log::Log4perl Mail::Send Net::Ping Proc::Daemon Time::HiRes Params::Validate Net::ARP<br><br>#这里我使用的是阿里云的cpan，所以需要更改镜像源<br>[root@masterA ~]# cpan           # 初始化<br>cpan[1]> o conf urllist          # 查看当前有的URL<br>    urllist           <br>    0 [http:&#x2F;&#x2F;mirror.navercorp.com&#x2F;CPAN&#x2F;]<br>    1 [http:&#x2F;&#x2F;cpan.mirror.cdnetworks.com&#x2F;]<br>    2 [http:&#x2F;&#x2F;cpan.rinet.ru&#x2F;]<br>Type 'o conf' to view all configuration items<br>#删除当前有的url<br>cpan[6]> o conf urllist pop http:&#x2F;&#x2F;cpan.mirror.cdnetworks.com&#x2F;<br>cpan[10]> o conf urllist pop http:&#x2F;&#x2F;mirror.navercorp.com&#x2F;CPAN&#x2F;<br>cpan[13]> o conf urllist pop http:&#x2F;&#x2F;cpan.rinet.ru&#x2F;<br>#添加阿里云的镜像源<br>cpan[16]> o conf urllist push https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;CPAN&#x2F;<br>cpan[17]> o conf commit            # 提交<br>#安装perl的相关库<br>[root@masterA ~]# cpan -i Algorithm::Diff Class::Singleton DBI DBD::mysql Log::Dispatch Log::Log4perl Mail::Send Net::Ping Proc::Daemon Time::HiRes Params::Validate Net::ARP<br></code></pre></td></tr></table></figure><p><strong>哦。。。报错了，排查发现DBD-mysql、Net-ping、Net::ARP这是哪个没有安装成功，所以下载软件包手动安装试试</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# wget https:&#x2F;&#x2F;cpan.metacpan.org&#x2F;authors&#x2F;id&#x2F;C&#x2F;CR&#x2F;CRAZYDJ&#x2F;Net-ARP-1.0.11.tgz<br>[root@masterA ~]# wget https:&#x2F;&#x2F;cpan.metacpan.org&#x2F;authors&#x2F;id&#x2F;R&#x2F;RU&#x2F;RURBAN&#x2F;Net-Ping-2.73.tar.gz<br>[root@masterA ~]# wget https:&#x2F;&#x2F;cpan.metacpan.org&#x2F;authors&#x2F;id&#x2F;D&#x2F;DV&#x2F;DVEEDEN&#x2F;DBD-mysql-4.050.tar.gz<br>[root@masterA ~]# tar zxf DBD-mysql-4.050.tar.gz <br>[root@masterA ~]# cd DBD-mysql-4.050&#x2F;<br>[root@masterA DBD-mysql-4.050]# perl Makefile.PL<br>[root@masterA DBD-mysql-4.050]# make install <br>[root@masterA ~]# tar zxf Net-Ping-2.73.tar.gz <br>[root@masterA ~]# cd Net-Ping-2.73&#x2F;<br>[root@masterA Net-Ping-2.73]# perl Makefile.PL <br>[root@masterA Net-Ping-2.73]# make install <br>[root@masterA ~]# tar zxf Net-ARP-1.0.11.tgz <br>[root@masterA ~]# cd Net-ARP-1.0.11&#x2F;<br>[root@masterA Net-ARP-1.0.11]# perl Makefile.PL <br>[root@masterA Net-ARP-1.0.11]# make install<br></code></pre></td></tr></table></figure><h4 id="perl的相关库安装成功如下所示">perl的相关库安装成功如下所示</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# cpan -i Algorithm::Diff Class::Singleton DBI DBD::mysql Log::Dispatch Log::Log4perl Mail::Send Net::Ping Proc::Daemon Time::HiRes Params::Validate Net::ARP<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200702170246.png" alt></p><h3 id="（2）MMM套件安装">（2）MMM套件安装</h3><h4 id="在Monitor端安装所有MMM组件">在Monitor端安装所有MMM组件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# yum install epel-release.noarch -y<br>[root@masterA ~]# yum install mysql-mmm-monitor -y<br>#mysql-mmm mysql-mmm-agent mysql-mmm-tools  这些也可以安装一下<br></code></pre></td></tr></table></figure><h4 id="在其他所有节点安装mysql-mmm-agent">在其他所有节点安装mysql-mmm-agent</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# yum install epel-release.noarch -y<br>[root@masterB ~]# yum install mysql-mmm-agent -y<br></code></pre></td></tr></table></figure><h2 id="安装方法二">安装方法二</h2><h3 id="1、monitor节点安装">1、monitor节点安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# wget http:&#x2F;&#x2F;pkgs.fedoraproject.org&#x2F;repo&#x2F;pkgs&#x2F;mysql-mmm&#x2F;mysql-mmm-2.2.1.tar.gz&#x2F;f5f8b48bdf89251d3183328f0249461e&#x2F;mysql-mmm-2.2.1.tar.gz<br><br>[root@masterA ~]# tar -zxf mysql-mmm-2.2.1.tar.gz<br>[root@masterA ~]# cd mysql-mmm-2.2.1<br>[root@masterA ~]# make install<br></code></pre></td></tr></table></figure><p><strong>或</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# yum -y install gcc gcc-c++ mysql-mmm-monitor<br></code></pre></td></tr></table></figure><h3 id="2、在数据库服务器-masterB、mysqlC、mysqlD-上安装代理">2、在数据库服务器(masterB、mysqlC、mysqlD)上安装代理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# wget http:&#x2F;&#x2F;pkgs.fedoraproject.org&#x2F;repo&#x2F;pkgs&#x2F;mysql-mmm&#x2F;mysql-mmm-2.2.1.tar.gz&#x2F;f5f8b48bdf89251d3183328f0249461e&#x2F;mysql-mmm-2.2.1.tar.gz<br><br>[root@masterB ~]# tar -zxf mysql-mmm-2.2.1.tar.gz<br>[root@masterB ~]# cd mysql-mmm-2.2.1<br>[root@masterB ~]# make install<br></code></pre></td></tr></table></figure><p><strong>或</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# yum -y install gcc gcc-c++ mysql-mmm-agent<br></code></pre></td></tr></table></figure><p><strong>mysql-mmm安装后的主要拓扑结构如下所示（注意：yum安装的和源码安装的路径有所区别）：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">目录                                                            介绍<br>&#x2F;usr&#x2F;lib&#x2F;perl5&#x2F;vendor_perl&#x2F;5.8.8&#x2F;MMM                    MMM使用的主要perl模块<br>&#x2F;usr&#x2F;lib&#x2F;mysql-mmm                                      MMM使用的主要脚本<br>&#x2F;usr&#x2F;sbin                                               MMM使用的主要命令的路径<br>&#x2F;etc&#x2F;init.d&#x2F;                                            MMM的agent和monitor启动服务的目录<br>&#x2F;etc&#x2F;mysql-mmm                                          MMM配置文件的路径，默认所以的配置文件位于该目录下<br>&#x2F;var&#x2F;log&#x2F;mysql-mmm                                      默认的MMM保存日志的位置<br></code></pre></td></tr></table></figure><p><strong>到这里已经完成了MMM的基本需求，接下来需要配置具体的配置文件，其中mmm_common.conf，mmm_agent.conf为agent端的配置文件，mmm_mon.conf为monitor端的配置文件。</strong></p><h2 id="继续剩下的">继续剩下的</h2><h2 id="3、修改mmm-common-conf文件（四台相同）">3、修改mmm_common.conf文件（四台相同）</h2><p><strong>完成安装后，所有的配置文件都放到了/etc/mysql-mmm/下面。管理服务器和数据库服务器上都要包含一个共同的文件mmm_common.conf</strong></p><h3 id="范例">范例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# vim &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_common.conf<br>active_master_role writer#积极的master角色的标示，所有的db服务器要开启read_only参数，对于writer服务器监控代理会自动将read_only属性关闭。<br><host default><br>truetruecluster_interface eno16777736#群集的网络接口<br>truetruepid_path       &#x2F;var&#x2F;run&#x2F;mmm_agentd.pid#pid路径<br>truetruebin_path       &#x2F;usr&#x2F;lib&#x2F;mysql-mmm&#x2F;#可执行文件路径<br>truetruereplication_user        rep#复制用户<br>truetruereplication_password    123456#复制用户密码<br>truetrueagent_user           mmm_agent#代理用户<br>truetrueagent_password      123456#代理用户密码<br><&#x2F;host><br><host master1>#master1的host名<br>truetrueip     192.168.31.83#master1的ip<br>truetruemode       master#角色属性，master代表是主<br>truetruepeer    master2#与master1对等的服务器的host名，也就是master2的服务器host名<br><&#x2F;host><br><host master2>#和master的概念一样<br>truetrueip       192.168.31.141<br>truetruemode       master<br>truetruepeer     master1<br><&#x2F;host><br><host slave1>#从库的host名,如果存在多个从库可以重复一样的配置<br>truetrueip      192.168.31.250#从的ip<br>truetruemode     slave#slave的角色属性代表当前host是从<br><&#x2F;host><br><host slave2>#和slave的概念一样<br>truetrueip      192.168.31.225<br>truetruemode    slave<br><&#x2F;host><br><role writer>#writer角色配置<br>        hosts      master1,master2#能进行写操作的服务器的host名，如果不想切换写操作这里可以只配置master,这样也可以避免因为网络延时而进行write的切换，但是一旦master出现故障那么当前的MMM就没有writer了只有对外的read操作。<br>        ips    192.168.31.2#对外提供的写操作的虚拟IP<br>        mode   exclusive#exclusive代表只允许存在一个主，也就是只能提供一个写的IP<br><&#x2F;role><br><role reader>#read角色配置        <br>truetruehosts   master2,slave1,slave2#对外提供读操作的服务器的host名,当然这里也可以把master加进来<br>truetrueips      192.168.31.3, 192.168.31.4, 192.168.31.5#对外提供读操作的虚拟ip，这三个ip和host不是一一对应的,并且ips也hosts的数目也可以不相同，如果这样配置的话其中一个hosts会分配两个ip        <br>        mode      balanced#balanced代表负载均衡<br><&#x2F;role><br></code></pre></td></tr></table></figure><h3 id="修改">修改</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlC ~]# vim &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_common.conf<br>active_master_role      writer<br><br><host default><br>    cluster_interface       ens33<br>    pid_path                &#x2F;run&#x2F;mysql-mmm-agent.pid<br>    bin_path                &#x2F;usr&#x2F;libexec&#x2F;mysql-mmm&#x2F;<br>    replication_user        replicant<br>    replication_password    123456<br>    agent_user              mmm_agent<br>    agent_password          123456<br><&#x2F;host><br><br><host masterB><br>    ip      192.168.1.11<br>    mode    master<br>    peer    mysqlC<br><&#x2F;host><br><br><host mysqlC><br>    ip      192.168.1.12<br>    mode    master<br>    peer    masterB<br><&#x2F;host><br><br><host mysqlD><br>    ip      192.168.1.13<br>    mode    slave<br><&#x2F;host><br><br><role writer><br>    hosts   masterB, mysqlC<br>    ips     192.168.1.100<br>    mode    exclusive<br><&#x2F;role><br><br><role reader><br>    hosts   masterB, mysqlC, mysqlD<br>    ips     192.168.1.110, 192.168.1.111, 192.168.1.112<br>    mode    balanced<br><&#x2F;role><br></code></pre></td></tr></table></figure><h3 id="通过scp命令传送到其他三台：">通过scp命令传送到其他三台：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# scp -r &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_common.conf masterB:&#x2F;etc&#x2F;mysql-mmm&#x2F;<br>[root@masterA ~]# scp -r &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_common.conf mysqlC:&#x2F;etc&#x2F;mysql-mmm&#x2F;<br>[root@masterA ~]# scp -r &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_common.conf mysqlD:&#x2F;etc&#x2F;mysql-mmm&#x2F;<br>#也有一个更简便的方法<br>[root@master1] for host in masterA masterB mysqlC mysqlD ; do scp &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_common.conf $host:&#x2F;etc&#x2F;mysql-mmm&#x2F; ; done<br></code></pre></td></tr></table></figure><h2 id="4、修改三台db代理端mmm-agent-conf文件">4、修改三台db代理端mmm_agent.conf文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_agent.conf<br><br>include mmm_common.conf<br>this mysqlD     #分别修改为本机的主机名<br></code></pre></td></tr></table></figure><p><em><strong>注意：这个配置只配置db服务器，监控服务器不需要配置，this后面的host名改成当前服务器的主机名。</strong></em></p><p><strong>启动代理进程 在 /etc/init.d/mysql-mmm-agent的脚本文件的#!/bin/sh下面，加入如下内容（所有db服务器上）</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# vim &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-agent <br><br>#!&#x2F;bin&#x2F;sh<br>source &#x2F;root&#x2F;.bash_profile<br></code></pre></td></tr></table></figure><h2 id="5、修改管理端mmm-mon-conf文件">5、修改管理端mmm_mon.conf文件</h2><h3 id="范例-2">范例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_mon.conf<br>include mmm_common.conf<br><monitor><br>    ip                  127.0.0.1<br>    pid_path            &#x2F;var&#x2F;run&#x2F;mysql-mmm&#x2F;mmm_mond.pid<br>    bin_path            &#x2F;usr&#x2F;libexec&#x2F;mysql-mmm<br>    status_path         &#x2F;var&#x2F;lib&#x2F;mysql-mmm&#x2F;mmm_mond.status<br>    ping_ips            192.168.1.11,192.168.1.12,192.168.1.13 #真实数据库IP，来检测网络是否正常，这里不要写入本机地址 <br>    auto_set_online     10  #设置自动online的时间，默认是超过60s就将它设置为online，默认是60s， 这里将其设为0就是立即online<br><&#x2F;monitor><br><check default><br>truecheck_period 5# 检查周期默认为5s <br>truetrap_period 10# 一个节点被检测不成功的时间持续trap_period秒，就慎重的认为这个节点失败了<br>truetimeout 2# 检查超时的时间 <br>true#restart_after 10000# 在完成restart_after次检查后，重启checker进程 <br>truemax_backlog 86400  # 记录检查rep_backlog日志的最大次数 <br><&#x2F;check><br><host default><br>    monitor_user        mmm_monitor<br>    monitor_password    123456<br><&#x2F;host><br><br>debug 0   # 0正常模式，1为debug模式<br></code></pre></td></tr></table></figure><h3 id="修改-2">修改</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# vim &#x2F;etc&#x2F;mysql-mmm&#x2F;mmm_mon.conf<br>include mmm_common.conf<br><br><monitor><br>    ip                  127.0.0.1<br>    pid_path            &#x2F;run&#x2F;mysql-mmm-monitor.pid<br>    bin_path            &#x2F;usr&#x2F;libexec&#x2F;mysql-mmm<br>    status_path         &#x2F;var&#x2F;lib&#x2F;mysql-mmm&#x2F;mmm_mond.status<br>    ping_ips            192.168.1.11, 192.168.1.12, 192.168.1.13<br>    auto_set_online     60<br><br>    # The kill_host_bin does not exist by default, though the monitor will<br>    # throw a warning about it missing.  See the section 5.10 "Kill Host<br>    # Functionality" in the PDF documentation.<br>    #<br>    # kill_host_bin     &#x2F;usr&#x2F;libexec&#x2F;mysql-mmm&#x2F;monitor&#x2F;kill_host<br>    #<br><&#x2F;monitor><br><br><check default><br>    check_period        5<br>    trap_period         10<br>    timeout             2<br>    #restart_after      10000<br>    max_backlog         86400<br><&#x2F;check><br><br><host default><br>    monitor_user        mmm_monitor<br>    monitor_password    123456<br><&#x2F;host><br><br>debug 0<br></code></pre></td></tr></table></figure><h1>五、启动MySQL-MMM</h1><ul><li><strong>无论是在db端还是在监控端如果有对配置文件进行修改操作都需要重启代理进程和监控进程。</strong></li><li><strong>MMM启动顺序：先启动monitor，再启动 agent</strong></li></ul><h2 id="1、安装方法一的启动方式">1、安装方法一的启动方式</h2><h3 id="（1）monitor管理端启动">（1）monitor管理端启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# systemctl start mysql-mmm-monitor<br></code></pre></td></tr></table></figure><h4 id="查看状态">查看状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# systemctl status mysql-mmm-monitor<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200703153855.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# netstat -anpt | grep 9988<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200703153941.png" alt></p><h3 id="（2）db代理端启动">（2）db代理端启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# systemctl start mysql-mmm-agent<br></code></pre></td></tr></table></figure><h4 id="查看状态-2">查看状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# systemctl status mysql-mmm-agent<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200703154153.png" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# netstat -anpt | grep 9989<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200703154209.png" alt></p><h2 id="安装方法二的启动方式">安装方法二的启动方式</h2><h3 id="（1）monitor管理端启动-2">（1）monitor管理端启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#启动监控进程，加入如下内容<br>[root@monitor ~]# vim &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-monitor <br><br>#!&#x2F;bin&#x2F;sh<br>source &#x2F;root&#x2F;.bash_profile<br>#添加成系统服务并设置为自启动<br>[root@monitor ~]# chkconfig --add mysql-mmm-monitor<br>[root@monitor ~]# chkconfig mysql-mmm-monitor on<br>[root@monitor ~]# &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-monitor start <br>Daemon bin: '&#x2F;usr&#x2F;sbin&#x2F;mmm_mond'<br>Daemon pid: '&#x2F;var&#x2F;run&#x2F;mmm_mond.pid'<br>Starting MMM Monitor daemon: Ok<br></code></pre></td></tr></table></figure><h4 id="启动报错">启动报错:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">Starting MMM Monitor daemon: Can not locate Proc&#x2F;Daemon.pm in @INC (@INC contains:<br>&#x2F;usr&#x2F;local&#x2F;lib64&#x2F;perl5 &#x2F;usr&#x2F;local&#x2F;share&#x2F;perl5 &#x2F;usr&#x2F;lib64&#x2F;perl5&#x2F;vendor_perl<br>&#x2F;usr&#x2F;share&#x2F;perl5&#x2F;vendor_perl &#x2F;usr&#x2F;lib64&#x2F;perl5 &#x2F;usr&#x2F;share&#x2F;perl5 .) at<br>&#x2F;usr&#x2F;sbin&#x2F;mmm_mond line 11.<br>BEGIN failed--compilation aborted at &#x2F;usr&#x2F;sbin&#x2F;mmm_mond line 11.<br>failed<br></code></pre></td></tr></table></figure><h4 id="解决方法：安装下列perl的库"><strong>解决方法：安装下列perl的库</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet"># yum -y install cpan<br># cpan Proc::Daemon<br># cpan Log::Log4perl<br># &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-agent start<br>Daemon bin: '&#x2F;usr&#x2F;sbin&#x2F;mmm_agentd'<br>Daemon pid: '&#x2F;var&#x2F;run&#x2F;mmm_agentd.pid'<br>Starting MMM Agent daemon... Ok  <br># netstat -anpt | grep 9988<br>tcp 0 0 127.0.0.1:9988 0.0.0.0:* LISTEN 8546&#x2F;mmm_mond<br></code></pre></td></tr></table></figure><h3 id="（2）db代理端启动-2">（2）db代理端启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#启动代理进程 在 &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-agent的脚本文件的#!&#x2F;bin&#x2F;sh下面，加入如下内容（所有db服务器上）<br>[root@masterB ~]# vim &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-agent <br>#!&#x2F;bin&#x2F;sh<br>source &#x2F;root&#x2F;.bash_profile<br>#添加成系统服务并设置为自启动<br></code></pre></td></tr></table></figure><h4 id="添加成系统服务并设置为自启动">添加成系统服务并设置为自启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterB ~]# chkconfig --add mysql-mmm-agent<br>[root@masterB ~]# chkconfig mysql-mmm-agent on<br>[root@masterB ~]# &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-agent start <br>Daemon bin: '&#x2F;usr&#x2F;sbin&#x2F;mmm_agentd'<br>Daemon pid: '&#x2F;var&#x2F;run&#x2F;mmm_agentd.pid'<br>Starting MMM Agent daemon... Ok<br></code></pre></td></tr></table></figure><p><strong>注：添加source /root/.bash_profile目的是为了mysql-mmm-agent服务能启机自启。 自动启动和手动启动的唯一区别，就是激活一个console 。那么说明在作为服务启动的时候，可能是由于缺少环境变量 服务启动失败，报错信息如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">Daemon bin: '&#x2F;usr&#x2F;sbin&#x2F;mmm_agentd'<br>Daemon pid: '&#x2F;var&#x2F;run&#x2F;mmm_agentd.pid'<br>Starting MMM Agent daemon... Can't locate Proc&#x2F;Daemon.pm in @INC (@INC conta<br>&#x2F;usr&#x2F;local&#x2F;lib64&#x2F;perl5 &#x2F;usr&#x2F;local&#x2F;share&#x2F;perl5 &#x2F;usr&#x2F;lib64&#x2F;perl5&#x2F;vendor_perl<br>&#x2F;usr&#x2F;share&#x2F;perl5&#x2F;vendor_perl &#x2F;usr&#x2F;lib64&#x2F;perl5 &#x2F;usr&#x2F;share&#x2F;perl5 .) at<br>&#x2F;usr&#x2F;sbin&#x2F;mmm_agentd line 7.<br>BEGIN failed--compilation aborted at &#x2F;usr&#x2F;sbin&#x2F;mmm_agentd line 7.<br>failed<br></code></pre></td></tr></table></figure><h4 id="解决方法：">解决方法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">\# yum -y install cpan<br>\# cpan Proc::Daemon<br>\# cpan Log::Log4perl<br>\# &#x2F;etc&#x2F;init.d&#x2F;mysql-mmm-agent start<br>Daemon bin: '&#x2F;usr&#x2F;sbin&#x2F;mmm_agentd'<br>Daemon pid: '&#x2F;var&#x2F;run&#x2F;mmm_agentd.pid'<br>Starting MMM Agent daemon... Ok  <br># netstat -antp | grep mmm_agentd<br>tcp 0 0 192.168.31.83:9989 0.0.0.0:* LISTEN 9693&#x2F;mmm_agentd<br></code></pre></td></tr></table></figure><h2 id="3、启动成功后操作">3、启动成功后操作</h2><h3 id="（1）monitor查看群集的最新状态">（1）monitor查看群集的最新状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# mmm_control show<br>  masterB(192.168.1.11) master&#x2F;HARD_OFFLINE. Roles: <br>  mysqlC(192.168.1.12) master&#x2F;HARD_OFFLINE. Roles: <br>  mysqlD(192.168.1.13) slave&#x2F;HARD_OFFLINE. Roles:<br></code></pre></td></tr></table></figure><p><strong>如果服务器状态不是ONLINE，可以用如下命令将服务器上线，例如：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">#如果一直显示等待，可手动设置<br>[root@masterA ~]# mmm_control set_online masterB<br>[root@masterA ~]# mmm_control set_online mysqlC<br>[root@masterA ~]# mmm_control set_online mysqlD<br></code></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1&gt;一、MMM简介&lt;/h1&gt;
&lt;p&gt;&lt;strong&gt;MMM即Multi-Master Replication Manager for MySQL:mysql多主复制管理器,基于perl实现,关于mysql主主复制置的监控、故障转移和管理的一套可伸缩的脚本套件（在任何时候只有一
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://wsdlxgp.top/categories/mysql/"/>
    
    
  </entry>
  
  <entry>
    <title>Keepalived高可用</title>
    <link href="https://wsdlxgp.top/posts/b9c4.html"/>
    <id>https://wsdlxgp.top/posts/b9c4.html</id>
    <published>2020-06-27T16:02:00.000Z</published>
    <updated>2020-07-11T08:08:52.971Z</updated>
    
    <content type="html"><![CDATA[<p><strong>下面我们就完成keepalived的高可用性。 keepalived是集群管理中保证集群高可用的一个软件解决方案，其功 能类似于heartbeat，用来防止单点故障 keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即虚拟路由冗余协议。 虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即 将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个 对外提供服务的vip，master会发组播（组播地址为224.0.0.18），当backup收不到vrrp包时就认为master宕掉 了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。 keepalived主要有三个模块，分别是core 、check和vrrp。core模块为keepalived的核心，负责主进程的启动、 维护以及全局配置文件的加载和解析。check负责健康检查，包括常见的各种检查方式。vrrp模块是来实现 VRRP协议的。</strong></p><h1>一、Keepalived高可用</h1><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630161657.png" alt></p><h2 id="1、Keepalived简介">1、Keepalived简介</h2><p><strong>keepalived是集群管理中保证集群高可用的一个软件解决方案，其功能类似于heartbeat，用来防止单点故障 keepalived是以VRRP协议为实现基础的，VRRP全称Virtual RouterRedundancy Protocol，即虚拟路由冗余协议。</strong></p><h2 id="2、Keepalived工作原理">2、Keepalived工作原理</h2><p><strong>虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip，master会发组播（组播地址为224.0.0.18），当backup收不到vrrp包时就认为master宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。</strong></p><p>keepalived主要有三个模块，分别是core 、check和vrrp。</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs tex"><code class="language-hljs tex">(1)core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。<br>(2)check负责健康检查，包括常见的各种检查方式。<br>(3)vrrp模块是来实现VRRP协议的。<br></code></pre></td></tr></table></figure><h2 id="3、keepalived的安装配置">3、keepalived的安装配置</h2><h3 id="（1）在master1和master2上安装软件包keepalived">（1）在master1和master2上安装软件包keepalived</h3><p><strong>在master1和master2上安装软件包keepalived，安装keepalived软件包与服务控制在编译安装Keepalived之前，必须先安装内核开发包kernel-devel以及openssl-devel、popt-devel等支持库。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# wget https:&#x2F;&#x2F;www.keepalived.org&#x2F;software&#x2F;keepalived-2.0.20.tar.gz<br></code></pre></td></tr></table></figure><h4 id="安装依赖库">安装依赖库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# yum -y install kernel-devel openssl-devel popt-devel<br></code></pre></td></tr></table></figure><h4 id="解压">解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# tar -zxf keepalived-2.0.20.tar.gz<br></code></pre></td></tr></table></figure><h4 id="安装">安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]#  cd keepalived-2.0.20&#x2F;<br>[root@masterA ~]#  .&#x2F;configure --prefix&#x3D;&#x2F; && make && make install<br></code></pre></td></tr></table></figure><p><strong>注意：如不知道keepalived需要哪些依赖包，可到下载后的源码解压目录下查看INSTALL 文件内容， 执行make install操作之后，会自动生成/etc/init.d/keepalived脚本文件，但还需要手动添加为系统服务，这样就可以使用 service、chkconfig工具来对keepalived服务程序进行管理了。</strong></p><h4 id="可能出现的错误">可能出现的错误</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">.&#x2F;configure 后显示<br>checking forgcc... no<br>checking forcc... no<br>checking for cl.exe... noconfigure.sh:error:no acceptable C compiler found in$PATH<br>See 'config.log'for more details. <br><br>解决办法：yum -y install gcc<br></code></pre></td></tr></table></figure><p><strong>注意：如不知道keepalived需要哪些依赖包，可到下载后的源码解压目录下查看INSTALL 文件内容， 执行make install操作之后，会自动生成/etc/init.d/keepalived脚本文件，但还需要手动添加为系统服务，这样就可以使用 service、chkconfig工具来对keepalived服务程序进行管理了。</strong></p><p><strong>另外：若开启了防火墙，需要关闭防火墙或创建规则。</strong></p><p><strong>创建防火墙规则：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet"># firewall-cmd --direct --permanent --add-rule ipv4 filter OUTPUT 0 --ininterface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT<br><br># firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --ininterface ens33 --destination 224.0.0.18 --protocol vrrp -j ACCEPT<br><br># firewall-cmd --reload<br></code></pre></td></tr></table></figure><h3 id="（2）修改Keepalived的配置文件">（2）修改Keepalived的配置文件</h3><p><strong>keepalived只有一个配置文件keepalived.conf, 里面主要包括以下几个配置区域:</strong></p><blockquote><p>global_defs：主要是配置故障发生时的通知对象以及 机器标识。<br>vrrp_instance：用来定义对外提供服务的VIP区域及其相关属性。<br>virtual_server：虚拟服务器定义</p></blockquote><h3 id="范例">范例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlA ~]# vim  &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf <br>! Configuration File for keepalived &#x2F;&#x2F;!表示注释<br><br>global_defs &#123;<br>  router_id MYSQL-1 &#x2F;&#x2F;表示运行keepalived服务器的一个标识<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>  # 指定keepalived的角色, 两台配置此处均是BACKUP,设为BACKUP将根据优先级决定主或从<br>  state BACKUP<br>  # 指定HA监测网络的接口<br>  interface ens33<br>  # 虚拟路由标识，这个标识是一个数字(取值在0-255之间,用来区分多个instance的VRRP组播)，<br>  # 同一个vrrp实例使用唯一的标识,确保和master2相同，同网内不同集群此项必须不同,否则发生冲突。<br>  virtual_router_id 51<br>  # 用来选举master的，要成为master，该项取值范围是1-255（在此范围之外会被识别成默认值100）,<br>  # 此处master2上设置为50<br>  priority 100<br>  # 发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）<br>  advert_int 1<br>  # 不抢占，即允许一个priority比较低的节点作为master，即使有priority更高的节点启动<br>  nopreempt <br>  <br>  # 认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）<br>  authentication &#123; <br>    auth_type PASS<br>    auth_pass 1111<br>  &#125;<br>  # VIP区域，指定vip地址<br>  virtual_ipaddress &#123;<br>    192.168.1.100<br>  &#125;<br>&#125;<br><br># 设置虚拟服务器，需要指定虚拟IP地址和服务端口，IP与端口之间用空格隔开<br>virtual_server 192.168.1.100 3306 &#123;<br>  # 设置运行情况检查时间，单位是秒<br>  delay_loop 2 <br>  # 设置后端调度算法，这里设置为rr，即轮询算法<br>  lb_algo rr<br>  # 设置LVS实现负载均衡的机制，有NAT、TUN、DR三个模式可选<br>  lb_kind DR <br>  # 会话保持时间，单位是秒。<br>  # 这个选项对动态网页是非常有用的，为集群系统中的session共享提供了一个很好的解决方案。<br>  # 有了这个会话保持功能，用户的请求会被一直分发到某个服务节点，直到超过这个会话的保持时间。<br>  persistence_timeout 60<br>  # 指定转发协议类型，有TCP和UDP两种<br>  protocol TCP<br>  <br>  # 配置服务节点1，需要指定real server的真实IP地址和端口，IP与端口之间用空格隔开<br>  # 注：master 2上此处改为192.168.1.20(即master2本机ip)<br>  real_server 192.168.1.10 3306 &#123;<br>    # 配置服务节点的权值，权值大小用数字表示，数字越大，权值越高，<br>    # 设置权值大小为了区分不同性能的服务器<br>    weight 3<br>    # 检测到realserver的mysql服务down后执行的脚本<br>    notify_down &#x2F;etc&#x2F;keepalived&#x2F;bin&#x2F;mysql.sh<br>    <br>    TCP_CHECK &#123;<br>      # 连接超时时间<br>      connect_timeout 3<br>      # 重连次数<br>      nb_get_retry 3 <br>      # 重连间隔时间<br>      delay_before_retry 3 <br>      # 健康检查端口<br>      connect_port 3306 <br>    &#125;<br>  &#125;<br>&#125;<br><br>[root@mysql &#x2F;]# systemctl start keepalived<br></code></pre></td></tr></table></figure><h3 id="masterA的配置">masterA的配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlA ~]# vim  &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf <br>! Configuration File for keepalived<br><br>global_defs &#123;<br>   router_id mysql-1<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    interface ens33<br>    virtual_router_id 51<br>    priority 100<br>    advert_int 1<br>    nopreempt<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.1.100<br>    &#125;<br>&#125;<br><br>virtual_server 192.168.1.100 3306 &#123;<br>    delay_loop 6<br>    lb_algo rr<br>    lb_kind DR<br>    persistence_timeout 60<br>    protocol TCP<br><br>    real_server 192.168.1.10 3306 &#123;<br>        weight 1<br>        notify_down &#x2F;etc&#x2F;keepalived&#x2F;bin&#x2F;mysql.sh<br>        TCP_CHECK &#123;<br>                connect_port 3306<br>                connect_timeout 3<br>                retry 3<br>                delay_before_retry 3<br><br>        &#125;<br>    &#125;<br>&#125;<br>[root@mysql &#x2F;]# systemctl start keepalived<br></code></pre></td></tr></table></figure><h3 id="masterB的配置">masterB的配置</h3><p><strong>将masterA配置好的文件复制给master，稍加修改即可</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysqlB ~]# scp &#x2F;etc&#x2F;keepalived&#x2F;keepalived.conf root@192.168.171.145:&#x2F;etc&#x2F;keepalived&#x2F;<br>! Configuration File for keepalived<br><br>global_defs &#123;<br>   router_id mysql-2<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    interface ens33<br>    virtual_router_id 51<br>    priority 50<br>    advert_int 1<br>    nopreempt<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.1.100<br>    &#125;<br>&#125;<br><br>virtual_server 192.168.1.100 3306 &#123;<br>    delay_loop 6<br>    lb_algo rr<br>    lb_kind DR<br>    persistence_timeout 60<br>    protocol TCP<br><br>    real_server 192.168.1.11 3306 &#123;<br>        weight 1<br>        notify_down &#x2F;etc&#x2F;keepalived&#x2F;bin&#x2F;mysql.sh<br>        TCP_CHECK &#123;<br>                connect_port 3306<br>                connect_timeout 3<br>                retry 3<br>                delay_before_retry 3<br><br>        &#125;<br>   &#125;<br>&#125;<br>[root@mysql ~]# systemctl start keepalived<br></code></pre></td></tr></table></figure><h3 id="（3）编写检测脚本">（3）编写检测脚本</h3><p><strong>在两台master上进行如下操作：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@mysql ~]# mkdir &#x2F;etc&#x2F;keepalived&#x2F;bin<br>[root@mysql ~]# vim &#x2F;etc&#x2F;keepalived&#x2F;bin&#x2F;mysql.sh<br>#!&#x2F;bin&#x2F;bash<br>pkill keepalived<br>#赋予执行权限<br>[root@mysql ~]# chmod +x &#x2F;etc&#x2F;keepalived&#x2F;bin&#x2F;mysql.sh<br></code></pre></td></tr></table></figure><p><strong>master1 和master2 上都添加此检测脚本，作用是当 mysql 停止工作时自动关闭本机的keepalived，从而实现将故障机器踢出（因每台机器上keepalived 只添加了本机为 realserver）。</strong></p><p><strong>当 mysqld 正常启动起来后，要手动启动 keepalived 服务</strong></p><h3 id="（4）测试">（4）测试</h3><h4 id="1）测试一">1）测试一</h4><p><strong>在master1和master2分别执行ip addr show dev ens33命令查看master1和 master2对VIP（群集虚拟</strong><br><strong>IP）的控制权。</strong></p><h5 id="master1主的查看结果："><strong>master1主的查看结果：</strong></h5><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630164542.png" alt></p><h5 id="master2主的查看结果：">master2主的查看结果：</h5><h5 id><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630164600.png" alt></h5><p><strong>从上图可以看出master1 是主服务器，master2 为备用服务器</strong></p><h4 id="2）测试二">2）测试二</h4><p><strong>停止MySQL服务，看keepalived健康检查程序是 否会触发我们编写的脚本</strong></p><p><strong>停止master1主机的mysql服务</strong></p><h5 id="masterA：">masterA：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# systemctl stop mysqld<br>[root@masterA ~]# ip addr show dev ens33<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630164954.png" alt></p><h5 id="masterB：">masterB：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# ip addr show dev ens33<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630165019.png" alt></p><p><strong>这说明在主服务上停止MySQL服务，触发了我们编写的脚本，进行自动故障切换</strong></p><h4 id="3）MySQL-远程登录测试">3）MySQL 远程登录测试</h4><p><strong>我们找一台安装有MySQL 客户端，然后登录 VIP，看是否能登录。</strong></p><p><strong>在登录的两台 MySQL 服务器都要授权允许从远程登录。例如：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@masterA ~]# mysql -uroot -p<br>mysql> set global validate_password_policy&#x3D;LOW;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql> set global validate_password_length&#x3D;4;<br>Query OK, 0 rows affected (0.00 sec)<br><br>mysql> grant all on *.* to 'root'@'%' identified by '1234';<br>Query OK, 0 rows affected, 1 warning (0.00 sec)<br><br>mysql> flush privileges;<br>Query OK, 0 rows affected (0.00 sec)<br></code></pre></td></tr></table></figure><p><strong>在客户端上测试登录</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@master1 ~]# mysql -uroot -p -h 192.168.206.100 -P3306<br><br>mysql> show variables like 'server_id';<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630225327.png" alt></p><p><strong>上图显示说明在客户端访问 VIP 地址，由 master1 主机提供响应的，因为 master1 当前是主服务器，将 master1 的 mysql 服务停止，在客户端执行 show variableslike‘server_id’;</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre class=" language-hljs spreadsheet"><code class="language-hljs spreadsheet">[root@master1 ~]# systemctl stop mysqld<br><br>mysql> show variables like 'server_id';<br></code></pre></td></tr></table></figure><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://gitee.com/xgpqq/tuchuang/raw/master/img/20200630225405.png" alt></p><p><strong>上图显示说明在客户端的查询请求是由 master2 主机响应的，故障切换成功。</strong></p><h1>二、Keepalived使用总结</h1><p><strong>Keepalived+mysql双主一般来说，中小型规模的时候，采用这种架构是最省事的。 在master节点发生</strong><br><strong>故障后，利用keepalived的高可用机制实现快速切换到备用节点。</strong></p><h3 id="在这个方案里，有几个需要注意的地方：">在这个方案里，有几个需要注意的地方：</h3><ul><li><strong>采用 keepalived 作为高可用方案时，两个节点最好都设置成 BACKUP模式，避免因为意外情况下（比如 脑裂）相互抢占导致往两个节点写入相同数据而引发冲突；</strong></li><li><strong>把两个节点的 auto_increment_increment（自增步长）和 auto_increment_offset（自增起始值）设成不同值。其目的是为了避免master 节点意外宕机时，可能会有部分 binlog 未能及时复制到slave上被应用，从而会导致slave新写入数据的自增值和原先master上冲突了，因此一开始就使其错开；当然了，如果有合适的容错机制能解决主从自增ID 冲突的话，也可以不这么做；</strong></li><li><strong>slave 节点服务器配置不要太差，否则更容易导致复制延迟。作为热备节点的 slave服务器，硬件配置不能低于 master 节点；</strong></li><li><strong>如果对延迟问题很敏感的话，可考虑使用 MariaDB 分支版本，或者直接上线 MySQL 5.7 最新版本，利用多线程复制的方式可以很大程度降低复制延迟。</strong></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;下面我们就完成keepalived的高可用性。 keepalived是集群管理中保证集群高可用的一个软件解决方案，其功 能类似于heartbeat，用来防止单点故障 keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router 
      
    
    </summary>
    
    
      <category term="mysql" scheme="https://wsdlxgp.top/categories/mysql/"/>
    
    
  </entry>
  
</feed>
